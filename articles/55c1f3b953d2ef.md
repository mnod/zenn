---
title: "Raspberry Pi OS で KVM"
emoji: "🎃"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["raspberrypi", "kvm", "debian"]
published: true
---

# 環境について

64bit版のRaspberry Pi OS Lite(Debian12 Bookworm版)で、KVM のインストール、仮想マシンの作成をしてみます。
Raspberry Pi 4B 8GB版でテストしましたが、CPUの仮想化支援が効くので、低負荷で動作します。

```
$ cat /etc/os-release
PRETTY_NAME="Debian GNU/Linux 12 (bookworm)"
NAME="Debian GNU/Linux"
VERSION_ID="12"
VERSION="12 (bookworm)"
VERSION_CODENAME=bookworm
ID=debian
HOME_URL="https://www.debian.org/"
SUPPORT_URL="https://www.debian.org/support"
BUG_REPORT_URL="https://bugs.debian.org/"

$ cat /etc/debian_version
12.7

$ uname -a
Linux testpi 6.6.51+rpt-rpi-v8 #1 SMP PREEMPT Debian 1:6.6.51-1+rpt3 (2024-10-08) aarch64 GNU/Linux
```

## NW設定

有線NICに仮想ブリッジを仕込み、KVMではブリッジを利用する想定。
以下のようなファイルをメディアに書き込んでOS起動する。

```:/etc/NetworkManager/system-connections/br0-<UUID>.nmconnection
[connection]
id=br0
uuid=<UUID>
type=bridge
interface-name=br0
timestamp=1720959930

[ethernet]

[bridge]
stp=false

[ipv4]
address1=<IPアドレス>/24,<デフォルトGW>
dns=<プライマリDNSサーバ>;<セカンダリDNSサーバ>;
method=manual
route1=<宛先NWアドレス>/24,<GWアドレス>

[ipv6]
addr-gen-mode=default
method=auto

[proxy]
```

```:/etc/NetworkManager/system-connections/bridge-slave-eth0.nmconnection
[connection]
id=bridge-slave-eth0
uuid=<UUID>
type=ethernet
interface-name=eth0
master=br0
slave-type=bridge

[ethernet]

[bridge-port]
```

## 作業用領域

ブートドライブの書き込み回数を減らしたいので、作業用領域は別のドライブに用意する。

```
$ dmesg | tail
$ sudo parted /dev/sda
> print
> rm 1
> mkpart primary 0% 100%
> print
> quit

$ sudo mkfs -t ext4 /dev/sda1
$ sudo mkdir /media/work

$ echo PARTUUID=$(ls -l /dev/disk/by-partuuid | grep sda1 | awk '{print $9}') /media/work ext4 defaults,noatime 0 1 | sudo tee -a /etc/fstab
PARTUUID=74e6849b-01 /media/work ext4 defaults,noatime 0 1

$ sudo mount /media/work
$ df
```

閑話休題
最初はUSBメモリを利用しようとしたのだが、I/Oの遅さのため断念。
10年以上前のSATAの2.5インチHDDを利用した。80GB。ケースに入れてUSB接続で利用できて便利。


## 関連パッケージのインストール

必要なパッケージをインストールします。

```
$ sudo apt install --no-install-recommends qemu-system-arm qemu-utils qemu-system-gui ipxe-qemu bridge-utils qemu-efi-aarch64 kpartx
```

#  仮想マシンの作成

ここでは例として、Debian12 の仮想マシンを作成します。
https://www.debian.org/CD/netinst/ より、arm64 ネットインストール版CDイメージをダウンロードして利用します。(以下、debian-12.7.0-arm64-netinst.iso)

```
$ ls -l /media/work/iso/
-rw-r--r-- 1 pi pi 551858176 Nov  4 05:09 debian-12.7.0-arm64-netinst.iso
```

## CDイメージからカーネルと初期化RAMディスクをコピー

インストールCDイメージから、カーネルと初期化RAMディスクをコピーします。


インストールメディアをマウント
```
$ sudo mkdir /media/iso
$ sudo mount /media/work/iso/debian-12.7.0-arm64-netinst.iso /media/iso
```

grub.cfg から、カーネルと初期化RAMディスクのパスを確認
```
$ egrep 'linux|initrd' /media/iso/boot/grub/grub.cfg | awk '{print $2}' | sort | uniq
/install.a64/gtk/initrd.gz
/install.a64/initrd.gz
/install.a64/vmlinuz
```

カーネルと初期化RAMディスクをコピー。コピーしたらアンマウント。
```
$ cd /media/work/iso/
$ cp -pi /media/iso/install.a64/vmlinuz debian-12.7.0-arm64-netinst.vmlinuz
$ cp -pi /media/iso/install.a64/initrd.gz debian-12.7.0-arm64-netinst.initrd.gz
$ ls -l /media/work/iso/
total 592188
-r--r--r-- 1 pi pi  21840895 Aug 31 19:41 debian-12.7.0-arm64-netinst.initrd.gz
-rw-r--r-- 1 pi pi 551858176 Nov  4 05:09 debian-12.7.0-arm64-netinst.iso
-r--r--r-- 1 pi pi  32692160 Aug 31 19:41 debian-12.7.0-arm64-netinst.vmlinuz
$ sudo umount /media/iso
```

## 仮想ディスクを作成

作業ディレクトリを作成
```
$ sudo mkdir /media/work/qemu
$ sudo chown pi: /media/work/qemu
$ cd /media/work/qemu/
```

```
$ qemu-img create -f qcow2 debian-12.7.0-arm64.qcow2.base 16G
Formatting 'debian-12.7.0-arm64.qcow2.base', fmt=qcow2 cluster_size=65536 extended_l2=off compression_type=zlib size=17179869184 lazy_refcounts=off refcount_bits=16

$ qemu-img info debian-12.7.0-arm64.qcow2.base
image: debian-12.7.0-arm64.qcow2.base
file format: qcow2
virtual size: 16 GiB (17179869184 bytes)
disk size: 196 KiB
cluster_size: 65536
Format specific information:
    compat: 1.1
    compression type: zlib
    lazy refcounts: false
    refcount bits: 16
    corrupt: false
    extended l2: false

$ ls -lhs debian-12.7.0-arm64.qcow2.base
196K -rw-r--r-- 1 pi pi 193K Nov  4 07:44 debian-12.7.0-arm64.qcow2.base
```

## インストール

amd64のKVMでおなじみのパラメータの他に、カーネル、初期化RAMディスクを指定してインストーラを起動する。
```
$ sudo qemu-system-aarch64 \
-machine virt \
-cpu host \
-m 1024 \
-enable-kvm \
-kernel /media/work/iso/debian-12.7.0-arm64-netinst.vmlinuz \
-initrd /media/work/iso/debian-12.7.0-arm64-netinst.initrd.gz \
-cdrom /media/work/iso/debian-12.7.0-arm64-netinst.iso \
-drive file=debian-12.7.0-arm64.qcow2.base \
-net nic,macaddr=52:54:00:12:34:10 -net tap,ifname=tap1 -vnc 0.0.0.0:0
```

VNCビューアを実行して KVMホストの 5900ポートに接続する
QEMUコンソールが開いたら、Ctrl + Alt + 2 で画面をシリアルコンソールへ切り替える。
インストールは通常の手順で実行する。

インストール終了したら下記で仮想マシンを終了する。

- QEMUを実行したコマンドプロンプトに戻って、Ctrl + c で終了する。
- または、Ctrl + Alt + 1 で QEMUターミナルに戻り、q で終了する。


## 仮想ディスクからカーネルと初期化RAMディスクをコピー

仮想ディスクをマウント
```
$ sudo modprobe nbd
$ sudo qemu-nbd -c /dev/nbd0 debian-12.7.0-arm64.qcow2.base

$ sudo kpartx -av /dev/nbd0
add map nbd0p1 (254:0): 0 997376 linear 43:0 2048
add map nbd0p2 (254:1): 0 30597120 linear 43:0 999424
add map nbd0p3 (254:2): 0 1955840 linear 43:0 31596544

$ sudo mkdir /media/tmp
$ sudo mount /dev/mapper/nbd0p1 /media/tmp
$ df
```

カーネルと初期化RAMディスクをコピー
```
$ cp -pi /media/tmp/vmlinuz debian-12.7.0-arm64.vmlinuz
$ cp -pi /media/tmp/initrd.img debian-12.7.0-arm64.initrd.img
$ la -l
```

アンマウント
```
$ sudo umount /media/tmp
$ sudo kpartx -dv /dev/nbd0
$ sudo qemu-nbd -d /dev/nbd0
$ sudo rmmod nbd
```

##  オーバーレイストレージイメージ作成

インストール完了直後のイメージをバッキングファイルとして、オーバーレイストレージイメージ作成する。
(こうすることで、いつでもインストール直後のまっさらな状態に戻すことができる)

```
$ qemu-img create -f qcow2 -b debian-12.7.0-arm64.qcow2.base -F qcow2 debian-12.7.0-arm64.qcow2 16G
Formatting 'debian-12.7.0-arm64.qcow2', fmt=qcow2 cluster_size=65536 extended_l2=off compression_type=zlib size=17179869184 backing_file=debian-12.7.0-arm64.qcow2.base backing_fmt=qcow2 lazy_refcounts=off refcount_bits=16

$ qemu-img info debian-12.7.0-arm64.qcow2
image: debian-12.7.0-arm64.qcow2
file format: qcow2
virtual size: 16 GiB (17179869184 bytes)
disk size: 196 KiB
cluster_size: 65536
backing file: debian-12.7.0-arm64.qcow2.base
backing file format: qcow2
Format specific information:
    compat: 1.1
    compression type: zlib
    lazy refcounts: false
    refcount bits: 16
    corrupt: false
    extended l2: false
```

# 仮想マシン起動

コピーしたカーネル、初期化RAMディスクで仮想マシンを起動する。

```
$ sudo qemu-system-aarch64 \
 -machine virt \
 -cpu host \
 -m 1024 \
 -enable-kvm \
 -kernel debian-12.7.0-arm64.vmlinuz \
 -initrd debian-12.7.0-arm64.initrd.img \
 -append root=/dev/vda2 \
 -drive file=debian-12.7.0-arm64.qcow2 \
 -net nic,macaddr=52:54:00:12:34:0 -net tap,ifname=tap1 \
 -vnc 0.0.0.0:0 \
 -daemonize
```

VNCビューアを実行して KVMホストの 5900ポートに接続する
QEMUコンソールが開いたら、Ctrl + Alt + 2 で画面をシリアルコンソールへ切り替える。

```
$ ip a
ipアドレスが付与されていることを確認する。
$ su -
$ apt install --no-install-recommends openssh-server
```

他のホストからssh 接続をテストする。
接続できたら、VNCビューアは閉じてよい。


