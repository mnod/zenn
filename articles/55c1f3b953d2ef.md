---
title: "Raspberry Pi OS ã§ KVM"
emoji: "ğŸƒ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["raspberrypi", "kvm", "debian"]
published: true
---

# ç’°å¢ƒã«ã¤ã„ã¦

64bitç‰ˆã®Raspberry Pi OS Lite(Debian12 Bookwormç‰ˆ)ã§ã€KVM ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€ä»®æƒ³ãƒã‚·ãƒ³ã®ä½œæˆã‚’ã—ã¦ã¿ã¾ã™ã€‚
Raspberry Pi 4B 8GBç‰ˆã§ãƒ†ã‚¹ãƒˆã—ã¾ã—ãŸãŒã€CPUã®ä»®æƒ³åŒ–æ”¯æ´ãŒåŠ¹ãã®ã§ã€ä½è² è·ã§å‹•ä½œã—ã¾ã™ã€‚

```
$ cat /etc/os-release
PRETTY_NAME="Debian GNU/Linux 12 (bookworm)"
NAME="Debian GNU/Linux"
VERSION_ID="12"
VERSION="12 (bookworm)"
VERSION_CODENAME=bookworm
ID=debian
HOME_URL="https://www.debian.org/"
SUPPORT_URL="https://www.debian.org/support"
BUG_REPORT_URL="https://bugs.debian.org/"

$ cat /etc/debian_version
12.7

$ uname -a
Linux testpi 6.6.51+rpt-rpi-v8 #1 SMP PREEMPT Debian 1:6.6.51-1+rpt3 (2024-10-08) aarch64 GNU/Linux
```

## NWè¨­å®š

æœ‰ç·šNICã«ä»®æƒ³ãƒ–ãƒªãƒƒã‚¸ã‚’ä»•è¾¼ã¿ã€KVMã§ã¯ãƒ–ãƒªãƒƒã‚¸ã‚’åˆ©ç”¨ã™ã‚‹æƒ³å®šã€‚
ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ¡ãƒ‡ã‚£ã‚¢ã«æ›¸ãè¾¼ã‚“ã§OSèµ·å‹•ã™ã‚‹ã€‚

```:/etc/NetworkManager/system-connections/br0-<UUID>.nmconnection
[connection]
id=br0
uuid=<UUID>
type=bridge
interface-name=br0
timestamp=1720959930

[ethernet]

[bridge]
stp=false

[ipv4]
address1=<IPã‚¢ãƒ‰ãƒ¬ã‚¹>/24,<ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆGW>
dns=<ãƒ—ãƒ©ã‚¤ãƒãƒªDNSã‚µãƒ¼ãƒ>;<ã‚»ã‚«ãƒ³ãƒ€ãƒªDNSã‚µãƒ¼ãƒ>;
method=manual
route1=<å®›å…ˆNWã‚¢ãƒ‰ãƒ¬ã‚¹>/24,<GWã‚¢ãƒ‰ãƒ¬ã‚¹>

[ipv6]
addr-gen-mode=default
method=auto

[proxy]
```

```:/etc/NetworkManager/system-connections/bridge-slave-eth0.nmconnection
[connection]
id=bridge-slave-eth0
uuid=<UUID>
type=ethernet
interface-name=eth0
master=br0
slave-type=bridge

[ethernet]

[bridge-port]
```

## ä½œæ¥­ç”¨é ˜åŸŸ

ãƒ–ãƒ¼ãƒˆãƒ‰ãƒ©ã‚¤ãƒ–ã®æ›¸ãè¾¼ã¿å›æ•°ã‚’æ¸›ã‚‰ã—ãŸã„ã®ã§ã€ä½œæ¥­ç”¨é ˜åŸŸã¯åˆ¥ã®ãƒ‰ãƒ©ã‚¤ãƒ–ã«ç”¨æ„ã™ã‚‹ã€‚

```
$ dmesg | tail
$ sudo parted /dev/sda
> print
> rm 1
> mkpart primary 0% 100%
> print
> quit

$ sudo mkfs -t ext4 /dev/sda1
$ sudo mkdir /media/work

$ echo PARTUUID=$(ls -l /dev/disk/by-partuuid | grep sda1 | awk '{print $9}') /media/work ext4 defaults,noatime 0 1 | sudo tee -a /etc/fstab
PARTUUID=74e6849b-01 /media/work ext4 defaults,noatime 0 1

$ sudo mount /media/work
$ df
```

é–‘è©±ä¼‘é¡Œ
æœ€åˆã¯USBãƒ¡ãƒ¢ãƒªã‚’åˆ©ç”¨ã—ã‚ˆã†ã¨ã—ãŸã®ã ãŒã€I/Oã®é…ã•ã®ãŸã‚æ–­å¿µã€‚
10å¹´ä»¥ä¸Šå‰ã®SATAã®2.5ã‚¤ãƒ³ãƒHDDã‚’åˆ©ç”¨ã—ãŸã€‚80GBã€‚ã‚±ãƒ¼ã‚¹ã«å…¥ã‚Œã¦USBæ¥ç¶šã§åˆ©ç”¨ã§ãã¦ä¾¿åˆ©ã€‚


## é–¢é€£ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```
$ sudo apt install --no-install-recommends qemu-system-arm qemu-utils qemu-system-gui ipxe-qemu bridge-utils qemu-efi-aarch64 kpartx
```

#  ä»®æƒ³ãƒã‚·ãƒ³ã®ä½œæˆ

ã“ã“ã§ã¯ä¾‹ã¨ã—ã¦ã€Debian12 ã®ä»®æƒ³ãƒã‚·ãƒ³ã‚’ä½œæˆã—ã¾ã™ã€‚
https://www.debian.org/CD/netinst/ ã‚ˆã‚Šã€arm64 ãƒãƒƒãƒˆã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç‰ˆCDã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦åˆ©ç”¨ã—ã¾ã™ã€‚(ä»¥ä¸‹ã€debian-12.7.0-arm64-netinst.iso)

```
$ ls -l /media/work/iso/
-rw-r--r-- 1 pi pi 551858176 Nov  4 05:09 debian-12.7.0-arm64-netinst.iso
```

## CDã‚¤ãƒ¡ãƒ¼ã‚¸ã‹ã‚‰ã‚«ãƒ¼ãƒãƒ«ã¨åˆæœŸåŒ–RAMãƒ‡ã‚£ã‚¹ã‚¯ã‚’ã‚³ãƒ”ãƒ¼

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«CDã‚¤ãƒ¡ãƒ¼ã‚¸ã‹ã‚‰ã€ã‚«ãƒ¼ãƒãƒ«ã¨åˆæœŸåŒ–RAMãƒ‡ã‚£ã‚¹ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚


ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ¡ãƒ‡ã‚£ã‚¢ã‚’ãƒã‚¦ãƒ³ãƒˆ
```
$ sudo mkdir /media/iso
$ sudo mount /media/work/iso/debian-12.7.0-arm64-netinst.iso /media/iso
```

grub.cfg ã‹ã‚‰ã€ã‚«ãƒ¼ãƒãƒ«ã¨åˆæœŸåŒ–RAMãƒ‡ã‚£ã‚¹ã‚¯ã®ãƒ‘ã‚¹ã‚’ç¢ºèª
```
$ egrep 'linux|initrd' /media/iso/boot/grub/grub.cfg | awk '{print $2}' | sort | uniq
/install.a64/gtk/initrd.gz
/install.a64/initrd.gz
/install.a64/vmlinuz
```

ã‚«ãƒ¼ãƒãƒ«ã¨åˆæœŸåŒ–RAMãƒ‡ã‚£ã‚¹ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã€‚ã‚³ãƒ”ãƒ¼ã—ãŸã‚‰ã‚¢ãƒ³ãƒã‚¦ãƒ³ãƒˆã€‚
```
$ cd /media/work/iso/
$ cp -pi /media/iso/install.a64/vmlinuz debian-12.7.0-arm64-netinst.vmlinuz
$ cp -pi /media/iso/install.a64/initrd.gz debian-12.7.0-arm64-netinst.initrd.gz
$ ls -l /media/work/iso/
total 592188
-r--r--r-- 1 pi pi  21840895 Aug 31 19:41 debian-12.7.0-arm64-netinst.initrd.gz
-rw-r--r-- 1 pi pi 551858176 Nov  4 05:09 debian-12.7.0-arm64-netinst.iso
-r--r--r-- 1 pi pi  32692160 Aug 31 19:41 debian-12.7.0-arm64-netinst.vmlinuz
$ sudo umount /media/iso
```

## ä»®æƒ³ãƒ‡ã‚£ã‚¹ã‚¯ã‚’ä½œæˆ

ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
```
$ sudo mkdir /media/work/qemu
$ sudo chown pi: /media/work/qemu
$ cd /media/work/qemu/
```

```
$ qemu-img create -f qcow2 debian-12.7.0-arm64.qcow2.base 16G
Formatting 'debian-12.7.0-arm64.qcow2.base', fmt=qcow2 cluster_size=65536 extended_l2=off compression_type=zlib size=17179869184 lazy_refcounts=off refcount_bits=16

$ qemu-img info debian-12.7.0-arm64.qcow2.base
image: debian-12.7.0-arm64.qcow2.base
file format: qcow2
virtual size: 16 GiB (17179869184 bytes)
disk size: 196 KiB
cluster_size: 65536
Format specific information:
    compat: 1.1
    compression type: zlib
    lazy refcounts: false
    refcount bits: 16
    corrupt: false
    extended l2: false

$ ls -lhs debian-12.7.0-arm64.qcow2.base
196K -rw-r--r-- 1 pi pi 193K Nov  4 07:44 debian-12.7.0-arm64.qcow2.base
```

## ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

amd64ã®KVMã§ãŠãªã˜ã¿ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ä»–ã«ã€ã‚«ãƒ¼ãƒãƒ«ã€åˆæœŸåŒ–RAMãƒ‡ã‚£ã‚¹ã‚¯ã‚’æŒ‡å®šã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ã‚’èµ·å‹•ã™ã‚‹ã€‚
```
$ sudo qemu-system-aarch64 \
-machine virt \
-cpu host \
-m 1024 \
-enable-kvm \
-kernel /media/work/iso/debian-12.7.0-arm64-netinst.vmlinuz \
-initrd /media/work/iso/debian-12.7.0-arm64-netinst.initrd.gz \
-cdrom /media/work/iso/debian-12.7.0-arm64-netinst.iso \
-drive file=debian-12.7.0-arm64.qcow2.base \
-net nic,macaddr=52:54:00:12:34:10 -net tap,ifname=tap1 -vnc 0.0.0.0:0
```

VNCãƒ“ãƒ¥ãƒ¼ã‚¢ã‚’å®Ÿè¡Œã—ã¦ KVMãƒ›ã‚¹ãƒˆã® 5900ãƒãƒ¼ãƒˆã«æ¥ç¶šã™ã‚‹
QEMUã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãŒé–‹ã„ãŸã‚‰ã€Ctrl + Alt + 2 ã§ç”»é¢ã‚’ã‚·ãƒªã‚¢ãƒ«ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã¸åˆ‡ã‚Šæ›¿ãˆã‚‹ã€‚
ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¯é€šå¸¸ã®æ‰‹é †ã§å®Ÿè¡Œã™ã‚‹ã€‚

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«çµ‚äº†ã—ãŸã‚‰ä¸‹è¨˜ã§ä»®æƒ³ãƒã‚·ãƒ³ã‚’çµ‚äº†ã™ã‚‹ã€‚

- QEMUã‚’å®Ÿè¡Œã—ãŸã‚³ãƒãƒ³ãƒ‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«æˆ»ã£ã¦ã€Ctrl + c ã§çµ‚äº†ã™ã‚‹ã€‚
- ã¾ãŸã¯ã€Ctrl + Alt + 1 ã§ QEMUã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã«æˆ»ã‚Šã€q ã§çµ‚äº†ã™ã‚‹ã€‚


## ä»®æƒ³ãƒ‡ã‚£ã‚¹ã‚¯ã‹ã‚‰ã‚«ãƒ¼ãƒãƒ«ã¨åˆæœŸåŒ–RAMãƒ‡ã‚£ã‚¹ã‚¯ã‚’ã‚³ãƒ”ãƒ¼

ä»®æƒ³ãƒ‡ã‚£ã‚¹ã‚¯ã‚’ãƒã‚¦ãƒ³ãƒˆ
```
$ sudo modprobe nbd
$ sudo qemu-nbd -c /dev/nbd0 debian-12.7.0-arm64.qcow2.base

$ sudo kpartx -av /dev/nbd0
add map nbd0p1 (254:0): 0 997376 linear 43:0 2048
add map nbd0p2 (254:1): 0 30597120 linear 43:0 999424
add map nbd0p3 (254:2): 0 1955840 linear 43:0 31596544

$ sudo mkdir /media/tmp
$ sudo mount /dev/mapper/nbd0p1 /media/tmp
$ df
```

ã‚«ãƒ¼ãƒãƒ«ã¨åˆæœŸåŒ–RAMãƒ‡ã‚£ã‚¹ã‚¯ã‚’ã‚³ãƒ”ãƒ¼
```
$ cp -pi /media/tmp/vmlinuz debian-12.7.0-arm64.vmlinuz
$ cp -pi /media/tmp/initrd.img debian-12.7.0-arm64.initrd.img
$ la -l
```

ã‚¢ãƒ³ãƒã‚¦ãƒ³ãƒˆ
```
$ sudo umount /media/tmp
$ sudo kpartx -dv /dev/nbd0
$ sudo qemu-nbd -d /dev/nbd0
$ sudo rmmod nbd
```

##  ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¤ãƒ¡ãƒ¼ã‚¸ä½œæˆ

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†ç›´å¾Œã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒãƒƒã‚­ãƒ³ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ã€ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¤ãƒ¡ãƒ¼ã‚¸ä½œæˆã™ã‚‹ã€‚
(ã“ã†ã™ã‚‹ã“ã¨ã§ã€ã„ã¤ã§ã‚‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç›´å¾Œã®ã¾ã£ã•ã‚‰ãªçŠ¶æ…‹ã«æˆ»ã™ã“ã¨ãŒã§ãã‚‹)

```
$ qemu-img create -f qcow2 -b debian-12.7.0-arm64.qcow2.base -F qcow2 debian-12.7.0-arm64.qcow2 16G
Formatting 'debian-12.7.0-arm64.qcow2', fmt=qcow2 cluster_size=65536 extended_l2=off compression_type=zlib size=17179869184 backing_file=debian-12.7.0-arm64.qcow2.base backing_fmt=qcow2 lazy_refcounts=off refcount_bits=16

$ qemu-img info debian-12.7.0-arm64.qcow2
image: debian-12.7.0-arm64.qcow2
file format: qcow2
virtual size: 16 GiB (17179869184 bytes)
disk size: 196 KiB
cluster_size: 65536
backing file: debian-12.7.0-arm64.qcow2.base
backing file format: qcow2
Format specific information:
    compat: 1.1
    compression type: zlib
    lazy refcounts: false
    refcount bits: 16
    corrupt: false
    extended l2: false
```

# ä»®æƒ³ãƒã‚·ãƒ³èµ·å‹•

ã‚³ãƒ”ãƒ¼ã—ãŸã‚«ãƒ¼ãƒãƒ«ã€åˆæœŸåŒ–RAMãƒ‡ã‚£ã‚¹ã‚¯ã§ä»®æƒ³ãƒã‚·ãƒ³ã‚’èµ·å‹•ã™ã‚‹ã€‚

```
$ sudo qemu-system-aarch64 \
 -machine virt \
 -cpu host \
 -m 1024 \
 -enable-kvm \
 -kernel debian-12.7.0-arm64.vmlinuz \
 -initrd debian-12.7.0-arm64.initrd.img \
 -append root=/dev/vda2 \
 -drive file=debian-12.7.0-arm64.qcow2 \
 -net nic,macaddr=52:54:00:12:34:0 -net tap,ifname=tap1 \
 -vnc 0.0.0.0:0 \
 -daemonize
```

VNCãƒ“ãƒ¥ãƒ¼ã‚¢ã‚’å®Ÿè¡Œã—ã¦ KVMãƒ›ã‚¹ãƒˆã® 5900ãƒãƒ¼ãƒˆã«æ¥ç¶šã™ã‚‹
QEMUã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãŒé–‹ã„ãŸã‚‰ã€Ctrl + Alt + 2 ã§ç”»é¢ã‚’ã‚·ãƒªã‚¢ãƒ«ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã¸åˆ‡ã‚Šæ›¿ãˆã‚‹ã€‚

```
$ ip a
ipã‚¢ãƒ‰ãƒ¬ã‚¹ãŒä»˜ä¸ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã€‚
$ su -
$ apt install --no-install-recommends openssh-server
```

ä»–ã®ãƒ›ã‚¹ãƒˆã‹ã‚‰ssh æ¥ç¶šã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã€‚
æ¥ç¶šã§ããŸã‚‰ã€VNCãƒ“ãƒ¥ãƒ¼ã‚¢ã¯é–‰ã˜ã¦ã‚ˆã„ã€‚


