---
title: "NATã®ç·´ç¿’"
emoji: "ğŸ§±"
type: "tech"
topics: ["cisco", "ccna", "dynamips", "dynagen", "vpcs"]
published: true
---


# æœ¬ã‚¨ãƒ³ãƒˆãƒªã«ã¤ã„ã¦

Dynagenã€Dynamipsã€vpcs ã‚’ä½¿ã£ã¦ã€NATè¨­å®šã®ç·´ç¿’ã‚’ã—ã¾ã™ã€‚
Dynagenã€Dynamipsã€vpcs ã®åˆ©ç”¨ç’°å¢ƒã¯ã™ã§ã«æ•´ã£ã¦ã„ã‚‹ã‚‚ã®ã¨ã—ã¾ã™ã€‚

## å‚è€ƒã‚µã‚¤ãƒˆ

https://www.infraexpert.com/study/ip10.html

# ç’°å¢ƒã«ã¤ã„ã¦

ç·´ç¿’ã‚’ã™ã‚‹ç’°å¢ƒã®åŸºæœ¬çš„ãªæ§‹æˆã¯ä¸‹è¨˜ã®é€šã‚Šã§ã™ã€‚

```mermaid
architecture-beta
    group internal(cloud)[internal]
    group external(cloud)[external]

    service r1(internet)[r1] in internal
    service r2(internet)[r2] in external
    service pc1(server)[pc1] in internal
    service pc2(server)[pc2] in internal
    service pc3(server)[pc3] in internal
    service pc4(server)[pc4] in internal
    service server(server)[server] in external

    junction hub1 in internal
    junction hub1p1 in internal
    junction hub1p2 in internal
    junction hub1p3 in internal
    junction hub1p4 in internal

    server:R -- L:r2
    r1:L -- R:r2
    r1:R -- L:hub1
    hub1:R -- L:hub1p1
    hub1p1:B -- T:hub1p2
    hub1p2:B -- T:hub1p3
    hub1p3:B -- T:hub1p4
    hub1p1:R -- L:pc1
    hub1p2:R -- L:pc2
    hub1p3:R -- L:pc3
    hub1p4:R -- L:pc4
```

| device | interface | ip address | network address | comment |
| --- | ----  | ---           | --- | --- |
| pc1 | -     | 10.2.0.1/24   | 10.2.0.0 | NATã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ |
| pc2 | -     | 10.2.0.65/24  |^ |^ |
| pc3 | -     | 10.2.0.129/24 |^ |^ |
| pc4 | -     | 10.2.0.193/24 |^ |^ |
| r1  | fe0/0 | 10.2.0.254/24 |^ | NATãƒ«ãƒ¼ã‚¿(å†…éƒ¨ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹) | 
|^    | fe0/1 | 10.2.1.253/24 | 10.2.1.0 | åŒ(å¤–éƒ¨ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹) | 
| r2  | fe0/0 | 10.2.1.254/24 |^ |  |
|^    | fe0/1 | 10.2.2.253/24 | 10.2.2.0 |  |
| server | -  | 10.2.2.1/24   |^  | å¤–éƒ¨ã®ã‚µãƒ¼ãƒ |

Dynagen ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸»è¦ãªéƒ¨åˆ†ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```:Dynagen è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«æŠœç²‹
autostart = False
[localhost:7200]
    [[3725]]
        ram = 160
        image = ã‚¤ãƒ¡ãƒ¼ã‚¸å
        idlepc = 0xxxxxxxxx
        sparsemem = True
        ghostios = True
    [[ROUTER r1]]
        model = 3725
        console = 2001
        f0/0 = sw1 5
        f0/1 = r2 f0/0
    [[ROUTER r2]]
        model = 3725
        console = 2002
        f0/1 = sw1 7
    [[ETHSW sw1]]
        1 = access 1 NIO_udp:30000:127.0.0.1:20000
        2 = access 1 NIO_udp:30001:127.0.0.1:20001
        3 = access 1 NIO_udp:30002:127.0.0.1:20002
        4 = access 1 NIO_udp:30003:127.0.0.1:20003
        5 = access 1
        6 = access 2 NIO_udp:30004:127.0.0.1:20004
        7 = access 2
```

## NAT ãƒ«ãƒ¼ã‚¿

r1 ã‚’ NAT ãƒ«ãƒ¼ã‚¿ã¨ã—ã¾ã™ã€‚
fe0/0 (10.2.0.254/24) ãŒå†…éƒ¨ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã€fe0/1 (10.2.1.253/24) ãŒå¤–éƒ¨ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã§ã™ã€‚
fe0/1 ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã¿ OSPF ã§ä¼æ’­ã—ã¾ã™ã€‚fe0/0 ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ OSPF ã«æµã—ã¾ã›ã‚“ã€‚

r1 åŸºæœ¬è¨­å®š

```
conf t
hostname r1
int fa0/0
ip addr 10.2.0.254 255.255.255.0
no shut
int fa0/1
ip addr 10.2.1.253 255.255.255.0
no shut
router ospf 1
network 10.2.1.0 0.0.0.255 area 0
```

è¨­å®šå¾Œã®çŠ¶æ³

```
#show ip int bri
Interface                  IP-Address      OK? Method Status                Protocol
FastEthernet0/0            10.2.0.254      YES NVRAM  up                    up
FastEthernet0/1            10.2.1.253      YES manual up                    up

#show ip route
Codes: C - connected, S - static, R - RIP, M - mobile, B - BGP
       D - EIGRP, EX - EIGRP external, O - OSPF, IA - OSPF inter area
       N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2
       E1 - OSPF external type 1, E2 - OSPF external type 2
       i - IS-IS, su - IS-IS summary, L1 - IS-IS level-1, L2 - IS-IS level-2
       ia - IS-IS inter area, * - candidate default, U - per-user static route
       o - ODR, P - periodic downloaded static route

Gateway of last resort is not set

     10.0.0.0/24 is subnetted, 3 subnets
C       10.2.0.0 is directly connected, FastEthernet0/0
C       10.2.1.0 is directly connected, FastEthernet0/1
O       10.2.2.0 [110/20] via 10.2.1.254, 00:01:06, FastEthernet0/1
```

## å¤–éƒ¨ã®ãƒ«ãƒ¼ã‚¿

r2 ã‚’å¤–éƒ¨ã®ãƒ«ãƒ¼ã‚¿ã¨ã—ã¾ã™ã€‚
fe0/0 (10.2.1.254/24) ã‚’ r1 ã® fe0/1 ã«æ¥ç¶šã—ã¾ã™ã€‚
fe0/1 (10.2.2.253/24) ã¯ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¨­å®šã—ã€NAT ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®é€šä¿¡å…ˆã¨ã—ã¾ã™ã€‚
fe0/0ã€fe0/1 ä¸¡æ–¹ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã€OSPFã«æµã—ã¾ã™ã€‚

r2 åŸºæœ¬è¨­å®š

```
conf t
hostname r2
int fa0/0
ip addr 10.2.1.254 255.255.255.0
no shut
int fa0/1
ip addr 10.2.2.253 255.255.255.0
no shut
router ospf 1
network 10.2.1.0 0.0.0.255 area 0
network 10.2.2.0 0.0.0.255 area 0
```

è¨­å®šå¾Œã®çŠ¶æ³

```
#show ip int bri
Interface                  IP-Address      OK? Method Status                Protocol
FastEthernet0/0            10.2.1.254      YES manual up                    up
FastEthernet0/1            10.2.2.253      YES manual up                    up

#show ip route
Codes: C - connected, S - static, R - RIP, M - mobile, B - BGP
       D - EIGRP, EX - EIGRP external, O - OSPF, IA - OSPF inter area
       N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2
       E1 - OSPF external type 1, E2 - OSPF external type 2
       i - IS-IS, su - IS-IS summary, L1 - IS-IS level-1, L2 - IS-IS level-2
       ia - IS-IS inter area, * - candidate default, U - per-user static route
       o - ODR, P - periodic downloaded static route

Gateway of last resort is not set

     10.0.0.0/24 is subnetted, 2 subnets
C       10.2.1.0 is directly connected, FastEthernet0/0
C       10.2.2.0 is directly connected, FastEthernet0/1
```

## ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿

ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒãƒ¼ãƒ‰ã¨ã—ã¦vpcs ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚
ä»•çµ„ã¿ãªã©ã®èª¬æ˜ã«ã¤ã„ã¦ã¯å‰²æ„›ã—ã¾ã™ã€‚

VPC1âˆ’ï¼”ã‚’NAT å¯¾è±¡ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã—ã¾ã™ã€‚ãƒãƒ–ã‚’ä»‹ã—ã¦ã€r1 ã® fe0/0 ã«æ¥ç¶šã—ã¾ã™ã€‚
VPC5ã‚’ã‚µãƒ¼ãƒã¨ã—ã€r2 ã® fe0/1 ã«æ¥ç¶šã—ã¾ã™ã€‚

| vpc | pc | addr/mask | gateway |
| --- | ---- | ---- | ---- |
| 1   | pc1 | 10.2.0.1/24 | 10.2.0.254 |
| 2   | pc2 | 10.2.0.65/24 | 10.2.0.254 |
| 3   | pc3 | 10.2.0.129/24 | 10.2.0.254 |
| 4   | pc4 | 10.2.0.193/24 | 10.2.0.254 |
| 5   | server | 10.2.2.1/24 | 10.2.2.253 |


```:startup.vpc
1
ip 10.2.0.1 10.2.0.254 24
2
ip 10.2.0.65 10.2.0.254 24
3
ip 10.2.0.129 10.2.0.254 24
4
ip 10.2.0.193 10.2.0.254 24
5
ip 10.2.2.1 10.2.2.253 24
6
7
8
9
1
```

ä¸Šè¨˜ã® startup.vpc ã‚’ç”¨æ„ã—ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã—ã¦ã€vpcs ã‚’èµ·å‹•ã—ã¾ã™ã€‚

```
$ vpcs
```

## è¨­å®šå†…å®¹ã¾ã¨ã‚

- NAT å¯¾è±¡ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ r2 fe0/1 ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«å¯¾ã—ã¦ã€ping ãŒé€šã‚‰ãªã„
(r2 ã¯ 10.2.0.0/24 ã®æƒ…å ±ã‚’çŸ¥ã‚‰ãªã„)
```
r1#ping
Protocol [ip]:
Target IP address: 10.2.2.253
Repeat count [5]:
Datagram size [100]:
Timeout in seconds [2]:
Extended commands [n]: y
Source address or interface: 10.2.0.254
Type of service [0]:
Set DF bit in IP header? [no]:
Validate reply data? [no]:
Data pattern [0xABCD]:
Loose, Strict, Record, Timestamp, Verbose[none]:
Sweep range of sizes [n]:
Type escape sequence to abort.
Sending 5, 100-byte ICMP Echos to 10.2.2.253, timeout is 2 seconds:
Packet sent with a source address of 10.2.0.254
.....
Success rate is 0 percent (0/5)
```

- NAT ãƒ«ãƒ¼ã‚¿ fe0/1 ã‹ã‚‰ r2 fe0/1 ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«å¯¾ã—ã¦ã€ping ãŒé€šã‚‹
```
r1#ping
Protocol [ip]:
Target IP address: 10.2.2.253
Repeat count [5]:
Datagram size [100]:
Timeout in seconds [2]:
Extended commands [n]: y
Source address or interface: 10.2.1.253
Type of service [0]:
Set DF bit in IP header? [no]:
Validate reply data? [no]:
Data pattern [0xABCD]:
Loose, Strict, Record, Timestamp, Verbose[none]:
Sweep range of sizes [n]:
Type escape sequence to abort.
Sending 5, 100-byte ICMP Echos to 10.2.2.253, timeout is 2 seconds:
Packet sent with a source address of 10.2.1.253
!!!!!
Success rate is 100 percent (5/5), round-trip min/avg/max = 4/15/20 ms
```

ã“ã®çŠ¶æ…‹ã‹ã‚‰ã€NATã‚’åˆ©ç”¨ã—ã¦ã€NAT å¯¾è±¡ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ r2 ã® fe0/1 ã« ping åˆ°é”ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã¿ã¾ã™ã€‚

# ã‚¹ã‚¿ãƒ†ã‚£ãƒƒã‚¯NAT

ã‚¹ã‚¿ãƒ†ã‚£ãƒƒã‚¯NATã§ã¯ã€NATå†…éƒ¨ã®ä¸€ã¤ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã€ä¸€ã¤ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¸ã€1å¯¾1ã§å¤‰æ›ã—ã¾ã™ã€‚

https://community.cisco.com/t5/%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%A4%E3%83%B3%E3%83%95%E3%83%A9%E3%82%B9%E3%83%88%E3%83%A9%E3%82%AF%E3%83%81%E3%83%A3-%E3%83%89%E3%82%AD%E3%83%A5%E3%83%A1%E3%83%B3%E3%83%88/static-nat-%E3%81%AE%E8%A8%AD%E5%AE%9A%E4%BE%8B/ta-p/3166358

## 10.2.0.1 ã‚’ 10.2.1.1 ã«å¤‰æ›ã™ã‚‹

fa0/0 ã‚’å†…éƒ¨ã€fa0/1 ã‚’å¤–éƒ¨ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã«è¨­å®šã—ã¾ã™ã€‚
ã‚¹ã‚¿ãƒ†ã‚£ãƒƒã‚¯ NAT ã®è¨­å®šã‚’è¿½åŠ ã—ã¾ã™ã€‚

```
# conf t
(config)# int fa0/0
(config-if)# ip nat inside
(config-if)# int fa0/1
(config-if)# ip nat outside
(config-if)# exit
(config)# ip nat inside source static 10.2.0.1 10.2.1.1
(config)# end
```

è¨­å®šã‚’ç¢ºèªã—ã¾ã™ã€‚
ã‚¹ã‚¿ãƒ†ã‚£ãƒƒã‚¯NAT ã§ã¯è¨­å®šã—ãŸæ™‚ç‚¹ã§ NAT å¤‰æ›ãƒ†ãƒ¼ãƒ–ãƒ«ã«ç™»éŒ²ã•ã‚Œã¾ã™ã€‚

```
# show ip nat statistics
Total active translations: 1 (1 static, 0 dynamic; 0 extended)
Outside interfaces:
  FastEthernet0/1
Inside interfaces:
  FastEthernet0/0
Hits: 0  Misses: 0
CEF Translated packets: 0, CEF Punted packets: 0
Expired translations: 0
Dynamic mappings:
Appl doors: 0
Normal doors: 0
Queued Packets: 0

# show ip nat translations
Pro Inside global      Inside local       Outside local      Outside global
--- 10.2.1.1           10.2.0.1           ---                ---
```

ping ã§ç¢ºèªã—ã¾ã™ã€‚
è¨­å®šã©ãŠã‚Š PC1ã‹ã‚‰ã¯ ping ç–é€šãŒã¨ã‚Œã¦ã€PC4 ã‹ã‚‰ã¯ ping ç–é€šãŒå–ã‚Œãªã„çŠ¶æ³ã§ã™ã€‚

```
VPCS[1]> ping 10.2.2.253
10.2.2.253 icmp_seq=1 timeout
10.2.2.253 icmp_seq=2 ttl=254 time=21.838 ms
10.2.2.253 icmp_seq=3 ttl=254 time=29.193 ms
10.2.2.253 icmp_seq=4 ttl=254 time=27.781 ms
10.2.2.253 icmp_seq=5 ttl=254 time=22.455 ms

VPCS[4]> ping 10.2.2.253
10.2.2.253 icmp_seq=1 timeout
10.2.2.253 icmp_seq=2 timeout
10.2.2.253 icmp_seq=3 timeout
10.2.2.253 icmp_seq=4 timeout
10.2.2.253 icmp_seq=5 timeout
```

ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’å‡ºåŠ›ã™ã‚‹ã¨ã€ä¸‹è¨˜ã®ã‚ˆã†ãªå†…å®¹ã‚’è¦‹ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```
# debug ip nat
IP NAT debugging is on
*Mar  1 00:38:04.131: NAT*: s=10.2.0.1->10.2.1.1, d=10.2.2.253 [3242]
*Mar  1 00:38:04.147: NAT*: s=10.2.2.253, d=10.2.1.1->10.2.0.1 [3242]
*Mar  1 00:38:05.139: NAT*: s=10.2.0.1->10.2.1.1, d=10.2.2.253 [3243]
*Mar  1 00:38:05.171: NAT*: s=10.2.2.253, d=10.2.1.1->10.2.0.1 [3243]
*Mar  1 00:38:06.167: NAT*: s=10.2.0.1->10.2.1.1, d=10.2.2.253 [3244]
*Mar  1 00:38:06.195: NAT*: s=10.2.2.253, d=10.2.1.1->10.2.0.1 [3244]
*Mar  1 00:38:07.203: NAT*: s=10.2.0.1->10.2.1.1, d=10.2.2.253 [3245]
*Mar  1 00:38:07.223: NAT*: s=10.2.2.253, d=10.2.1.1->10.2.0.1 [3245]
*Mar  1 00:38:08.219: NAT*: s=10.2.0.1->10.2.1.1, d=10.2.2.253 [3246]
*Mar  1 00:38:08.247: NAT*: s=10.2.2.253, d=10.2.1.1->10.2.0.1 [3246]
```

NAT å¤‰æ›ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç¢ºèªã—ã¾ã™ã€‚
NAT é€šä¿¡ç›´å¾Œã«ç¢ºèªã™ã‚‹ã¨ã€å¤–éƒ¨ãƒ­ãƒ¼ã‚«ãƒ«ã€å¤–éƒ¨ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¦‹ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```
# show ip nat translations
Pro Inside global      Inside local       Outside local      Outside global
icmp 10.2.1.1:13576    10.2.0.1:13576     10.2.2.253:13576   10.2.2.253:13576
icmp 10.2.1.1:14088    10.2.0.1:14088     10.2.2.253:14088   10.2.2.253:14088
icmp 10.2.1.1:14344    10.2.0.1:14344     10.2.2.253:14344   10.2.2.253:14344
icmp 10.2.1.1:14600    10.2.0.1:14600     10.2.2.253:14600   10.2.2.253:14600
icmp 10.2.1.1:14856    10.2.0.1:14856     10.2.2.253:14856   10.2.2.253:14856
--- 10.2.1.1           10.2.0.1           ---                ---
```

NATå¤–éƒ¨ã‹ã‚‰å†…éƒ¨ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«å¯¾ã—ã¦ ping ã—ã¦ã¿ã¾ã™ã€‚
ã‚¹ã‚¿ãƒ†ã‚£ãƒƒã‚¯ NAT ã§ã¯ã€NAT å¤–éƒ¨ã‹ã‚‰å†…éƒ¨ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«å¯¾ã™ã‚‹ã‚¢ã‚¯ã‚»ã‚¹ã¯ã€NAT å¤‰æ›ã•ã‚Œã¦å†…éƒ¨ãƒ­ãƒ¼ã‚«ãƒ«ã¸åˆ°é”ã—ã¾ã™ã€‚

```
r2#ping
Protocol [ip]:
Target IP address: 10.2.1.1
Repeat count [5]:
Datagram size [100]:
Timeout in seconds [2]:
Extended commands [n]: y
Source address or interface: 10.2.2.253
Type of service [0]:
Set DF bit in IP header? [no]:
Validate reply data? [no]:
Data pattern [0xABCD]:
Loose, Strict, Record, Timestamp, Verbose[none]:
Sweep range of sizes [n]:
Type escape sequence to abort.
Sending 5, 100-byte ICMP Echos to 10.2.1.1, timeout is 2 seconds:
Packet sent with a source address of 10.2.2.253
!!!!!
Success rate is 100 percent (5/5), round-trip min/avg/max = 24/28/32 ms
```

# ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯NAT

ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯NATã§ã¯ã€è¨±å¯ã•ã‚ŒãŸç¯„å›²ã®NATã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã€ãƒ—ãƒ¼ãƒ«ã—ãŸã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«å‹•çš„ã«å‰²ã‚Šå½“ã¦ã¾ã™ã€‚
https://community.cisco.com/t5/%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%A4%E3%83%B3%E3%83%95%E3%83%A9%E3%82%B9%E3%83%88%E3%83%A9%E3%82%AF%E3%83%81%E3%83%A3-%E3%83%89%E3%82%AD%E3%83%A5%E3%83%A1%E3%83%B3%E3%83%88/dynamic-nat-%E3%81%AE%E8%A8%AD%E5%AE%9A%E4%BE%8B/ta-p/3166381

## 10.2.0.1 - 254 ã‚’ 10.2.1.1, 10.2.1.2 ã«å¤‰æ›ã™ã‚‹

NAT ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã—ã¦è¨±å¯ã™ã‚‹ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ç¯„å›²ã‚’ACLã§å®šç¾©ã—ã¾ã™ã€‚

```
# conf t
(config)# access-list 1 permit 10.2.0.0 0.0.0.255
```

NATã®å†…éƒ¨ãƒ»å¤–éƒ¨ã®ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®šç¾©ã—ã¾ã™ã€‚

```
(config)# int fa0/0
(config-if)# ip nat inside
(config-if)# int fa0/1
(config-if)# ip nat outside
(config-if)# exit
```

å†…éƒ¨ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒ—ãƒ¼ãƒ«ã‚’å®šç¾©ã—ã¾ã™ã€‚
ã¾ãŸã€ACLã¨ãƒ—ãƒ¼ãƒ«ã‚’é–¢é€£ã¥ã‘ã¾ã™ã€‚

```
(config)# ip nat pool POOL1 10.2.1.1 10.2.1.2 netmask 255.255.255.0
(config)# ip nat inside source list 1 pool POOL1
(config)# end
```

ä½œæˆã—ãŸã‚¢ã‚¯ã‚»ã‚¹ãƒªã‚¹ãƒˆã¨ã€NAT ã®è¨­å®šã‚’ç¢ºèªã—ã¾ã™ã€‚
ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ NAT ã§ã¯ã€NAT å¤‰æ›ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã¯äº‹å‰ã«å®šç¾©ã•ã‚ŒãŸå†…å®¹ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

```
# show ip access-lists 1
Standard IP access list 1
    10 permit 10.2.0.0, wildcard bits 0.0.0.255

# show ip nat statistics
Total active translations: 0 (0 static, 0 dynamic; 0 extended)
Outside interfaces:
  FastEthernet0/1
Inside interfaces:
  FastEthernet0/0
Hits: 0  Misses: 0
CEF Translated packets: 0, CEF Punted packets: 0
Expired translations: 0
Dynamic mappings:
-- Inside Source
[Id: 1] access-list 1 pool POOL1 refcount 0
 pool POOL1: netmask 255.255.255.0
        start 10.2.1.1 end 10.2.1.2
        type generic, total addresses 2, allocated 0 (0%), misses 0
Appl doors: 0
Normal doors: 0
Queued Packets: 0

# show ip nat translations

```

NAT ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ ping ã—ã¦ã¿ã¾ã™ã€‚
å‹•çš„ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒ2ã¤ã—ã‹ã‚ã‚Šã¾ã›ã‚“ã®ã§ã€æœ€åˆã®2ã¤ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã¯é€šä¿¡ãŒã§ãã¾ã™ãŒã€3ã¤ç›®ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®é€šä¿¡ã¯ NAT å¤‰æ›ã§ããšã«å¤±æ•—ã—ã¾ã™ã€‚

```
VPCS[1]> ping 10.2.2.253
10.2.2.253 icmp_seq=1 ttl=254 time=22.604 ms
10.2.2.253 icmp_seq=2 ttl=254 time=26.894 ms
10.2.2.253 icmp_seq=3 ttl=254 time=29.344 ms
10.2.2.253 icmp_seq=4 ttl=254 time=24.161 ms
10.2.2.253 icmp_seq=5 ttl=254 time=21.384 ms

VPCS[4]> ping 10.2.2.253
10.2.2.253 icmp_seq=1 ttl=254 time=29.479 ms
10.2.2.253 icmp_seq=2 ttl=254 time=28.189 ms
10.2.2.253 icmp_seq=3 ttl=254 time=26.304 ms
10.2.2.253 icmp_seq=4 ttl=254 time=27.765 ms
10.2.2.253 icmp_seq=5 ttl=254 time=23.054 ms

VPCS[2]> ping 10.2.2.253
10.2.2.253 icmp_seq=1 timeout
10.2.2.253 icmp_seq=2 timeout
10.2.2.253 icmp_seq=3 timeout
10.2.2.253 icmp_seq=4 timeout
10.2.2.253 icmp_seq=5 timeout
```

ping å®Ÿè¡Œã—ãŸã¨ãã® debug æƒ…å ±ã§ã™

```
# debug ip nat
*Mar  1 00:19:40.675: NAT*: s=10.2.0.1->10.2.1.1, d=10.2.2.253 [13440]
*Mar  1 00:19:40.687: NAT*: s=10.2.2.253, d=10.2.1.1->10.2.0.1 [13440]
*Mar  1 00:19:41.683: NAT*: s=10.2.0.1->10.2.1.1, d=10.2.2.253 [13441]
*Mar  1 00:19:41.715: NAT*: s=10.2.2.253, d=10.2.1.1->10.2.0.1 [13441]
*Mar  1 00:19:42.707: NAT*: s=10.2.0.1->10.2.1.1, d=10.2.2.253 [13442]
*Mar  1 00:19:42.743: NAT*: s=10.2.2.253, d=10.2.1.1->10.2.0.1 [13442]
*Mar  1 00:19:43.735: NAT*: s=10.2.0.1->10.2.1.1, d=10.2.2.253 [13443]
*Mar  1 00:19:43.771: NAT*: s=10.2.2.253, d=10.2.1.1->10.2.0.1 [13443]
*Mar  1 00:19:44.759: NAT*: s=10.2.0.1->10.2.1.1, d=10.2.2.253 [13444]
*Mar  1 00:19:44.795: NAT*: s=10.2.2.253, d=10.2.1.1->10.2.0.1 [13444]
*Mar  1 00:19:50.659: NAT*: s=10.2.0.193->10.2.1.2, d=10.2.2.253 [13450]
*Mar  1 00:19:50.671: NAT*: s=10.2.2.253, d=10.2.1.2->10.2.0.193 [13450]
*Mar  1 00:19:51.663: NAT*: s=10.2.0.193->10.2.1.2, d=10.2.2.253 [13451]
*Mar  1 00:19:51.699: NAT*: s=10.2.2.253, d=10.2.1.2->10.2.0.193 [13451]
*Mar  1 00:19:52.715: NAT*: s=10.2.0.193->10.2.1.2, d=10.2.2.253 [13452]
*Mar  1 00:19:52.727: NAT*: s=10.2.2.253, d=10.2.1.2->10.2.0.193 [13452]
*Mar  1 00:19:53.727: NAT*: s=10.2.0.193->10.2.1.2, d=10.2.2.253 [13453]
*Mar  1 00:19:53.755: NAT*: s=10.2.2.253, d=10.2.1.2->10.2.0.193 [13453]
*Mar  1 00:19:54.747: NAT*: s=10.2.0.193->10.2.1.2, d=10.2.2.253 [13454]
*Mar  1 00:19:54.779: NAT*: s=10.2.2.253, d=10.2.1.2->10.2.0.193 [13454]
```

NAT å¤‰æ›ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç¢ºèªã—ã¾ã™ã€‚

```
# show ip nat translations
Pro Inside global      Inside local       Outside local      Outside global
icmp 10.2.1.1:32820    10.2.0.1:32820     10.2.2.253:32820   10.2.2.253:32820
icmp 10.2.1.1:33076    10.2.0.1:33076     10.2.2.253:33076   10.2.2.253:33076
icmp 10.2.1.1:33332    10.2.0.1:33332     10.2.2.253:33332   10.2.2.253:33332
icmp 10.2.1.1:33588    10.2.0.1:33588     10.2.2.253:33588   10.2.2.253:33588
icmp 10.2.1.1:33844    10.2.0.1:33844     10.2.2.253:33844   10.2.2.253:33844
--- 10.2.1.1           10.2.0.1           ---                ---
icmp 10.2.1.2:35380    10.2.0.193:35380   10.2.2.253:35380   10.2.2.253:35380
icmp 10.2.1.2:35636    10.2.0.193:35636   10.2.2.253:35636   10.2.2.253:35636
icmp 10.2.1.2:35892    10.2.0.193:35892   10.2.2.253:35892   10.2.2.253:35892
icmp 10.2.1.2:36148    10.2.0.193:36148   10.2.2.253:36148   10.2.2.253:36148
icmp 10.2.1.2:36404    10.2.0.193:36404   10.2.2.253:36404   10.2.2.253:36404
--- 10.2.1.2           10.2.0.193         ---                ---

# show ip nat statistics
Total active translations: 12 (0 static, 12 dynamic; 10 extended)
Outside interfaces:
  FastEthernet0/1
Inside interfaces:
  FastEthernet0/0
Hits: 66  Misses: 0
CEF Translated packets: 66, CEF Punted packets: 0
Expired translations: 25
Dynamic mappings:
-- Inside Source
[Id: 1] access-list 1 pool POOL1 refcount 12
 pool POOL1: netmask 255.255.255.0
        start 10.2.1.1 end 10.2.1.2
        type generic, total addresses 2, allocated 2 (100%), misses 5
Appl doors: 0
Normal doors: 0
Queued Packets: 0
```

ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯NATã§ã¯ã€å¤–éƒ¨ã‹ã‚‰å†…éƒ¨ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¸ã® ping ã¯é€šã‚Šã¾ã›ã‚“ã€‚

```
r2#ping
Protocol [ip]:
Target IP address: 10.2.0.1
Repeat count [5]:
Datagram size [100]:
Timeout in seconds [2]:
Extended commands [n]: y
Source address or interface: 10.2.2.253
Type of service [0]:
Set DF bit in IP header? [no]:
Validate reply data? [no]:
Data pattern [0xABCD]:
Loose, Strict, Record, Timestamp, Verbose[none]:
Sweep range of sizes [n]:
Type escape sequence to abort.
Sending 5, 100-byte ICMP Echos to 10.2.0.1, timeout is 2 seconds:
Packet sent with a source address of 10.2.2.253
.....
Success rate is 0 percent (0/5)
```

ä¸‹è¨˜ã§ã€NAT å¤‰æ›ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰Šé™¤ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```
# show ip nat translations
Pro Inside global      Inside local       Outside local      Outside global
--- 10.2.1.1           10.2.0.1           ---                ---
--- 10.2.1.2           10.2.0.193         ---                ---

#clear ip nat translation *
```

# ãƒãƒ¼ãƒˆå¤‰æ›

ãƒãƒ¼ãƒˆå¤‰æ›ã§ã¯ã€è¨±å¯ã•ã‚ŒãŸç¯„å›²ã®è¤‡æ•°ã®NATã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã€å˜ä¸€ã¤ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«å¤‰æ›ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

https://community.cisco.com/t5/%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%A4%E3%83%B3%E3%83%95%E3%83%A9%E3%82%B9%E3%83%88%E3%83%A9%E3%82%AF%E3%83%81%E3%83%A3-%E3%83%89%E3%82%AD%E3%83%A5%E3%83%A1%E3%83%B3%E3%83%88/nat-overload-%E3%81%AE%E8%A8%AD%E5%AE%9A%E4%BE%8B/ta-p/3166386

## 10.2.0.1 - 129 ã‚’ 10.2.1.1 ã«å¤‰æ›ã™ã‚‹

NAT ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã—ã¦è¨±å¯ã™ã‚‹ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ç¯„å›²ã‚’ACLã§å®šç¾©ã—ã¾ã™ã€‚

```
# conf t
(config)# access-list 2 permit 10.2.0.0 0.0.0.127
```

NATã®å†…éƒ¨ãƒ»å¤–éƒ¨ã®ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®šç¾©ã—ã¾ã™ã€‚

```
(config)# int fa0/0
(config-if)# ip nat inside
(config-if)# int fa0/1
(config-if)# ip nat outside
(config-if)# exit
```

å†…éƒ¨ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒ—ãƒ¼ãƒ«ã‚’å®šç¾©ã—ã¾ã™ã€‚
ACLã¨ãƒ—ãƒ¼ãƒ«ã‚’é–¢é€£ã¥ã‘ã‚‹ã¨ãã«ã€overload ã‚’æŒ‡å®šã—ã¾ã™ã€‚

```
(config)# ip nat pool POOL2 10.2.1.1 10.2.1.1 netmask 255.255.255.0
(config)# ip nat inside source list 2 pool POOL2 overload
(config)# end
```

ä½œæˆã—ãŸã‚¢ã‚¯ã‚»ã‚¹ãƒªã‚¹ãƒˆã¨ã€NAT ã®è¨­å®šã‚’ç¢ºèªã—ã¾ã™ã€‚
PATã«ãŠã„ã¦ã‚‚ã€NAT å¤‰æ›ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã¯äº‹å‰ã«å®šç¾©ã•ã‚ŒãŸå†…å®¹ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

```
# show ip access-lists 2
Standard IP access list 2
    10 permit 10.2.0.0, wildcard bits 0.0.0.127

# show ip nat statistics
Total active translations: 0 (0 static, 0 dynamic; 0 extended)
Outside interfaces:
  FastEthernet0/1
Inside interfaces:
  FastEthernet0/0
Hits: 95  Misses: 0
CEF Translated packets: 95, CEF Punted packets: 0
Expired translations: 50
Dynamic mappings:
-- Inside Source
[Id: 2] access-list 2 pool POOL2 refcount 0
 pool POOL2: netmask 255.255.255.0
        start 10.2.1.1 end 10.2.1.1
        type generic, total addresses 1, allocated 0 (0%), misses 0
Appl doors: 0
Normal doors: 0
Queued Packets: 0

# show ip nat translations

```

NAT ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ ping ã—ã¦ã¿ã¾ã™ã€‚
vpcs ã® ping ã§ã¯ä¸‹è¨˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒä½¿ãˆã¾ã™ã€‚
ã“ã“ã§ã¯ 22/tcp ã¸ ping ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

```
VPCS[1]> ping

ping <host> [-options]
  Ping the network <host>. <host> can be an ip address or name
    options:
     -1             ICMP mode, default
     -2             UDP mode
     -3             TCP mode
     -P <protocol>  Same as above, setting ip protocol
                    1 - icmp, 17 - udp, 6 - tcp
     -c <count>     packet count, default 5
     -l <size>      data size
     -T <ttl>       set TTL, default 64
     -s <port>      source port
     -p <port>      destination port
     -f <flag>      tcp head flag, |C|E|U|A|P|R|S|F|
                              bits |7 6 5 4 3 2 1 0|
     -t             send packet until interrupt by Ctrl+C
     -i <ms>        wait <ms> milliseconds between sending each packet
     -w <ms>        wait <ms> milliseconds to receive the response

  Note: 1. Using names requires DNS to be set.
        2. Use Ctrl+C to stop the command.
```

ACLã§è¨±å¯ã•ã‚ŒãŸç¯„å›²ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã¯é€šä¿¡ãŒã§ãã¾ã™ãŒã€ç¯„å›²å¤–ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®é€šä¿¡ã¯ NAT å¤‰æ›ã§ããšã«å¤±æ•—ã—ã¾ã™ã€‚

```
VPCS[1]> ping 10.2.2.253 -P 6 -p 22
Connect   22@10.2.2.253 RST returned
Connect   22@10.2.2.253 RST returned
Connect   22@10.2.2.253 RST returned
Connect   22@10.2.2.253 RST returned
Connect   22@10.2.2.253 RST returned

VPCS[2]> ping 10.2.2.253 -P 6 -p 22
Connect   22@10.2.2.253 RST returned
Connect   22@10.2.2.253 RST returned
Connect   22@10.2.2.253 RST returned
Connect   22@10.2.2.253 RST returned
Connect   22@10.2.2.253 RST returned

VPCS[3]> ping 10.2.2.253 -P 6 -p 22
Connect   22@10.2.2.253 timeout
Connect   22@10.2.2.253 timeout
Connect   22@10.2.2.253 timeout
Connect   22@10.2.2.253 timeout
Connect   22@10.2.2.253 timeout

```

ping å®Ÿè¡Œã—ãŸã¨ãã® debug æƒ…å ±ã§ã™
è¤‡æ•°ã®å†…éƒ¨ãƒ­ãƒ¼ã‚«ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒã€å˜ä¸€ã®å†…éƒ¨ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«NATå¤‰æ›ã•ã‚Œã¦ã€å¤–éƒ¨ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨é€šä¿¡ã—ã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

```
r1#debug ip nat
IP NAT debugging is on
*Mar  1 01:55:53.655: NAT*: s=10.2.0.1->10.2.1.1, d=10.2.2.253 [22307]
*Mar  1 01:55:54.635: NAT*: s=10.2.0.1->10.2.1.1, d=10.2.2.253 [22308]
*Mar  1 01:55:54.671: NAT*: s=10.2.2.253, d=10.2.1.1->10.2.0.1 [42925]
*Mar  1 01:55:55.663: NAT*: s=10.2.0.1->10.2.1.1, d=10.2.2.253 [22309]
*Mar  1 01:55:55.695: NAT*: s=10.2.2.253, d=10.2.1.1->10.2.0.1 [59152]
*Mar  1 01:55:56.687: NAT*: s=10.2.0.1->10.2.1.1, d=10.2.2.253 [22310]
*Mar  1 01:55:56.723: NAT*: s=10.2.2.253, d=10.2.1.1->10.2.0.1 [15252]
*Mar  1 01:55:57.719: NAT*: s=10.2.0.1->10.2.1.1, d=10.2.2.253 [22311]
*Mar  1 01:55:57.751: NAT*: s=10.2.2.253, d=10.2.1.1->10.2.0.1 [58811]
*Mar  1 01:55:58.747: NAT*: s=10.2.0.1->10.2.1.1, d=10.2.2.253 [22312]
*Mar  1 01:55:58.779: NAT*: s=10.2.2.253, d=10.2.1.1->10.2.0.1 [63120]
*Mar  1 01:56:07.135: NAT*: s=10.2.0.65->10.2.1.1, d=10.2.2.253 [22320]
*Mar  1 01:56:08.111: NAT*: s=10.2.0.65->10.2.1.1, d=10.2.2.253 [22321]
*Mar  1 01:56:08.151: NAT*: s=10.2.2.253, d=10.2.1.1->10.2.0.65 [40865]
*Mar  1 01:56:09.159: NAT*: s=10.2.0.65->10.2.1.1, d=10.2.2.253 [22322]
*Mar  1 01:56:09.179: NAT*: s=10.2.2.253, d=10.2.1.1->10.2.0.65 [33067]
*Mar  1 01:56:10.175: NAT*: s=10.2.0.65->10.2.1.1, d=10.2.2.253 [22323]
*Mar  1 01:56:10.215: NAT*: s=10.2.2.253, d=10.2.1.1->10.2.0.65 [18963]
*Mar  1 01:56:11.227: NAT*: s=10.2.0.65->10.2.1.1, d=10.2.2.253 [22324]
*Mar  1 01:56:11.239: NAT*: s=10.2.2.253, d=10.2.1.1->10.2.0.65 [7669]
*Mar  1 01:56:12.235: NAT*: s=10.2.0.65->10.2.1.1, d=10.2.2.253 [22325]
*Mar  1 01:56:12.271: NAT*: s=10.2.2.253, d=10.2.1.1->10.2.0.65 [17451]
```

NAT å¤‰æ›ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç¢ºèªã—ã¾ã™ã€‚
å†…éƒ¨ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒãƒ¼ãƒˆç•ªå·ãŒã€å†…éƒ¨ãƒ­ãƒ¼ã‚«ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã”ã¨ã«ç•°ãªã£ã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

```
# show ip nat translations
Pro Inside global      Inside local       Outside local      Outside global
tcp 10.2.1.1:1593      10.2.0.1:1593      10.2.2.253:22      10.2.2.253:22
tcp 10.2.1.1:6338      10.2.0.65:6338     10.2.2.253:22      10.2.2.253:22

# show ip nat statistics
Total active translations: 2 (0 static, 2 dynamic; 2 extended)
Outside interfaces:
  FastEthernet0/1
Inside interfaces:
  FastEthernet0/0
Hits: 167  Misses: 0
CEF Translated packets: 136, CEF Punted packets: 22
Expired translations: 55
Dynamic mappings:
-- Inside Source
[Id: 3] access-list 2 pool POOL2 refcount 2
 pool POOL2: netmask 255.255.255.0
        start 10.2.1.1 end 10.2.1.1
        type generic, total addresses 1, allocated 1 (100%), misses 0
Appl doors: 0
Normal doors: 0
Queued Packets: 0
```

# ã¾ã¨ã‚

ä»¥ä¸Šã€Dynagenã€Dynamipsã€vpcs ã‚’ä½¿ã£ãŸ NATè¨­å®šã®ç·´ç¿’ã«ã¤ã„ã¦è¨˜è¼‰ã—ã¾ã—ãŸã€‚
NAT ã¯ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã®åŸºæœ¬çš„ãªæ©Ÿèƒ½ã®ä¸€ã¤ã§ã€èº«è¿‘ãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æŠ€è¡“ã®ä¸€ã¤ã§ã™ã€‚
ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«èˆˆå‘³ã‚’æŒã¡å‹‰å¼·ã‚’å§‹ã‚ã‚‹ãŸã‚ã®æ‰‹ãŒã‹ã‚Šã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚
