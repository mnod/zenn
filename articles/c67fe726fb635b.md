---
title: "Debian11 ã§ Open vSwitch"
emoji: "ğŸƒ"
type: "tech"
topics: ["debian", "openvswitch"]
published: true
---

# ç’°å¢ƒã«ã¤ã„ã¦

ä¸‹è¨˜ã®Debian11ã®ç’°å¢ƒã§ã€Open vSwitch ã‚’è¨­å®šã—ã¦ã¿ã¾ã™ã€‚

```
root@web1:~# uname -a
Linux web1 5.10.0-21-amd64 #1 SMP Debian 5.10.162-1 (2023-01-21) x86_64 GNU/Linux
root@web1:~#
root@web1:~# cat /etc/os-release
PRETTY_NAME="Debian GNU/Linux 11 (bullseye)"
NAME="Debian GNU/Linux"
VERSION_ID="11"
VERSION="11 (bullseye)"
VERSION_CODENAME=bullseye
ID=debian
HOME_URL="https://www.debian.org/"
SUPPORT_URL="https://www.debian.org/support"
BUG_REPORT_URL="https://bugs.debian.org/"
root@web1:~#
```

# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚³ãƒãƒ³ãƒ‰

ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’åˆ©ç”¨ã—ã¦ã€apt ä¸€ç™ºã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```
root@web1:~# apt install --no-install-recommends openvswitch-switch
```

`ovs-vsctl show` ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€ã‚¨ãƒ©ãƒ¼ã«ãªã‚‰ãªã„ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

```
root@web1:~# ovs-vsctl show
537967ba-2d48-46f4-9ab8-bb3116153289
    ovs_version: "2.15.0"
root@web1:~#
```

# ä»®æƒ³ãƒ–ãƒªãƒƒã‚¸ã®ä½œæˆ

OVSã®ä»®æƒ³ãƒ–ãƒªãƒƒã‚¸ã‚’ä½œæˆã—ã¾ã™ã€‚
```
root@web1:~# ovs-vsctl add-br ovsbr0
root@web1:~#
root@web1:~# ovs-vsctl show
537967ba-2d48-46f4-9ab8-bb3116153289
    Bridge ovsbr0
        Port ovsbr0
            Interface ovsbr0
                type: internal
    ovs_version: "2.15.0"
root@web1:~#
root@web1:~# ip link show ovsbr0
5: ovsbr0: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000
    link/ether 6e:2c:2d:f0:08:4b brd ff:ff:ff:ff:ff:ff
root@web1:~#
```

Linuxã®æ¨™æº–ã®ä»®æƒ³ãƒ–ãƒªãƒƒã‚¸ã¨åŒæ§˜ã€ä¸‹è¨˜ã§ãƒªãƒ³ã‚¯ã‚¢ãƒƒãƒ—ã•ã›ã¾ã™ã€‚
```
root@web1:~# ip link set ovsbr0 up
root@web1:~#
root@web1:~# ip link show ovsbr0
5: ovsbr0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000
    link/ether 6e:2c:2d:f0:08:4b brd ff:ff:ff:ff:ff:ff
root@web1:~#
```

# IPã‚¢ãƒ‰ãƒ¬ã‚¹ã®å‰²ã‚Šå½“ã¦

ip ã‚³ãƒãƒ³ãƒ‰ã§ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å‰²ã‚Šå½“ã¦ã¾ã™ã€‚
```
root@web1:~# ip address add 10.2.0.201/24 brd + dev ovsbr0
root@web1:~# ip addr show ovsbr0
5: ovsbr0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UNKNOWN group default qlen 1000
    link/ether 6e:2c:2d:f0:08:4b brd ff:ff:ff:ff:ff:ff
    inet 10.2.0.201/24 brd 10.2.0.255 scope global ovsbr0
       valid_lft forever preferred_lft forever
    inet6 fe80::6c2c:2dff:fef0:84b/64 scope link
       valid_lft forever preferred_lft forever
```

ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨­å®šã‚‚ã€åŒæ§˜ã« ip ã‚³ãƒãƒ³ãƒ‰ã§è¿½åŠ ã—ã¾ã™ã€‚
```
root@web1:~# ip route add 10.2.0.0/16 dev ovsbr0
root@web1:~# ip route show 10.2.0.0/16
10.2.0.0/16 dev ovsbr0 scope link
```

# tap ãƒ‡ãƒã‚¤ã‚¹ã®è¿½åŠ 

ip ã‚³ãƒãƒ³ãƒ‰ã§ tap ãƒ‡ãƒã‚¤ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚
```
root@web1:~# ip tuntap add dev tap0 mode tap
root@web1:~#
root@web1:~# ip link show tap0
6: tap0: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000
    link/ether ca:b3:cb:fb:1d:92 brd ff:ff:ff:ff:ff:ff
root@web1:~#
```

ä½œæˆã—ãŸ tap ãƒ‡ãƒã‚¤ã‚¹ã‚’ã€ä»®æƒ³ãƒ–ãƒªãƒƒã‚¸ã«è¿½åŠ ã—ã¾ã™ã€‚
```
root@web1:~# ovs-vsctl add-port ovsbr0 tap0
root@web1:~#
root@web1:~# ovs-vsctl show
537967ba-2d48-46f4-9ab8-bb3116153289
    Bridge ovsbr0
        Port ovsbr0
            Interface ovsbr0
                type: internal
        Port tap0
            Interface tap0
    ovs_version: "2.15.0"
root@web1:~#
```

tap ãƒ‡ãƒã‚¤ã‚¹ã‚’ãƒªãƒ³ã‚¯ã‚¢ãƒƒãƒ—ã•ã›ã¾ã™ã€‚
```
root@web1:~# ip link set tap0 up
root@web1:~#
root@web1:~# ip link show tap0
6: tap0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc pfifo_fast master ovs-system state DOWN mode DEFAULT group default qlen 1000
    link/ether ca:b3:cb:fb:1d:92 brd ff:ff:ff:ff:ff:ff
root@web1:~#
```

# VLANè¨­å®š

## æ—¢å­˜ã®ãƒãƒ¼ãƒˆã¸VLANè¨­å®šè¿½åŠ 

è¿½åŠ ã—ãŸ tap0 ãƒãƒ¼ãƒˆã«ã€VLANã®è¨­å®šã‚’è¿½åŠ ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```
root@web1:~# ovs-vsctl set port tap0 tag=9
root@web1:~#
root@web1:~# ovs-vsctl show
537967ba-2d48-46f4-9ab8-bb3116153289
    Bridge ovsbr0
        Port ovsbr0
            Interface ovsbr0
                type: internal
        Port tap0
            tag: 9
            Interface tap0
    ovs_version: "2.15.0"
root@web1:~#
```

## ãƒãƒ¼ãƒˆæ–°è¦ä½œæˆæ™‚ã«è¨­å®š

tapãƒ‡ãƒã‚¤ã‚¹ã‚’è¿½åŠ ã™ã‚‹ã¨ãã«ã€æœ€åˆã‹ã‚‰VLANã®è¨­å®šã‚’æ–½ã™ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

```
root@web1:~# ip tuntap add dev tap1 mode tap
root@web1:~# ovs-vsctl add-port ovsbr0 tap1 tag=9
root@web1:~# ovs-vsctl show
537967ba-2d48-46f4-9ab8-bb3116153289
    Bridge ovsbr0
        Port ovsbr0
            Interface ovsbr0
                type: internal
        Port tap0
            tag: 9
            Interface tap0
        Port tap1
            tag: 9
            Interface tap1
    ovs_version: "2.15.0"
root@web1:~#
```

è¿½åŠ ã—ãŸtapãƒ‡ãƒã‚¤ã‚¹ã‚’ãƒªãƒ³ã‚¯ã‚¢ãƒƒãƒ—ã•ã›ã¾ã™ã€‚
```
root@web1:~# ip link set tap1 up
root@web1:~# ip link show tap1
7: tap1: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc pfifo_fast master ovs-system state DOWN mode DEFAULT group default qlen 1000
    link/ether 92:11:56:24:be:70 brd ff:ff:ff:ff:ff:ff
root@web1:~#
```

# OSãƒªãƒ–ãƒ¼ãƒˆå¾Œã®çŠ¶æ…‹

ã“ã“ã¾ã§ã®è¨­å®šã‚’çµ‚ãˆãŸçŠ¶æ…‹ã§ã€OSã‚’ãƒªãƒ–ãƒ¼ãƒˆã™ã‚‹ã¨ã©ã®ã‚ˆã†ãªçŠ¶æ…‹ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚

ä»®æƒ³ãƒ–ãƒªãƒƒã‚¸ã®ãƒªãƒ³ã‚¯ã¯ãƒ€ã‚¦ãƒ³ã—ã¦ã„ã¾ã™ã€‚ã¾ãŸã€å‰²ã‚Šå½“ã¦ãŸIPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚‚ç„¡ããªã£ã¦ã„ã¾ã™ã€‚
```
user@web1:~$ ip link show ovsbr0
5: ovsbr0: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000
    link/ether 6e:2c:2d:f0:08:4b brd ff:ff:ff:ff:ff:ff
user@web1:~$
user@web1:~$ ip addr show ovsbr0
5: ovsbr0: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN group default qlen 1000
    link/ether 6e:2c:2d:f0:08:4b brd ff:ff:ff:ff:ff:ff
user@web1:~$
```

ä»®æƒ³ãƒ–ãƒªãƒƒã‚¸ã«tapãƒ‡ãƒã‚¤ã‚¹ã‚’å‰²ã‚Šå½“ã¦ãŸæƒ…å ±ã¯æ®‹ã£ã¦ã„ã¾ã™ãŒã€tap ãƒ‡ãƒã‚¤ã‚¹è‡ªä½“ãŒç„¡ããªã£ã¦ã„ã¾ã™ã€‚
```
root@web1:~# ovs-vsctl show
537967ba-2d48-46f4-9ab8-bb3116153289
    Bridge ovsbr0
        Port ovsbr0
            Interface ovsbr0
                type: internal
        Port tap0
            tag: 9
            Interface tap0
                error: "could not open network device tap0 (No such device)"
        Port tap1
            tag: 9
            Interface tap1
                error: "could not open network device tap1 (No such device)"
    ovs_version: "2.15.0"
root@web1:~#
```

# å¾Œç‰‡ä»˜ã‘

ä»®æƒ³ãƒ–ãƒªãƒƒã‚¸ã¸ã® tap ãƒ‡ãƒã‚¤ã‚¹ã®å‰²ã‚Šå½“ã¦ã‚’è§£é™¤ã—ã¾ã™ã€‚
```
root@web1:~# ovs-vsctl del-port ovsbr0 tap1
root@web1:~# ovs-vsctl del-port ovsbr0 tap0
root@web1:~# ovs-vsctl show
537967ba-2d48-46f4-9ab8-bb3116153289
    Bridge ovsbr0
        Port ovsbr0
            Interface ovsbr0
                type: internal
    ovs_version: "2.15.0"
root@web1:~#
```

ä»®æƒ³ãƒ–ãƒªãƒƒã‚¸ã‚’å‰Šé™¤ã—ã¾ã™ã€‚
```
root@web1:~# ovs-vsctl del-br ovsbr0
root@web1:~# ovs-vsctl show
537967ba-2d48-46f4-9ab8-bb3116153289
    ovs_version: "2.15.0"
```


# æ°¸ç¶šåŒ–

ä»®æƒ³ãƒ–ãƒªãƒƒã‚¸ã®æ°¸ç¶šåŒ–ã¯ã€ `/etc/network/interfaces` ã«è¨˜è¼‰ã—ã¾ã™ã€‚

```
root@web1:~# cp -pi /etc/network/interfaces /etc/network/interfaces.000
root@web1:~# vi /etc/network/interfaces
root@web1:~# grep -E -v '^$|^#' /etc/network/interfaces
source /etc/network/interfaces.d/*
auto lo
iface lo inet loopback
auto ovsbr0
allow-ovs ovsbr0
iface ovsbr0 inet static
        ovs_type OVSBridge
        ovs_ports ens4
        address 10.2.0.242/24
        gateway 10.2.0.1
        dns-nameservers 192.168.11.249
allow-ovsbr0 ens4
iface ens4 inet manual
        ovs_bridge ovsbr0
        ovs_type OVSPort
```

:::message
Debian10 ã§ã¯ `auto ovsbr0` ã®è¡Œã¯ä¸è¦ã§ã—ãŸã€‚
Debian11 ã§ã¯ `auto ovsbr0` ã®è¡ŒãŒãªã„ã¨ã€ä»®æƒ³ãƒ–ãƒªãƒƒã‚¸ãŒä½œæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚
:::


è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¨˜è¼‰ã—ãŸã‚‰ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’å†èµ·å‹•ã—ã¾ã™ã€‚
(ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®è¨­å®šã‚’å¤‰æ›´ã™ã‚‹ã®ã§ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ã®ç¢ºä¿ã‚’å¼·ããŠå‹§ã‚ã—ã¾ã™ã€‚)
```
root@debian:~# systemctl restart networking
```

:::message
è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¨˜è¼‰å¾Œã€ `ifup --allow=ovs ovsbr0` ã‚³ãƒãƒ³ãƒ‰ã§ã€ovsbr0 ã‚’ä½œæˆã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
:::
