---
title: "STPの高速化機能の練習"
emoji: "🌳"
type: "tech"
topics: ["cisco", "ccna", "dynamips", "dynagen", "stp"]
published: true
---

#  本エントリについて

Dynagen、Dynamips を使って、STP の高速化機能を練習します。
Dynagen、Dynamips の利用環境はすでに整っているものとします。

## 参考

https://www.infraexpert.com/study/stpz7.html

## 環境について

sw01 sw02 sw11 間で、trunk ポート同士を接続して、STP の動作を確認します。
sw01 sw02 間は fa1/15 同士で接続、sw11 の fa1/14、fa1/15 からそれぞれsw01 sw02 の fa1/0 へ接続します。
```
    [[ROUTER sw01]]
        model = 3725
        slot1 = NM-16ESW
        f1/0 = sw11 f1/14
        f1/15 = sw02 f1/15
    [[ROUTER sw02]]
        model = 3725
        slot1 = NM-16ESW
        f1/0 = sw11 f1/15
        f1/15 = sw01 f1/15
    [[ROUTER sw11]]
        model = 3725
        slot1 = NM-16ESW
        f1/0 = nio_tap:tap0
        f1/1 = NIO_udp:30000:127.0.0.1:20000
        f1/4 = NIO_udp:30001:127.0.0.1:20001
        f1/5 = NIO_udp:30002:127.0.0.1:20002
        f1/14 = sw01 f1/0
        f1/15 = sw02 f1/0
```

# 基本設定

設定手順は割愛します。
sw01 の trunk インタフェースの設定の確認
```
sw01#show int trunk

Port      Mode         Encapsulation  Status        Native vlan
Fa1/0     on           802.1q         trunking      1
Fa1/15    on           802.1q         trunking      1

Port      Vlans allowed on trunk
Fa1/0     1-4094
Fa1/15    1-4094

Port      Vlans allowed and active in management domain
Fa1/0     1,10-11
Fa1/15    1,10-11

Port      Vlans in spanning tree forwarding state and not pruned
Fa1/0     1,10-11
Fa1/15    1,10-11

sw01#show int status

Port    Name               Status       Vlan       Duplex Speed Type
Fa1/0                      connected    trunk      a-full   a-100 10/100BaseTX
Fa1/1                      notconnect   1            auto    auto 10/100BaseTX
Fa1/2                      notconnect   1            auto    auto 10/100BaseTX
Fa1/3                      notconnect   1            auto    auto 10/100BaseTX
Fa1/4                      notconnect   1            auto    auto 10/100BaseTX
Fa1/5                      notconnect   1            auto    auto 10/100BaseTX
Fa1/6                      notconnect   1            auto    auto 10/100BaseTX
Fa1/7                      notconnect   1            auto    auto 10/100BaseTX
Fa1/8                      notconnect   1            auto    auto 10/100BaseTX
Fa1/9                      notconnect   1            auto    auto 10/100BaseTX
Fa1/10                     notconnect   1            auto    auto 10/100BaseTX
Fa1/11                     notconnect   1            auto    auto 10/100BaseTX
Fa1/12                     notconnect   1            auto    auto 10/100BaseTX
Fa1/13                     notconnect   1            auto    auto 10/100BaseTX
Fa1/14                     notconnect   1            auto    auto 10/100BaseTX
Fa1/15                     connected    trunk      a-full   a-100 10/100BaseTX
```

sw02 の trunk インタフェースの設定の確認
```
sw02#show int trunk

Port      Mode         Encapsulation  Status        Native vlan
Fa1/0     on           802.1q         trunking      1
Fa1/15    on           802.1q         trunking      1

Port      Vlans allowed on trunk
Fa1/0     1-4094
Fa1/15    1-4094

Port      Vlans allowed and active in management domain
Fa1/0     1,10-11
Fa1/15    1,10-11

Port      Vlans in spanning tree forwarding state and not pruned
Fa1/0     1,10-11
Fa1/15    1,10-11

sw02#show int status

Port    Name               Status       Vlan       Duplex Speed Type
Fa1/0                      connected    trunk      a-full   a-100 10/100BaseTX
Fa1/1                      notconnect   1            auto    auto 10/100BaseTX
Fa1/2                      notconnect   1            auto    auto 10/100BaseTX
Fa1/3                      notconnect   1            auto    auto 10/100BaseTX
Fa1/4                      notconnect   1            auto    auto 10/100BaseTX
Fa1/5                      notconnect   1            auto    auto 10/100BaseTX
Fa1/6                      notconnect   1            auto    auto 10/100BaseTX
Fa1/7                      notconnect   1            auto    auto 10/100BaseTX
Fa1/8                      notconnect   1            auto    auto 10/100BaseTX
Fa1/9                      notconnect   1            auto    auto 10/100BaseTX
Fa1/10                     notconnect   1            auto    auto 10/100BaseTX
Fa1/11                     notconnect   1            auto    auto 10/100BaseTX
Fa1/12                     notconnect   1            auto    auto 10/100BaseTX
Fa1/13                     notconnect   1            auto    auto 10/100BaseTX
Fa1/14                     notconnect   1            auto    auto 10/100BaseTX
Fa1/15                     connected    trunk      a-full   a-100 10/100BaseTX
```

sw11 の trunk インタフェースの設定の確認
```
sw11#show int trunk

Port      Mode         Encapsulation  Status        Native vlan
Fa1/14    on           802.1q         trunking      1
Fa1/15    on           802.1q         trunking      1

Port      Vlans allowed on trunk
Fa1/14    1-4094
Fa1/15    1-4094

Port      Vlans allowed and active in management domain
Fa1/14    1,10-11
Fa1/15    1,10-11

Port      Vlans in spanning tree forwarding state and not pruned
Fa1/14    none
Fa1/15    none

sw11#show int status

Port    Name               Status       Vlan       Duplex Speed Type
Fa1/0                      connected    1          a-full   a-100 10/100BaseTX
Fa1/1                      connected    1          a-full   a-100 10/100BaseTX
Fa1/2                      notconnect   1            auto    auto 10/100BaseTX
Fa1/3                      notconnect   1            auto    auto 10/100BaseTX
Fa1/4                      connected    1          a-full   a-100 10/100BaseTX
Fa1/5                      connected    1          a-full   a-100 10/100BaseTX
Fa1/6                      notconnect   1            auto    auto 10/100BaseTX
Fa1/7                      notconnect   1            auto    auto 10/100BaseTX
Fa1/8                      notconnect   1            auto    auto 10/100BaseTX
Fa1/9                      notconnect   1            auto    auto 10/100BaseTX
Fa1/10                     notconnect   1            auto    auto 10/100BaseTX
Fa1/11                     notconnect   1            auto    auto 10/100BaseTX
Fa1/12                     notconnect   1            auto    auto 10/100BaseTX
Fa1/13                     notconnect   1            auto    auto 10/100BaseTX
Fa1/14                     connected    trunk      a-full   a-100 10/100BaseTX
Fa1/15                     connected    trunk      a-full   a-100 10/100BaseTX
```

## STP の設定

sw01と、sw02で下記の設定がされています。
```
sw01(config)#spanning-tree vlan 10 root primary
% This switch is already the root of VLAN10 spanning tree
 VLAN 10 bridge priority set to 8192
 VLAN 10 bridge max aging time unchanged at 20
 VLAN 10 bridge hello time unchanged at 2
 VLAN 10 bridge forward delay unchanged at 15

sw01(config)#spanning-tree vlan 11 root secondary
 VLAN 11 bridge priority set to 16384
 VLAN 11 bridge max aging time unchanged at 20
 VLAN 11 bridge hello time unchanged at 2
 VLAN 11 bridge forward delay unchanged at 15
```

```
sw02(config)#spanning-tree vlan 10 root secondary
 VLAN 10 bridge priority set to 16384
 VLAN 10 bridge max aging time unchanged at 20
 VLAN 10 bridge hello time unchanged at 2
 VLAN 10 bridge forward delay unchanged at 15

sw02(config)#spanning-tree vlan 11 root primary
 VLAN 11 bridge priority set to 8192
 VLAN 11 bridge max aging time unchanged at 20
 VLAN 11 bridge hello time unchanged at 2
 VLAN 11 bridge forward delay unchanged at 15
```

sw01 の STPの状態の確認
```
sw01#show spanning-tree summary                                                                                                                                                                                                      [20/442]
Root bridge for: VLAN1, VLAN10.
PortFast BPDU Guard is disabled
UplinkFast is disabled
BackboneFast is disabled

Name                 Blocking Listening Learning Forwarding STP Active
-------------------- -------- --------- -------- ---------- ----------
VLAN1                0        0         0        2          2
VLAN10               0        0         0        2          2
VLAN11               0        0         0        2          2
-------------------- -------- --------- -------- ---------- ----------
             3 VLANs 0        0         0        6          6

sw01#show spanning-tree brief

VLAN1
  Spanning tree enabled protocol ieee
  Root ID    Priority    32768
             Address     c200.04e3.0000
             This bridge is the root
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec

  Bridge ID  Priority    32768
             Address     c200.04e3.0000
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec
             Aging Time 300

Interface                                   Designated
Name                 Port ID Prio Cost  Sts Cost  Bridge ID            Port ID
-------------------- ------- ---- ----- --- ----- -------------------- -------
FastEthernet1/0      128.41   128    19 FWD     0 32768 c200.04e3.0000 128.41
FastEthernet1/15     128.56   128    19 FWD     0 32768 c200.04e3.0000 128.56


VLAN10
  Spanning tree enabled protocol ieee
  Root ID    Priority    8192
             Address     c200.04e3.0001
             This bridge is the root
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec

  Bridge ID  Priority    8192
             Address     c200.04e3.0001
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec
             Aging Time 300

Interface                                   Designated
Name                 Port ID Prio Cost  Sts Cost  Bridge ID            Port ID
-------------------- ------- ---- ----- --- ----- -------------------- -------
FastEthernet1/0      128.41   128    19 FWD     0  8192 c200.04e3.0001 128.41
FastEthernet1/15     128.56   128    19 FWD     0  8192 c200.04e3.0001 128.56


VLAN11
  Spanning tree enabled protocol ieee
  Root ID    Priority    8192
             Address     c201.04e3.0002
             Cost        19
             Port        56 (FastEthernet1/15)
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec

  Bridge ID  Priority    16384
             Address     c200.04e3.0002
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec
             Aging Time 300

Interface                                   Designated
Name                 Port ID Prio Cost  Sts Cost  Bridge ID            Port ID
-------------------- ------- ---- ----- --- ----- -------------------- -------
FastEthernet1/0      128.41   128    19 FWD    19 16384 c200.04e3.0002 128.41
FastEthernet1/15     128.56   128    19 FWD     0  8192 c201.04e3.0002 128.56

```

sw02 の STPの状態の確認
```
sw02#show spanning-tree summary                                                                                                                                                                                                      [21/328]
Root bridge for: VLAN11.
PortFast BPDU Guard is disabled
UplinkFast is disabled
BackboneFast is disabled

Name                 Blocking Listening Learning Forwarding STP Active
-------------------- -------- --------- -------- ---------- ----------
VLAN1                0        0         0        2          2
VLAN10               0        0         0        2          2
VLAN11               0        0         0        2          2
-------------------- -------- --------- -------- ---------- ----------
             3 VLANs 0        0         0        6          6

sw02#show spanning-tree brief

VLAN1
  Spanning tree enabled protocol ieee
  Root ID    Priority    32768
             Address     c200.04e3.0000
             Cost        19
             Port        56 (FastEthernet1/15)
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec

  Bridge ID  Priority    32768
             Address     c201.04e3.0000
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec
             Aging Time 300

Interface                                   Designated
Name                 Port ID Prio Cost  Sts Cost  Bridge ID            Port ID
-------------------- ------- ---- ----- --- ----- -------------------- -------
FastEthernet1/0      128.41   128    19 FWD    19 32768 c201.04e3.0000 128.41
FastEthernet1/15     128.56   128    19 FWD     0 32768 c200.04e3.0000 128.56


VLAN10
  Spanning tree enabled protocol ieee
  Root ID    Priority    8192
             Address     c200.04e3.0001
             Cost        19
             Port        56 (FastEthernet1/15)
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec

  Bridge ID  Priority    16384
             Address     c201.04e3.0001
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec
             Aging Time 300

Interface                                   Designated
Name                 Port ID Prio Cost  Sts Cost  Bridge ID            Port ID
-------------------- ------- ---- ----- --- ----- -------------------- -------
FastEthernet1/0      128.41   128    19 FWD    19 16384 c201.04e3.0001 128.41
FastEthernet1/15     128.56   128    19 FWD     0  8192 c200.04e3.0001 128.56


VLAN11
  Spanning tree enabled protocol ieee
  Root ID    Priority    8192
             Address     c201.04e3.0002
             This bridge is the root
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec

  Bridge ID  Priority    8192
             Address     c201.04e3.0002
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec
             Aging Time 300

Interface                                   Designated
Name                 Port ID Prio Cost  Sts Cost  Bridge ID            Port ID
-------------------- ------- ---- ----- --- ----- -------------------- -------
FastEthernet1/0      128.41   128    19 FWD     0  8192 c201.04e3.0002 128.41
FastEthernet1/15     128.56   128    19 FWD     0  8192 c201.04e3.0002 128.56

```

sw11 の STPの状態の確認
```
sw11#show spanning-tree summary
Root bridge for: none.
PortFast BPDU Guard is disabled
UplinkFast is disabled
BackboneFast is disabled

Name                 Blocking Listening Learning Forwarding STP Active
-------------------- -------- --------- -------- ---------- ----------
VLAN1                1        0         0        5          6
VLAN10               1        0         0        1          2
VLAN11               1        0         0        1          2
-------------------- -------- --------- -------- ---------- ----------
             3 VLANs 3        0         0        7          10

sw11#show spanning-tree brief

VLAN1
  Spanning tree enabled protocol ieee
  Root ID    Priority    32768
             Address     c200.04e3.0000
             Cost        19
             Port        55 (FastEthernet1/14)
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec

  Bridge ID  Priority    32768
             Address     c202.04e3.0000
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec
             Aging Time 300

Interface                                   Designated
Name                 Port ID Prio Cost  Sts Cost  Bridge ID            Port ID
-------------------- ------- ---- ----- --- ----- -------------------- -------
FastEthernet1/0      128.41   128    19 FWD    19 32768 c202.04e3.0000 128.41
FastEthernet1/1      128.42   128    19 FWD    19 32768 c202.04e3.0000 128.42
FastEthernet1/4      128.45   128    19 FWD    19 32768 c202.04e3.0000 128.45
FastEthernet1/5      128.46   128    19 FWD    19 32768 c202.04e3.0000 128.46
FastEthernet1/14     128.55   128    19 FWD     0 32768 c200.04e3.0000 128.41
FastEthernet1/15     128.56   128    19 BLK    19 32768 c201.04e3.0000 128.41


VLAN10
  Spanning tree enabled protocol ieee
  Root ID    Priority    8192
             Address     c200.04e3.0001
             Cost        19
             Port        55 (FastEthernet1/14)
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec

  Bridge ID  Priority    32768
             Address     c202.04e3.0001
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec
             Aging Time 300

Interface                                   Designated
Name                 Port ID Prio Cost  Sts Cost  Bridge ID            Port ID
-------------------- ------- ---- ----- --- ----- -------------------- -------
FastEthernet1/14     128.55   128    19 FWD     0  8192 c200.04e3.0001 128.41
FastEthernet1/15     128.56   128    19 BLK    19 16384 c201.04e3.0001 128.41


VLAN11
  Spanning tree enabled protocol ieee
  Root ID    Priority    8192
             Address     c201.04e3.0002
             Cost        19
             Port        56 (FastEthernet1/15)
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec

  Bridge ID  Priority    32768
             Address     c202.04e3.0002
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec
             Aging Time 300

Interface                                   Designated
Name                 Port ID Prio Cost  Sts Cost  Bridge ID            Port ID
-------------------- ------- ---- ----- --- ----- -------------------- -------
FastEthernet1/14     128.55   128    19 BLK    19 16384 c200.04e3.0002 128.41
FastEthernet1/15     128.56   128    19 FWD     0  8192 c201.04e3.0002 128.41

```

なお、各デバイスで `debug spann events` を設定してあります。

# portfast の設定

## 未設定時

portfast を設定していない状態で、アクセスポートを shut/no shut したときの STPのイベントの様子です。
shut/no shut でトポロジーチェンジを送信しています。
no shut するときに、通常の listening → learning → forwarding という遷移をしています。
```
sw11(config)#int fa1/5
sw11(config-if)#shut
*Mar  1 00:25:02.215: STP: VLAN1 sent Topology Change Notice on Fa1/14
*Mar  1 00:25:02.263: STP: VLAN1 Fa1/5 -> blocking

sw11(config-if)#no shut
*Mar  1 00:30:18.555: STP: VLAN1 Fa1/5 -> listening
*Mar  1 00:30:33.559: STP: VLAN1 Fa1/5 -> learning
*Mar  1 00:30:48.583: STP: VLAN1 sent Topology Change Notice on Fa1/14
*Mar  1 00:30:48.583: STP: VLAN1 Fa1/5 -> forwarding
```

sw01 で トポロジーチェンジを受信しました。
```
sw01#
*Mar  1 00:38:14.331: STP: VLAN1 Topology Change rcvd on Fa1/0
*Mar  1 00:44:00.663: STP: VLAN1 Topology Change rcvd on Fa1/0
```

## 設定時

`portfast` を有効にしてみます。

```
sw11(config)#int range fa1/0 - 7
sw11(config-if-range)#spanning-tree portfast
```

設定したインタフェース分、下記メッセージが表示されます。
```
%Warning: portfast should only be enabled on ports connected to a single host.
 Connecting hubs, concentrators, switches,  bridges, etc.to this interface
 when portfast is enabled, can cause temporary spanning tree loops.
 Use with CAUTION

%Portfast has been configured on FastEthernet1/0 but will only
 have effect when the interface is in a non-trunking mode.
%Warning: portfast should only be enabled on ports connected to a single host.
 Connecting hubs, concentrators, switches,  bridges, etc.to this interface
 when portfast is enabled, can cause temporary spanning tree loops.
 Use with CAUTION
```

実際に、shut/no shut してみます。
トポロジーチェンジは発生しません。
no shut の際、通常のポート状態の遷移をせず、一気に forwarding になりました。
```
sw11(config-if-range)#int fa1/5
sw11(config-if)#shut
*Mar  1 00:35:43.259: STP: VLAN1 Fa1/5 -> blocking

sw11(config-if)#no shut
*Mar  1 00:36:50.171: STP: VLAN1 Fa1/5 ->jump to forwarding from blocking
```

なお、portfast が有効かどうかは下記で確認することができます。
```
sw11#show spanning-tree vlan 1 | section FastEthernet1/5
          from FastEthernet1/5
 Port 46 (FastEthernet1/5) of VLAN1 is forwarding
   Port path cost 19, Port priority 128, Port Identifier 128.46.
   Designated root has priority 32768, address c200.04e3.0000
   Designated bridge has priority 32768, address c202.04e3.0000
   Designated port id is 128.46, designated path cost 19
   Timers: message age 0, forward delay 0, hold 0
   Number of transitions to forwarding state: 1
   BPDU: sent 51, received 0
   The port is in the portfast mode

```

# uplink fast


## 未設定時

uplink fast を設定していないときの STP のイベントの様子です。
dynagen でルートポートの接続を解除します。
```
=> conf
=>(config)hypervisor 127.0.0.1:7200
=>(config-127.0.0.1:7200)router sw11
=>(config-127.0.0.1:7200-router sw11)no f1/14 = sw01 f1/0
```

sw11のSTPのイベントの様子です。
VLAN1 f1/15 が Forwarding に切り替わるまで、30秒ほどかかりました。
```
sw11#
*Mar  1 00:42:43.047: STP: VLAN11 Fa1/14 -> listening
*Mar  1 00:42:44.695: STP: VLAN1 new root port Fa1/15, cost 38
*Mar  1 00:42:44.699: STP: VLAN1 Fa1/15 -> listening
*Mar  1 00:42:44.711: STP: VLAN10 new root port Fa1/15, cost 38
*Mar  1 00:42:44.731: STP: VLAN10 Fa1/15 -> listening
*Mar  1 00:42:58.051: STP: VLAN11 Fa1/14 -> learning
*Mar  1 00:42:59.727: STP: VLAN1 Fa1/15 -> learning
*Mar  1 00:42:59.747: STP: VLAN10 Fa1/15 -> learning
*Mar  1 00:43:13.059: STP: VLAN11 sent Topology Change Notice on Fa1/15
*Mar  1 00:43:13.059: STP: VLAN11 Fa1/14 -> forwarding
*Mar  1 00:43:14.743: STP: VLAN1 sent Topology Change Notice on Fa1/15
*Mar  1 00:43:14.743: STP: VLAN1 Fa1/15 -> forwarding
*Mar  1 00:43:14.755: STP: VLAN10 sent Topology Change Notice on Fa1/15
*Mar  1 00:43:14.755: STP: VLAN10 Fa1/15 -> forwarding

sw11#show spanning-tree vlan 1 brief

VLAN1
  Spanning tree enabled protocol ieee
  Root ID    Priority    32768
             Address     c200.04e3.0000
             Cost        38
             Port        56 (FastEthernet1/15)
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec

  Bridge ID  Priority    32768
             Address     c202.04e3.0000
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec
             Aging Time 300

Interface                                   Designated
Name                 Port ID Prio Cost  Sts Cost  Bridge ID            Port ID
-------------------- ------- ---- ----- --- ----- -------------------- -------
FastEthernet1/0      128.41   128    19 FWD    38 32768 c202.04e3.0000 128.41
FastEthernet1/1      128.42   128    19 FWD    38 32768 c202.04e3.0000 128.42
FastEthernet1/4      128.45   128    19 FWD    38 32768 c202.04e3.0000 128.45
FastEthernet1/5      128.46   128    19 FWD    38 32768 c202.04e3.0000 128.46
FastEthernet1/14     128.55   128    19 FWD    38 32768 c202.04e3.0000 128.55
FastEthernet1/15     128.56   128    19 FWD    19 32768 c201.04e3.0000 128.41

```

```
sw01#
*Mar  1 00:56:26.867: STP: VLAN1 Topology Change rcvd on Fa1/15
*Mar  1 00:56:26.879: STP: VLAN10 Topology Change rcvd on Fa1/15
```

```
sw02#
*Mar  1 00:45:25.447: STP: VLAN11 Topology Change rcvd on Fa1/0
*Mar  1 00:45:27.151: STP: VLAN1 Topology Change rcvd on Fa1/0
*Mar  1 00:45:27.155: STP: VLAN1 sent Topology Change Notice on Fa1/15
*Mar  1 00:45:27.171: STP: VLAN10 Topology Change rcvd on Fa1/0
*Mar  1 00:45:27.175: STP: VLAN10 sent Topology Change Notice on Fa1/15
```


接続を戻します。
```
=>(config-127.0.0.1:7200-router sw11)f1/14 = sw01 f1/0
```

```
sw11#
*Mar  1 00:47:42.923: STP: VLAN10 new root port Fa1/14, cost 19
*Mar  1 00:47:42.927: STP: VLAN10 sent Topology Change Notice on Fa1/14
*Mar  1 00:47:42.931: STP: VLAN10 Fa1/15 -> blocking
*Mar  1 00:47:44.279: STP: VLAN11 sent Topology Change Notice on Fa1/15
*Mar  1 00:47:44.283: STP: VLAN11 Fa1/14 -> blocking
*Mar  1 00:47:44.895: STP: VLAN1 new root port Fa1/14, cost 19
*Mar  1 00:47:44.899: STP: VLAN1 sent Topology Change Notice on Fa1/14
*Mar  1 00:47:44.915: STP: VLAN1 Fa1/15 -> blocking

sw11#show spanning-tree vlan 1 brief

VLAN1
  Spanning tree enabled protocol ieee
  Root ID    Priority    32768
             Address     c200.04e3.0000
             Cost        19
             Port        55 (FastEthernet1/14)
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec

  Bridge ID  Priority    32768
             Address     c202.04e3.0000
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec
             Aging Time 300

Interface                                   Designated
Name                 Port ID Prio Cost  Sts Cost  Bridge ID            Port ID
-------------------- ------- ---- ----- --- ----- -------------------- -------
FastEthernet1/0      128.41   128    19 FWD    19 32768 c202.04e3.0000 128.41
FastEthernet1/1      128.42   128    19 FWD    19 32768 c202.04e3.0000 128.42
FastEthernet1/4      128.45   128    19 FWD    19 32768 c202.04e3.0000 128.45
FastEthernet1/5      128.46   128    19 FWD    19 32768 c202.04e3.0000 128.46
FastEthernet1/14     128.55   128    19 FWD     0 32768 c200.04e3.0000 128.41
FastEthernet1/15     128.56   128    19 BLK    19 32768 c201.04e3.0000 128.41

```

```
sw01#
*Mar  1 01:00:55.027: STP: VLAN10 Topology Change rcvd on Fa1/0
*Mar  1 01:00:57.011: STP: VLAN1 Topology Change rcvd on Fa1/0
```

```
sw02#
*Mar  1 00:49:56.683: STP: VLAN11 Topology Change rcvd on Fa1/0
```

## 設定時

uplinkfast を設定します。
次のメッセージが表示されます。
```
sw11#conf t
sw11(config)#spanning-tree uplinkfast
*Mar  1 00:50:26.191: STP: VLAN1 new root port Fa1/15, cost 38
*Mar  1 00:50:26.191: STP: VLAN1 sent Topology Change Notice on Fa1/15
*Mar  1 00:50:26.195: STP: VLAN1 Fa1/14 -> blocking
*Mar  1 00:50:26.195: %SPANTREE_FAST-7-PORT_FWD_UPLINK: VLAN1 FastEthernet1/15 moved to Forwarding (UplinkFast).
*Mar  1 00:50:26.195: STP: VLAN1 new root port Fa1/14, cost 3019
*Mar  1 00:50:26.195: STP: VLAN10 new root port Fa1/15, cost 38
*Mar  1 00:50:26.195: STP: VLAN10 sent Topology Change Notice on Fa1/15
*Mar  1 00:50:26.199: STP: VLAN10 Fa1/14 -> blocking
*Mar  1 00:50:26.199: STP: VLAN10 new root port Fa1/14, cost 3019
*Mar  1 00:50:28.191: STP: VLAN1 sent Topology Change Notice on Fa1/14
*Mar  1 00:50:28.195: STP: VLAN10 sent Topology Change Notice on Fa1/14

sw11(config)#do show spanning-tree vlan 1 brief

VLAN1
  Spanning tree enabled protocol ieee uplinkfast enabled
  Root ID    Priority    32768
             Address     c200.04e3.0000
             Cost        3019
             Port        55 (FastEthernet1/14)
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec

  Bridge ID  Priority    49152
             Address     c202.04e3.0000
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec
             Aging Time 300

Interface                                   Designated
Name                 Port ID Prio Cost  Sts Cost  Bridge ID            Port ID
-------------------- ------- ---- ----- --- ----- -------------------- -------
FastEthernet1/0      128.41   128  3019 FWD  3019 49152 c202.04e3.0000 128.41
FastEthernet1/1      128.42   128  3019 FWD  3019 49152 c202.04e3.0000 128.42
FastEthernet1/4      128.45   128  3019 FWD  3019 49152 c202.04e3.0000 128.45
FastEthernet1/5      128.46   128  3019 FWD  3019 49152 c202.04e3.0000 128.46
FastEthernet1/14     128.55   128  3019 FWD     0 32768 c200.04e3.0000 128.41
FastEthernet1/15     128.56   128  3019 BLK    19 32768 c201.04e3.0000 128.41

```

:::message
https://www.cisco.com/c/ja_jp/support/docs/lan-switching/spanning-tree-protocol/10575-51.html より
- スイッチのブリッジの優先度がデフォルトよりも著しく高い値に増やされます。これにより、そのスイッチはルート ブリッジとして選ばれなくなります。ルート ブリッジはルート ポートを持ちません（すべてのポートが指定されます）。
- スイッチにあるすべてのポートで、コストが 3000 だけ増やされます。これにより、スイッチポートが指定ポートとして選択される可能性が低くなります。
:::

sw01、sw02 でトポロジーチェンジを受信しています。
```
sw01#
*Mar  1 01:03:38.307: STP: VLAN1 Topology Change rcvd on Fa1/15
*Mar  1 01:03:38.331: STP: VLAN10 Topology Change rcvd on Fa1/15
*Mar  1 01:03:40.287: STP: VLAN1 Topology Change rcvd on Fa1/0
*Mar  1 01:03:40.307: STP: VLAN10 Topology Change rcvd on Fa1/0
```

```
sw02#
*Mar  1 00:52:38.595: STP: VLAN1 Topology Change rcvd on Fa1/0
*Mar  1 00:52:38.599: STP: VLAN1 sent Topology Change Notice on Fa1/15
*Mar  1 00:52:38.611: STP: VLAN10 Topology Change rcvd on Fa1/0
*Mar  1 00:52:38.615: STP: VLAN10 sent Topology Change Notice on Fa1/15
```

sw11 のルートポートの接続を解除してみます。
```
=>(config-127.0.0.1:7200-router sw11)no f1/14 = sw01 f1/0
```

VLAN1 f1/15 はほぼ即時で Forwarding に切り替わりました。
```
sw11#
*Mar  1 00:54:07.135: STP: VLAN1 new root port Fa1/15, cost 3038
*Mar  1 00:54:07.155: %SPANTREE_FAST-7-PORT_FWD_UPLINK: VLAN1 FastEthernet1/15 moved to Forwarding (UplinkFast).
*Mar  1 00:54:07.155: STP: VLAN1 sent Topology Change Notice on Fa1/15
*Mar  1 00:54:07.187: STP: VLAN10 new root port Fa1/15, cost 3038
*Mar  1 00:54:07.187: STP: VLAN10 sent Topology Change Notice on Fa1/15
*Mar  1 00:54:07.199: STP: VLAN1 Fa1/14 -> listening
*Mar  1 00:54:07.215: STP: VLAN10 Fa1/14 -> listening
*Mar  1 00:54:07.547: STP: VLAN11 Fa1/14 -> listening
*Mar  1 00:54:22.199: STP: VLAN1 Fa1/14 -> learning
*Mar  1 00:54:22.231: STP: VLAN10 Fa1/14 -> learning
*Mar  1 00:54:22.547: STP: VLAN11 Fa1/14 -> learning
*Mar  1 00:54:37.207: STP: VLAN1 sent Topology Change Notice on Fa1/15
*Mar  1 00:54:37.207: STP: VLAN1 Fa1/14 -> forwarding
*Mar  1 00:54:37.231: STP: VLAN10 sent Topology Change Notice on Fa1/15
*Mar  1 00:54:37.231: STP: VLAN10 Fa1/14 -> forwarding
*Mar  1 00:54:37.567: STP: VLAN11 sent Topology Change Notice on Fa1/15
*Mar  1 00:54:37.567: STP: VLAN11 Fa1/14 -> forwarding

sw11#show spanning-tree summary
Root bridge for: none.
PortFast BPDU Guard is disabled
UplinkFast is enabled
BackboneFast is disabled

Name                 Blocking Listening Learning Forwarding STP Active
-------------------- -------- --------- -------- ---------- ----------
VLAN1                0        0         0        6          6
VLAN10               0        0         0        2          2
VLAN11               0        0         0        2          2
-------------------- -------- --------- -------- ---------- ----------
             3 VLANs 0        0         0        10         10

Station update rate set to 150 packets/sec.

UplinkFast statistics
-----------------------
Number of transitions via uplinkFast (all VLANs)            : 6
Number of proxy multicast addresses transmitted (all VLANs) : 0

sw11#show spanning-tree vlan 1 brief

VLAN1
  Spanning tree enabled protocol ieee uplinkfast enabled
  Root ID    Priority    32768
             Address     c200.04e3.0000
             Cost        3038
             Port        56 (FastEthernet1/15)
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec

  Bridge ID  Priority    49152
             Address     c202.04e3.0000
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec
             Aging Time 300

Interface                                   Designated
Name                 Port ID Prio Cost  Sts Cost  Bridge ID            Port ID
-------------------- ------- ---- ----- --- ----- -------------------- -------
FastEthernet1/0      128.41   128  3019 FWD  3038 49152 c202.04e3.0000 128.41
FastEthernet1/1      128.42   128  3019 FWD  3038 49152 c202.04e3.0000 128.42
FastEthernet1/4      128.45   128  3019 FWD  3038 49152 c202.04e3.0000 128.45
FastEthernet1/5      128.46   128  3019 FWD  3038 49152 c202.04e3.0000 128.46
FastEthernet1/14     128.55   128  3019 FWD  3038 49152 c202.04e3.0000 128.55
FastEthernet1/15     128.56   128  3019 FWD    19 32768 c201.04e3.0000 128.41

```

```
sw01#
*Mar  1 01:07:19.255: STP: VLAN1 Topology Change rcvd on Fa1/15
*Mar  1 01:07:19.287: STP: VLAN10 Topology Change rcvd on Fa1/15
*Mar  1 01:07:49.299: STP: VLAN1 Topology Change rcvd on Fa1/15
*Mar  1 01:07:49.327: STP: VLAN10 Topology Change rcvd on Fa1/15
```

```
sw02#
*Mar  1 00:56:19.551: STP: VLAN1 Topology Change rcvd on Fa1/0
*Mar  1 00:56:19.555: STP: VLAN1 sent Topology Change Notice on Fa1/15
*Mar  1 00:56:19.603: STP: VLAN10 Topology Change rcvd on Fa1/0
*Mar  1 00:56:19.603: STP: VLAN10 sent Topology Change Notice on Fa1/15
*Mar  1 00:56:49.615: STP: VLAN1 Topology Change rcvd on Fa1/0
*Mar  1 00:56:49.615: STP: VLAN1 sent Topology Change Notice on Fa1/15
*Mar  1 00:56:49.639: STP: VLAN10 Topology Change rcvd on Fa1/0
*Mar  1 00:56:49.643: STP: VLAN10 sent Topology Change Notice on Fa1/15
*Mar  1 00:56:49.955: STP: VLAN11 Topology Change rcvd on Fa1/0
```

接続を戻します。
```
=>(config-127.0.0.1:7200-router sw11)f1/14 = sw01 f1/0
```

```
sw11#
*Mar  1 00:58:02.731: STP: VLAN11 sent Topology Change Notice on Fa1/15
*Mar  1 00:58:02.735: STP: VLAN11 Fa1/14 -> blocking
*Mar  1 00:58:03.299: STP: VLAN1 new root port Fa1/14, cost 3019
*Mar  1 00:58:03.303: STP: VLAN1 sent Topology Change Notice on Fa1/14
*Mar  1 00:58:03.319: STP: VLAN1 Fa1/15 -> blocking
*Mar  1 00:58:03.331: STP: VLAN10 new root port Fa1/14, cost 3019
*Mar  1 00:58:03.335: STP: VLAN10 sent Topology Change Notice on Fa1/14
*Mar  1 00:58:03.339: STP: VLAN10 Fa1/15 -> blocking

sw11#show spanning-tree summary
Root bridge for: none.
PortFast BPDU Guard is disabled
UplinkFast is enabled
BackboneFast is disabled

Name                 Blocking Listening Learning Forwarding STP Active
-------------------- -------- --------- -------- ---------- ----------
VLAN1                1        0         0        5          6
VLAN10               1        0         0        1          2
VLAN11               1        0         0        1          2
-------------------- -------- --------- -------- ---------- ----------
             3 VLANs 3        0         0        7          10

Station update rate set to 150 packets/sec.

UplinkFast statistics
-----------------------
Number of transitions via uplinkFast (all VLANs)            : 6
Number of proxy multicast addresses transmitted (all VLANs) : 0

sw11#show spanning-tree vlan 1 brief

VLAN1
  Spanning tree enabled protocol ieee uplinkfast enabled
  Root ID    Priority    32768
             Address     c200.04e3.0000
             Cost        3019
             Port        55 (FastEthernet1/14)
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec

  Bridge ID  Priority    49152
             Address     c202.04e3.0000
             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec
             Aging Time 300

Interface                                   Designated
Name                 Port ID Prio Cost  Sts Cost  Bridge ID            Port ID
-------------------- ------- ---- ----- --- ----- -------------------- -------
FastEthernet1/0      128.41   128  3019 FWD  3019 49152 c202.04e3.0000 128.41
FastEthernet1/1      128.42   128  3019 FWD  3019 49152 c202.04e3.0000 128.42
FastEthernet1/4      128.45   128  3019 FWD  3019 49152 c202.04e3.0000 128.45
FastEthernet1/5      128.46   128  3019 FWD  3019 49152 c202.04e3.0000 128.46
FastEthernet1/14     128.55   128  3019 FWD     0 32768 c200.04e3.0000 128.41
FastEthernet1/15     128.56   128  3019 BLK    19 32768 c201.04e3.0000 128.41

```

```
sw01#
*Mar  1 01:11:15.419: STP: VLAN1 Topology Change rcvd on Fa1/0
*Mar  1 01:11:15.451: STP: VLAN10 Topology Change rcvd on Fa1/0
```
```
sw02#
*Mar  1 01:00:15.135: STP: VLAN11 Topology Change rcvd on Fa1/0
```

# backborn fast

## 未設定時

通常時、backbornのリンク障害時のSTPイベントの様子です。
ここではバックボーン接続をdynagen で解除しています。
```
=>(config-127.0.0.1:7200-router sw11)exit
Exiting...
=>(config-127.0.0.1:7200)router sw01
=>(config-127.0.0.1:7200-router sw01)no f1/15 = sw02 f1/15
```

```
sw01#
*Mar  1 01:15:08.951: STP: VLAN11 we are the spanning tree root
*Mar  1 01:15:08.979: STP: VLAN11 heard root  8192-c201.04e3.0002 on Fa1/0
*Mar  1 01:15:08.983: current Root has 16384-c200.04e3.0002
*Mar  1 01:15:08.983:     supersedes 16384-c200.04e3.0002
*Mar  1 01:15:08.983: STP: VLAN11 new root is 8192, c201.04e3.0002 on port Fa1/0, cost 3038
*Mar  1 01:15:08.983: STP: VLAN11 sent Topology Change Notice on Fa1/0
*Mar  1 01:15:09.655: STP: VLAN10 Topology Change rcvd on Fa1/0
*Mar  1 01:15:09.683: STP: VLAN1 Topology Change rcvd on Fa1/0
*Mar  1 01:15:38.667: STP: VLAN1 Topology Change rcvd on Fa1/0
*Mar  1 01:15:38.691: STP: VLAN10 Topology Change rcvd on Fa1/0
```
```
sw02#
*Mar  1 01:04:09.299: STP: VLAN11 Topology Change rcvd on Fa1/0
*Mar  1 01:04:09.907: STP: VLAN1 we are the spanning tree root
*Mar  1 01:04:09.931: STP: VLAN10 we are the spanning tree root
*Mar  1 01:04:09.935: STP: VLAN10 heard root  8192-c200.04e3.0001 on Fa1/0
*Mar  1 01:04:09.939: current Root has 16384-c201.04e3.0001
*Mar  1 01:04:09.939:     supersedes 16384-c201.04e3.0001
*Mar  1 01:04:09.939: STP: VLAN10 new root is 8192, c200.04e3.0001 on port Fa1/0, cost 3038
*Mar  1 01:04:09.939: STP: VLAN10 sent Topology Change Notice on Fa1/0
*Mar  1 01:04:09.943: STP: VLAN1 heard root 32768-c200.04e3.0000 on Fa1/0
*Mar  1 01:04:09.947: current Root has 32768-c201.04e3.0000
*Mar  1 01:04:09.947:     supersedes 32768-c201.04e3.0000
*Mar  1 01:04:09.947: STP: VLAN1 new root is 32768, c200.04e3.0000 on port Fa1/0, cost 3038
*Mar  1 01:04:09.947: STP: VLAN1 sent Topology Change Notice on Fa1/0
*Mar  1 01:04:38.291: STP: VLAN11 Topology Change rcvd on Fa1/0
```
```
sw11#
*Mar  1 01:01:55.875: STP: VLAN11 Fa1/14 -> listening
*Mar  1 01:01:56.535: STP: VLAN1 Fa1/15 -> listening
*Mar  1 01:01:56.567: STP: VLAN10 Fa1/15 -> listening
*Mar  1 01:01:56.879: STP: VLAN11 heard root 16384-c200.04e3.0002 on Fa1/14
*Mar  1 01:01:56.883: current Root has  8192-c201.04e3.0002
*Mar  1 01:01:56.891: STP: VLAN11 Topology Change rcvd on Fa1/14
*Mar  1 01:01:56.895: STP: VLAN11 sent Topology Change Notice on Fa1/15
*Mar  1 01:01:57.527: STP: VLAN1 heard root 32768-c201.04e3.0000 on Fa1/15
*Mar  1 01:01:57.531: current Root has 32768-c200.04e3.0000
*Mar  1 01:01:57.547: STP: VLAN10 heard root 16384-c201.04e3.0001 on Fa1/15
*Mar  1 01:01:57.547: current Root has  8192-c200.04e3.0001
*Mar  1 01:01:57.559: STP: VLAN10 Topology Change rcvd on Fa1/15
*Mar  1 01:01:57.559: STP: VLAN10 sent Topology Change Notice on Fa1/14
*Mar  1 01:01:57.579: STP: VLAN1 Topology Change rcvd on Fa1/15
*Mar  1 01:01:57.583: STP: VLAN1 sent Topology Change Notice on Fa1/14
*Mar  1 01:02:10.875: STP: VLAN11 Fa1/14 -> learning
*Mar  1 01:02:11.539: STP: VLAN1 Fa1/15 -> learning
*Mar  1 01:02:11.583: STP: VLAN10 Fa1/15 -> learning
*Mar  1 01:02:25.887: STP: VLAN11 sent Topology Change Notice on Fa1/15
*Mar  1 01:02:25.887: STP: VLAN11 Fa1/14 -> forwarding
*Mar  1 01:02:26.559: STP: VLAN1 sent Topology Change Notice on Fa1/14
*Mar  1 01:02:26.559: STP: VLAN1 Fa1/15 -> forwarding
*Mar  1 01:02:26.591: STP: VLAN10 sent Topology Change Notice on Fa1/14
*Mar  1 01:02:26.591: STP: VLAN10 Fa1/15 -> forwarding
```

戻しの様子です。
```
=>(config-127.0.0.1:7200-router sw01)f1/15 = sw02 f1/15
```

```
sw01#
*Mar  1 01:18:11.751: STP: VLAN1 Topology Change rcvd on Fa1/0
*Mar  1 01:18:11.767: STP: VLAN10 Topology Change rcvd on Fa1/0
*Mar  1 01:18:13.095: STP: VLAN11 new root port Fa1/15, cost 19
```
```
sw02#
*Mar  1 01:07:12.007: STP: VLAN1 new root port Fa1/15, cost 19
*Mar  1 01:07:12.055: STP: VLAN10 new root port Fa1/15, cost 19
*Mar  1 01:07:13.435: STP: VLAN11 Topology Change rcvd on Fa1/0
```
```
sw11#
*Mar  1 01:04:59.627: STP: VLAN1 sent Topology Change Notice on Fa1/14
*Mar  1 01:04:59.631: STP: VLAN1 Fa1/15 -> blocking
*Mar  1 01:04:59.643: STP: VLAN10 sent Topology Change Notice on Fa1/14
*Mar  1 01:04:59.663: STP: VLAN10 Fa1/15 -> blocking
*Mar  1 01:05:01.003: STP: VLAN11 sent Topology Change Notice on Fa1/15
*Mar  1 01:05:01.019: STP: VLAN11 Fa1/14 -> blocking
```

## 設定時

backbonefast を設定します。
backbonefast はL2ドメイン内の全てのスイッチで設定する必要があります。

```
sw01#conf t
sw01(config)#spanning-tree backbonefast

sw01#show spanning-tree summary
Root bridge for: VLAN1, VLAN10.
PortFast BPDU Guard is disabled
UplinkFast is disabled
BackboneFast is enabled

Name                 Blocking Listening Learning Forwarding STP Active
-------------------- -------- --------- -------- ---------- ----------
VLAN1                0        0         0        2          2
VLAN10               0        0         0        2          2
VLAN11               0        0         0        2          2
-------------------- -------- --------- -------- ---------- ----------
             3 VLANs 0        0         0        6          6

BackboneFast statistics
-----------------------
Number of transition via backboneFast (all VLANs)           : 0
Number of inferior BPDUs received (all VLANs)               : 0
Number of RLQ request PDUs received (all VLANs)             : 0
Number of RLQ response PDUs received (all VLANs)            : 0
Number of RLQ request PDUs sent (all VLANs)                 : 0
Number of RLQ response PDUs sent (all VLANs)                : 0
```

```
sw02#conf t
sw02(config)#spanning-tree backbonefast

sw02#show spanning-tree summary
Root bridge for: VLAN11.
PortFast BPDU Guard is disabled
UplinkFast is disabled
BackboneFast is enabled

Name                 Blocking Listening Learning Forwarding STP Active
-------------------- -------- --------- -------- ---------- ----------
VLAN1                0        0         0        2          2
VLAN10               0        0         0        2          2
VLAN11               0        0         0        2          2
-------------------- -------- --------- -------- ---------- ----------
             3 VLANs 0        0         0        6          6

BackboneFast statistics
-----------------------
Number of transition via backboneFast (all VLANs)           : 0
Number of inferior BPDUs received (all VLANs)               : 0
Number of RLQ request PDUs received (all VLANs)             : 0
Number of RLQ response PDUs received (all VLANs)            : 0
Number of RLQ request PDUs sent (all VLANs)                 : 0
Number of RLQ response PDUs sent (all VLANs)                : 0

```

```
sw11#conf t
sw11(config)#spanning-tree backbonefast

sw11#show spanning-tree
*Mar  1 01:08:01.555: %SYS-5-CONFIG_I: Configured from console by consolesu
sw11#show spanning-tree summary
Root bridge for: none.
PortFast BPDU Guard is disabled
UplinkFast is enabled
BackboneFast is enabled

Name                 Blocking Listening Learning Forwarding STP Active
-------------------- -------- --------- -------- ---------- ----------
VLAN1                1        0         0        5          6
VLAN10               1        0         0        1          2
VLAN11               1        0         0        1          2
-------------------- -------- --------- -------- ---------- ----------
             3 VLANs 3        0         0        7          10

Station update rate set to 150 packets/sec.

UplinkFast statistics
-----------------------
Number of transitions via uplinkFast (all VLANs)            : 6
Number of proxy multicast addresses transmitted (all VLANs) : 0

BackboneFast statistics
-----------------------
Number of transition via backboneFast (all VLANs)           : 0
Number of inferior BPDUs received (all VLANs)               : 0
Number of RLQ request PDUs received (all VLANs)             : 0
Number of RLQ response PDUs received (all VLANs)            : 0
Number of RLQ request PDUs sent (all VLANs)                 : 0
Number of RLQ response PDUs sent (all VLANs)                : 0

```

バックボーン障害として、sw01 の fa1/15 をshut してみます。
```
sw01(config)#int fa1/15
sw01(config-if)#shut

*Mar  1 01:30:38.027: STP: VLAN1 Fa1/15 -> blocking
*Mar  1 01:30:38.027: STP: VLAN10 Fa1/15 -> blocking
*Mar  1 01:30:38.027: STP: VLAN11 Fa1/15 -> blocking
*Mar  1 01:30:38.027: STP: VLAN11 we are the spanning tree root
*Mar  1 01:30:38.531: %DTP-5-NONTRUNKPORTON: Port Fa1/15 has become non-trunk
*Mar  1 01:30:39.607: STP: VLAN11 heard root  8192-c201.04e3.0002 on Fa1/0
*Mar  1 01:30:39.611: current Root has 16384-c200.04e3.0002
*Mar  1 01:30:39.611:     supersedes 16384-c200.04e3.0002
*Mar  1 01:30:39.615: STP: VLAN11 new root is 8192, c201.04e3.0002 on port Fa1/0, cost 3038
*Mar  1 01:30:39.619: STP: VLAN11 sent Topology Change Notice on Fa1/0
*Mar  1 01:30:39.995: %LINK-5-CHANGED: Interface FastEthernet1/15, changed state to administratively down
*Mar  1 01:30:40.995: %LINEPROTO-5-UPDOWN: Line protocol on Interface FastEthernet1/15, changed state to down
*Mar  1 01:30:56.219: STP: VLAN10 Topology Change rcvd on Fa1/0
*Mar  1 01:30:56.239: STP: VLAN1 Topology Change rcvd on Fa1/0
*Mar  1 01:31:25.195: STP: VLAN1 Topology Change rcvd on Fa1/0
*Mar  1 01:31:25.223: STP: VLAN10 Topology Change rcvd on Fa1/0
```

```
sw02#
*Mar  1 01:18:15.915: STP: VLAN11 Topology Change rcvd on Fa1/0
*Mar  1 01:18:16.427: STP: VLAN1 new root port Fa1/15, cost 19
*Mar  1 01:18:16.463: STP: VLAN10 new root port Fa1/15, cost 19
*Mar  1 01:19:39.935: STP: VLAN11 Topology Change rcvd on Fa1/0
*Mar  1 01:19:56.455: STP: VLAN1 we are the spanning tree root
*Mar  1 01:19:56.503: STP: VLAN10 we are the spanning tree root
*Mar  1 01:19:56.519: STP: VLAN10 heard root  8192-c200.04e3.0001 on Fa1/0
*Mar  1 01:19:56.523: current Root has 16384-c201.04e3.0001
*Mar  1 01:19:56.523:     supersedes 16384-c201.04e3.0001
*Mar  1 01:19:56.523: STP: VLAN10 new root is 8192, c200.04e3.0001 on port Fa1/0, cost 3038
*Mar  1 01:19:56.527: STP: VLAN10 sent Topology Change Notice on Fa1/0
*Mar  1 01:19:56.531: STP: VLAN1 heard root 32768-c200.04e3.0000 on Fa1/0
*Mar  1 01:19:56.535: current Root has 32768-c201.04e3.0000
*Mar  1 01:19:56.535:     supersedes 32768-c201.04e3.0000
*Mar  1 01:19:56.535: STP: VLAN1 new root is 32768, c200.04e3.0000 on port Fa1/0, cost 3038
*Mar  1 01:19:56.535: STP: VLAN1 sent Topology Change Notice on Fa1/0
*Mar  1 01:20:09.003: STP: VLAN11 Topology Change rcvd on Fa1/0
```

```
sw11#
*Mar  1 01:17:26.515: STP: VLAN11 heard root 16384-c200.04e3.0002 on Fa1/14
*Mar  1 01:17:26.519: current Root has  8192-c201.04e3.0002
*Mar  1 01:17:26.551: STP: VLAN11 Fa1/14 -> listening
*Mar  1 01:17:27.527: STP: VLAN11 Topology Change rcvd on Fa1/14
*Mar  1 01:17:27.531: STP: VLAN11 sent Topology Change Notice on Fa1/15
*Mar  1 01:17:41.563: STP: VLAN11 Fa1/14 -> learning
*Mar  1 01:17:43.083: STP: VLAN1 Fa1/15 -> listening
*Mar  1 01:17:43.115: STP: VLAN10 Fa1/15 -> listening
*Mar  1 01:17:44.055: STP: VLAN1 heard root 32768-c201.04e3.0000 on Fa1/15
*Mar  1 01:17:44.059: current Root has 32768-c200.04e3.0000
*Mar  1 01:17:44.103: STP: VLAN10 heard root 16384-c201.04e3.0001 on Fa1/15
*Mar  1 01:17:44.103: current Root has  8192-c200.04e3.0001
*Mar  1 01:17:44.115: STP: VLAN10 Topology Change rcvd on Fa1/15
*Mar  1 01:17:44.119: STP: VLAN10 sent Topology Change Notice on Fa1/14
*Mar  1 01:17:44.131: STP: VLAN1 Topology Change rcvd on Fa1/15
*Mar  1 01:17:44.135: STP: VLAN1 sent Topology Change Notice on Fa1/14
*Mar  1 01:17:56.583: STP: VLAN11 sent Topology Change Notice on Fa1/15
*Mar  1 01:17:56.587: STP: VLAN11 Fa1/14 -> forwarding
*Mar  1 01:17:58.087: STP: VLAN1 Fa1/15 -> learning
*Mar  1 01:17:58.115: STP: VLAN10 Fa1/15 -> learning
*Mar  1 01:18:13.099: STP: VLAN1 sent Topology Change Notice on Fa1/14
*Mar  1 01:18:13.099: STP: VLAN1 Fa1/15 -> forwarding
*Mar  1 01:18:13.123: STP: VLAN10 sent Topology Change Notice on Fa1/14
*Mar  1 01:18:13.123: STP: VLAN10 Fa1/15 -> forwarding

sw11#show spanning-tree summary
Root bridge for: none.
PortFast BPDU Guard is disabled
UplinkFast is enabled
BackboneFast is enabled

Name                 Blocking Listening Learning Forwarding STP Active
-------------------- -------- --------- -------- ---------- ----------
VLAN1                0        0         0        6          6
VLAN10               0        0         0        2          2
VLAN11               0        0         0        2          2
-------------------- -------- --------- -------- ---------- ----------
             3 VLANs 0        0         0        10         10

Station update rate set to 150 packets/sec.

UplinkFast statistics
-----------------------
Number of transitions via uplinkFast (all VLANs)            : 6
Number of proxy multicast addresses transmitted (all VLANs) : 0

BackboneFast statistics
-----------------------
Number of transition via backboneFast (all VLANs)           : 1
Number of inferior BPDUs received (all VLANs)               : 1
Number of RLQ request PDUs received (all VLANs)             : 0
Number of RLQ response PDUs received (all VLANs)            : 1
Number of RLQ request PDUs sent (all VLANs)                 : 1
Number of RLQ response PDUs sent (all VLANs)                : 0

```

戻します。
```
sw01(config-if)#no shut
sw01(config-if)#
*Mar  1 01:34:17.559: STP: VLAN1 Fa1/15 -> listening
*Mar  1 01:34:17.563: STP: VLAN10 Fa1/15 -> listening
*Mar  1 01:34:17.563: STP: VLAN11 Fa1/15 -> listening
*Mar  1 01:34:17.739: STP: VLAN11 new root port Fa1/15, cost 19
*Mar  1 01:34:18.051: %DTP-5-TRUNKPORTON: Port Fa1/15 has become dot1q trunk
*Mar  1 01:34:18.351: STP: VLAN1 Topology Change rcvd on Fa1/0
*Mar  1 01:34:18.371: STP: VLAN10 Topology Change rcvd on Fa1/0
*Mar  1 01:34:20.527: %LINEPROTO-5-UPDOWN: Line protocol on Interface FastEthernet1/15, changed state to up
*Mar  1 01:34:32.575: STP: VLAN1 Fa1/15 -> learning
*Mar  1 01:34:32.575: STP: VLAN10 Fa1/15 -> learning
*Mar  1 01:34:32.575: STP: VLAN11 Fa1/15 -> learning
*Mar  1 01:34:47.603: STP: VLAN1 Fa1/15 -> forwarding
*Mar  1 01:34:47.603: STP: VLAN10 Fa1/15 -> forwarding
*Mar  1 01:34:47.603: STP: VLAN11 sent Topology Change Notice on Fa1/15
*Mar  1 01:34:47.603: STP: VLAN11 Fa1/15 -> forwarding
```

```
sw02#
*Mar  1 01:23:18.071: STP: VLAN11 Topology Change rcvd on Fa1/0
*Mar  1 01:23:18.631: STP: VLAN1 new root port Fa1/15, cost 19
*Mar  1 01:23:18.651: STP: VLAN10 new root port Fa1/15, cost 19
*Mar  1 01:23:47.919: STP: VLAN11 Topology Change rcvd on Fa1/15

sw02#show spanning-tree summary
Root bridge for: VLAN11.
PortFast BPDU Guard is disabled
UplinkFast is disabled
BackboneFast is enabled

Name                 Blocking Listening Learning Forwarding STP Active
-------------------- -------- --------- -------- ---------- ----------
VLAN1                0        0         0        2          2
VLAN10               0        0         0        2          2
VLAN11               0        0         0        2          2
-------------------- -------- --------- -------- ---------- ----------
             3 VLANs 0        0         0        6          6

BackboneFast statistics
-----------------------
Number of transition via backboneFast (all VLANs)           : 0
Number of inferior BPDUs received (all VLANs)               : 0
Number of RLQ request PDUs received (all VLANs)             : 1
Number of RLQ response PDUs received (all VLANs)            : 0
Number of RLQ request PDUs sent (all VLANs)                 : 0
Number of RLQ response PDUs sent (all VLANs)                : 1
```

```
sw11#
*Mar  1 01:21:05.659: STP: VLAN11 sent Topology Change Notice on Fa1/15
*Mar  1 01:21:05.667: STP: VLAN11 Fa1/14 -> blocking
*Mar  1 01:21:06.231: STP: VLAN1 sent Topology Change Notice on Fa1/14
*Mar  1 01:21:06.235: STP: VLAN1 Fa1/15 -> blocking
*Mar  1 01:21:06.259: STP: VLAN10 sent Topology Change Notice on Fa1/14
*Mar  1 01:21:06.267: STP: VLAN10 Fa1/15 -> blocking
```

# まとめ

Dynagen、Dynamips を使って、STP の高速化機能を練習しました。
bpduguard、bpdufilter、guard root、guard loop といった拡張技術に対応していないようです。これらの検証にもまた他の手段が必要となってきます。
