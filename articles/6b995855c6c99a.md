---
title: "OpenTofu ã‚’è©¦ã™"
emoji: "ğŸ›•"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["OpenTofu", "Terraform"]
published: true
---

## ã“ã“ã§ã®ç›®æ¨™

- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ã—ã¦Azure Blobã‚³ãƒ³ãƒ†ãƒŠã‚’åˆ©ç”¨ã—ã¦ã¿ã‚‹
- [http ãƒ—ãƒ­ãƒã‚¤ãƒ€](https://registry.terraform.io/providers/hashicorp/http/latest/docs/data-sources/http) ã‚’è©¦ã™

## æº–å‚™

ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ã—ã¦åˆ©ç”¨ã™ã‚‹Blobã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆã—ã¦ãŠãã¾ã™ã€‚(æ—¢å­˜ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½¿ç”¨ã™ã‚‹å‰æ)

```
$ az storage container create --name <container name> --account-name <storage account name>
```

## tf ãƒ•ã‚¡ã‚¤ãƒ«

æ§‹ç¯‰æ™‚ã«è‡ªPCã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ã—ã¦åˆ©ç”¨ã—ãŸã„ã¨ã„ã†çŠ¶æ³ã¯ã‚ˆãã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚ã“ã‚“ãªã¨ã http ãƒ—ãƒ­ãƒã‚¤ãƒ€ãŒåˆ©ç”¨ã•ã‚Œã¾ã™ã€‚
ã“ã“ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ã§ json å½¢å¼ã§IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ã§ãã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ©ç”¨ã—ã¦ã¿ã¾ã™ã€‚

```
$ curl -s https://example.net/getaddress/ | jq .
{
  "sourceip": "x.x.x.x",
  "domainname": "ptr-xxx.example.com"
}
```

ä»¥ä¸‹ã® tf ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™ã—ã¾ã™ã€‚
è‡ªPCã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’èª¿ã¹ã¦å‡ºåŠ›ã™ã‚‹ã ã‘ã®å†…å®¹ã§ã™ã€‚
NSGã®è¨±å¯ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ã—ã¦åˆ©ç”¨ã™ã‚‹å ´åˆ local.allowed_address_prefix_ssh ã‚’æŒ‡å®šã™ã‚‹æ„Ÿã˜ã«ãªã‚Šã¾ã™ã€‚

```
$ cat init.tf
terraform {
  required_version = ">=0.12"

  required_providers {
    http = {
      source  = "hashicorp/http"
      version = "~> 3.0"
    }
  }
  backend "azurerm" {
    resource_group_name  = "management"
    storage_account_name = "<storage account name>"
    container_name       = "<container name>"
    key                  = "terraform.tfstate"
  }
}

provider http {
}

data "http" "getaddress" {
  url = "https://example.net/getaddress/"
}

locals {
  allowed_address_prefix_ssh = jsondecode(data.http.getaddress.response_body).sourceip
}

output "allowed_address_prefix_ssh" {
    value = local.allowed_address_prefix_ssh
}
```

## init

```
$ tofu init 
```

é…ã‚Œã°ã›ãªãŒã‚‰ã€ç’°å¢ƒã¯ä»¥ä¸‹ã€‚
```
$ tofu --version
OpenTofu v1.6.0
on linux_arm64
+ provider registry.opentofu.org/hashicorp/http v3.4.2

$ uname -a
Linux 9d43bf16a58b 5.4.42-v8+ #1319 SMP PREEMPT Wed May 20 14:18:56 BST 2020 aarch64 aarch64 aarch64 GNU/Linux

$ cat /etc/os-release
NAME="Amazon Linux"
VERSION="2"
ID="amzn"
ID_LIKE="centos rhel fedora"
VERSION_ID="2"
PRETTY_NAME="Amazon Linux 2"
ANSI_COLOR="0;33"
CPE_NAME="cpe:2.3:o:amazon:amazon_linux:2"
HOME_URL="https://amazonlinux.com/"
SUPPORT_END="2025-06-30"
```

## plan

```
$ tofu plan | cat
data.http.getaddress: Reading...
data.http.getaddress: Read complete after 0s [id=https://example.net/getaddress/]

Changes to Outputs:
  + allowed_address_prefix_ssh = "x.x.x.x"

You can apply this plan to save these new output values to the OpenTofu
state, without changing any real infrastructure.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Note: You didn't use the -out option to save this plan, so OpenTofu can't
guarantee to take exactly these actions if you run "tofu apply" now.
```

## apply

```
$ tofu apply | cat
data.http.getaddress: Reading...
data.http.getaddress: Read complete after 0s [id=https://example.net/getaddress/]

Changes to Outputs:
  + allowed_address_prefix_ssh = "x.x.x.x"

You can apply this plan to save these new output values to the OpenTofu
state, without changing any real infrastructure.

Do you want to perform these actions?
  OpenTofu will perform the actions described above.
  Only 'yes' will be accepted to approve.

  Enter a value: yes


Apply complete! Resources: 0 added, 0 changed, 0 destroyed.

Outputs:

allowed_address_prefix_ssh = "x.x.x.x"
```

ç¢ºèª
```
$ tofu state list
data.http.getaddress

$ tofu show
# data.http.getaddress:
data "http" "getaddress" {
    body                 = jsonencode(
        {
            domainname = "ptr-xxx.example.com"
            sourceip   = "x.x.x.x"
        }
    )
    id                   = "https://example.net/getaddress/"
    response_body        = jsonencode(
        {
            domainname = "ptr-xxx.example.com"
            sourceip   = "x.x.x.x"
        }
    )
    response_body_base64 = "xxxx"
    response_headers     = {
        å‰²æ„›
    }
    status_code          = 200
    url                  = "https://example.net/getaddress/"
}


Outputs:

allowed_address_prefix_ssh = "x.x.x.x"
```

- `tofu state show data.http.getaddress` ã§ `data.http.getaddress` ã®æƒ…å ±ã ã‘å‡ºåŠ›ã§ãã‚‹ã€‚
- `tofu state rm data.http.getaddress` ã§ `data.http.getaddress` ã‚’ç®¡ç†ä¸‹ã‹ã‚‰é™¤å¤–ã§ãã‚‹ã€‚


## destroy

```
$ tofu destroy | cat
data.http.getaddress: Reading...
data.http.getaddress: Read complete after 0s [id=https://example.net/getaddress/]

Changes to Outputs:
  - allowed_address_prefix_ssh = "x.x.x.x" -> null

You can apply this plan to save these new output values to the OpenTofu
state, without changing any real infrastructure.

Do you really want to destroy all resources?
  OpenTofu will destroy all your managed infrastructure, as shown above.
  There is no undo. Only 'yes' will be accepted to confirm.

  Enter a value: yes


Destroy complete! Resources: 0 destroyed.
```

ç¢ºèª
```
$ tofu show
The state file is empty. No resources are represented.
```

