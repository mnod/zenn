---
title: "Debian11 ã§ Pacemeker ã¨ SCSIãƒ•ã‚§ãƒ³ã‚·ãƒ³ã‚°"
emoji: "ğŸ¤º"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["pacemaker"]
published: true
---

# å‰æ

https://zenn.dev/mnod/articles/490386c39bc8d3 ã®ç’°å¢ƒã‚’åˆ©ç”¨ã—ã¾ã™ã€‚
ã‚¤ãƒ‹ã‚·ã‚¨ãƒ¼ã‚¿å´ã§ sda ã¨ã—ã¦èªè­˜ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒã‚¤ã‚¹ã‚’ãƒ•ã‚§ãƒ³ã‚·ãƒ³ã‚°ãƒ‡ãƒã‚¤ã‚¹ã¨ã—ã¾ã™ã€‚

```
# ls -l /dev/disk/by-id/ | grep sda
lrwxrwxrwx 1 root root 9 Aug  9 19:23 scsi-36001405de80b906d5904c9d841819705 -> ../../sda
lrwxrwxrwx 1 root root 9 Aug  9 19:23 wwn-0x6001405de80b906d5904c9d841819705 -> ../../sda
```

## æº–å‚™

å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
```
# apt install --no-install-recommends fence-agents sg3-utils
```


# è¨­å®š

è¨­å®šã—ã¾ã™ã€‚
```
# pcs stonith create scsi-shooter fence_scsi pcmk_host_list="debian11-0 debian11-1" devices=/dev/disk/by-id/wwn-0x6001405de80b906d5904c9d841819705 meta provides=unfencing

# pcs stonith config scsi-shooter
 Resource: scsi-shooter (class=stonith type=fence_scsi)
  Attributes: devices=/dev/disk/by-id/wwn-0x6001405de80b906d5904c9d841819705 pcmk_host_list="debian11-0 debian11-1"
  Meta Attrs: provides=unfencing
  Operations: monitor interval=60s (scsi-shooter-monitor-interval-60s)
```

çµæœã‚’ç¢ºèªã—ã¾ã™ã€‚
```
# pcs status
Cluster name: web_cluster
Cluster Summary:
  * Stack: corosync
  * Current DC: debian11-0 (version 2.0.5-ba59be7122) - partition with quorum
  * Last updated: Thu Aug 10 17:05:33 2023
  * Last change:  Thu Aug 10 16:57:40 2023 by root via cibadmin on debian11-0
  * 2 nodes configured
  * 14 resource instances configured

Node List:
  * Online: [ debian11-0 debian11-1 ]

Full List of Resources:
  * ClusterIP   (ocf::heartbeat:IPaddr2):        Started debian11-0
  * WebServer   (systemd:nginx):         Started debian11-0
  * Clone Set: drbd_r0-clone [drbd_r0] (promotable):
    * Masters: [ debian11-0 ]
    * Slaves: [ debian11-1 ]
  * fs_drbd_r0  (ocf::heartbeat:Filesystem):     Started debian11-0
  * Clone Set: drbd_r1-clone [drbd_r1] (promotable):
    * Masters: [ debian11-0 debian11-1 ]
  * Clone Set: shared_fs-clone [shared_fs]:
    * Started: [ debian11-0 debian11-1 ]
  * Clone Set: locking-clone [locking]:
    * Stopped: [ debian11-0 debian11-1 ]
  * scsi-shooter        (stonith:fence_scsi):    Started debian11-1

Failed Resource Actions:
  * o2cb_monitor_0 on debian11-0 'not installed' (5): call=60, status='complete', exitreason='Setup problem: couldn't find command: /usr/sbin/ocfs2_controld.pcmk', last-rc-change='2023-08-10 17:04:01 -04:00', queued=0ms, exec=16ms
  * o2cb_monitor_0 on debian11-1 'not installed' (5): call=47, status='complete', exitreason='Setup problem: couldn't find command: /usr/sbin/ocfs2_controld.pcmk', last-rc-change='2023-08-10 17:05:28 -04:00', queued=0ms, exec=23ms

Daemon Status:
  corosync: active/disabled
  pacemaker: active/disabled
  pcsd: active/enabled
```

:::message
ä¸‹è¨˜ãŒè¡¨ç¤ºã•ã‚Œã‚‹å ´åˆã€https://zenn.dev/mnod/scraps/15d8a7e0e4b094 ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
```
scsi-shooter        (stonith:fence_scsi):    Stopped
```
:::

# å‹•ä½œãƒ†ã‚¹ãƒˆ

ä¸‹è¨˜ã‚’ã‚»ã‚«ãƒ³ãƒ€ãƒªç³»ã§å®Ÿè¡Œã—ã¾ã™ã€‚
```
# pcs stonith fence debian11-0
Node: debian11-0 fenced
```

ãƒªã‚½ãƒ¼ã‚¹ãŒã‚»ã‚«ãƒ³ãƒ€ãƒªç³»ã¸ç§»å‹•ã—ã¾ã—ãŸã€‚
```
# pcs status
Cluster name: web_cluster
Cluster Summary:
  * Stack: corosync
  * Current DC: debian11-1 (version 2.0.5-ba59be7122) - partition with quorum
  * Last updated: Thu Aug 10 17:07:19 2023
  * Last change:  Thu Aug 10 16:57:40 2023 by root via cibadmin on debian11-0
  * 2 nodes configured
  * 14 resource instances configured

Node List:
  * Online: [ debian11-1 ]
  * OFFLINE: [ debian11-0 ]

Full List of Resources:
  * ClusterIP   (ocf::heartbeat:IPaddr2):        Started debian11-1
  * WebServer   (systemd:nginx):         Started debian11-1
  * Clone Set: drbd_r0-clone [drbd_r0] (promotable):
    * Masters: [ debian11-1 ]
    * Stopped: [ debian11-0 ]
  * fs_drbd_r0  (ocf::heartbeat:Filesystem):     Started debian11-1
  * Clone Set: drbd_r1-clone [drbd_r1] (promotable):
    * Masters: [ debian11-1 ]
    * Stopped: [ debian11-0 ]
  * Clone Set: shared_fs-clone [shared_fs]:
    * Started: [ debian11-1 ]
    * Stopped: [ debian11-0 ]
  * Clone Set: locking-clone [locking]:
    * Stopped: [ debian11-0 debian11-1 ]
  * scsi-shooter        (stonith:fence_scsi):    Started debian11-1

Failed Resource Actions:
  * o2cb_monitor_0 on debian11-1 'not installed' (5): call=47, status='complete', exitreason='Setup problem: couldn't find command: /usr/sbin/ocfs2_controld.pcmk', last-rc-change='2023-08-10 17:05:28 -04:00', queued=0ms, exec=23ms

Daemon Status:
  corosync: active/disabled
  pacemaker: active/disabled
  pcsd: active/enabled

# df | grep /mnt
/dev/drbd0       1324760      32   1239180   1% /mnt
```

ãƒã‚¹ã‚¿ç³»ã§ç¢ºèªã™ã‚‹ã¨ã€pacemaker ã‚µãƒ¼ãƒ“ã‚¹ãŒå¼·åˆ¶åœæ­¢ã•ã›ã‚‰ã‚Œã¦ã„ã¾ã—ãŸã€‚
```
# systemctl status pacemaker
â— pacemaker.service - Pacemaker High Availability Cluster Manager
     Loaded: loaded (/lib/systemd/system/pacemaker.service; disabled; vendor preset: enabled)
     Active: inactive (dead) since Thu 2023-08-10 17:07:10 EDT; 2min 47s ago
       Docs: man:pacemakerd
             https://clusterlabs.org/pacemaker/doc/en-US/Pacemaker/2.0/html-single/Pacemaker_Explained/index.html
    Process: 608 ExecStart=/usr/sbin/pacemakerd -f (code=exited, status=100)
   Main PID: 608 (code=exited, status=100)
        CPU: 6.472s

Aug 10 17:07:10 debian11-0 pacemakerd[608]:  notice: Stopping pacemaker-fenced
Aug 10 17:07:10 debian11-0 pacemaker-fenced[610]:  notice: Caught 'Terminated' signal
Aug 10 17:07:10 debian11-0 pacemakerd[608]:  notice: Stopping pacemaker-based
Aug 10 17:07:10 debian11-0 pacemaker-based[609]:  notice: Caught 'Terminated' signal
Aug 10 17:07:10 debian11-0 pacemaker-based[609]:  notice: Disconnected from Corosync
Aug 10 17:07:10 debian11-0 pacemaker-based[609]:  notice: Disconnected from Corosync
Aug 10 17:07:10 debian11-0 pacemakerd[608]:  notice: Shutdown complete
Aug 10 17:07:10 debian11-0 pacemakerd[608]:  notice: Shutting down and staying down after fatal error
Aug 10 17:07:10 debian11-0 systemd[1]: pacemaker.service: Succeeded.
Aug 10 17:07:10 debian11-0 systemd[1]: pacemaker.service: Consumed 6.472s CPU time.
```

## æˆ»ã—

ã‚»ã‚«ãƒ³ãƒ€ãƒªç³»ã§ä¸‹è¨˜ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
```
# pcs cluster start debian11-0
debian11-0: Starting Cluster...
```

ãƒã‚¹ã‚¿ç³»ãŒã‚¯ãƒ©ã‚¹ã‚¿ã«å¾©å¸°ã—ã€ãƒªã‚½ãƒ¼ã‚¹ã‚‚ãƒã‚¹ã‚¿ç³»ã¸ç§»å‹•ã—ã¾ã—ãŸã€‚
```
# pcs status
Cluster name: web_cluster
Cluster Summary:
  * Stack: corosync
  * Current DC: debian11-1 (version 2.0.5-ba59be7122) - partition with quorum
  * Last updated: Thu Aug 10 17:10:52 2023
  * Last change:  Thu Aug 10 16:57:40 2023 by root via cibadmin on debian11-0
  * 2 nodes configured
  * 14 resource instances configured

Node List:
  * Online: [ debian11-0 debian11-1 ]

Full List of Resources:
  * ClusterIP   (ocf::heartbeat:IPaddr2):        Started debian11-0
  * WebServer   (systemd:nginx):         Started debian11-0
  * Clone Set: drbd_r0-clone [drbd_r0] (promotable):
    * Masters: [ debian11-0 ]
    * Slaves: [ debian11-1 ]
  * fs_drbd_r0  (ocf::heartbeat:Filesystem):     Started debian11-0
  * Clone Set: drbd_r1-clone [drbd_r1] (promotable):
    * Masters: [ debian11-0 debian11-1 ]
  * Clone Set: shared_fs-clone [shared_fs]:
    * Started: [ debian11-0 debian11-1 ]
  * Clone Set: locking-clone [locking]:
    * Stopped: [ debian11-0 debian11-1 ]
  * scsi-shooter        (stonith:fence_scsi):    Started debian11-1

Failed Resource Actions:
  * o2cb_monitor_0 on debian11-0 'not installed' (5): call=51, status='complete', exitreason='Setup problem: couldn't find command: /usr/sbin/ocfs2_controld.pcmk', last-rc-change='2023-08-10 17:10:48 -04:00', queued=0ms, exec=21ms
  * o2cb_monitor_0 on debian11-1 'not installed' (5): call=47, status='complete', exitreason='Setup problem: couldn't find command: /usr/sbin/ocfs2_controld.pcmk', last-rc-change='2023-08-10 17:05:28 -04:00', queued=0ms, exec=23ms

Daemon Status:
  corosync: active/disabled
  pacemaker: active/disabled
  pcsd: active/enabled
```

ãƒã‚¹ã‚¿ç³»ã§ç¢ºèªã™ã‚‹ã¨ã€ã‚‚ã¡ã‚ã‚“ã€pacemaker ã‚µãƒ¼ãƒ“ã‚¹ãŒèµ·å‹•ã—ã¦ã„ã¾ã—ãŸã€‚

```
# pcs status
Cluster name: web_cluster
Cluster Summary:
  * Stack: corosync
  * Current DC: debian11-1 (version 2.0.5-ba59be7122) - partition with quorum
  * Last updated: Thu Aug 10 17:12:26 2023
  * Last change:  Thu Aug 10 16:57:40 2023 by root via cibadmin on debian11-0
  * 2 nodes configured
  * 14 resource instances configured

Node List:
  * Online: [ debian11-0 debian11-1 ]

Full List of Resources:
  * ClusterIP   (ocf::heartbeat:IPaddr2):        Started debian11-0
  * WebServer   (systemd:nginx):         Started debian11-0
  * Clone Set: drbd_r0-clone [drbd_r0] (promotable):
    * Masters: [ debian11-0 ]
    * Slaves: [ debian11-1 ]
  * fs_drbd_r0  (ocf::heartbeat:Filesystem):     Started debian11-0
  * Clone Set: drbd_r1-clone [drbd_r1] (promotable):
    * Masters: [ debian11-0 debian11-1 ]
  * Clone Set: shared_fs-clone [shared_fs]:
    * Started: [ debian11-0 debian11-1 ]
  * Clone Set: locking-clone [locking]:
    * Stopped: [ debian11-0 debian11-1 ]
  * scsi-shooter        (stonith:fence_scsi):    Started debian11-1

Failed Resource Actions:
  * o2cb_monitor_0 on debian11-0 'not installed' (5): call=51, status='complete', exitreason='Setup problem: couldn't find command: /usr/sbin/ocfs2_controld.pcmk', last-rc-change='2023-08-10 17:10:48 -04:00', queued=0ms, exec=21ms
  * o2cb_monitor_0 on debian11-1 'not installed' (5): call=47, status='complete', exitreason='Setup problem: couldn't find command: /usr/sbin/ocfs2_controld.pcmk', last-rc-change='2023-08-10 17:05:28 -04:00', queued=0ms, exec=23ms

Daemon Status:
  corosync: active/disabled
  pacemaker: active/disabled
  pcsd: active/enabled
```




