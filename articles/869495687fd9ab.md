---
title: "OpenTofuã§ ASRç’°å¢ƒã‚’æ§‹ç¯‰"
emoji: "ğŸ¦ "
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Azure", "OpenTofu", "Terraform"]
published: true
published_at: 2024-05-03 18:03 
---

ASRã¨ã¯ãªã«ã‚‚ã®ãªã®ã‹ã€‚å¿…è¦ã¨ãªã‚‹ãƒªã‚½ãƒ¼ã‚¹ã¨ãã®èª¬æ˜ã€‚ASRã®æ“ä½œæ–¹æ³•ç­‰ã¯ä¸€åˆ‡åˆåˆ‡çœç•¥ã—ã¾ã™ã€‚
ãã‚Œã‚‰ã«ã¤ã„ã¦ã®èª¬æ˜ã¯å…ˆè¼©è«¸æ°ã®ã‚µã‚¤ãƒˆã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚
ã“ã“ã§ã¯ãŸã  OpenTofu ã§æ§‹ç¯‰ã—ãŸã¨ãã®è³‡æã¨æ“ä½œæ–¹æ³•ã®æ¦‚è¦ã®ã¿æç¤ºã—ã¾ã™ã€‚

## å‚è€ƒ

https://qiita.com/k-yasuhiro/items/6a59e95e7a979c8170f0


## æ§‹ç¯‰è³‡æ

å•†ç”¨ç’°å¢ƒã ã¨é–‰åŸŸã«ã¤ã„ã¦ã‚‚è€ƒæ…®ã—ã¦ã„ãå¿…è¦ãŒã‚ã‚‹ã“ã¨ã‚‚å¤šã‹ã‚ã†ã¨æ€ã„ã¾ã™ãŒã€
ã“ã¡ã‚‰ã¯é–‰åŸŸæ§‹æˆã¨ã‹è€ƒæ…®ã—ãªã„æ§‹æˆã¨ãªã£ã¦ã„ã¾ã™ã€‚

:::details asr_main.tf ãƒ•ã‚¡ã‚¤ãƒ«

resource group, vnet, nsg, storege account, recovery service vault, vm ç­‰ã‚’æ§‹ç¯‰ã™ã‚‹ tf ãƒ•ã‚¡ã‚¤ãƒ«ã€‚
Linux VMã®ã‚«ãƒ¼ãƒãƒ«ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰ã‚’è€ƒæ…®ã—ã¦ã€ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®è¨­å®šã¯ åˆ¥ã®tf ãƒ•ã‚¡ã‚¤ãƒ«ã«åˆ†ã‘ã¦ã„ã‚‹ã€‚

- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«ã¤ã„ã¦ã¯é©å®œè¨­å®šã—ã¦ãã ã•ã„ã€‚
- `https://example.net/getaddress/` ã«ã¤ã„ã¦ã¯ã€ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ `{ "sourceip": "x.x.x.x" }` ã¨ã„ã£ãŸå½¢ã§ã‚¢ã‚¯ã‚»ã‚¹å…ƒã‚°ãƒ­ãƒ¼ãƒãƒ«IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¿”ã™URLã‚’æŒ‡å®šã—ã¾ã™ã€‚

@[gist](https://gist.github.com/mnod/0ed9ec48287d3a785a1e648911720b37?file=asr_main.tf)
:::

:::details asr_replication.tf ãƒ•ã‚¡ã‚¤ãƒ«
ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®è¨­å®šã‚’è¨˜è¼‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã€‚Linux VMã®ã‚«ãƒ¼ãƒãƒ«ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰ã‚’å®Ÿæ–½ã—ã¦ã‹ã‚‰é©ç”¨ã™ã‚‹ã€‚
ä¸€ã¤ã®tfãƒ•ã‚¡ã‚¤ãƒ«ã«ã¾ã¨ã‚ã¦ã„ã¦ã‚‚ã€è¦é ˜ã‚ˆãã‚„ã‚Œã° vmãŒç«‹ã¡ä¸ŠãŒã£ã¦ã‹ã‚‰ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹ã¾ã§ã®é–“ã«ã‚«ãƒ¼ãƒãƒ«ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã¯æ™‚é–“çš„ã«å¯èƒ½ã ã‘ã©ã€å¿µã®ãŸã‚åˆ†ã‘ã¦ã„ã‚‹ã€‚

@[gist](https://gist.github.com/mnod/0ed9ec48287d3a785a1e648911720b37?file=asr_replication.tf)
:::

:::details asr_parameters.tfvars ãƒ•ã‚¡ã‚¤ãƒ«
@[gist](https://gist.github.com/mnod/0ed9ec48287d3a785a1e648911720b37?file=asr_parameters.tfvars)
:::


### è³‡æã®åˆ©ç”¨æ–¹æ³•

#### æ§‹ç¯‰

0. ä¸Šè¨˜è³‡æã‚’ã‚«ãƒ¬ãƒ³ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã«ä¿å­˜
1. asr_main.tfã€asr_parameters.tfvars ã®å†…å®¹ã‚’ä¿®æ­£ã€‚
2. init ã‚’å®Ÿè¡Œ
```
tofu validate
tofu init
```
3. asr_replication.tfã¯é€€é¿ã—ã¦ã€asr_main.tf ã®ã¿é©ç”¨
```
mv asr_replication.tf asr_replication.tf.tmp
tofu plan -var-file=asr_parameters.tfvars -out=tofu.out
tofu apply "tofu.out"
```
4. å¿…è¦ãªã‚‰ VM ã®ã‚«ãƒ¼ãƒãƒ«ã‚’ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰
5. asr_replication.tf ã‚’é©ç”¨
```
mv asr_replication.tf.tmp asr_replication.tf
tofu plan -var-file=asr_parameters.tfvars -var disk_id=$(az disk list --query "[?name=='<environment>_vm_OsDisk' && location=='japaneast'].id" --output tsv) -out=tofu.out
tofu apply "tofu.out"
```
ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æœ‰åŠ¹åŒ–ã¨ãƒ‡ã‚£ã‚¹ã‚¯åŒæœŸã®é–“ãšã£ã¨å¾…æ©Ÿã«ãªã‚‹ã®ã§ã€ç›¸å½“æ™‚é–“ã‹ã‹ã‚‹ã€‚(30åˆ†ãã‚‰ã„)
ãƒ•ã‚§ãƒ¼ãƒ«ã‚ªãƒ¼ãƒãƒ¼ã€å†ä¿è­·(ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®æŒ‡å®šã‚’å¿˜ã‚Œãšã«)ã€ãƒ•ã‚§ãƒ¼ãƒ«ãƒãƒƒã‚¯ç­‰ã®æ“ä½œã¯ã€Recovery Services ã‚³ãƒ³ãƒ†ãƒŠãƒ¼ã®ã€Œå¾©æ—§è¨ˆç”»(Recovery Plan)ã€ã®ç”»é¢ã§è¡Œã†ã€‚

#### replication ã®ã‚„ã‚Šç›´ã—

1. Azureã®ç®¡ç†ç”»é¢ã§ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç„¡åŠ¹åŒ–
2. å¾©æ—§è¨ˆç”»ã‚’å‰Šé™¤ã€‚tofu ã®ç®¡ç†ä¸‹ã‹ã‚‰ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é™¤å¤–ã€‚
```
tofu plan -var-file=parameters.tfvars -var disk_id=$(az disk list --query "[?name=='<environment>_vm_OsDisk' && location=='japaneast'].id" --output tsv) -out=tofu.out -destroy -target=azurerm_site_recovery_replication_recovery_plan.recovery_plan
tofu state rm azurerm_site_recovery_replicated_vm.replicated_vm
```

3. tofu ã§å†åº¦ apply ã™ã‚‹
```
tofu plan -var-file=asr_parameters.tfvars -var disk_id=$(az disk list --query "[?name=='<environment>_vm_OsDisk' && location=='japaneast'].id" --output tsv) -out=tofu.out
tofu apply "tofu.out"
```

#### vault ã®ä½œã‚Šç›´ã—

1. Azureã®ç®¡ç†ç”»é¢ã§ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç„¡åŠ¹åŒ–ã€‚tofu ã®ç®¡ç†ä¸‹ã‹ã‚‰ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é™¤å¤–ã€‚
2. vaultã¨vaultã«ä¾å­˜ã—ã¦ã„ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã‚’destroy
```
tofu plan -destroy -target=azurerm_recovery_services_vault.vault -var-file=parameters.tfvars -var disk_id=$(az disk list --query "[?name=='<environment>_vm_OsDisk' && location=='japaneast'].id" --output tsv) -out=tofu.out
tofu apply "tofu.out"
```
å‰Šé™¤ã«å¤±æ•—ã—ãŸã‚‰ã€ç®¡ç†ç”»é¢ã‹ã‚‰å‰Šé™¤å¾Œã€ä¸‹è¨˜ã‚’å®Ÿè¡Œã€‚
```
tofu state list | grep rec
tofu state list | grep rec | xargs tofu state rm
```

### å…¨å‰Šé™¤

1. destroy ã™ã‚‹
```
tofu plan -destroy -var-file=asr_parameters.tfvars -var disk_id=$(az disk list --query "[?name=='<environment>_vm_OsDisk' && location=='japaneast'].id" --output tsv) -out=tofu.out
tofu apply "tofu.out"
```
2. æ¶ˆãˆãªã„ãƒªã‚½ãƒ¼ã‚¹ãŒã‚ã£ãŸã‚‰ç®¡ç†ç”»é¢ã‹ã‚‰æ‰‹å‹•ã§å‰Šé™¤
3. state ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æ‰‹å‹•ã§å‰Šé™¤
```
tofu state list
tofu state list | xargs tofu state rm
```



## ä¸€éƒ¨ãƒªã‚½ãƒ¼ã‚¹ã®ç ´æ£„

`-target` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã€ç ´æ£„ã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã‚’æŒ‡å®šã™ã‚‹ã€‚è¤‡æ•°ãƒªã‚½ãƒ¼ã‚¹ã‚’ç ´æ£„ã™ã‚‹ã¨ãã¯ã€`-target` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¤‡æ•°å›æŒ‡å®šã™ã‚‹ã€‚

VMã€NICã€ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã‚’å‰Šé™¤ã™ã‚‹planã®ä¾‹ã€‚

```
$ tofu plan -destroy -target=azurerm_linux_virtual_machine.vm -target=azurerm_network_interface.nic -target=azurerm_public_ip.pip -var-file=parameters.tfvars -out tfplan.out
:
:
OpenTofu used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:
  - destroy

OpenTofu will perform the following actions:
:
:
Plan: 0 to add, 0 to change, 3 to destroy.
â•·
â”‚ Warning: Resource targeting is in effect
â”‚
â”‚ You are creating a plan with the -target option, which means that the result of this plan may not represent all of the changes requested by the current configuration.
â”‚
â”‚ The -target option is not for routine use, and is provided only for exceptional situations such as recovering from errors or mistakes, or when OpenTofu specifically suggests to use it as part of an error message.
â•µ

Saved the plan to: tfplan.out

To perform exactly these actions, run the following command to apply:
    tofu apply "tfplan.out"
```


out ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é©ç”¨ã—ã¦å®Ÿéš›ã«å‰Šé™¤ã™ã‚‹ã€‚

```
$ tofu apply "tfplan.out"
:
:
â•·
â”‚ Warning: Applied changes may be incomplete
â”‚
â”‚ The plan was created with the -target option in effect, so some changes requested in the configuration may have been ignored and the output values may not be fully updated. Run the following command to verify that no other changes are
â”‚ pending:
â”‚     tofu plan
â”‚
â”‚ Note that the -target option is not suitable for routine use, and is provided only for exceptional situations such as recovering from errors or mistakes, or when OpenTofu specifically suggests to use it as part of an error message.
â•µ

Apply complete! Resources: 0 added, 0 changed, 3 destroyed.

Outputs:

public_ip_address = "x.x.x.x"
```


## å‰Šé™¤ã—ãŸãƒªã‚½ãƒ¼ã‚¹ã®å†ä½œæˆ

é€šå¸¸ã©ãŠã‚Š plan ã‚’å®Ÿè¡Œã€‚

```
$ tofu plan -var-file=parameters.tfvars -out tfplan.out
:
:
OpenTofu used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:
  + create

OpenTofu will perform the following actions:
:
:
Plan: 3 to add, 0 to change, 0 to destroy.

Changes to Outputs:
  ~ public_ip_address = "x.x.x.x" -> (known after apply)

Saved the plan to: tfplan.out

To perform exactly these actions, run the following command to apply:
    tofu apply "tfplan.out"
```

é€šå¸¸ã©ãŠã‚Š apply ã‚’å®Ÿè¡Œã€‚

```
$ tofu apply "tfplan.out"
:
:
Apply complete! Resources: 3 added, 0 changed, 0 destroyed.

Outputs:

public_ip_address = ""
```

ä½œæˆã—ãŸãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã®å€¤ãŒå…¥ã£ã¦ã„ãªã„ã®ã§ plan ã‚’å®Ÿè¡Œã—ã¦ç¢ºèªã—ã¦ã¿ã‚‹ã€‚

```
$ tofu plan -var-file=parameters.tfvars -out tfplan.out


Note: Objects have changed outside of OpenTofu

OpenTofu detected the following changes made outside of OpenTofu since the
last "tofu apply" which may have affected this plan:

  # azurerm_public_ip.pip has changed
  ~ resource "azurerm_public_ip" "pip" {
        id                      = "/subscriptions/<subscription id>/resourceGroups/<environment>/providers/Microsoft.Network/publicIPAddresses/<environment>_pip"
      + ip_address              = "x.x.x.x"
        name                    = "<environment>_pip"
        # (8 unchanged attributes hidden)
    }


Unless you have made equivalent changes to your configuration, or ignored the
relevant attributes using ignore_changes, the following plan may include
actions to undo or respond to these changes.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Changes to Outputs:
  ~ public_ip_address = "" -> "x.x.x.x"

You can apply this plan to save these new output values to the OpenTofu
state, without changing any real infrastructure.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Saved the plan to: tfplan.out

To perform exactly these actions, run the following command to apply:
    tofu apply "tfplan.out"
```

tofu å¤–ã®æ“ä½œã§å¤‰æ›´ã•ã‚ŒãŸã¨ã„ã†ã®ã¯äº‹å®Ÿã¨ç•°ãªã‚‹ã®ã§æ°—ã«é£Ÿã‚ãªã„ã¨ã“ã‚ã ãŒã€
æ–‡å¥ã‚’è¨€ã£ã¦ã‚‚ä»•æ–¹ãªã„ã®ã§ãŠã¨ãªã—ã apply ã‚’å®Ÿè¡Œã™ã‚‹ã€‚

```
$ tofu apply "tfplan.out" | cat

Apply complete! Resources: 0 added, 0 changed, 0 destroyed.

Outputs:

public_ip_address = "x.x.x.x"
```

## ãƒªã‚½ãƒ¼ã‚¹ã®å®Œå…¨ç ´æ£„

ãªãŠã€tofu destroy ã€° ã¯ tofu plan -destroy ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã¨ã®ã“ã¨ã€‚
```
$ tofu plan -destroy -var-file=parameters.tfvars -out tfplan.out | cat
:
:
OpenTofu used the selected providers to generate the following execution
plan. Resource actions are indicated with the following symbols:
  - destroy

OpenTofu will perform the following actions:
:
:
Plan: 0 to add, 0 to change, 27 to destroy.

Changes to Outputs:
  - public_ip_address = "x.x.x.x" -> null

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Saved the plan to: tfplan.out

To perform exactly these actions, run the following command to apply:
    tofu apply "tfplan.out"
```

out ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é©ç”¨ã—ã¦å®Ÿéš›ã«å‰Šé™¤ã™ã‚‹ã€‚
```
$ tofu apply "tfplan.out" | cat
:
:
Apply complete! Resources: 0 added, 0 changed, 27 destroyed.
```
