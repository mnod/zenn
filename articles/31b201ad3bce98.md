---
title: "Docker ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‚’è©¦ã™"
emoji: "ğŸ§®"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["docker"]
published: true
---

# æ¦‚è¦

Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’åˆ©ç”¨ã—ã¦ Dockerã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã‚’è©¦ã—ã¾ã™ã€‚

å‚è€ƒ
https://distribution.github.io/distribution/

# ç’°å¢ƒ

Raspberry Pi ä¸Šã® KVM ã§ Docker12 ã‚’å‹•ã‹ã—ã€ãã®ä¸­ã§ Docker ã‚’å‹•ã‹ã™ã€‚

# Docker ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

å…¬å¼è¨˜è¼‰ã®é€šã‚Šã€‚

```
sudo apt-get update
sudo apt-get install ca-certificates curl
sudo install -m 0755 -d /etc/apt/keyrings
sudo curl -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc
sudo chmod a+r /etc/apt/keyrings/docker.asc

echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian \
  $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt-get update
```

```
sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
```

```
sudo docker run --rm hello-world
```

# Docker ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‚’å‹•ã‹ã™

compose.yaml ã‚’ç”¨æ„ã™ã‚‹ã€‚

```: compose.yaml
services:
  # docker run -d -p 5000:5000 -v /work/vol:/var/lib/registry -name registry registry
  registry:                                                                                                                                                                                                          image: registry:latest
    ports:
      - 5000:5000
    volumes:
      - /work/vol:/var/lib/registry
```

ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã™ã‚‹ã€‚

```
$ sudo docker compose up -d
```
èµ·å‹•ã—ãŸã“ã¨ã‚’ç¢ºèª

```
$ sudo docker compose ps
NAME              IMAGE             COMMAND                  SERVICE    CREATED              STATUS              PORTS
work-registry-1   registry:latest   "/entrypoint.sh /etc_"   registry   About a minute ago   Up About a minute   0.0.0.0:5000->5000/tcp, :::5000->5000/tcp
```


# Push ã—ã¦ã¿ã‚‹

hello-world:latest ã‚’ hello-world:test ã¨ã—ã¦ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã«ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦ã¿ãŸã„ã€‚

```
$ sudo docker images
REPOSITORY    TAG       IMAGE ID       CREATED         SIZE
hello-world   latest    f1f77a0f96b7   9 days ago      5.2kB
registry      latest    d8876582179f   16 months ago   25MB
```

ã‚¿ã‚°ã‚’ä»˜ã‘ã‚‹
```
$ sudo docker tag hello-world:latest localhost:5000/hello-world:test

$ sudo docker images
REPOSITORY                   TAG       IMAGE ID       CREATED         SIZE
hello-world                  latest    f1f77a0f96b7   9 days ago      5.2kB
localhost:5000/hello-world   test      f1f77a0f96b7   9 days ago      5.2kB
registry                     latest    d8876582179f   16 months ago   25MB
```

ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹
```
$ sudo docker push localhost:5000/hello-world:test
The push refers to repository [localhost:5000/hello-world]
98a92b28c9b8: Pushed
test: digest: sha256:d2b712d831f1cc89d997457109d01fb7ca4dd1d39a363d9f2f9426958a0ca44a size: 524
```

ç¢ºèª
```
$ curl http://localhost:5000/v2/_catalog
{"repositories":["hello-world"]}

$ curl http://localhost:5000/v2/hello-world/tags/list
{"name":"hello-world","tags":["test"]}
```

ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
```
$ du -sh /work/vol
148K    /work/vol

$ find /work/vol -type f -exec ls -l {} \;
-rw-r--r-- 1 root root 71 Jan 31 23:00 /work/vol/docker/registry/v2/repositories/hello-world/_manifests/tags/test/current/link
-rw-r--r-- 1 root root 71 Jan 31 23:00 /work/vol/docker/registry/v2/repositories/hello-world/_manifests/tags/test/index/sha256/d2b712d831f1cc89d997457109d01fb7ca4dd1d39a363d9f2f9426958a0ca44a/link
-rw-r--r-- 1 root root 71 Jan 31 23:00 /work/vol/docker/registry/v2/repositories/hello-world/_manifests/revisions/sha256/d2b712d831f1cc89d997457109d01fb7ca4dd1d39a363d9f2f9426958a0ca44a/link
-rw-r--r-- 1 root root 71 Jan 31 23:00 /work/vol/docker/registry/v2/repositories/hello-world/_layers/sha256/f1f77a0f96b7251d7ef5472705624e2d76db64855b5b121e1cbefe9dc52d0f86/link
-rw-r--r-- 1 root root 71 Jan 31 23:00 /work/vol/docker/registry/v2/repositories/hello-world/_layers/sha256/c9c5fd25a1bdc181cb012bc4fbb1ab272a975728f54064b7ae3ee8e77fd28c46/link
-rw-r--r-- 1 root root 3156 Jan 31 23:00 /work/vol/docker/registry/v2/blobs/sha256/c9/c9c5fd25a1bdc181cb012bc4fbb1ab272a975728f54064b7ae3ee8e77fd28c46/data
-rw-r--r-- 1 root root 524 Jan 31 23:00 /work/vol/docker/registry/v2/blobs/sha256/d2/d2b712d831f1cc89d997457109d01fb7ca4dd1d39a363d9f2f9426958a0ca44a/data
-rw-r--r-- 1 root root 562 Jan 31 23:00 /work/vol/docker/registry/v2/blobs/sha256/f1/f1f77a0f96b7251d7ef5472705624e2d76db64855b5b121e1cbefe9dc52d0f86/data
```

# Pull ã—ã¦ã¿ã‚‹

ã‚¿ã‚°ã‚’ã¤ã‘ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å‰Šé™¤ã™ã‚‹
```
$ sudo docker rmi localhost:5000/hello-world:test
Untagged: localhost:5000/hello-world:test
Untagged: localhost:5000/hello-world@sha256:d2b712d831f1cc89d997457109d01fb7ca4dd1d39a363d9f2f9426958a0ca44a

$ sudo docker images
REPOSITORY    TAG       IMAGE ID       CREATED         SIZE
hello-world   latest    f1f77a0f96b7   10 days ago     5.2kB
registry      latest    d8876582179f   16 months ago   25MB
```


ãƒ—ãƒ«ã™ã‚‹
```
$ sudo docker pull localhost:5000/hello-world:test
test: Pulling from hello-world
Digest: sha256:d2b712d831f1cc89d997457109d01fb7ca4dd1d39a363d9f2f9426958a0ca44a
Status: Downloaded newer image for localhost:5000/hello-world:test
localhost:5000/hello-world:test

$ sudo docker images
REPOSITORY                   TAG       IMAGE ID       CREATED         SIZE
hello-world                  latest    f1f77a0f96b7   10 days ago     5.2kB
localhost:5000/hello-world   test      f1f77a0f96b7   10 days ago     5.2kB
registry                     latest    d8876582179f   16 months ago   25MB
```

# ç•°ãªã‚‹ãƒ›ã‚¹ãƒˆã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹

## ãªã«ã‚‚è€ƒãˆãšæ¥ç¶šã—ã¦ã¿ãŸ

ç•°ãªã‚‹ãƒ›ã‚¹ãƒˆã‹ã‚‰ 192.168.11.15:5000 ã¸ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦åˆ©ç”¨ã™ã‚‹ã€‚

```
$ curl http://192.168.11.15:5000/v2/_catalog
{"repositories":["hello-world"]}
```

ã‚¿ã‚°ã‚’ä»˜ã‘ã‚‹

```
$ sudo docker tag hello-world:latest 192.168.11.15:5000/hello-world:oldest

$ sudo docker images | grep hello-world
192.168.11.15:5000/hello-world   oldest                    ee301c921b8a   21 months ago   9.14kB
hello-world                      latest                    ee301c921b8a   21 months ago   9.14kB
```

ãƒ—ãƒƒã‚·ãƒ¥ã‚’è©¦ã¿ã‚‹ãŒã€ã‚¨ãƒ©ãƒ¼ã¨ãªã‚‹ã€‚

```
$ sudo docker push 192.168.11.15:5000/hello-world:oldest
The push refers to repository [192.168.11.15:5000/hello-world]
Get "https://192.168.11.15:5000/v2/": http: server gave HTTP response to HTTPS client
```

å¯¾å¿œæ–¹æ³•ã¨ã—ã¦ã¯ã€ä»¥ä¸‹ã®2ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒã‚ã‚‹
- ã‚»ã‚­ãƒ¥ã‚¢ã§ã¯ãªã„é€šä¿¡ã‚’è¨±å¯ã™ã‚‹ã€‚
- httpsåŒ–ã™ã‚‹ã€‚

ã“ã“ã§ã¯å¾Œè€…ã‚’é¸æŠã€‚æ‰‹ã£å–ã‚Šæ—©ãè‡ªå·±ç½²åè¨¼æ˜æ›¸ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã«ã™ã‚‹ã€‚
ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ç­‰ã®åˆ©ç”¨ã‚‚ã„ã£ãŸã‚“è€ƒãˆãªã„ã€‚

## ãƒ¬ã‚¸ã‚¹ãƒˆãƒªå´ã§è¨­å®šå¤‰æ›´

è¨¼æ˜æ›¸ä½œæˆ

```
# mkdir /work/vol/certs

# openssl req -x509 -sha256 -nodes -days 3650 -newkey rsa:2048 -subj /CN=192.168.11.15 -keyout server.key -out server.crt -addext 'subjectAltName = IP:192.168.11.15'

# ls -l
total 8
-rw-r--r-- 1 root root 1123 Feb  1 02:52 server.crt
-rw------- 1 root root 1704 Feb  1 02:52 server.key
```

compose.yaml ã‚’ä¿®æ­£

```: compose.yaml
services:
  # docker run -d -p 5000:5000 -v /vol:/var/lib/registry -name registry registry
  registry:
    image: registry:latest
    ports:
      - 5000:5000
    volumes:
      - /work/vol:/var/lib/registry
    environment:
      - REGISTRY_HTTP_TLS_CERTIFICATE=/var/lib/registry/certs/server.crt
      - REGISTRY_HTTP_TLS_KEY=/var/lib/registry/certs/server.key
```

æ›´æ–°ã‚’åæ˜ 

```
$ sudo docker compose up -d
[+] Running 1/1
 _ Container work-registry-1  Started                   
```


## å†åº¦æ¥ç¶šã‚’è©¦ã¿ã‚‹

æ¥ç¶šãƒ†ã‚¹ãƒˆ
```
$ curl -k https://192.168.11.15:5000/v2/_catalog
{"repositories":["hello-world"]}
```

ä¿¡é ¼ã™ã‚‹CAã®æƒ…å ±ã‚’ä¿å­˜(dockerdã®å†èµ·å‹•ã¯ä¸è¦)
```
$ sudo mkdir -p /etc/docker/certs.d/192.168.11.15:5000

$ ls -l /etc/docker/certs.d/192.168.11.15\:5000/ca.crt
-rw-r--r-- 1 root root 1147 Feb  1 15:32 /etc/docker/certs.d/192.168.11.15:5000/ca.crt
```

ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦ã¿ã‚‹
```
$ sudo docker push 192.168.11.15:5000/hello-world:oldest
The push refers to repository [192.168.11.15:5000/hello-world]
12660636fe55: Pushed
oldest: digest: sha256:a8ea96bb64d60208d6a56712042d1cf58aa4a7d3751b897b9320b0813c81cbb4 size: 524
```

çµæœç¢ºèª
```
$ curl -k https://192.168.11.15:5000/v2/hello-world/tags/list
{"name":"hello-world","tags":["test","oldest"]}
```


# èªè¨¼è¨­å®š

æœ¬ç¨¿ã§ã¯å‰²æ„›ã™ã‚‹ãŒã€ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã‚’å¤–ã«ç½®ã„ã¦ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆçµŒç”±ã§åˆ©ç”¨ã™ã‚‹ãªã‚‰èªè¨¼ã‚’è¨­å®šã—ãŸã„ã¨ã“ã‚ã€‚
(æ°—ãŒå‘ã„ãŸã‚‰è¿½è¨˜ã™ã‚‹)


# ãƒ—ãƒ­ã‚­ã‚·ã¨ã—ã¦åˆ©ç”¨ã—ã¦ã¿ã‚‹

å‚è€ƒ
https://distribution.github.io/distribution/recipes/mirror/
https://docs.docker.com/docker-hub/image-library/mirror/

ãƒ•ã‚§ãƒƒãƒã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹ã€‚

## è¨­å®šè¿½åŠ 

compose.yaml ã«ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã‚’è¿½åŠ ã€‚
```
$ diff -u compose.yaml*
--- compose.yaml        2025-02-07 08:31:07.633794885 +0900
+++ compose.yaml.000    2025-02-07 07:36:25.536494351 +0900
@@ -9,4 +9,3 @@
     environment:
       - REGISTRY_HTTP_TLS_CERTIFICATE=/var/lib/registry/certs/server.crt
       - REGISTRY_HTTP_TLS_KEY=/var/lib/registry/certs/server.key
-      - REGISTRY_PROXY_REMOTEURL="https://registry-1.docker.io"
```

è¨­å®šã‚’è¿½åŠ ã—ãŸã‚‰ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãªãŠã™
```
$ sudo docker compose up -d
```

## ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´è¨­å®š

ãƒ—ãƒ­ã‚­ã‚·ã‚’åˆ©ç”¨ã™ã‚‹ã‚ˆã†ã« daemon.json ã«ä»¥ä¸‹ã‚’è¿½åŠ ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã‘ã‚Œã°æ–°è¦ä½œæˆã€‚

```: /etc/docker/daemon.json
{
  "registry-mirrors": ["https://192.168.11.14:5000"]
}
```

è¨­å®šåæ˜ ã®ãŸã‚ dockerd å†èµ·å‹•

```
$ sudo systemctl restat docker
```

è¨­å®šãŒåæ˜ ã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
```
$ sudo docker info | grep -A 1 -i mirror
 Registry Mirrors:
  https://192.168.11.14:5000/
```

## ç¢ºèª

å®Ÿéš›ã«ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ—ãƒ«ã—ã¦æˆåŠŸã™ã‚‹ã“ã¨ã‚’ç¢ºèªã€‚
```
$ sudo docker pull nginx
Using default tag: latest
latest: Pulling from library/nginx
4d2547c08499: Pull complete
1529751f7538: Pull complete
bbefd32e7dcb: Pull complete
47cc26834fb6: Pull complete
aba9a01aa562: Pull complete
25ef5805725b: Pull complete
f6eaf43e06b3: Pull complete
Digest: sha256:91734281c0ebfc6f1aea979cffeed5079cfe786228a71cc6f1f46a228cde6e34
Status: Downloaded newer image for nginx:latest
docker.io/library/nginx:latest
```

ãƒ—ãƒ­ã‚­ã‚·å´ã§ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ãŠãã¨ã€ãƒ­ã‚°ãŒæµã‚Œã‚‹ã€‚
```
$ sudo docker compose logs -f registry
```
