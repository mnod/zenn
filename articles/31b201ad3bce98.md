---
title: "Docker プライベートレジストリを試す"
emoji: "🧮"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["docker"]
published: true
---

# 概要

Dockerイメージを利用して Dockerのプライベートリポジトリを試します。

# 環境

Raspberry Pi 上の KVM で Docker12 を動かし、その中で Docker を動かす。

# Docker のインストール

公式記載の通り。

```
sudo apt-get update
sudo apt-get install ca-certificates curl
sudo install -m 0755 -d /etc/apt/keyrings
sudo curl -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc
sudo chmod a+r /etc/apt/keyrings/docker.asc

echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian \
  $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt-get update
```

```
sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
```

```
sudo docker run --rm hello-world
```

# Docker レジストリを動かす

compose.yaml を用意する。

```: compose.yaml
services:
  # docker run -d -p 5000:5000 -v /work/vol:/var/lib/registry -name registry registry
  registry:                                                                                                                                                                                                          image: registry:latest
    ports:
      - 5000:5000
    volumes:
      - /work/vol:/var/lib/registry
```

コンテナを起動する。

```
$ sudo docker compose up -d
```
起動したことを確認

```
$ sudo docker compose ps
NAME              IMAGE             COMMAND                  SERVICE    CREATED              STATUS              PORTS
work-registry-1   registry:latest   "/entrypoint.sh /etc_"   registry   About a minute ago   Up About a minute   0.0.0.0:5000->5000/tcp, :::5000->5000/tcp
```


# Push してみる

hello-world:latest を hello-world:test としてプライベートリポジトリにプッシュしてみたい。

```
$ sudo docker images
REPOSITORY    TAG       IMAGE ID       CREATED         SIZE
hello-world   latest    f1f77a0f96b7   9 days ago      5.2kB
registry      latest    d8876582179f   16 months ago   25MB
```

タグを付ける
```
$ sudo docker tag hello-world:latest localhost:5000/hello-world:test

$ sudo docker images
REPOSITORY                   TAG       IMAGE ID       CREATED         SIZE
hello-world                  latest    f1f77a0f96b7   9 days ago      5.2kB
localhost:5000/hello-world   test      f1f77a0f96b7   9 days ago      5.2kB
registry                     latest    d8876582179f   16 months ago   25MB
```

プッシュする
```
$ sudo docker push localhost:5000/hello-world:test
The push refers to repository [localhost:5000/hello-world]
98a92b28c9b8: Pushed
test: digest: sha256:d2b712d831f1cc89d997457109d01fb7ca4dd1d39a363d9f2f9426958a0ca44a size: 524
```

確認
```
$ curl http://localhost:5000/v2/_catalog
{"repositories":["hello-world"]}

$ curl http://localhost:5000/v2/hello-world/tags/list
{"name":"hello-world","tags":["test"]}
```

ローカルファイルを確認
```
$ du -sh /work/vol
148K    /work/vol

$ find /work/vol -type f -exec ls -l {} \;
-rw-r--r-- 1 root root 71 Jan 31 23:00 /work/vol/docker/registry/v2/repositories/hello-world/_manifests/tags/test/current/link
-rw-r--r-- 1 root root 71 Jan 31 23:00 /work/vol/docker/registry/v2/repositories/hello-world/_manifests/tags/test/index/sha256/d2b712d831f1cc89d997457109d01fb7ca4dd1d39a363d9f2f9426958a0ca44a/link
-rw-r--r-- 1 root root 71 Jan 31 23:00 /work/vol/docker/registry/v2/repositories/hello-world/_manifests/revisions/sha256/d2b712d831f1cc89d997457109d01fb7ca4dd1d39a363d9f2f9426958a0ca44a/link
-rw-r--r-- 1 root root 71 Jan 31 23:00 /work/vol/docker/registry/v2/repositories/hello-world/_layers/sha256/f1f77a0f96b7251d7ef5472705624e2d76db64855b5b121e1cbefe9dc52d0f86/link
-rw-r--r-- 1 root root 71 Jan 31 23:00 /work/vol/docker/registry/v2/repositories/hello-world/_layers/sha256/c9c5fd25a1bdc181cb012bc4fbb1ab272a975728f54064b7ae3ee8e77fd28c46/link
-rw-r--r-- 1 root root 3156 Jan 31 23:00 /work/vol/docker/registry/v2/blobs/sha256/c9/c9c5fd25a1bdc181cb012bc4fbb1ab272a975728f54064b7ae3ee8e77fd28c46/data
-rw-r--r-- 1 root root 524 Jan 31 23:00 /work/vol/docker/registry/v2/blobs/sha256/d2/d2b712d831f1cc89d997457109d01fb7ca4dd1d39a363d9f2f9426958a0ca44a/data
-rw-r--r-- 1 root root 562 Jan 31 23:00 /work/vol/docker/registry/v2/blobs/sha256/f1/f1f77a0f96b7251d7ef5472705624e2d76db64855b5b121e1cbefe9dc52d0f86/data
```

# Pull してみる

タグをつけたイメージを削除する
```
$ sudo docker rmi localhost:5000/hello-world:test
Untagged: localhost:5000/hello-world:test
Untagged: localhost:5000/hello-world@sha256:d2b712d831f1cc89d997457109d01fb7ca4dd1d39a363d9f2f9426958a0ca44a

$ sudo docker images
REPOSITORY    TAG       IMAGE ID       CREATED         SIZE
hello-world   latest    f1f77a0f96b7   10 days ago     5.2kB
registry      latest    d8876582179f   16 months ago   25MB
```


プルする
```
$ sudo docker pull localhost:5000/hello-world:test
test: Pulling from hello-world
Digest: sha256:d2b712d831f1cc89d997457109d01fb7ca4dd1d39a363d9f2f9426958a0ca44a
Status: Downloaded newer image for localhost:5000/hello-world:test
localhost:5000/hello-world:test

$ sudo docker images
REPOSITORY                   TAG       IMAGE ID       CREATED         SIZE
hello-world                  latest    f1f77a0f96b7   10 days ago     5.2kB
localhost:5000/hello-world   test      f1f77a0f96b7   10 days ago     5.2kB
registry                     latest    d8876582179f   16 months ago   25MB
```

# 通信の秘匿化

本稿では割愛するが、プライベートリポジトリを外においてインターネット経由で利用するなら HTTPS 化したいところ。
(気が向いたら追記する)