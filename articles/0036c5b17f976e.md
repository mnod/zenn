---
title: "Raspberry Pi OS ã§ã‚¯ãƒ©ã‚¦ãƒ‰ã‚¤ãƒ¡ãƒ¼ã‚¸ã®åˆ©ç”¨"
emoji: "ğŸ‘»"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["cloud-init", "raspberrypi", "kvm", "libvirt"]
published: true
---

# ã¯ã˜ã‚ã«

OSã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¯é€šå¸¸ã ã¨ã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ¡ãƒ‡ã‚£ã‚¢ã‚’æŒ¿å…¥ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’é€²ã‚ã‚‹å½¢ã«ãªã‚Šã¾ã™ã€‚
ä»®æƒ³ç’°å¢ƒã§ã‚‚åŒæ§˜ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«CDãƒ¡ãƒ‡ã‚£ã‚¢ã‹ã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã¨ã„ã†ã®ãŒæ™®é€šã§ã—ãŸãŒã€æœ€è¿‘ã§ã¯OSã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã®ä»®æƒ³ãƒ‡ã‚£ã‚¹ã‚¯ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒé…å¸ƒã•ã‚Œã¦ã„ã¾ã™ã€‚
ã“ã†ã„ã£ãŸä»®æƒ³ãƒ‡ã‚£ã‚¹ã‚¯ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯ã€ã‚¯ãƒ©ã‚¦ãƒ‰ã‚¤ãƒ¡ãƒ¼ã‚¸ã¨å‘¼ã°ã‚Œã¦ã„ã¾ã™ã€‚ã“ã¡ã‚‰ã‚’åˆ©ç”¨ã™ã‚‹ã¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®æ‰‹é–“ã‚’çœã„ã¦æ‰‹ã£å–ã‚Šæ—©ãä»®æƒ³ç’°å¢ƒã‚’ç”¨æ„ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ã‚¯ãƒ©ã‚¦ãƒ‰ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯(å¿…è¦ãªè¨­å®šãŒã•ã‚Œã¦ãŠã‚Š)ã€cloud-init ã¨ã„ã†ä»•çµ„ã¿ã§åˆæœŸè¨­å®šã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

ã“ã“ã§ã¯ã€ã‚¯ãƒ©ã‚¦ãƒ‰ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ cloud-init ã‚’å‹•ã‹ã—ã¦ã¿ã¾ã™ã€‚

# å‚è€ƒ
https://gihyo.jp/admin/serial/01/ubuntu-recipe/0565
https://cloudinit.readthedocs.io/en/latest/index.html
https://blog.programster.org/create-debian-12-kvm-guest-from-cloud-image


# ç’°å¢ƒ

https://zenn.dev/mnod/articles/ed212df5a8786f ã®ç’°å¢ƒã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

## ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ã‚¯ãƒ©ã‚¦ãƒ‰ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ cloud-init ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã€åˆæœŸè¨­å®šã—ãŸã„å†…å®¹ã‚’å«ã‚“ã æ‰€å®šã®å½¢å¼ã® iso ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ cdrom ã¨ã—ã¦ãƒã‚¦ãƒ³ãƒˆã—ã¾ã™ã€‚
ã“ã® iso ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ç°¡å˜ã«ä½œã‚‹ãŸã‚ã«ã€å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```
$ sudo apt install --no-install-recommends cloud-utils
```

# ã‚¯ãƒ©ã‚¦ãƒ‰ã‚¤ãƒ¡ãƒ¼ã‚¸ã®å…¥æ‰‹

ä¾‹ã¨ã—ã¦Debianã€‚
Debianã®å…¬å¼ https://cloud.debian.org/images/cloud/ ã‹ã‚‰Cloudã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å–å¾—ã—ã¾ã™ã€‚

```
$ sudo curl -L https://cloud.debian.org/images/cloud/bookworm/latest/debian-12-genericcloud-arm64.qcow2 -o debian-12-genericcloud-arm64.qcow2

$ ls -l /media/work/libvirt/images/debian-12-genericcloud-arm64.qcow2
-rw-r--r-- 1 root root 333499392 Nov  4 19:50 /media/work/libvirt/images/debian-12-genericcloud-arm64.qcow2

$ qemu-img info /media/work/libvirt/images/debian-12-genericcloud-arm64.qcow2
image: /media/work/libvirt/images/debian-12-genericcloud-arm64.qcow2
file format: qcow2
virtual size: 2 GiB (2147483648 bytes)
disk size: 318 MiB
cluster_size: 65536
Format specific information:
    compat: 1.1
    compression type: zlib
    lazy refcounts: false
    refcount bits: 16
    corrupt: false
    extended l2: false
```

ç°¡å˜ã«åˆæœŸçŠ¶æ…‹ã¸æˆ»ã›ã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã¾ã™ã€‚
```
$ mv debian-12-genericcloud-arm64.qcow2 debian-12-genericcloud-arm64.qcow2.base
$ qemu-img create -f qcow2 -b debian-12-genericcloud-arm64.qcow2.base -F qcow2 debian-12-genericcloud-arm64.qcow2 2G
Formatting 'debian-12-genericcloud-arm64.qcow2', fmt=qcow2 cluster_size=65536 extended_l2=off compression_type=zlib size=2147483648 backing_file=debian-12-genericcloud-arm64.qcow2.base backing_fmt=qcow2 lazy_refcounts=off refcount_bits=16
```

# cloudinit.iso ã®ä½œæˆ

- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã‚’ä½¿ç”¨
- ã‚¯ãƒ©ã‚¦ãƒ‰ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¦ãƒ¼ã‚¶(debian)ã¨ã€rootãƒ¦ãƒ¼ã‚¶ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã™ã‚‹
- ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«ãƒ‘ã‚¹å¤‰æ›´ã‚’æ±‚ã‚ã‚‰ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹
```
$ cloud-localds cloudinit.iso <(cat <<EOF
#cloud-config
ssh_pwauth: True
chpasswd:
  expire: false
  users: 
  - name: root
    password: password
    type: text
  - name: debian
    password: password
    type: text
EOF
);
```

::: message
sudo ãŒä½¿ãˆã‚‹ã®ã§ root ãƒ¦ãƒ¼ã‚¶ã¸ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šã¯éæ¨å¥¨
:::

ä½œæˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
```
$ ls -l cloudinit.iso
-rw-r--r-- 1 pi pi 374784 Nov  6 07:41 cloudinit.iso

$ file cloudinit.iso
cloudinit.iso: ISO 9660 CD-ROM filesystem data 'cidata'

$ sudo mount cloudinit.iso /media/tmp/
mount: /media/tmp: WARNING: source write-protected, mounted read-only.

$ cat /media/tmp/meta-data
{
"instance-id": "iid-local01"
}

$ cat /media/tmp/user-data
#cloud-config
ssh_pwauth: True
chpasswd:
  expire: false
  users:
  - name: root
    password: password
    type: text
  - name: debian
    password: password
    type: text
```

# KVMã§èµ·å‹•ã™ã‚‹å ´åˆ

ã‚¯ãƒ©ã‚¦ãƒ‰ã‚¤ãƒ¡ãƒ¼ã‚¸å†…ã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ãŸã‚«ãƒ¼ãƒãƒ«ã¨åˆæœŸåŒ–RAMãƒ‡ã‚£ã‚¹ã‚¯ã‚’æŒ‡å®šã€‚ã¾ãŸ ä½œæˆã—ãŸ cloudinit.iso ã‚’ cdrom ã¨ã—ã¦åˆ©ç”¨ã€‚

```
$ sudo qemu-system-aarch64 \
 -machine virt \
 -cpu host \
 -m 1024 \
 -enable-kvm \
 -kernel debian-12-genericcloud-arm64.vmlinuz \
 -initrd debian-12-genericcloud-arm64.initrd.img \
 -append root=/dev/vdb1 \
 -cdrom cloudinit.iso \
 -drive file=debian-12-genericcloud-arm64.qcow2 \
 -net nic,macaddr=52:54:00:12:34:0 -net tap,ifname=tap1 \
 -vnc 0.0.0.0:0 \
 -daemonize
```

# virt-install ã§ä½œæˆã™ã‚‹å ´åˆ

```
$ sudo virt-install --virt-type kvm \
--features acpi=off \
--connect qemu:///system \
--name debian-12-genericcloud-arm64 \
--os-variant debian11 \
--memory 1024 \
--cdrom /media/work/libvirt/images/cloudinit.iso \
--boot kernel=/media/work/libvirt/images/debian-12-genericcloud-arm64.vmlinuz,initrd=/media/work/libvirt/images/debian-12-genericcloud-arm64.initrd.img,kernel_args='root=/dev/vda1' \
--disk /media/work/libvirt/images/debian-12-genericcloud-arm64.qcow2 \
--network network=host-bridge \
--graphics none --serial pty --console pty \
--import
```

ä»®æƒ³ãƒã‚·ãƒ³ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãŒæ¨™æº–å‡ºåŠ›ã«æ¥ç¶šã•ã‚Œã‚‹ãŒ `Ctrl + ]` ã§ãƒ‡ã‚¿ãƒƒãƒã™ã‚‹

```
Domain is still running. Installation may be in progress.
You can reconnect to the console to complete the installation process.
```

ãƒ‡ã‚¿ãƒƒãƒã—ãŸã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã¯ `virsh console` ã§æ¥ç¶šã§ãã‚‹

```
$ sudo virsh list --all
 Id   Name                           State
-----------------------------------------------
 1    debian-12-genericcloud-arm64   running
 -    debian-12.7.0-arm64            shut off

$ sudo virsh console debian-12-genericcloud-arm64
Connected to domain 'debian-12-genericcloud-arm64'
Escape character is ^] (Ctrl + ])
```


# cloud-init ã®å†…å®¹ã®ä½œæˆ(1)

duckduckgo https://duckduckgo.com/ ã® chat æ©Ÿèƒ½ã‚’åˆ©ç”¨ã—ã¦ gpt-4o mini ã«ãŠä¼ºã„ã™ã‚‹

## ãŠä¼ºã„å†…å®¹
```
cloud-localds ã‚’åˆ©ç”¨ã—ã¦cloudinit.iso ã‚’ä½œæˆã—ãŸã„ã€‚
ä»¥ä¸‹ã®å†…å®¹ã®ãƒ¦ãƒ¼ã‚¶ãƒ‡ãƒ¼ã‚¿ã€ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚³ãƒ³ãƒ•ã‚£ã‚°ã‚’ç”Ÿæˆã—ãŸã„ã€‚
YAMLã®å†…å®¹ã¨cloud-localds ã®ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‚’æ•™ãˆã¦ã€‚
- ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³JST
- ãƒ›ã‚¹ãƒˆåã¯ myhost01
- IPã‚¢ãƒ‰ãƒ¬ã‚¹ 192.168.11.101/24 ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆGW 192.168.11.254ã€DNS 192.168.11.254, 192.168.11.253
- 10.0.0.1/16 ã¸ã®ãƒã‚¯ã‚¹ãƒˆãƒ›ãƒƒãƒ—ã¯192.168.11.1
```

## ä¸‹ã•ã‚ŒãŸã”å®£è¨—

`cloud-localds` ã‚’ä½¿ç”¨ã—ã¦ `cloudinit.iso` ã‚’ä½œæˆã™ã‚‹ãŸã‚ã«ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã€ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®šã‚’å«ã‚€YAMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ä»¥ä¸‹ã«ã€å¿…è¦ãªYAMLã®å†…å®¹ã¨ `cloud-localds` ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‚’ç¤ºã—ã¾ã™ã€‚

### 1. YAMLãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ

ä»¥ä¸‹ã®å†…å®¹ã§ `user-data` ã¨ `meta-data`ã€`network-config` ã®3ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

#### user-data
```yaml
#cloud-config
timezone: Asia/Tokyo
hostname: myhost01
```

#### meta-data
```yaml
instance-id: iid-local01
local-hostname: myhost01
```

#### network-config
```yaml
version: 2
ethernets:
  eth0:
    dhcp4: no
    addresses:
      - 192.168.11.101/24
    gateway4: 192.168.11.254
    nameservers:
      addresses:
        - 192.168.11.254
        - 192.168.11.253
    routes:
      - to: 10.0.0.0/16
        via: 192.168.11.1
```

### 2. cloud-localds ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³

æ¬¡ã«ã€ä¸Šè¨˜ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¦ `cloudinit.iso` ã‚’ä½œæˆã™ã‚‹ãŸã‚ã® `cloud-localds` ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```bash
cloud-localds -v cloudinit.iso user-data meta-data network-config
```

### 3. ãƒ•ã‚¡ã‚¤ãƒ«ã®é…ç½®

ä¸Šè¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹å‰ã«ã€`user-data`ã€`meta-data`ã€`network-config` ã®å„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åŒã˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜ã—ã¦ãã ã•ã„ã€‚

ã“ã‚Œã§ã€æŒ‡å®šã•ã‚ŒãŸå†…å®¹ã® `cloudinit.iso` ãŒä½œæˆã•ã‚Œã¾ã™ã€‚

## è©¦ã—ã¦ã¿ã‚‹

å¤‰æ›´ã—ãŸã“ã¨
- ãƒ¦ãƒ¼ã‚¶ãƒ‡ãƒ¼ã‚¿ã«ã¯å‰è¿°ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šã‚’è¿½è¨˜
- åˆ©ç”¨ã™ã‚‹ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹åã¯ enp1s0 ã¨ã™ã‚‹

```
$ cloud-localds -v cloudinit.iso user-data meta-data network-config
Usage: cloud-localds [ options ] output user-data [meta-data]

confused by additional args
```
ã‚¨ãƒ©ãƒ¼ã¨ãªã£ãŸã€‚ç¾æ™‚ç‚¹ã§ã¯ã¯ã¾ã  AI ã‚’100%ä¿¡é ¼ã§ãã‚‹ã‚ã‘ã§ã¯ãªã„ã€‚

æ…Œã¦ãšé¨’ãŒãšã€ä»¥ä¸‹ã§å†å®Ÿè¡Œ
```
$ cloud-localds -v cloudinit.iso user-data meta-data -N network-config
wrote cloudinit.iso with filesystem=iso9660 and diskformat=raw
```

ä½œæˆã•ã‚ŒãŸå†…å®¹ã‚’ç¢ºèª
```
$ file cloudinit.iso
cloudinit.iso: ISO 9660 CD-ROM filesystem data 'cidata'

$ sudo mount cloudinit.iso /media/tmp
mount: /media/tmp: WARNING: source write-protected, mounted read-only.

$ cat /media/tmp/meta-data
instance-id: iid-local01
local-hostname: myhost01

$ cat /media/tmp/user-data
#cloud-config
timezone: Asia/Tokyo
hostname: myhost01
ssh_pwauth: True
chpasswd:
  expire: false
  users:
  - name: root
    password: password
    type: text
  - name: debian
    password: password
    type: text

$ cat /media/tmp/network-config
version: 2
ethernets:
  enp1s0:
    dhcp4: no
    addresses:
      - 192.168.11.101/24
    gateway4: 192.168.11.254
    nameservers:
      addresses:
        - 192.168.11.254
        - 192.168.11.253
    routes:
      - to: 10.0.0.0/16
        via: 192.168.11.1

$ sudo umount /media/tmp
```

å‰è¿°ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ virt-install ã‚’å®Ÿè¡Œã—ã¦ã€çµæœã‚’ç¢ºèªã™ã‚‹ã€‚ 

- æ‰€å®šã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ debian ãƒ¦ãƒ¼ã‚¶ã§ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹
- ãƒ›ã‚¹ãƒˆåãŒæ‰€å®šã®ã‚‚ã®ã«å¤‰ã‚ã£ã¦ã„ã‚‹
- ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ãŒJSTã«ãªã£ã¦ã„ã‚‹
- ip ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒæ‰€å®šã®ã‚‚ã®ã«ãªã£ã¦ã„ã‚‹
- æŒ‡å®šã—ãŸã¨ãŠã‚Šãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹
- æŒ‡å®šã—ãŸã¨ãŠã‚Šåå‰è§£æ±ºãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹
- æ‰€å®šã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ root ãƒ¦ãƒ¼ã‚¶ã§ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹
```
$ id
uid=1000(debian) gid=1000(debian) groups=1000(debian),4(adm),20(dialout),24(cdrom),25(floppy),27(sudo),29(audio),30(dip),44(video),46(plugdev)

$ hostname
myhost01

$ date
Sun Nov 10 07:58:12 JST 2024


$ ip a show enp1s0
2: enp1s0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 52:54:00:44:23:67 brd ff:ff:ff:ff:ff:ff
    inet 192.168.11.101/24 brd 192.168.11.255 scope global enp1s0
       valid_lft forever preferred_lft forever
    inet6 2405:6580:d400:2900:5054:ff:fe44:2367/64 scope global dynamic mngtmpaddr noprefixroute
       valid_lft 86388sec preferred_lft 14388sec
    inet6 fe80::5054:ff:fe44:2367/64 scope link
       valid_lft forever preferred_lft forever

$ ip route
default via 192.168.11.254 dev enp1s0 proto static
10.0.0.0/16 via 192.168.11.1 dev enp1s0 proto static
192.168.11.0/24 dev enp1s0 proto kernel scope link src 192.168.11.101

$ cat /etc/resolv.conf
ï¼š
ï¼š
nameserver 192.168.11.254
nameserver 192.168.11.253
search .

$ host www.yahoo.co.jp
www.yahoo.co.jp is an alias for edge12.g.yimg.jp.
edge12.g.yimg.jp has address 183.79.249.252

$ su -
Password:
# id
uid=0(root) gid=0(root) groups=0(root)
```


ãªãŠã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®šã¯ netplan ãŒåˆ©ç”¨ã•ã‚Œã¦ã„ã‚‹ã€‚
```
$ ls -l /etc/netplan/50-cloud-init.yaml
-rw-r--r-- 1 root root 688 Nov 10 07:57 /etc/netplan/50-cloud-init.yaml

$ cat /etc/netplan/50-cloud-init.yaml
# This file is generated from information provided by the datasource.  Changes
# to it will not persist across an instance reboot.  To disable cloud-init's
# network configuration capabilities, write a file
# /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:
# network: {config: disabled}
network:
    ethernets:
        enp1s0:
            addresses:
            - 192.168.11.101/24
            dhcp4: false
            gateway4: 192.168.11.254
            nameservers:
                addresses:
                - 192.168.11.254
                - 192.168.11.253
            routes:
            -   to: 10.0.0.0/16
                via: 192.168.11.1
    version: 2
```

cloud-init é–¢é€£ã®ãƒ­ã‚°ã¯ä¸‹è¨˜ã€‚
```
$ ls -l /var/log/cloud-init*
-rw-r----- 1 root adm  5452 Nov 10 07:57 /var/log/cloud-init-output.log
-rw-r--r-- 1 root adm 90888 Nov 10 07:57 /var/log/cloud-init.log
````

# cloud-init ã®å†…å®¹ã®ä½œæˆ(2)

CAè¨¼æ˜æ›¸ã‚’åˆ©ç”¨ã—ãŸsshdè¨­å®š

## ä»®æƒ³ãƒã‚·ãƒ³ä½œæˆ

ä»¥ä¸‹ã®å†…å®¹ã§ cloudinit.iso ã‚’ä½œæˆã—ã¦ã€virt-install ã§ä»®æƒ³ãƒã‚·ãƒ³ä½œæˆ

```:/media/tmp/meta-data
instance-id: iid-local01
local-hostname: myhost01
```

```:/media/tmp/user-data
#cloud-config
timezone: Asia/Tokyo
hostname: ${local-hostname}

write_files:
  - path: /etc/ssh/ca_key
    content: |
      -----BEGIN OPENSSH PRIVATE KEY-----
      (çœç•¥)
      -----END OPENSSH PRIVATE KEY-----
    owner: root:root
    permissions: '0600'

  - path: /etc/ssh/ca_cert.pub
    content: |
      (çœç•¥)
    owner: root:root
    permissions: '0644'

runcmd:
  - |
    CA_KEY="/etc/ssh/ca_key"
    ssh-keygen -s ${CA_KEY} -I $(hostname) -h /etc/ssh/ssh_host_ed25519_key.pub
    echo "TrustedUserCAKeys /etc/ssh/ca_cert.pub" >> /etc/ssh/sshd_config
    echo "HostCertificate /etc/ssh/ssh_host_ed25519_key-cert.pub" >> /etc/ssh/sshd_config
    sed -i -e '/#PasswordAuthentication/ s/.*/PasswordAuthentication no/' /etc/ssh/sshd_config
    systemctl restart sshd
```

```:/media/tmp/network-config
version: 2
ethernets:
  enp1s0:
    dhcp4: no
    addresses:
      - 192.168.11.101/24
    gateway4: 192.168.11.254
    nameservers:
      addresses:
        - 192.168.11.254
        - 192.168.11.253
    routes:
      - to: 10.0.0.0/16
        via: 192.168.11.1
```

## ssh ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®è¨­å®š




ä»¥ä¸‹ã§CAç§˜å¯†éµã§sshã‚­ãƒ¼ã«ç½²åã€‚ç½²åã—ãŸãƒ¦ãƒ¼ã‚¶è¨¼æ˜æ›¸ã¨sshã‚­ãƒ¼ã‚’ssh ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®
```
$ ssh-keygen -s ca.key -I certificate-test -n debian -z $(date +%Y%m%d%H%M) -V +365d id_ed25519
```

CAå…¬é–‹éµã®æƒ…å ±ã§ ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã« known_hosts ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
```
$ echo "@cert-authority 192.168.11.* $(cat ca.key.pub)" >> known_hosts
```

ssh config ã‚’ä½œæˆ
```
Host myalias
    HostName 192.168.11.101
    User debian
    IdentityFile ./id_ed25519
    UserKnownHostsFile ./known_hosts
```

æ¥ç¶šãƒ†ã‚¹ãƒˆ
```
$ ssh -v -F config myalias

:
debug1: Server host certificate: ssh-ed25519-cert-v01@openssh.com SHA256:Yx/G3La3/ckdOIprHoUyQIBoRM2rwGrWJMqfq+Kxwmw, serial 0 ID "myhost01" CA ssh-ed25519 SHA256:p12hRLK8xDAv+ArfcrZS1loLBUXkTC3JRtlRyYZvpwQ valid forever
:
debug1: Host '192.168.11.101' is known and matches the ED25519-CERT host certificate.
debug1: Found CA key in ./known_hosts:1
:
debug1: Offering public key: ./id_ed25519 ED25519-CERT SHA256:tPR4rIIfnnh7gHp9sqNnrDGv2nukqx8QwlS2SxTC1Os explicit
debug1: Server accepts key: ./id_ed25519 ED25519-CERT SHA256:tPR4rIIfnnh7gHp9sqNnrDGv2nukqx8QwlS2SxTC1Os explicit
:

```


ã‚µãƒ¼ãƒä¸Šã§ãƒ­ã‚°ç¢ºèª
```
$ journalctl -u ssh:
:
Nov 10 17:21:52 myhost01 sshd[588]: Accepted publickey for debian from 192.168.11.250 port 45000 ssh2: ED25519-CERT SHA256:tPR4rIIfnnh7gHp9sqNnrDGv2nukqx8QwlS2SxTC1Os ID certificate-test (serial 202411100738) CA ED25519 SHA256:p12hRLK8x>
:
```



# FreeBSD

FreeBSDã§ã‚‚qcow2ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒé…å¸ƒã•ã‚Œã¦ã„ã‚‹ã€‚arm64ç‰ˆã§ã¯æ®‹å¿µãªãŒã‚‰ã€€cloud-init ã«ã¯å¯¾å¿œã—ã¦ã„ãªã„ã‚ˆã†ã ã€‚
è©¦ã—ã¦ã„ãªã„ãŒ amd64ç‰ˆ ã§ã¯ cloud-init å¯¾å¿œã®ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒé…å¸ƒã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã ã€‚

## ã‚¯ãƒ©ã‚¦ãƒ‰ã‚¤ãƒ¡ãƒ¼ã‚¸ã®å…¥æ‰‹

FreeBSDã®å…¬å¼ https://download.freebsd.org/releases/VM-IMAGES/ ã‹ã‚‰Cloudã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å–å¾—ã—ã¾ã™ã€‚
ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’å±•é–‹ã—ã¾ã™ã€‚
```
$ ls -l FreeBSD-14.1-RELEASE-arm64-aarch64.qcow2
-rw-r--r-- 1 pi pi 770752572 Nov 16 10:08 FreeBSD-14.1-RELEASE-arm64-aarch64.qcow2.xz

$ xz -d FreeBSD-14.1-RELEASE-arm64-aarch64.qcow2.xz
$ ls -l FreeBSD-14.1-RELEASE-arm64-aarch64.qcow2
-rw-r--r-- 1 pi pi 3526492160 Nov 16 10:08 FreeBSD-14.1-RELEASE-arm64-aarch64.qcow2
```

ç°¡å˜ã«åˆæœŸçŠ¶æ…‹ã¸æˆ»ã›ã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã¾ã™ã€‚
```
$ mv FreeBSD-14.1-RELEASE-arm64-aarch64.qcow2 FreeBSD-14.1-RELEASE-arm64-aarch64.qcow2.base

$ qemu-img create -f qcow2 -b FreeBSD-14.1-RELEASE-arm64-aarch64.qcow2.base -F qcow2 FreeBSD-14.1-RELEASE-arm64-aarch64.qcow2 16G
Formatting 'FreeBSD-14.1-RELEASE-arm64-aarch64.qcow2', fmt=qcow2 cluster_size=65536 extended_l2=off compression_type=zlib size=17179869184 backing_file=FreeBSD-14.1-RELEASE-arm64-aarch64.qcow2.base backing_fmt=qcow2 lazy_refcounts=off refcount_bits=16

$ qemu-img info FreeBSD-14.1-RELEASE-arm64-aarch64.qcow2
image: FreeBSD-14.1-RELEASE-arm64-aarch64.qcow2
file format: qcow2
virtual size: 16 GiB (17179869184 bytes)
disk size: 196 KiB
cluster_size: 65536
backing file: FreeBSD-14.1-RELEASE-arm64-aarch64.qcow2.base
backing file format: qcow2
Format specific information:
    compat: 1.1
    compression type: zlib
    lazy refcounts: false
    refcount bits: 16
    corrupt: false
    extended l2: false
```



## ä»®æƒ³ãƒã‚·ãƒ³ã‚’èµ·å‹•
```
$ sudo qemu-system-aarch64 \
-machine virt \
-cpu host \
-enable-kvm \
-m 2048 \
-drive file=libvirt/cloudinit.iso.orig,media=cdrom -boot c \
-device virtio-blk,drive=sda -drive id=sda,if=none,format=qcow2,file=iso/FreeBSD-14.1-RELEASE-arm64-aarch64.qcow2 \
-device virtio-net,netdev=net0,mac=52:54:00:12:34:12 -netdev tap,id=net0,script=/etc/qemu-ifup,downscript=/etc/qemu-ifdown,ifname=tap2 \
-bios /usr/share/qemu-efi-aarch64/QEMU_EFI.fd \
-vnc 0.0.0.0:2 -daemonize
```
