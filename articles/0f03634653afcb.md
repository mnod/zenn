---
title: "step-ca ã§è‡ªå‰è¨¼æ˜æ›¸ã‚’ä½¿ã†"
emoji: "ğŸ‚"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["step-ca", "openssl"]
published: true
---

# æ¦‚ç•¥

ä»–ã§åˆ©ç”¨ã—ã¦ã„ãŸè‡ªå‰ã® CAè¨¼æ˜æ›¸ã€ä¸­é–“CAè¨¼æ˜æ›¸ã‚’ step-ca ã«æŒã¡è¾¼ã‚“ã§åˆ©ç”¨ã—ã¾ã™ã€‚
CAã®ç§˜å¯†éµã‚’æŒã¤ã¹ãã‹ã€æŒã¤ã“ã¨ãŒã§ãã‚‹ã‹ã€‚
ä¸­é–“è¨¼è¨¼æ˜æ›¸ã®ç§˜å¯†éµã‚’ãƒ›ã‚¹ãƒˆé–“ã§è»¢é€ã™ã‚‹ã“ã¨ã‚’è¨±å®¹ã§ãã‚‹ã‹ãªã©ã®è¦ä»¶ã§ã€
ã„ãã¤ã‹ã®æ‰‹é †ã‹ã‚‰é¸æŠã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

# å‚è€ƒ

https://smallstep.com/docs/tutorials/intermediate-ca-new-ca/


# ç’°å¢ƒ

ç’°å¢ƒã¯ https://zenn.dev/mnod/articles/1864e73b736569 ã¨åŒç­‰ã€‚

å¿…è¦ã¨ãªã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’è¿½åŠ ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```
# apk add openssl openssh-keygen jq
```

é©å½“ãªSSHè¨¼æ˜æ›¸ã‚’ä½œæˆ
ssh-keygen -q -t ed25519 -f ca.key



# The Easy Way

https://smallstep.com/docs/tutorials/intermediate-ca-new-ca/#the-easy-way

è‡ªå‰ã®CAè¨¼æ˜æ›¸ã¨ç§˜å¯†éµã‚’æŒã¡è¾¼ã‚“ã§åˆ©ç”¨ã—ã¾ã™ã€‚
step-ca ä¸Šã§æ–°è¦ä¸­é–“CAã‚’ä½œæˆã—ã¦åˆ©ç”¨ã—ã¾ã™ã€‚


## è‡ªå‰CAè¨¼æ˜æ›¸ã‚’ä½œæˆ

é©å½“ãªCAè¨¼æ˜æ›¸ã‚’ä½œæˆã™ã‚‹

```
openssl dgst -sha1 /proc/meminfo  > rand.dat
openssl genrsa -rand rand.dat -out cakey.pem 4096
openssl req -new -sha256 -key cakey.pem -out cacsr.csr -subj '/C=JP/ST=Tokyo/O=my organization/CN=my root ca'
openssl req -x509 -sha256 -days 3650 -key cakey.pem -in cacsr.csr -out cacert.cer
```

## åˆæœŸåŒ–

æŒã¡è¾¼ã¿CAã§ step-ca ã‚’åˆæœŸåŒ–ã™ã‚‹

```
# step ca init --root=./cacert.cer --key=./cakey.pem
_ Deployment Type: Standalone
What would you like to name your new PKI?
_ (e.g. Smallstep): test-ca
What DNS names or IP addresses will clients use to reach your CA?
_ (e.g. ca.example.com[,10.1.2.3,etc.]): 127.0.0.1_
What IP and port will your new CA bind to? (:443 will bind to 0.0.0.0:443)
_ (e.g. :443 or 127.0.0.1:443): :443
What would you like to name the CA's first provisioner?
_ (e.g. you@smallstep.com): test@example.com
Choose a password for your CA keys and first provisioner.
_ [leave empty and we'll generate one]:

Copying root certificate... done!
Generating intermediate certificate... done!

_ Root certificate: /root/.step/certs/root_ca.crt
_ Root private key: /root/.step/secrets/root_ca_key
_ Root fingerprint: d457ca067a7676e1c56b9b5821bb7842ff2e3ba7d2a20995e9483b008f7cdf54
_ Intermediate certificate: /root/.step/certs/intermediate_ca.crt
_ Intermediate private key: /root/.step/secrets/intermediate_ca_key
_ Database folder: /root/.step/db
_ Default configuration: /root/.step/config/defaults.json
_ Certificate Authority configuration: /root/.step/config/ca.json

Your PKI is ready to go. To generate certificates for individual services see 'step help ca'.

FEEDBACK __ __
  The step utility is not instrumented for usage statistics. It does not phone
  home. But your feedback is extremely valuable. Any information you can provide
  regarding how you_re using `step` helps. Please send us a sentence or two,
  good or bad at feedback@smallstep.com or join GitHub Discussions
  https://github.com/smallstep/certificates/discussions and our Discord
  https://u.step.sm/discord.
```

## èµ·å‹•

step-ca ã‚’èµ·å‹•ã™ã‚‹

```
# echo password >> ~/.step/config/.incapassword
# chmod 600 ~/.step/config/.incapassword

# step-ca --password-file ~/.step/config/.incapassword ~/.step/config/ca.json
```

## ç¢ºèª

åˆ©ç”¨ã—ã¦ã„ã‚‹CAè¨¼æ˜æ›¸ã¯ã€æŒã¡è¾¼ã‚“ã CAã«ãªã£ã¦ã„ã‚‹

```
# step ca root | openssl x509 -noout -dates -issuer -subject
notBefore=Dec 24 23:21:26 2024 GMT
notAfter=Dec 22 23:21:26 2034 GMT
issuer=C = JP, ST = Tokyo, O = my organization, CN = my root ca
subject=C = JP, ST = Tokyo, O = my organization, CN = my root ca


# openssl x509 -in cacert.cer -noout -dates -issuer -subject
notBefore=Dec 24 23:21:26 2024 GMT
notAfter=Dec 22 23:21:26 2034 GMT
issuer=C = JP, ST = Tokyo, O = my organization, CN = my root ca
subject=C = JP, ST = Tokyo, O = my organization, CN = my root ca
```

ä½œæˆã•ã‚ŒãŸä¸­é–“CAè¨¼æ˜æ›¸ã‚’ç¢ºèªã™ã‚‹ã¨ã€æŒã¡è¾¼ã‚“ã CAè¨¼æ˜æ›¸ã§ç½²åã•ã‚Œã¦ã„ã‚‹ã€‚
```
# step certificate inspect ~/.step/certs/intermediate_ca.crt --short
X.509v3 Intermediate CA Certificate (ECDSA P-256) [Serial: 2469...3215]
  Subject:     test-ca Intermediate CA
  Issuer:      my root ca
  Valid from:  2024-12-25T23:15:13Z
          to:  2034-12-23T23:15:13Z
```


# The Medium Way

https://smallstep.com/docs/tutorials/intermediate-ca-new-ca/#the-medium-way


init ã™ã‚‹ã¨è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã‚‹ã€‚
rootã®ç¤ºã™ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒã¡è¾¼ã¿CAè¨¼æ˜æ›¸ã«ã€
crtã®ç¤ºã™ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒã¡è¾¼ã¿ä¸­é–“CAè¨¼æ˜æ›¸ã«ã€
keyã®ç¤ºã™ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒã¡è¾¼ã¿ä¸­é–“CAè¨¼æ˜æ›¸ã®ç§˜å¯†éµã«
ç½®ãæ›ãˆã‚‹ã€‚

æŒã¡è¾¼ã‚“ã ä¸­é–“CAè¨¼æ˜æ›¸ã‚’åˆ©ç”¨ã™ã‚‹ã®ã§ã€CAè¨¼æ˜æ›¸ã®ç§˜å¯†éµã¯ä¸è¦ã€‚

```
# jq .root .step/config/ca.json
"/root/.step/certs/root_ca.crt"

# jq .crt .step/config/ca.json
"/root/.step/certs/intermediate_ca.crt"

# jq .key .step/config/ca.json
"/root/.step/secrets/intermediate_ca_key"
```

ã“ã“ã§ã¯ The Easy Way ã«ç¶šã‘ã¦æ¤œè¨¼ã—ã¦ã„ã‚‹ã®ã§ã€CAè¨¼æ˜æ›¸ã®ç½®ãæ›ãˆã¯å‰²æ„›ã€‚

## ä¸­é–“CAè¨¼æ˜æ›¸ã‚’ä½œæˆ

é©å½“ãªä¸­é–“CAè¨¼æ˜æ›¸ã‚’ä½œæˆã™ã‚‹

```
openssl dgst -sha1 /proc/meminfo  > rand.dat
openssl genrsa -rand rand.dat -out inca.pem 2048
openssl req -new -sha256 -key inca.pem -out inca.csr -subj '/C=JP/ST=Tokyo/O=my organization/CN=my intermediate ca'
echo basicConstraints=CA:TRUE > v3ext.txt
openssl x509 -req -days 365 -in inca.csr -extfile v3ext.txt -CA cacert.cer -CAkey cakey.pem -CAcreateserial -out inca.cer
```

## ä¸­é–“CAè¨¼æ˜æ›¸ã€ç§˜å¯†éµã®ç½®ãæ›ãˆ

ä¸­é–“CAè¨¼æ˜æ›¸ã‚’ç½®ãæ›ãˆã‚‹ã€‚

```
# cp -pi /root/.step/certs/intermediate_ca.crt /root/.step/certs/intermediate_ca.crt.old
# cp -pi inca.cer /root/.step/certs/intermediate_ca.crt
cp: overwrite '/root/.step/certs/intermediate_ca.crt'? y

# openssl x509 -in /root/.step/certs/intermediate_ca.crt -noout -subject -issuer -modulus
subject=C = JP, ST = Tokyo, O = my organization, CN = my intermediate ca
issuer=C = JP, ST = Tokyo, O = my organization, CN = my root ca
Modulus=E2228220183950633369901CBCE3F25A0CEF5D45D4D8456B0A84D4989B46F4EC2656C495F9C6506D5F5829C63F5EBB06DC7E227DACC7D8299EB993C76C56A9168B7DDDD4C846648BAF50E088A46E88845B4417FAF486362B4EDA1BC10320F3627C0A0573E5D6B82FCEBB55A15B4D436DB66DEBA02915952494A0D4B4EEAAFA69DAFF9E3715735B5AF1467A57B4B0AA81665EA009A8ECC5601E03EE1478A0626A4516FAC675670C5DC4B68F8578F2169A370B79E39B987C049103CABA2040689B29C967CB6DBE14E12B757200CE741582CAF226360494CE8472192F8FB09C5D919E78C1A9A80A6A43E52920A88C03CD4A644D2BEAF7384C0DCD0DEB50E5F09873
```

ä¸­é–“CAè¨¼æ˜æ›¸ç§˜å¯†éµã‚’ç½®ãæ›ãˆã‚‹ã€‚

```
# cp -pi /root/.step/secrets/intermediate_ca_key /root/.step/secrets/intermediate_ca_key.old
# cp -pi inca.pem /root/.step/secrets/intermediate_ca_key
cp: overwrite '/root/.step/secrets/intermediate_ca_key'? y

# openssl rsa -in /root/.step/secrets/intermediate_ca_key -noout -modulus
Modulus=E2228220183950633369901CBCE3F25A0CEF5D45D4D8456B0A84D4989B46F4EC2656C495F9C6506D5F5829C63F5EBB06DC7E227DACC7D8299EB993C76C56A9168B7DDDD4C846648BAF50E088A46E88845B4417FAF486362B4EDA1BC10320F3627C0A0573E5D6B82FCEBB55A15B4D436DB66DEBA02915952494A0D4B4EEAAFA69DAFF9E3715735B5AF1467A57B4B0AA81665EA009A8ECC5601E03EE1478A0626A4516FAC675670C5DC4B68F8578F2169A370B79E39B987C049103CABA2040689B29C967CB6DBE14E12B757200CE741582CAF226360494CE8472192F8FB09C5D919E78C1A9A80A6A43E52920A88C03CD4A644D2BEAF7384C0DCD0DEB50E5F09873
```


## default.json ã®ç¢ºèª

å…¬å¼ã‚µã‚¤ãƒˆã§ã¯ `step ca bootstrap` ã‚’å®Ÿè¡Œã›ã‚ˆã¨ã‚ã‚‹ãŒã€default.json ã®å†…å®¹ã«é½Ÿé½¬ã¯ãªã„ã‹ã‚‰å‰²æ„›ã™ã‚‹ã€‚

```
# openssl x509 -in cacert.cer -sha256 -fingerprint -noout | awk -F= '{print $2}' | tr -d ':' | tr [:upper:] [:lower:]
d457ca067a7676e1c56b9b5821bb7842ff2e3ba7d2a20995e9483b008f7cdf54

# jq . /root/.step/config/defaults.json
{
  "ca-url": "https://127.0.0.1",
  "ca-config": "/root/.step/config/ca.json",
  "fingerprint": "d457ca067a7676e1c56b9b5821bb7842ff2e3ba7d2a20995e9483b008f7cdf54",
  "root": "/root/.step/certs/root_ca.crt"
}
```

## step-ca å†èµ·å‹•
```
# killall step-ca
# step-ca --password-file ~/.step/config/.incapassword ~/.step/config/ca.json

```

## ç¢ºèª

è¨¼æ˜æ›¸ã‚’ç™ºè¡Œã—ã¦ã¿ã‚‹ã€‚
ç™ºè¡Œã•ã‚ŒãŸè¨¼æ˜æ›¸ã¯ã€æŒã¡è¾¼ã‚“ã ä¸­é–“è¨¼æ˜æ›¸ã‹ã‚‰ç½²åã•ã‚Œã¦ã„ã‚‹ã€‚

```
# step ca certificate test-server test-server.crt test-server.key
_ Provisioner: test@example.com (JWK) [kid: Fkio0ONp-CzUk1Z7PZnbpTh9z7mu-uwqcOSHYzVXHAQ]
Please enter the password to decrypt the provisioner key:
_ CA: https://127.0.0.1
_ Certificate: test-server.crt
_ Private Key: test-server.key

# ls -l test-server.crt
-rw-------    1 root     root          2603 Dec 26 23:10 test-server.crt

# step certificate inspect test-server.crt --short
X.509v3 TLS Certificate (ECDSA P-256) [Serial: 7949...1299]
  Subject:     test-server
  Issuer:      my intermediate ca
  Provisioner: test@example.com [ID: Fkio...XHAQ]
  Valid from:  2024-12-26T23:09:46Z
          to:  2024-12-27T23:10:46Z
```




# The Secure Way

https://smallstep.com/docs/tutorials/intermediate-ca-new-ca/#the-secure-way

step-ca ä¸Šã§CSRã‚’ä½œæˆã—ã¦ã€CAã§ç½²åã—ã¦ã‚‚ã‚‰ã†ã€‚
CAã‹ã‚‰ä¸­é–“è¨¼æ˜æ›¸ã‚’å—ã‘å–ã£ã¦ã€step-ca ã§åˆ©ç”¨ã™ã‚‹ã¨ã„ã†æ–¹æ³•ã€‚
CAã®ç§˜å¯†éµã¯åˆ©ç”¨ã—ãªã„ã€‚ä¸­é–“è¨¼æ˜æ›¸ã®ç§˜å¯†éµã®è»¢é€ã¯ã—ãªã„ã€‚

ã“ã“ã§ã¯ã€ä¸Šã® The Medium Way ã®ç¶šãã§æ¤œè¨¼ã—ã¦ã„ã‚‹ã€‚

## CSRä½œæˆ

ä¸­é–“è¨¼æ˜æ›¸ã®CSRã‚’ä½œæˆã™ã‚‹ã€‚

```
# step certificate create "my intermediate ca" inca2.csr inca2.key --csr
Please enter the password to encrypt the private key:
Your certificate signing request has been saved in inca2.csr.
Your private key has been saved in inca2.key.

# openssl req -in inca2.csr -text -noout
Certificate Request:
    Data:
        Version: 1 (0x0)
        Subject: CN = my intermediate ca2
        Subject Public Key Info:
            Public Key Algorithm: id-ecPublicKey
                Public-Key: (256 bit)
                pub:
                    04:c7:b4:7b:c8:26:d9:36:56:27:70:88:d3:2b:47:
                    d2:37:e1:47:70:ca:c3:4c:17:0c:ad:02:a5:fe:89:
                    28:7e:6d:45:94:dd:d9:81:f4:16:79:c4:45:85:1c:
                    c2:8f:44:14:29:30:c0:c4:da:24:5e:b7:f2:bb:d2:
                    cb:3a:3e:6e:48
                ASN1 OID: prime256v1
                NIST CURVE: P-256
        Attributes:
        Requested Extensions:
            X509v3 Subject Alternative Name:
                DNS:my intermediate ca2
    Signature Algorithm: ecdsa-with-SHA256
         30:45:02:21:00:bc:49:9d:78:67:22:b2:72:46:16:b0:b6:5a:
         52:7a:08:48:04:46:d2:e1:5a:bf:3e:fe:9d:40:88:77:39:9e:
         7a:02:20:33:79:9a:0f:99:bc:0c:a5:ff:1a:5d:85:0f:3f:94:
         72:a9:46:76:24:1e:cb:0a:cc:a3:bd:11:d0:de:99:c8:88
```


## CAã§ç½²å

openssl ã‚³ãƒãƒ³ãƒ‰ã§ç½²åã™ã‚‹
```
# openssl x509 -req -days 365 -in inca2.csr -extfile v3ext.txt -CA cacert.cer -CAkey cakey.pem -CAcreateserial -out inca2.cer
Signature ok
subject=CN = my intermediate ca2
Getting CA Private Key

# step certificate inspect inca2.cer --short
X.509v3 Intermediate CA Certificate (ECDSA P-256) [Serial: 3870...8906]
  Subject:     my intermediate ca2
  Issuer:      my root ca
  Valid from:  2024-12-26T23:24:52Z
          to:  2025-12-26T23:24:52Z
```

å‚è€ƒã¾ã§ã« step-ca ã§ã®ç½²åã‚³ãƒãƒ³ãƒ‰ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ãªã‚‹ã€‚
(CAè¨¼æ˜æ›¸ã«ã¯ `keyCertSign usage` ãŒå¿…è¦)

```
# step certificate sign --profile intermediate-ca inca2.csr cacert.cer cakey.pem
```


## ä¸­é–“CAè¨¼æ˜æ›¸ã€ç§˜å¯†éµã®ç½®ãæ›ãˆ

```
# cp -pi inca2.cer /root/.step/certs/intermediate_ca.crt
cp: overwrite '/root/.step/certs/intermediate_ca.crt'? y
# cp -pi inca2.key /root/.step/secrets/intermediate_ca_key
cp: overwrite '/root/.step/secrets/intermediate_ca_key'? y
```

## step-ca å†èµ·å‹•

```
# killall step-ca
# step-ca --password-file ~/.step/config/.incapassword ~/.step/config/ca.json

```

## ç¢ºèª

è¨¼æ˜æ›¸ã‚’ç™ºè¡Œã—ã¦ã¿ã‚‹ã€‚
ç™ºè¡Œã•ã‚ŒãŸè¨¼æ˜æ›¸ã¯ã€CSRã‹ã‚‰ä½œæˆã—ãŸä¸­é–“è¨¼æ˜æ›¸ã‹ã‚‰ç½²åã•ã‚Œã¦ã„ã‚‹ã€‚

```
# step ca certificate another-server another-server.crt another-server.key
_ Provisioner: test@example.com (JWK) [kid: Fkio0ONp-CzUk1Z7PZnbpTh9z7mu-uwqcOSHYzVXHAQ]
Please enter the password to decrypt the provisioner key:
_ CA: https://127.0.0.1
_ Certificate: another-server.crt
_ Private Key: another-server.key

# step certificate inspect another-server.crt --short
X.509v3 TLS Certificate (ECDSA P-256) [Serial: 1386...4214]
  Subject:     another-server
  Issuer:      my intermediate ca2
  Provisioner: test@example.com [ID: Fkio...XHAQ]
  Valid from:  2024-12-26T23:32:14Z
          to:  2024-12-27T23:33:14Z
```
