---
title: "Debian11 ã§ KVM"
emoji: "ğŸƒ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["debian","kvm"]
published: true
---

# ç’°å¢ƒã«ã¤ã„ã¦

Debian11ã®ç’°å¢ƒã§ã€KVM ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€ä»®æƒ³ãƒã‚·ãƒ³ã®ä½œæˆã‚’ã—ã¦ã¿ã¾ã™ã€‚

# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

APTãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```
# apt install --no-install-recommends qemu-kvm qemu-utils
```

# ä»®æƒ³ãƒã‚·ãƒ³ã®ä½œæˆ

ã“ã“ã§ã¯ä¾‹ã¨ã—ã¦ã€Rocky Linux 9.1 ã®ä»®æƒ³ãƒã‚·ãƒ³ã‚’ä½œæˆã—ã¾ã™ã€‚
ä»®æƒ³ãƒã‚·ãƒ³ã®å°å…¥ã«ã¯ Rocky-9.1-x86_64-minimal.iso ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

## ä»®æƒ³ãƒ‡ã‚£ã‚¹ã‚¯ä½œæˆ

```
# qemu-img create -f qcow2 Rocky-9.1-x86_64-minimal.qcow2 8G
Formatting 'Rocky-9.1-x86_64-minimal.qcow2', fmt=qcow2 cluster_size=65536 extended_l2=off compression_type=zlib size=8589934592 lazy_refcounts=off refcount_bits=16

# ls -ls Rocky-9.1-x86_64-minimal.qcow2
196 -rw-r--r-- 1 root root 196736 Feb 13 04:55 Rocky-9.1-x86_64-minimal.qcow2
```

## ä»®æƒ³ãƒ–ãƒªãƒƒã‚¸

é€šå¸¸ã ã¨Linuxæ¨™æº–ãƒ–ãƒªãƒƒã‚¸ã‚’åˆ©ç”¨ã™ã‚‹ã¨ã“ã‚ã§ã™ãŒã€ã“ã“ã§ã¯ Open vSwitch ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚
ä½œæˆã«ã¤ã„ã¦ã¯ https://zenn.dev/mnod/articles/c67fe726fb635b ã‚’å‚ç…§

ãªãŠã€Rocky-9.1-x86_64-minimal.iso ã‹ã‚‰ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ã¯ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’åˆ©ç”¨ã—ãŸãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¯ç™ºç”Ÿã—ã¾ã›ã‚“ã€‚

```
# ovs-vsctl show
537967ba-2d48-46f4-9ab8-bb3116153289
    Bridge ovsbr0
        Port ens4
            Interface ens4
        Port ovsbr0
            Interface ovsbr0
                type: internal
    ovs_version: "2.15.0"

# ip addr show ovsbr0
5: ovsbr0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UNKNOWN group default qlen 1000
    link/ether 26:bb:9f:9d:ab:44 brd ff:ff:ff:ff:ff:ff
    inet 10.2.0.242/24 brd 10.2.0.255 scope global ovsbr0
       valid_lft forever preferred_lft forever
    inet6 fe80::24bb:9fff:fe9d:ab44/64 scope link
       valid_lft forever preferred_lft forever
```

## ä»®æƒ³ãƒã‚·ãƒ³èµ·å‹•

ãŠã‚ˆãä»¥ä¸‹ã®ã‚ˆã†ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ä»®æƒ³ãƒã‚·ãƒ³ã‚’èµ·å‹•ã—ã¾ã™ã€‚

```
# kvm -m 1024 -cpu host -vnc :0 -boot order=d \
-device virtio-blk,drive=sda -drive id=sda,if=none,file=Rocky-9.1-x86_64-minimal.qcow2,format=qcow2 \
-device virtio-net,netdev=net0 -netdev tap,id=net0,ifname=tap0,script=no,downscript=no \
-cdrom Rocky-9.1-x86_64-minimal.iso
```

ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢ã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯ã€vncãƒ“ãƒ¥ãƒ¼ã‚¢ã§ 5900 ãƒãƒ¼ãƒˆã«æ¥ç¶šã—ã¾ã™ã€‚
ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ã®ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ã€é€šå¸¸é€šã‚Šã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’å®Ÿæ–½ã—ã¾ã™ã€‚
ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†å¾Œã€å†èµ·å‹•ã™ã‚‹ã¨ã€å†åº¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ¡ãƒ‡ã‚£ã‚¢ã®GRUBãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
kvm ã‚’èµ·å‹•ã—ãŸã‚·ã‚§ãƒ«ã§ `ctrl + c` ã™ã‚‹ã“ã¨ã§ã€ä»®æƒ³ãƒã‚·ãƒ³ã‚’çµ‚äº†ã•ã›ã¾ã™ã€‚

## ä»®æƒ³ãƒ–ãƒªãƒƒã‚¸ã¸ã® tap ãƒ‡ãƒã‚¤ã‚¹ã®æ¥ç¶š

å‰å¾Œã—ã¾ã™ãŒã€ä¸Šè¨˜ã‚³ãƒãƒ³ãƒ‰ã§ä»®æƒ³ãƒã‚·ãƒ³ã‚’èµ·å‹•ã™ã‚‹ã¨ã€tap ãƒ‡ãƒã‚¤ã‚¹ãŒä½œæˆã•ã‚Œã¾ã™ã€‚
`script=no` ã¨ã—ãŸå ´åˆã€ä»®æƒ³ãƒ–ãƒªãƒƒã‚¸ã¸ã®å‰²ã‚Šå½“ã¦ã¯æ‰‹å‹•ã§å®Ÿæ–½ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
```
# ip link show tap0
6: tap0: <BROADCAST,MULTICAST> mtu 1500 qdisc noop master ovs-system state DOWN mode DEFAULT group default qlen 1000
    link/ether ca:b3:cb:fb:1d:92 brd ff:ff:ff:ff:ff:ff

# ovs-vsctl show
537967ba-2d48-46f4-9ab8-bb3116153289
    Bridge ovsbr0
        Port ens4
            Interface ens4
        Port ovsbr0
            Interface ovsbr0
                type: internal
    ovs_version: "2.15.0"
```

ä½œæˆã•ã‚ŒãŸ tap ãƒ‡ãƒã‚¤ã‚¹ã‚’ä»®æƒ³ãƒ–ãƒªãƒƒã‚¸ã«å‰²ã‚Šå½“ã¦ã¾ã™ã€‚
```
# ovs-vsctl add-port ovsbr0 tap0

# ovs-vsctl show
537967ba-2d48-46f4-9ab8-bb3116153289
    Bridge ovsbr0
        Port tap0
            Interface tap0
        Port ens4
            Interface ens4
        Port ovsbr0
            Interface ovsbr0
                type: internal
    ovs_version: "2.15.0"
```

tap ãƒ‡ãƒã‚¤ã‚¹ã‚’ãƒªãƒ³ã‚¯ã‚¢ãƒƒãƒ—ã•ã›ã¾ã™ã€‚
```
# ip link set tap0 up

# ip link show tap0
6: tap0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast master ovs-system state UNKNOWN mode DEFAULT group default qlen 1000
    link/ether ca:b3:cb:fb:1d:92 brd ff:ff:ff:ff:ff:ff
```

:::message
ä»®æƒ³ãƒã‚·ãƒ³åœæ­¢æ™‚ã«ã€tap ãƒ‡ãƒã‚¤ã‚¹ã¯å‰Šé™¤ã•ã‚Œã¾ã™ã€‚
`downscript=no` ã‚’æŒ‡å®šã—ãŸå ´åˆã€ä»®æƒ³ãƒ–ãƒªãƒƒã‚¸ã‹ã‚‰ tap ãƒ‡ãƒã‚¤ã‚¹å‰²ã‚Šå½“ã¦ã‚’è§£é™¤ã™ã‚‹å†…å®¹ã‚‚ã€æ‰‹å‹•ã§å®Ÿè¡Œã—ã¦ã‚„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
:::

## tap ãƒ‡ãƒã‚¤ã‚¹å‰²ã‚Šå½“ã¦ãƒ»è§£é™¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

https://ovs-istokes.readthedocs.io/en/latest/howto/kvm.html

ä»®æƒ³ãƒã‚·ãƒ³èµ·å‹•æ™‚ã® tap ãƒ‡ãƒã‚¤ã‚¹å‰²ã‚Šå½“ã¦ã€ä»®æƒ³ãƒã‚·ãƒ³åœæ­¢æ™‚ã® tap ãƒ‡ãƒã‚¤ã‚¹å‰²ã‚Šå½“ã¦ã®è§£é™¤ã‚’ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

tap ãƒ‡ãƒã‚¤ã‚¹å‰²ã‚Šå½“ã¦ç”¨ã¨ã€tap ãƒ‡ãƒã‚¤ã‚¹å‰²ã‚Šå½“ã¦ã®è§£é™¤ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç”¨æ„ã—ã¾ã™ã€‚
ã“ã“ã§ã¯ /usr/local/bin ã§ä½œæˆã—ã¦ã„ã¾ã™ãŒã€/etc ç›´ä¸‹ã«ç½®ãã®ãŒä¸€èˆ¬çš„ãªã‚ˆã†ã§ã™ã€‚
```
# ls -l /usr/local/bin/ovs*.sh
-rwxr-xr-x 1 root root 80 Feb 13 15:16 /usr/local/bin/ovs-ifdown.sh
-rwxr-xr-x 1 root root 78 Feb 13 15:16 /usr/local/bin/ovs-ifup.sh
```

```:/usr/local/bin/ovs-ifdown.sh
#!/bin/sh

switch='ovsbr0'

ip link set $1 down
ovs-vsctl del-port ${switch} $1
```

```:/usr/local/bin/ovs-ifup.sh
#!/bin/sh

switch='ovsbr0'

ip link set $1 up
ovs-vsctl add-port ${switch} $1
```

## ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ä»®æƒ³ãƒã‚·ãƒ³èµ·å‹•

`--cdrom` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å¤–ã—ã¾ã™ã€‚
ã¾ãŸã€ä¸Šã§ä½œæˆã—ãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ã€ `script` `downscript` ã§ãã‚Œãã‚ŒæŒ‡å®šã—ã¾ã™ã€‚

```
# kvm -m 1024 -cpu host -vnc :0 \
-device virtio-blk,drive=sda -drive id=sda,if=none,file=Rocky-9.1-x86_64-minimal.qcow2,format=qcow2 \
-device virtio-net,netdev=net0 -netdev tap,id=net0,ifname=tap0,script=/usr/local/bin/ovs-ifup.sh,downscript=/usr/local/bin/ovs-ifdown.sh
```

ä»®æƒ³ãƒã‚·ãƒ³èµ·å‹•å¾Œã«ã€ãƒ›ã‚¹ãƒˆOSå´ã§ç¢ºèªã™ã‚‹ã¨ã€ä»®æƒ³ãƒ–ãƒªãƒƒã‚¸ã« tap ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã€ãƒªãƒ³ã‚¯ãŒã‚¢ãƒƒãƒ—ã—ã¦ã„ã¾ã™ã€‚
```
# ovs-vsctl show
537967ba-2d48-46f4-9ab8-bb3116153289
    Bridge ovsbr0
        Port ens4
            Interface ens4
        Port ovsbr0
            Interface ovsbr0
                type: internal
        Port tap0
            Interface tap0
    ovs_version: "2.15.0"

# ip link show tap0
9: tap0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast master ovs-system state UNKNOWN mode DEFAULT group default qlen 1000
    link/ether ca:b3:cb:fb:1d:92 brd ff:ff:ff:ff:ff:ff
```

ä»®æƒ³ãƒã‚·ãƒ³ã‚’ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³å¾Œã«ç¢ºèªã™ã‚‹ã¨ã€ä»®æƒ³ãƒ–ãƒªãƒƒã‚¸ã‹ã‚‰ tap ãƒ‡ãƒã‚¤ã‚¹ã®å‰²ã‚Šå½“ã¦ãŒè§£é™¤ã•ã‚Œã¦ã„ã¾ã™ã€‚

```
# ovs-vsctl show
537967ba-2d48-46f4-9ab8-bb3116153289
    Bridge ovsbr0
        Port ens4
            Interface ens4
        Port ovsbr0
            Interface ovsbr0
                type: internal
    ovs_version: "2.15.0"
#
```
