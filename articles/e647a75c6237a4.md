---
title: "ECRã‚’è©¦ã™"
emoji: "ğŸª¦"
type: "tech"
topics: ["aws", "ecr"]
published: true
---

# ECRä½œæˆ

## å‚è€ƒ

https://docs.aws.amazon.com/ja_jp/AmazonECR/latest/userguide/what-is-ecr.html
https://docs.aws.amazon.com/ja_jp/AmazonECR/latest/userguide/getting-started-cli.html

## ãƒªãƒã‚¸ãƒˆãƒªä½œæˆ

ä½œæˆå‰ã®çŠ¶æ…‹
```
$ aws ecr describe-repositories
{
    "repositories": []
}
```

ãƒªãƒã‚¸ãƒˆãƒªåã‚’æŒ‡å®šã™ã‚‹ã ã‘ã§ã€ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```
$ aws ecr create-repository --repository-name <repository_name>
{
    "repository": {
        "repositoryUri": "<aws_account_id>.dkr.ecr.<region>.amazonaws.com/<repository_name>",
        "imageScanningConfiguration": {
            "scanOnPush": false
        },
        "encryptionConfiguration": {
            "encryptionType": "AES256"
        },
        "registryId": "<aws_account_id>",
        "imageTagMutability": "MUTABLE",
        "repositoryArn": "arn:aws:ecr:<region>:<aws_account_id>:repository/<repository_name>",
        "repositoryName": "<repository_name>",
        "createdAt": 1703277662.0
    }
}
```

## ãƒ­ã‚°ã‚¤ãƒ³

å‡ºåŠ›ã—ãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’docker ã‚³ãƒãƒ³ãƒ‰ã®æ¨™æº–å…¥åŠ›ã‹ã‚‰å…¥ã‚Œã‚‹ä½¿ã„æ–¹ã‚‚ã§ãã¾ã™ãŒã€
è‡ªåˆ†ã®ç’°å¢ƒã§ã¯ aws-cli ã¨ docker ã¯ç•°ãªã‚‹ç’°å¢ƒã«å…¥ã‚Œã¦ã„ã‚‹ã®ã§ã€ã“ã“ã§ã¯ä¸€æ™‚çš„ã«ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¾ã™ã€‚
```
$ aws ecr get-login-password > ~/work/ecr-login-password
```

ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã€‚
```
$ cat /export/home/docker/work/ecr-login-password | sudo docker login -u AWS --password-stdin <aws_account_id>.dkr.ecr.<region>.amazonaws.com
WARNING! Your password will be stored unencrypted in /root/.docker/config.json.
Configure a credential helper to remove this warning. See
https://docs.docker.com/engine/reference/commandline/login/#credentials-store

Login Succeeded
```

ä¸€æ™‚çš„ã«ä¿å­˜ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯ä»¥å¾Œä¸è¦ãªã®ã§å‰Šé™¤ã—ã¾ã™ã€‚
```
$ rm /export/home/docker/work/ecr-login-password
```

## ã‚¤ãƒ¡ãƒ¼ã‚¸ã®push

ãƒ†ã‚¹ãƒˆã¨ã—ã¦ã€ã¿ã‚“ãªå¤§å¥½ã hello-world ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚
ã‚¿ã‚°ä»˜ã‘ã—ã¦ push ã—ã¾ã™ã€‚
```
$ sudo docker tag hello-world:latest <aws_account_id>.dkr.ecr.<region>.amazonaws.com/<repository_name>:test

$ sudo docker push <aws_account_id>.dkr.ecr.<region>.amazonaws.com/<repository_name>:test
The push refers to repository [<aws_account_id>.dkr.ecr.<region>.amazonaws.com/<repository_name>]
12660636fe55: Pushed
test: digest: sha256:a8ea96bb64d60208d6a56712042d1cf58aa4a7d3751b897b9320b0813c81cbb4 size: 524
```

pushå¾Œã€ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ç¢ºèªã—ã¾ã™ã€‚
```
$ aws ecr list-images --repository-name <repository_name>
{
    "imageIds": [
        {
            "imageTag": "test",
            "imageDigest": "sha256:a8ea96bb64d60208d6a56712042d1cf58aa4a7d3751b897b9320b0813c81cbb4"
        }
    ]
}

$ aws ecr describe-images --repository-name <repository_name>
{
    "imageDetails": [
        {
            "artifactMediaType": "application/vnd.docker.container.image.v1+json",
            "imageSizeInBytes": 3776,
            "imageDigest": "sha256:a8ea96bb64d60208d6a56712042d1cf58aa4a7d3751b897b9320b0813c81cbb4",
            "imageManifestMediaType": "application/vnd.docker.distribution.manifest.v2+json",
            "imageTags": [
                "test"
            ],
            "registryId": "<aws_account_id>",
            "repositoryName": "<repository_name>",
            "imagePushedAt": 1703280057.0
        }
    ]
}
```

## ã‚¤ãƒ¡ãƒ¼ã‚¸ã® pull

ãƒ†ã‚¹ãƒˆã®ãŸã‚ã€ãƒ­ãƒ¼ã‚«ãƒ«ã®æ—¢å­˜ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¦ãŠãã¾ã™ã€‚
```
$ sudo docker rmi <aws_account_id>.dkr.ecr.<region>.amazonaws.com/<repository_name>:test
Untagged: <aws_account_id>.dkr.ecr.<region>.amazonaws.com/<repository_name>:test
Untagged: <aws_account_id>.dkr.ecr.<region>.amazonaws.com/<repository_name>@sha256:a8ea96bb64d60208d6a56712042d1cf58aa4a7d3751b897b9320b0813c81cbb4

$ sudo docker rmi hello-world:latest
Untagged: hello-world:latest
Untagged: hello-world@sha256:ac69084025c660510933cca701f615283cdbb3aa0963188770b54c31c8962493
```

ã•ãã»ã© push ã—ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ pull ã—ã¾ã™ã€‚
```
$ sudo docker pull <aws_account_id>.dkr.ecr.<region>.amazonaws.com/<repository_name>:test
test: Pulling from <repository_name>
Digest: sha256:a8ea96bb64d60208d6a56712042d1cf58aa4a7d3751b897b9320b0813c81cbb4
Status: Downloaded newer image for <aws_account_id>.dkr.ecr.<region>.amazonaws.com/<repository_name>:test
<aws_account_id>.dkr.ecr.<region>.amazonaws.com/<repository_name>:test
```

å®Ÿè¡Œã—ã¦ã¿ã¾ã™ã€‚
```
$ sudo docker run --rm <aws_account_id>.dkr.ecr.<region>.amazonaws.com/<repository_name>:test

Hello from Docker!
This message shows that your installation appears to be working correctly.

To generate this message, Docker took the following steps:
 1. The Docker client contacted the Docker daemon.
 2. The Docker daemon pulled the "hello-world" image from the Docker Hub.
    (arm64v8)
 3. The Docker daemon created a new container from that image which runs the
    executable that produces the output you are currently reading.
 4. The Docker daemon streamed that output to the Docker client, which sent it
    to your terminal.

To try something more ambitious, you can run an Ubuntu container with:
 $ docker run -it ubuntu bash

Share images, automate workflows, and more with a free Docker ID:
 https://hub.docker.com/

For more examples and ideas, visit:
 https://docs.docker.com/get-started/
```

## ã‚¤ãƒ¡ãƒ¼ã‚¸ã®å‰Šé™¤

push ã—ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰å‰Šé™¤ã—ã¦ã¿ã¾ã™ã€‚
```
$ aws ecr batch-delete-image --repository-name <repository_name> --image-ids imageTag=test
{
    "failures": [],
    "imageIds": [
        {
            "imageTag": "test",
            "imageDigest": "sha256:a8ea96bb64d60208d6a56712042d1cf58aa4a7d3751b897b9320b0813c81cbb4"
        }
    ]
}
```

å‰Šé™¤å¾Œã®ç¢ºèª
```
$ aws ecr list-images --repository-name <repository_name>
{
    "imageIds": []
}
```

## ãƒªãƒã‚¸ãƒˆãƒªã®å‰Šé™¤

ä½œæˆã—ãŸãƒªãƒã‚¸ãƒˆãƒªã‚’å‰Šé™¤ã—ã¦ã¿ã¾ã™ã€‚
```
$ aws ecr delete-repository --repository-name <repository_name>
{
    "repository": {
        "repositoryUri": "<aws_account_id>.dkr.ecr.<region>.amazonaws.com/<repository_name>",
        "registryId": "<aws_account_id>",
        "imageTagMutability": "MUTABLE",
        "repositoryArn": "arn:aws:ecr:<region>:<aws_account_id>:repository/<repository_name>",
        "repositoryName": "<repository_name>",
        "createdAt": 1703277662.0
    }
}
```


## å‚è€ƒ: CloudFormation ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

```
AWSTemplateFormatVersion: 2010-09-09
Parameters:
  RepositoryName:
    Type: String
  ENV:
    Type: String
Resources:
  MyRepository:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: !Ref RepositoryName
      ImageScanningConfiguration:
        ScanOnPush: false
      EncryptionConfiguration:
        EncryptionType: "AES256"
      ImageTagMutability: "MUTABLE"
      Tags:
        - Key: Name
          Value: !Ref RepositoryName
        - Key: ENV
          Value: !Ref ENV
```
