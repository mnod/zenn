---
title: "Debian11 ã§ DRBD"
emoji: "ðŸªž"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["drbd","ocfs2"]
published: true
---

# æº–å‚™

https://zenn.dev/mnod/articles/946ea1823ef680 ã®ç’°å¢ƒã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

åˆ©ç”¨ã™ã‚‹ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¦ãŠãã¾ã™ã€‚
ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã€ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚’åˆ‡ã‚Šã¾ã™ã€‚
```
# apt install --no-install-recommends parted

# parted /dev/vdb print
Error: /dev/vdb: unrecognised disk label
Model: Virtio Block Device (virtblk)
Disk /dev/vdb: 4295MB
Sector size (logical/physical): 512B/512B
Partition Table: unknown
Disk Flags:

# parted /dev/vdb mklabel msdos
Information: You may need to update /etc/fstab.

# parted /dev/vdb mkpart primary 0% 33%
Information: You may need to update /etc/fstab.

# parted /dev/vdb print
Model: Virtio Block Device (virtblk)
Disk /dev/vdb: 4295MB
Sector size (logical/physical): 512B/512B
Partition Table: msdos
Disk Flags:

Number  Start   End     Size    Type     File system  Flags
 1      1049kB  1418MB  1417MB  primary

```


# åˆæœŸåŒ–

ä¸¡ãƒŽãƒ¼ãƒ‰ã§å®Ÿè¡Œã—ã¾ã™ã€‚
å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```
# DEBIAN_FRONTEND=noninteractive apt install --no-install-recommends drbd-utils
```

ã‚«ãƒ¼ãƒãƒ«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
```
# lsmod | grep drbd
# modprobe drbd

# lsmod | grep drbd
drbd                  421888  0
lru_cache              16384  1 drbd
libcrc32c              16384  1 drbd
```

è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
```:/etc/drbd.d/r0.res
resource r0 {
    volume 0 {
        device           /dev/drbd0;
        disk             /dev/vdb1;
        meta-disk        internal;
    }
    on debian11-0 {
        address          ipv4 10.2.1.240:7789;
    }
    on debian11-1 {
        address          ipv4 10.2.1.241:7789;
    }
}
```

ãƒ‡ã‚£ã‚¹ã‚¯ã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚
```
# drbdadm create-md r0
initializing activity log
initializing bitmap (44 KB) to all zero
Writing meta data...
New drbd meta data block successfully created.

# systemctl start drbd

# drbdadm status r0
r0 role:Secondary
  disk:Inconsistent
  peer role:Secondary
    replication:Established peer-disk:Inconsistent
```

ä»¥ä¸Šã€ã“ã“ã¾ã§ã‚’ä¸¡ãƒŽãƒ¼ãƒ‰ã§å®Ÿæ–½ã—ã¾ã™ã€‚

## æ˜‡æ ¼

Primary ã¨ã—ãŸã„å´ã§ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```
# drbdadm primary --force r0
```

åŒæœŸãŒé–‹å§‹ã—ã¾ã™ã€‚
åŒæœŸé–‹å§‹ç›´å¾Œã®çŠ¶æ…‹ã€‚
```
# drbdadm status r0
r0 role:Primary
  disk:UpToDate
  peer role:Secondary
    replication:SyncSource peer-disk:Inconsistent done:3.55

# cat /proc/drbd
version: 8.4.11 (api:1/proto:86-101)
srcversion: 32DFEF1F0DADCBF174877F7
 0: cs:SyncSource ro:Primary/Secondary ds:UpToDate/Inconsistent C r-----
    ns:117984 nr:0 dw:0 dr:117984 al:8 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:1265360
        [>...................] sync'ed:  8.9% (1265360/1383344)K
        finish: 0:03:02 speed: 6,940 (6,940) K/sec
```

åŒæœŸå®Œäº†å¾Œã®çŠ¶æ…‹
```
# drbdadm status r0
r0 role:Primary
  disk:UpToDate
  peer role:Secondary
    replication:Established peer-disk:UpToDate

# cat /proc/drbd
version: 8.4.11 (api:1/proto:86-101)
srcversion: 32DFEF1F0DADCBF174877F7
 0: cs:Connected ro:Primary/Secondary ds:UpToDate/UpToDate C r-----
    ns:1383344 nr:0 dw:0 dr:1383344 al:8 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0
```

ã‚»ã‚«ãƒ³ãƒ€ãƒªå´ã®çŠ¶æ…‹
```
# drbdadm status r0
r0 role:Secondary
  disk:UpToDate
  peer role:Primary
    replication:Established peer-disk:UpToDate

# cat /proc/drbd
version: 8.4.11 (api:1/proto:86-101)
srcversion: 32DFEF1F0DADCBF174877F7
 0: cs:Connected ro:Secondary/Primary ds:UpToDate/UpToDate C r-----
    ns:0 nr:1383344 dw:1383344 dr:0 al:8 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0
```

## ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã®åˆ©ç”¨

ãƒ—ãƒ©ã‚¤ãƒžãƒªå´ã§ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ä½œæˆ
```
# lsblk
NAME      MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
fd0         2:0    1    4K  0 disk
sr0        11:0    1 1024M  0 rom
vda       254:0    0   16G  0 disk
â”œâ”€vda1    254:1    0   15G  0 part /
â”œâ”€vda2    254:2    0    1K  0 part
â””â”€vda5    254:5    0  975M  0 part [SWAP]
vdb       254:16   0    4G  0 disk
â””â”€vdb1    254:17   0  1.3G  0 part
  â””â”€drbd0 147:0    0  1.3G  0 disk

# mkfs -t ext4 /dev/drbd0
mke2fs 1.46.2 (28-Feb-2021)
Discarding device blocks: done
Creating filesystem with 345836 4k blocks and 86592 inodes
Filesystem UUID: da2359f5-4671-4d37-8253-1741452ec3c9
Superblock backups stored on blocks:
        32768, 98304, 163840, 229376, 294912

Allocating group tables: done
Writing inode tables: done
Creating journal (8192 blocks): done
Writing superblocks and filesystem accounting information: done
```

ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿ãƒ†ã‚¹ãƒˆ
```
# mount /dev/drbd0 /mnt

# df -h /mnt
Filesystem      Size  Used Avail Use% Mounted on
/dev/drbd0      1.3G   24K  1.2G   1% /mnt

# echo Hello World > /mnt/helloworld.txt

# ls -l /mnt/helloworld.txt
-rw-r--r-- 1 root root 12 Aug  6 03:35 /mnt/helloworld.txt

# umount /mnt
```

## é™æ ¼

ãƒ—ãƒ©ã‚¤ãƒžãƒªå´ã§ã‚³ãƒžãƒ³ãƒ‰ã‚’æŠ•å…¥ã—ã¦é™æ ¼ã—ã¾ã™ã€‚
```
# drbdadm secondary r0

# drbdadm status r0
r0 role:Secondary
  disk:UpToDate
  peer role:Secondary
    replication:Established peer-disk:UpToDate

```

## æ˜‡æ ¼

ã‚»ã‚«ãƒ³ãƒ€ãƒªç³»ã§ã‚³ãƒžãƒ³ãƒ‰ã‚’æŠ•å…¥ã—ã¦ã€æ˜‡æ ¼ã—ã¾ã™ã€‚
```
# drbdadm status r0
r0 role:Secondary
  disk:UpToDate
  peer role:Secondary
    replication:Established peer-disk:UpToDate

# drbdadm primary r0

# drbdadm status r0
r0 role:Primary
  disk:UpToDate
  peer role:Secondary
    replication:Established peer-disk:UpToDate
```

ãƒžã‚¦ãƒ³ãƒˆã—ã¦ãƒ†ã‚¹ãƒˆã—ã¦ã¿ã¾ã™ã€‚
```
# mount /dev/drbd0 /mnt

# df -h /mnt
Filesystem      Size  Used Avail Use% Mounted on
/dev/drbd0      1.3G   28K  1.2G   1% /mnt

# ls -l /mnt/helloworld.txt
-rw-r--r-- 1 root root 12 Aug  6 03:35 /mnt/helloworld.txt

# echo Hello another world > /mnt/helloworld1.txt

# ls -l /mnt/*txt
-rw-r--r-- 1 root root 20 Aug  6 03:38 /mnt/helloworld1.txt
-rw-r--r-- 1 root root 12 Aug  6 03:35 /mnt/helloworld.txt

# umount /mnt
```

## é™æ ¼

```
# drbdadm status r0
r0 role:Primary
  disk:UpToDate
  peer role:Secondary
    replication:Established peer-disk:UpToDate

# drbdadm secondary r0

# drbdadm status r0
r0 role:Secondary
  disk:UpToDate
  peer role:Secondary
    replication:Established peer-disk:UpToDate
```



# Dual Primary

OCFS2ã‚’åˆ©ç”¨ã—ã¦ã€ä¸¡ãƒŽãƒ¼ãƒ‰ã§åŒæ™‚ã«æ›¸ãè¾¼ã¿ãƒ»èª­ã¿è¾¼ã¿ã§ãã‚‹ç’°å¢ƒã‚’ä½œã£ã¦ã¿ã¾ã™ã€‚

## æº–å‚™

ä¸¡ãƒŽãƒ¼ãƒ‰ã§ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¾ã™ã€‚
```
# parted /dev/vdb print
Model: Virtio Block Device (virtblk)
Disk /dev/vdb: 4295MB
Sector size (logical/physical): 512B/512B
Partition Table: msdos
Disk Flags:

Number  Start   End     Size    Type     File system  Flags
 1      1049kB  1418MB  1417MB  primary  ext4

# parted /dev/vdb mkpart primary 33% 66%
Information: You may need to update /etc/fstab.

# parted /dev/vdb print
Model: Virtio Block Device (virtblk)
Disk /dev/vdb: 4295MB
Sector size (logical/physical): 512B/512B
Partition Table: msdos
Disk Flags:

Number  Start   End     Size    Type     File system  Flags
 1      1049kB  1418MB  1417MB  primary  ext4
 2      1418MB  2834MB  1417MB  primary
```

## åˆæœŸåŒ–

ä¸¡ãƒŽãƒ¼ãƒ‰ã§å®Ÿæ–½ã—ã¾ã™ã€‚

è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
```: /etc/drbd.d/r1.res
resource r1 {
    net {
        allow-two-primaries yes;
        after-sb-0pri    discard-zero-changes;
        after-sb-1pri    discard-secondary;
        after-sb-2pri    disconnect;
    }
    volume 1 {
        device           /dev/drbd1;
        disk             /dev/vdb2;
        meta-disk        internal;
    }
    on debian11-2 {
        address          ipv4 10.2.1.242:7790;
    }
    on debian11-3 {
        address          ipv4 10.2.1.243:7790;
    }
}
```

ãƒ‡ã‚£ã‚¹ã‚¯ã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚
```
# drbdadm create-md r1
initializing activity log
initializing bitmap (44 KB) to all zero
Writing meta data...
New drbd meta data block successfully created.

# drbdadm up r1

# drbdadm status r1
r1 role:Secondary
  volume:1 disk:Inconsistent
  peer role:Secondary
    volume:1 replication:Established peer-disk:Inconsistent
```

ä»¥ä¸Šã€ã“ã“ã¾ã§ã‚’ä¸¡ç³»ã§å®Ÿæ–½ã—ã¾ã™ã€‚

## æ˜‡æ ¼
ã¾ãšã¯ç‰‡ç³»ã§ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```
# drbdadm primary --force r1

# drbdadm status r1
r1 role:Primary
  volume:1 disk:UpToDate
  peer role:Secondary
    volume:1 replication:SyncSource peer-disk:Inconsistent done:2.45

# cat /proc/drbd
version: 8.4.11 (api:1/proto:86-101)
srcversion: 32DFEF1F0DADCBF174877F7
 0: cs:Connected ro:Secondary/Secondary ds:UpToDate/UpToDate C r-----
    ns:1384264 nr:112 dw:1438908 dr:1385573 al:15 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0
 1: cs:SyncSource ro:Primary/Secondary ds:UpToDate/Inconsistent C r-----
    ns:167616 nr:0 dw:0 dr:167616 al:8 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:1215728
        [=>..................] sync'ed: 12.5% (1215728/1383344)K
        finish: 0:02:31 speed: 7,980 (7,980) K/sec
```

åŒæœŸå®Œäº†å¾Œã®çŠ¶æ…‹
```
# drbdadm status r1
r1 role:Primary
  volume:1 disk:UpToDate
  peer role:Secondary
    volume:1 replication:Established peer-disk:UpToDate


# cat /proc/drbd
version: 8.4.11 (api:1/proto:86-101)
srcversion: 32DFEF1F0DADCBF174877F7
 0: cs:Connected ro:Secondary/Secondary ds:UpToDate/UpToDate C r-----
    ns:1384264 nr:112 dw:1438908 dr:1385573 al:15 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0
 1: cs:Connected ro:Primary/Secondary ds:UpToDate/UpToDate C r-----
    ns:1383344 nr:0 dw:0 dr:1383344 al:8 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0
```

ã‚‚ã†ç‰‡æ–¹ã®ãƒŽãƒ¼ãƒ‰ã®çŠ¶æ…‹
```
# drbdadm status r1
r1 role:Secondary
  volume:1 disk:UpToDate
  peer role:Primary
    volume:1 replication:Established peer-disk:UpToDate

# cat /proc/drbd
version: 8.4.11 (api:1/proto:86-101)
srcversion: 32DFEF1F0DADCBF174877F7
 0: cs:Connected ro:Secondary/Secondary ds:UpToDate/UpToDate C r-----
    ns:112 nr:1384264 dw:2822252 dr:1109 al:12 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0
 1: cs:Connected ro:Secondary/Primary ds:UpToDate/UpToDate C r-----
    ns:0 nr:1383344 dw:1383344 dr:0 al:8 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0
```


ã‚‚ã†ç‰‡æ–¹ã®ãƒŽãƒ¼ãƒ‰ã§ã‚‚ã‚³ãƒžãƒ³ãƒ‰ã‚’æŠ•å…¥ã—ã¦ã€æ˜‡æ ¼ã—ã¾ã™ã€‚
```
# drbdadm primary r1

# drbdadm status r1
r1 role:Primary
  volume:1 disk:UpToDate
  peer role:Primary
    volume:1 replication:Established peer-disk:UpToDate

# cat /proc/drbd
version: 8.4.11 (api:1/proto:86-101)
srcversion: 32DFEF1F0DADCBF174877F7
 0: cs:Connected ro:Secondary/Secondary ds:UpToDate/UpToDate C r-----
    ns:112 nr:1384264 dw:2822252 dr:1109 al:12 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0
 1: cs:Connected ro:Primary/Primary ds:UpToDate/UpToDate C r-----
    ns:0 nr:1383344 dw:1383344 dr:0 al:8 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0
```

åå¯¾å´ãƒŽãƒ¼ãƒ‰ã§ã®çŠ¶æ…‹
```
# drbdadm status r1
r1 role:Primary
  volume:1 disk:UpToDate
  peer role:Primary
    volume:1 replication:Established peer-disk:UpToDate

# cat /proc/drbd
version: 8.4.11 (api:1/proto:86-101)
srcversion: 32DFEF1F0DADCBF174877F7
 0: cs:Connected ro:Secondary/Secondary ds:UpToDate/UpToDate C r-----
    ns:1384264 nr:112 dw:1438908 dr:1385573 al:15 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0
 1: cs:Connected ro:Primary/Primary ds:UpToDate/UpToDate C r-----
    ns:1383344 nr:0 dw:0 dr:1383344 al:8 bm:0 lo:0 pe:0 ua:0 ap:0 ep:1 wo:f oos:0
```

## OCFS2

ä¸¡ãƒŽãƒ¼ãƒ‰ã§å®Ÿæ–½ã—ã¾ã™ã€‚
ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
```
# apt install --no-install-recommends ocfs2-tools
```

è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
```: /etc/ocfs2/cluster.conf
cluster:
  node_count = 2
  name = ocfs2

node:
  ip_port = 7777
  ip_address = 10.2.1.240
  number = 0
  name = debian11-0
  cluster = ocfs2
node:
  ip_port = 7777
  ip_address = 10.2.1.241
  number = 1
  name = debian11-1
  cluster = ocfs2
```

ã‚µãƒ¼ãƒ“ã‚¹ã®å†è¨­å®š
```
# dpkg-reconfigure ocfs2-tools
(èµ·å‹•æ™‚ã«ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•ã™ã‚‹ä»¥å¤–ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)

# grep -E -v '^#|^$' /etc/default/o2cb
O2CB_ENABLED=true
O2CB_BOOTCLUSTER=ocfs2
O2CB_HEARTBEAT_THRESHOLD=31
O2CB_IDLE_TIMEOUT_MS=30000
O2CB_KEEPALIVE_DELAY_MS=2000
O2CB_RECONNECT_DELAY_MS=2000
```

ã‚µãƒ¼ãƒ“ã‚¹ã‚’å†èµ·å‹•ã—ã¾ã™ã€‚
```
# systemctl restart o2cb
```

ã“ã“ã¾ã§ã€ä¸¡ãƒŽãƒ¼ãƒ‰ã§å®Ÿæ–½ã—ã¾ã™ã€‚

## OCFS2 ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ä½œæˆ

ç‰‡ç³»ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ä½œæˆã—ã¾ã™ã€‚

```
# mkfs.ocfs2 -L ocfs2 /dev/drbd1
mkfs.ocfs2 1.8.6
Cluster stack: classic o2cb
Label: ocfs2
Features: sparse extended-slotmap backup-super unwritten inline-data strict-journal-super xattr indexed-dirs refcount discontig-bg append-dio
Block size: 4096 (12 bits)
Cluster size: 4096 (12 bits)
Volume size: 1416544256 (345836 clusters) (345836 blocks)
Cluster groups: 11 (tail covers 23276 clusters, rest cover 32256 clusters)
Extent allocator size: 4194304 (1 groups)
Journal size: 67108864
Node slots: 2
Creating bitmaps: done
Initializing superblock: done
Writing system files: done
Writing superblock: done
Writing backup superblock: 1 block(s)
Formatting Journals: done
Growing extent allocator: done
Formatting slot map: done
Formatting quota files: done
Writing lost+found: done
mkfs.ocfs2 successful
```

ä¸¡ç³»ã§ãƒžã‚¦ãƒ³ãƒˆã—ã¾ã™ã€‚
```
# mount /dev/drbd1 /mnt

# df -h /mnt
Filesystem      Size  Used Avail Use% Mounted on
/dev/drbd1      1.4G  143M  1.2G  11% /mnt
```


ç‰‡ç³»ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ã¿ã¾ã™ã€‚
```
# echo Hello World > /mnt/helloworld.txt

# ls -l /mnt/*txt
-rw-r--r-- 1 root root 12 Aug  6 04:28 /mnt/helloworld.txt
```

ä½œæˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’åå¯¾å´ãƒŽãƒ¼ãƒ‰ã§ç¢ºèªã—ã¾ã™ã€‚
ã¾ãŸã€ã“ã¡ã‚‰ã§ã‚‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ã¿ã¾ã™ã€‚
```
# ls -l /mnt/*txt
-rw-r--r-- 1 root root 12 Aug  6 04:28 /mnt/helloworld.txt

# cat /mnt/helloworld.txt
Hello World

# echo Hello Another World > /mnt/helloworld1.txt

# ls -l /mnt/*txt
-rw-r--r-- 1 root root 20 Aug  6 04:29 /mnt/helloworld1.txt
-rw-r--r-- 1 root root 12 Aug  6 04:28 /mnt/helloworld.txt
```

