---
title: "Debian11 ã§ Pacemaker"
emoji: "ğŸ«¶"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["pacemaker"]
published: start
---

# å‰æ

2å°ã®Webã‚µãƒ¼ãƒ(debian11-0ã€debian11-1)ã§ãƒªã‚½ãƒ¼ã‚¹ã®å…±æœ‰ã‚’å›³ã£ã¦ã„ãã¾ã™ã€‚
å…±æœ‰ã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã¯ã€Webã‚µãƒ¼ãƒã¨å…±æœ‰ã‚¢ãƒ‰ãƒ¬ã‚¹(10.2.0.244/24)ã§ã™

ã¾ãšã¯ nginx ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦å‹•ä½œç¢ºèªã—ã¾ã™ã€‚
```
# apt install --no-install-recommends nginx

# cp -pi /var/www/html/index.nginx-debian.html /var/www/html/index.nginx-debian.html.orig
# hostname > /var/www/html/index.nginx-debian.html
```


# ä¸¡ãƒãƒ¼ãƒ‰ã§æº–å‚™

å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
```
# apt install --no-install-recommends pacemaker fence-agents pcs pacemaker-cli-utils
```

ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®è¨­å®šã¨åˆæœŸåŒ–ã‚’å®Ÿæ–½ã—ã¾ã™ã€‚
```
# passwd -S hacluster
hacluster L 02/21/2023 0 99999 7 -1

# passwd hacluster
New password:
Retype new password:
passwd: password updated successfully

# passwd -S hacluster
hacluster P 02/21/2023 0 99999 7 -1

# pcs cluster destroy
Shutting down pacemaker/corosync services...
Killing any remaining services...
Removing all cluster configuration files...
```

/etc/hosts ã«è¨˜è¼‰ã™ã‚‹ãªã©ã€ãƒ›ã‚¹ãƒˆåã‹ã‚‰ã‚¢ãƒ‰ãƒ¬ã‚¹ã¸ã®è§£æ±ºãŒã§ãã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã¾ã™ã€‚

# ãƒã‚¹ã‚¿ãƒ¼ãƒãƒ¼ãƒ‰ã§å®Ÿæ–½

ãƒ¦ãƒ¼ã‚¶ã®èªè¨¼ã‚’è¡Œã„ã¾ã™ã€‚
```
# pcs host auth debian11-0 debian11-1
Username: hacluster
Password:
debian11-1: Authorized
debian11-0: Authorized
```

## ã‚¯ãƒ©ã‚¹ã‚¿ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

ã‚¯ãƒ©ã‚¹ã‚¿ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’è¡Œã„ã¾ã™ã€‚
```
# pcs cluster setup web_cluster debian11-0 debian11-1
No addresses specified for host 'debian11-0', using 'debian11-0'
No addresses specified for host 'debian11-1', using 'debian11-1'
Destroying cluster on hosts: 'debian11-0', 'debian11-1'...
debian11-0: Successfully destroyed cluster
debian11-1: Successfully destroyed cluster
Requesting remove 'pcsd settings' from 'debian11-0', 'debian11-1'
debian11-0: successful removal of the file 'pcsd settings'
debian11-1: successful removal of the file 'pcsd settings'
Sending 'corosync authkey', 'pacemaker authkey' to 'debian11-0', 'debian11-1'
debian11-0: successful distribution of the file 'corosync authkey'
debian11-0: successful distribution of the file 'pacemaker authkey'
debian11-1: successful distribution of the file 'corosync authkey'
debian11-1: successful distribution of the file 'pacemaker authkey'
Sending 'corosync.conf' to 'debian11-0', 'debian11-1'
debian11-0: successful distribution of the file 'corosync.conf'
debian11-1: successful distribution of the file 'corosync.conf'
Cluster has been successfully set up.
```

ã‚¯ãƒ©ã‚¹ã‚¿ã‚’é–‹å§‹ã—ã¾ã™ã€‚
```
# pcs cluster start --all
debian11-1: Starting Cluster...
debian11-0: Starting Cluster...
```

ã‚¯ãƒ©ã‚¹ã‚¿ã®çŠ¶æ…‹ã‚’ç¢ºèªã—ã¾ã™ã€‚
```
# pcs status
Cluster name: web_cluster

WARNINGS:
No stonith devices and stonith-enabled is not false

Cluster Summary:
  * Stack: unknown
  * Current DC: NONE
  * Last updated: Sat Aug  5 17:35:10 2023
  * Last change:  Sat Aug  5 17:34:53 2023 by hacluster via crmd on debian11-0
  * 2 nodes configured
  * 0 resource instances configured

Node List:
  * Node debian11-0: UNCLEAN (offline)
  * Node debian11-1: UNCLEAN (offline)

Full List of Resources:
  * No resources

Daemon Status:
  corosync: active/disabled
  pacemaker: active/disabled
  pcsd: active/enabled

# pcs status corosync

Membership information
----------------------
    Nodeid      Votes Name
         1          1 debian11-0 (local)
         2          1 debian11-1
```

## ãƒªã‚½ãƒ¼ã‚¹ã®å…±æœ‰è¨­å®š

è¨­å®šã‚’ã™ã‚‹ã¨ãƒã‚¹ã‚¿ãƒ¼å´ã§nginxã®èµ·å‹•ã¨ã€å…±æœ‰ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ä»˜ä¸ãŒè¡Œã‚ã‚Œã¾ã™ã€‚
ã“ã®ã¨ãã€ã‚¹ã‚¿ãƒ³ãƒã‚¤å´ã§nginxãŒèµ·å‹•ã—ã¦ã„ãŸã‚‰åœæ­¢ã•ã‚Œã¾ã™ã€‚

```
# pcs property set stonith-enabled=false
# pcs resource create ClusterIP IPaddr2 ip="10.2.0.244" cidr_netmask="24" nic=ens3
Assumed agent name 'ocf:heartbeat:IPaddr2' (deduced from 'IPaddr2')
# pcs resource create WebServer systemd:nginx
# pcs constraint colocation add WebServer with ClusterIP
# pcs constraint order ClusterIP then start WebServer
Adding ClusterIP WebServer (kind: Mandatory) (Options: first-action=start then-action=start)
```

ãƒªã‚½ãƒ¼ã‚¹ç¢ºèª
```
# pcs resource
  * ClusterIP   (ocf::heartbeat:IPaddr2):        Started debian11-0
  * WebServer   (systemd:nginx):         Started debian11-0

# pcs resource config ClusterIP
 Resource: ClusterIP (class=ocf provider=heartbeat type=IPaddr2)
  Attributes: cidr_netmask=24 ip=10.2.0.244 nic=ens3
  Operations: monitor interval=10s timeout=20s (ClusterIP-monitor-interval-10s)
              start interval=0s timeout=20s (ClusterIP-start-interval-0s)
              stop interval=0s timeout=20s (ClusterIP-stop-interval-0s)

# pcs resource config WebServer
 Resource: WebServer (class=systemd type=nginx)
  Operations: monitor interval=60 timeout=100 (WebServer-monitor-interval-60)
              start interval=0s timeout=100 (WebServer-start-interval-0s)
              stop interval=0s timeout=100 (WebServer-stop-interval-0s)
```

ã‚¯ãƒ©ã‚¹ã‚¿ã®çŠ¶æ…‹ã‚’ç¢ºèªã—ã¾ã™ã€‚
```
# pcs status
Cluster name: web_cluster
Cluster Summary:
  * Stack: corosync
  * Current DC: debian11-1 (version 2.0.5-ba59be7122) - partition with quorum
  * Last updated: Sat Aug  5 17:51:36 2023
  * Last change:  Sat Aug  5 17:49:07 2023 by root via cibadmin on debian11-0
  * 2 nodes configured
  * 2 resource instances configured

Node List:
  * Online: [ debian11-0 debian11-1 ]

Full List of Resources:
  * ClusterIP   (ocf::heartbeat:IPaddr2):        Started debian11-0
  * WebServer   (systemd:nginx):         Started debian11-0

Daemon Status:
  corosync: active/disabled
  pacemaker: active/disabled
  pcsd: active/enabled
```

## ãƒªã‚½ãƒ¼ã‚¹ã®ç§»å‹•ã€‚

ã‚¯ãƒ©ã‚¹ã‚¿ã‚’ã‚¹ã‚¿ãƒ³ãƒã‚¤ãƒãƒ¼ãƒ‰ã¸ç§»å‹•ã—ã¾ã™ã€‚
debian11-0å´ã§ã€nginx ãŒåœæ­¢ã€‚å…±æœ‰ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã¯ãå¥ª
debian11-1å´ã§ã€nginx ãŒèµ·å‹•ã€‚å…±æœ‰ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ä»˜ä¸
ãŒè¡Œã‚ã‚Œã¾ã™ã€‚

ãƒªã‚½ãƒ¼ã‚¹ã®ç§»å‹•ã¯ã€ã©ã¡ã‚‰ã®ãƒãƒ¼ãƒ‰ã§å®Ÿè¡Œã—ã¦ã‚‚æ§‹ã„ã¾ã›ã‚“ã€‚

```
# pcs resource move WebServer debian11-1

# pcs status
Cluster name: web_cluster
Cluster Summary:
  * Stack: corosync
  * Current DC: debian11-1 (version 2.0.5-ba59be7122) - partition with quorum
  * Last updated: Sat Aug  5 17:55:33 2023
  * Last change:  Sat Aug  5 17:55:26 2023 by root via crm_resource on debian11-0
  * 2 nodes configured
  * 2 resource instances configured

Node List:
  * Online: [ debian11-0 debian11-1 ]

Full List of Resources:
  * ClusterIP   (ocf::heartbeat:IPaddr2):        Started debian11-1
  * WebServer   (systemd:nginx):         Started debian11-1

Daemon Status:
  corosync: active/disabled
  pacemaker: active/disabled
  pcsd: active/enabled
```

ãƒªã‚½ãƒ¼ã‚¹ã‚’æˆ»ã—ã¦ã¿ã¾ã™ã€‚
```
# pcs resource move WebServer debian11-0

# pcs status
Cluster name: web_cluster
Cluster Summary:
  * Stack: corosync
  * Current DC: debian11-1 (version 2.0.5-ba59be7122) - partition with quorum
  * Last updated: Sat Aug  5 18:02:00 2023
  * Last change:  Sat Aug  5 18:01:50 2023 by root via crm_resource on debian11-0
  * 2 nodes configured
  * 2 resource instances configured

Node List:
  * Online: [ debian11-0 debian11-1 ]

Full List of Resources:
  * ClusterIP   (ocf::heartbeat:IPaddr2):        Started debian11-0
  * WebServer   (systemd:nginx):         Started debian11-0

Daemon Status:
  corosync: active/disabled
  pacemaker: active/disabled
  pcsd: active/enabled
```

## ãƒã‚¹ã‚¿ãƒ¼ç³»ã®åˆ‡ã‚Šé›¢ã—

ãƒã‚¹ã‚¿ãƒ¼å´ãƒãƒ¼ãƒ‰ã‚’ã‚¹ã‚¿ãƒ³ãƒã‚¤ãƒ¢ãƒ¼ãƒ‰ã«ã—ã¾ã™ã€‚
ãƒªã‚½ãƒ¼ã‚¹ãŒã‚¹ã‚¿ãƒ³ãƒã‚¤ç³»ã¸ç§»å‹•ã—ã¾ã™ã€‚

ã‚¹ã‚¿ãƒ³ãƒã‚¤ãƒ¢ãƒ¼ãƒ‰ã¸ã®ç§»è¡Œã¯ã€ã©ã¡ã‚‰ã®ãƒãƒ¼ãƒ‰ã§å®Ÿè¡Œã—ã¦ã‚‚æ§‹ã„ã¾ã›ã‚“ã€‚

```
# pcs node standby debian11-0

# pcs status
Cluster name: web_cluster
Cluster Summary:
  * Stack: corosync
  * Current DC: debian11-1 (version 2.0.5-ba59be7122) - partition with quorum
  * Last updated: Sat Aug  5 18:51:26 2023
  * Last change:  Sat Aug  5 18:51:18 2023 by root via cibadmin on debian11-1
  * 2 nodes configured
  * 2 resource instances configured

Node List:
  * Node debian11-0: standby
  * Online: [ debian11-1 ]

Full List of Resources:
  * ClusterIP   (ocf::heartbeat:IPaddr2):        Started debian11-1
  * WebServer   (systemd:nginx):         Started debian11-1

Daemon Status:
  corosync: active/disabled
  pacemaker: active/disabled
  pcsd: active/enabled
```

ãƒã‚¹ã‚¿ãƒ¼ç³»ã‚’ã‚¹ã‚¿ãƒ³ãƒã‚¤ãƒ¢ãƒ¼ãƒ‰ã‹ã‚‰æˆ»ã—ã¾ã™ã€‚
ãƒªã‚½ãƒ¼ã‚¹ãŒãƒã‚¹ã‚¿ãƒ¼ç³»ã¸æˆ»ã‚Šã¾ã™ã€‚
```
# pcs node unstandby debian11-0

# pcs status
Cluster name: web_cluster
Cluster Summary:
  * Stack: corosync
  * Current DC: debian11-1 (version 2.0.5-ba59be7122) - partition with quorum
  * Last updated: Sat Aug  5 18:52:45 2023
  * Last change:  Sat Aug  5 18:52:36 2023 by root via cibadmin on debian11-1
  * 2 nodes configured
  * 2 resource instances configured

Node List:
  * Online: [ debian11-0 debian11-1 ]

Full List of Resources:
  * ClusterIP   (ocf::heartbeat:IPaddr2):        Started debian11-0
  * WebServer   (systemd:nginx):         Started debian11-0

Daemon Status:
  corosync: active/disabled
  pacemaker: active/disabled
  pcsd: active/enabled
```

## ã‚¹ã‚¿ãƒ³ãƒã‚¤ç³»ã®åˆ‡ã‚Šé›¢ã—

```
# pcs node standby debian11-1

# pcs status
Cluster name: web_cluster
Cluster Summary:
  * Stack: corosync
  * Current DC: debian11-0 (version 2.0.5-ba59be7122) - partition with quorum
  * Last updated: Sat Aug  5 20:39:22 2023
  * Last change:  Sat Aug  5 20:39:17 2023 by root via cibadmin on debian11-0
  * 2 nodes configured
  * 2 resource instances configured

Node List:
  * Node debian11-1: standby
  * Online: [ debian11-0 ]

Full List of Resources:
  * ClusterIP   (ocf::heartbeat:IPaddr2):        Started debian11-0
  * WebServer   (systemd:nginx):         Started debian11-0

Daemon Status:
  corosync: active/disabled
  pacemaker: active/disabled
  pcsd: active/enabled
```

ã‚¹ã‚¿ãƒ³ãƒã‚¤ãƒ¢ãƒ¼ãƒ‰ã«ç§»è¡Œã—ãŸã‚¹ã‚¿ãƒ³ãƒã‚¤ç³»ã§ã€ã‚¯ãƒ©ã‚¹ã‚¿ã‚’åœæ­¢ã—ã¾ã™ã€‚
```
# pcs cluster stop debian11-1
debian11-1: Stopping Cluster (pacemaker)...
debian11-1: Stopping Cluster (corosync)...

# pcs status
Cluster name: web_cluster
Cluster Summary:
  * Stack: corosync
  * Current DC: debian11-0 (version 2.0.5-ba59be7122) - partition with quorum
  * Last updated: Sat Aug  5 20:41:26 2023
  * Last change:  Sat Aug  5 20:39:17 2023 by root via cibadmin on debian11-0
  * 2 nodes configured
  * 2 resource instances configured

Node List:
  * Node debian11-1: OFFLINE (standby)
  * Online: [ debian11-0 ]

Full List of Resources:
  * ClusterIP   (ocf::heartbeat:IPaddr2):        Started debian11-0
  * WebServer   (systemd:nginx):         Started debian11-0

Daemon Status:
  corosync: active/disabled
  pacemaker: active/disabled
  pcsd: active/enabled
```

ã‚¹ã‚¿ãƒ³ãƒã‚¤ç³»ã®OSå†èµ·å‹•ã—ã¦ã¿ã¾ã™ã€‚
```
# pcs status
Error: error running crm_mon, is pacemaker running?
  Could not connect to the CIB: Transport endpoint is not connected
  crm_mon: Error: cluster is not available on this node

# shutdown -r now
```

å†èµ·å‹•å¾Œã€pacemaker ã‚µãƒ¼ãƒ“ã‚¹ã‚’èµ·å‹•ã—ã¾ã™ã€‚
```
# systemctl start pacemaker

# pcs status
Cluster name: web_cluster
Cluster Summary:
  * Stack: corosync
  * Current DC: debian11-0 (version 2.0.5-ba59be7122) - partition with quorum
  * Last updated: Sat Aug  5 20:45:11 2023
  * Last change:  Sat Aug  5 20:39:17 2023 by root via cibadmin on debian11-0
  * 2 nodes configured
  * 2 resource instances configured

Node List:
  * Node debian11-1: standby
  * Online: [ debian11-0 ]

Full List of Resources:
  * ClusterIP   (ocf::heartbeat:IPaddr2):        Started debian11-0
  * WebServer   (systemd:nginx):         Started debian11-0

Daemon Status:
  corosync: active/disabled
  pacemaker: active/disabled
  pcsd: active/enabled
```

ã‚¹ã‚¿ãƒ³ãƒã‚¤ç³»ã‚’ã‚¯ãƒ©ã‚¹ã‚¿ã¸å†åº¦çµ„ã¿å…¥ã‚Œã¾ã™ã€‚
```
# pcs node unstandby debian11-1

# pcs status
Cluster name: web_cluster
Cluster Summary:
  * Stack: corosync
  * Current DC: debian11-0 (version 2.0.5-ba59be7122) - partition with quorum
  * Last updated: Sat Aug  5 20:46:50 2023
  * Last change:  Sat Aug  5 20:46:46 2023 by root via cibadmin on debian11-0
  * 2 nodes configured
  * 2 resource instances configured

Node List:
  * Online: [ debian11-0 debian11-1 ]

Full List of Resources:
  * ClusterIP   (ocf::heartbeat:IPaddr2):        Started debian11-0
  * WebServer   (systemd:nginx):         Started debian11-0

Daemon Status:
  corosync: active/disabled
  pacemaker: active/disabled
  pcsd: active/enabled
```

:::message
TIPS: ä¸¡æ–¹ã®OSã¨ã‚‚é›»æºæ–­ã‹ã‚‰èµ·å‹•ã—ãŸã¨ãã€(èµ·å‹•ã—ã¦ã„ãªã‘ã‚Œã°)ä¸¡ç³»ã§ pacemaker ã‚µãƒ¼ãƒ“ã‚¹ã‚’èµ·å‹•ã™ã‚‹
:::