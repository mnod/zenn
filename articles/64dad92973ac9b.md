---
title: "Ciscoãƒ«ãƒ¼ã‚¿ã‹ã‚‰ AWS Site to Site VPN ã¸ã®æ¥ç¶šã‚’è©¦ã™"
emoji: "ğŸ›‘"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["aws", "ipsec", "cisco"]
published: true
---

# (1) é™çš„ãƒ«ãƒ¼ãƒˆã‚’åˆ©ç”¨ / IKEv1ã§æ¥ç¶š

```
# ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«IPã‚¢ãƒ‰ãƒ¬ã‚¹
publicip=x.x.x.x

# VGWã‚’ã‚¢ã‚¿ãƒƒãƒã™ã‚‹VPC
vpcid=vpc-<unique-id>

# ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã®BGP ASN
customerasn=65000

# AWSå´ã®BGP ASN
amazonasn=64512

# ãƒ«ãƒ¼ãƒˆã‚’ä¼æ’­ã™ã‚‹ãƒ«ãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«
routetableid=rtb-<uniqueid>

# VGWã‚’å®›å…ˆã¨ã™ã‚‹ã‚¢ãƒ‰ãƒ¬ã‚¹å¸¯(ã‚¹ã‚¿ãƒ†ã‚£ãƒƒã‚¯ãƒ«ãƒ¼ãƒˆ)
localcidr=x.x.x.x/x
```

AWS S2S VPNã¯ï¼’ã‚»ãƒƒã‚·ãƒ§ãƒ³è²¼ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚
éšœå®³ç™ºç”Ÿæ™‚ã«ãƒ«ãƒ¼ãƒˆã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹è¨­å®šã‚’å…¥ã‚Œã‚‹ã¨ç›¤çŸ³ã€‚
(ã“ã“ã§ã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ï¼‘ã¤ã—ã‹ã¯ã‚‰ãªã„)

## ä»®æƒ³ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã®ä½œæˆ
```
aws ec2 create-vpn-gateway --type ipsec.1 --amazon-side-asn ${amazonasn}
```

çµæœç¢ºèª
```
vpngatewayid=vgw-<unique-id>
aws ec2 describe-vpn-gateways --vpn-gateway-ids ${vpngatewayid}
```

## VPCã¸ã®VGWã®ã‚¢ã‚¿ãƒƒãƒ

```
aws ec2 attach-vpn-gateway --vpn-gateway-id ${vpngatewayid} --vpc-id ${vpcid}
```

çµæœç¢ºèª
```
aws ec2 describe-vpn-gateways --vpn-gateway-ids ${vpngatewayid}
```

## ã‚«ã‚¹ã‚¿ãƒãƒ¼ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã®ä½œæˆ
```
aws ec2 create-customer-gateway --type ipsec.1 --public-ip ${publicip} --bgp-asn ${customerasn}
```

çµæœç¢ºèª
```
customergatewayid=cgw-<unique-id>
aws ec2 describe-customer-gateways --customer-gateway-ids ${customergatewayid}
```

## VPNæ¥ç¶šã®ä½œæˆ

é™çš„ãƒ«ãƒ¼ãƒˆã®ã¿åˆ©ç”¨ã™ã‚‹
```
aws ec2 create-vpn-connection --type ipsec.1 --customer-gateway-id ${customergatewayid} --vpn-gateway-id ${vpngatewayid} \
--options "{\"StaticRoutesOnly\":true}"
```

çµæœç¢ºèª
```
vpnconnectionid=vpn-<unique-id>
aws ec2 describe-vpn-connections --vpn-connection-ids ${vpnconnectionid}
```

VPNæ¥ç¶šç”¨ã®ã‚¹ã‚¿ãƒ†ã‚£ãƒƒã‚¯ãƒ«ãƒ¼ãƒˆã®è¿½åŠ 

```
aws ec2 create-vpn-connection-route --vpn-connection-id ${vpnconnectionid} --destination-cidr-block ${localcidr}
```

```
aws ec2 describe-vpn-connections --vpn-connection-ids ${vpnconnectionid}
```

## å¯¾å‘ã®è¨­å®šã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
åˆ©ç”¨ã§ãã‚‹ãƒ‡ãƒã‚¤ã‚¹ã‚¿ã‚¤ãƒ—ã‚’ç¢ºèª
```
aws ec2 get-vpn-connection-device-types --query 'VpnConnectionDeviceTypes[?Vendor==`Cisco Systems, Inc.`]'
aws ec2 get-vpn-connection-device-types --query 'VpnConnectionDeviceTypes[?Vendor==`Strongswan`]'
```

ç›®çš„ã®ãƒ‡ãƒã‚¤ã‚¹ã®ã‚‚ã®ã‚’å‡ºåŠ›
```
aws ec2 get-vpn-connection-device-sample-configuration --vpn-connection-id ${vpnconnectionid} \
--vpn-connection-device-type-id b0adb196 --internet-key-exchange-version ikev1 --output text
```

## Cisco ãƒ«ãƒ¼ã‚¿ã®è¨­å®š

å¿…è¦ã¨ãªã‚‹æƒ…å ±ã¯
<VGWã®ã‚¢ãƒ‰ãƒ¬ã‚¹>
<ãƒ«ãƒ¼ã‚¿ã®ã‚¢ãƒ‰ãƒ¬ã‚¹> NATè¶…ãˆã®å ´åˆã¯ã€ãƒ«ãƒ¼ã‚¿ã®ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã„ã„ã€‚
<PSK>
<ãƒˆãƒ³ãƒãƒ«ãƒ‡ãƒã‚¤ã‚¹ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹> ã¨ <ãƒˆãƒ³ãƒãƒ«ãƒ‡ãƒã‚¤ã‚¹ã®NWãƒã‚¹ã‚¯>
<VPCã®IPã‚¢ãƒ‰ãƒ¬ã‚¹> ã¨ <VPCã®ã®NWãƒã‚¹ã‚¯>

```
crypto isakmp policy 200
  encryption aes 128
  authentication pre-share
  group 2
  lifetime 28800
  hash sha

crypto keyring keyring-awsvpn-0
  local-address <ãƒ«ãƒ¼ã‚¿ã®ã‚¢ãƒ‰ãƒ¬ã‚¹>
  pre-shared-key address <VGWã®ã‚¢ãƒ‰ãƒ¬ã‚¹> key <pre shared key>

crypto isakmp profile isakmp-awsvpn-0
  local-address <ãƒ«ãƒ¼ã‚¿ã®ã‚¢ãƒ‰ãƒ¬ã‚¹>
  match identity address <VGWã®ã‚¢ãƒ‰ãƒ¬ã‚¹>
  keyring keyring-awsvpn-0

crypto ipsec transform-set ipsec-prop-awsvpn-0 esp-aes 128 esp-sha-hmac
  mode tunnel

crypto ipsec profile ipsec-awsvpn-0
  set pfs group2
  set security-association lifetime seconds 3600
  set transform-set ipsec-prop-awsvpn-0

crypto ipsec df-bit clear
crypto ipsec security-association replay window-size 128
crypto ipsec fragmentation before-encryption

interface Tunnel1
  ip address <ãƒˆãƒ³ãƒãƒ«ãƒ‡ãƒã‚¤ã‚¹ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹> <ãƒˆãƒ³ãƒãƒ«ãƒ‡ãƒã‚¤ã‚¹ã®NWãƒã‚¹ã‚¯>
  ip virtual-reassembly
  ! tunnel source 220.146.31.241
  tunnel source <ãƒ«ãƒ¼ã‚¿ã®ã‚¢ãƒ‰ãƒ¬ã‚¹>
  tunnel destination <VGWã®ã‚¢ãƒ‰ãƒ¬ã‚¹>
  tunnel mode ipsec ipv4
  tunnel protection ipsec profile ipsec-awsvpn-0
  ! This option causes the router to reduce the Maximum Segment Size of
  ! TCP packets to prevent packet fragmentation.
  ip tcp adjust-mss 1379
  no shutdown

ip route <VPCã®IPã‚¢ãƒ‰ãƒ¬ã‚¹> <VPCã®ã®NWãƒã‚¹ã‚¯> Tunnel1
```

çµæœç¢ºèª

```
R1#show crypto isakmp sa 
IPv4 Crypto ISAKMP SA
dst             src             state          conn-id status
3.114.212.141   192.168.11.212  QM_IDLE           1001 ACTIVE

IPv6 Crypto ISAKMP SA

```

```
R1#show crypto ipsec sa

interface: Tunnel1
    Crypto map tag: Tunnel1-head-0, local addr 192.168.11.212

   protected vrf: (none)
   local  ident (addr/mask/prot/port): (0.0.0.0/0.0.0.0/0/0)
   remote ident (addr/mask/prot/port): (0.0.0.0/0.0.0.0/0/0)
   current_peer 3.114.212.141 port 4500
     PERMIT, flags={origin_is_acl,}
    #pkts encaps: 1, #pkts encrypt: 1, #pkts digest: 1
    #pkts decaps: 1, #pkts decrypt: 1, #pkts verify: 1
    #pkts compressed: 0, #pkts decompressed: 0
    #pkts not compressed: 0, #pkts compr. failed: 0
    #pkts not decompressed: 0, #pkts decompress failed: 0
    #send errors 0, #recv errors 0

     local crypto endpt.: 192.168.11.212, remote crypto endpt.: 3.114.212.141
     plaintext mtu 1422, path mtu 1500, ip mtu 1500, ip mtu idb FastEthernet0/0
     current outbound spi: 0xC1851607(3246724615)
     PFS (Y/N): Y, DH group: group2

     inbound esp sas:
      spi: 0xDD6AD72(232172914)
        transform: esp-aes esp-sha-hmac ,
        in use settings ={Tunnel UDP-Encaps, }
        conn id: 1, flow_id: SW:1, sibling_flags 80004040, crypto map: Tunnel1-head-0
        sa timing: remaining key lifetime (k/sec): (4304515/3513)
        IV size: 16 bytes
        replay detection support: Y  replay window size: 128
        Status: ACTIVE(ACTIVE)

     inbound ah sas:

     inbound pcp sas:

     outbound esp sas:
      spi: 0xC1851607(3246724615)
        transform: esp-aes esp-sha-hmac ,
        in use settings ={Tunnel UDP-Encaps, }
        conn id: 2, flow_id: SW:2, sibling_flags 80004040, crypto map: Tunnel1-head-0
        sa timing: remaining key lifetime (k/sec): (4304515/3513)
        IV size: 16 bytes
        replay detection support: Y  replay window size: 128
        Status: ACTIVE(ACTIVE)
          
     outbound ah sas:

     outbound pcp sas:
```

```
R1#show crypto ipsec transform-set
Transform set default: { esp-aes esp-sha-hmac  } 
   will negotiate = { Transport,  }, 
   
Transform set ipsec-prop-awss2svpn-0: { esp-aes esp-sha-hmac  } 
   will negotiate = { Tunnel,  }, 
```


```
R1#show crypto session int tun1
Crypto session current status

Interface: Tunnel1
Profile: isakmp-awss2svpn-0
Session status: UP-ACTIVE     
Peer: 3.114.212.141 port 4500 
  Session ID: 0  
  IKEv1 SA: local 192.168.11.212/4500 remote 3.114.212.141/4500 Active 
  IPSEC FLOW: permit ip 0.0.0.0/0.0.0.0 0.0.0.0/0.0.0.0 
        Active SAs: 2, origin: crypto map
```

```
R1#show crypto session int tun1 detail
Crypto session current status

Code: C - IKE Configuration mode, D - Dead Peer Detection     
K - Keepalives, N - NAT-traversal, T - cTCP encapsulation     
X - IKE Extended Authentication, F - IKE Fragmentation

Interface: Tunnel1
Profile: isakmp-awss2svpn-0
Uptime: 00:04:35
Session status: UP-ACTIVE     
Peer: 3.114.212.141 port 4500 fvrf: (none) ivrf: (none)
      Phase1_id: 3.114.212.141
      Desc: (none)
  Session ID: 0  
  IKEv1 SA: local 192.168.11.212/4500 remote 3.114.212.141/4500 Active 
          Capabilities:N connid:1001 lifetime:07:55:24
  IPSEC FLOW: permit ip 0.0.0.0/0.0.0.0 0.0.0.0/0.0.0.0 
        Active SAs: 2, origin: crypto map
        Inbound:  #pkts dec'ed 3 drop 0 life (KB/Sec) 4304515/3324
        Outbound: #pkts enc'ed 3 drop 0 life (KB/Sec) 4304515/3324

```


AWS å´ã§æ¥ç¶šã‚’ç¢ºèª
```
aws ec2 describe-vpn-connections --vpn-connection-ids ${vpnconnectionid}
```


##  ãƒ«ãƒ¼ãƒˆã®ä¼æ’­

```
aws ec2 enable-vgw-route-propagation --gateway-id ${vpngatewayid} --route-table-id ${routetableid}
```

çµæœç¢ºèª
```
aws ec2 describe-route-tables --route-table-id ${routetableid}
```

## ç‰‡ä»˜ã‘
```
aws ec2 disable-vgw-route-propagation --gateway-id ${vpngatewayid} --route-table-id ${routetableid}
```

```
aws ec2 delete-vpn-connection-route --vpn-connection-id ${vpnconnectionid} --destination-cidr-block ${localcidr}
```


```
aws ec2 delete-vpn-connection --vpn-connection-id ${vpnconnectionid}
```

```
aws ec2 delete-customer-gateway --customer-gateway-id ${customergatewayid}
```


```
aws ec2 detach-vpn-gateway --vpc-id ${vpcid} --vpn-gateway-id ${vpngatewayid}
```

aws ec2 describe-vpn-gateways ã€œ ã§ã€detaching ã¨ãªã£ã¦ã„ã‚‹é–“ã¯æ¬¡ã®å‰Šé™¤ãŒã§ããªã„ã€‚detached ã¨ãªã‚‹ã¾ã§å¾…ã¤ã€‚
```
    "VpnGateways": [
        {
            "VpcAttachments": [
                {
                    "State": "detaching"
                }
            ]
        }
```

```
aws ec2 delete-vpn-gateway --vpn-gateway-id ${vpngatewayid}
```


# (2) BGPã‚’åˆ©ç”¨ / IKEv1ã§æ¥ç¶šã€‚

BGPã®è¨­å®šã‚’æ´»ã‹ã—ã¦ã€ï¼’ã¤ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³é–“ã§é€šä¿¡ã‚’æŒ¯ã‚Šåˆ†ã‘ãŸã‚Šã‚‚ã§ãã‚‹ã‚ˆã†ã ã€‚

## ä»®æƒ³ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã®ä½œæˆ
```
aws ec2 create-vpn-gateway --type ipsec.1 --amazon-side-asn ${amazonasn}
```

```
vpngatewayid=vgw-<unique-id>
aws ec2 describe-vpn-gateways --vpn-gateway-ids ${vpngatewayid}
```

## VPCã¸ã®VGWã®ã‚¢ã‚¿ãƒƒãƒ

```
aws ec2 attach-vpn-gateway --vpn-gateway-id ${vpngatewayid} --vpc-id ${vpcid}
```

```
aws ec2 describe-vpn-gateways --vpn-gateway-ids ${vpngatewayid}
```

## ã‚«ã‚¹ã‚¿ãƒãƒ¼ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã®ä½œæˆ
```
aws ec2 create-customer-gateway --type ipsec.1 --public-ip ${publicip} --bgp-asn ${customerasn}
```

```
customergatewayid=cgw-<unique-id>
aws ec2 describe-customer-gateways --customer-gateway-ids ${customergatewayid}
```

## VPNæ¥ç¶šã®ä½œæˆ
```
aws ec2 create-vpn-connection --type ipsec.1 --customer-gateway-id ${customergatewayid} --vpn-gateway-id ${vpngatewayid}
```

```
vpnconnectionid=vpn-<unique-id>
aws ec2 describe-vpn-connections --vpn-connection-ids ${vpnconnectionid}
```

## å¯¾å‘ã®è¨­å®šã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
```
aws ec2 get-vpn-connection-device-types --query 'VpnConnectionDeviceTypes[?Vendor==`Cisco Systems, Inc.`]'
aws ec2 get-vpn-connection-device-types --query 'VpnConnectionDeviceTypes[?Vendor==`Strongswan`]'

aws ec2 get-vpn-connection-device-sample-configuration --vpn-connection-id ${vpnconnectionid} \
--vpn-connection-device-type-id b0adb196 --internet-key-exchange-version ikev1 --output text
```



## Ciscoãƒ«ãƒ¼ã‚¿å´è¨­å®š

ãã®ä»–ã®è¨­å®šã¯(1)ã¨åŒæ§˜ãªã®ã§å‰²æ„›ã€‚

è¿½åŠ ã§BGPã®è¨­å®šã‚’ã™ã‚‹

<ãƒã‚¤ãƒãƒ¼ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹> ãƒˆãƒ³ãƒãƒ«IPã‚¢ãƒ‰ãƒ¬ã‚¹ã®ï¼‘ã¤è‹¥ç•ª
<ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã®ã‚¢ãƒ‰ãƒ¬ã‚¹å¸¯> 0.0.0.0 ã ã¨ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’VPNã«å‘ã‘ã‚‰ã‚Œã‚‹ã€‚

```
router bgp 65000
  neighbor <ãƒã‚¤ãƒãƒ¼ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹> remote-as 64512
  neighbor <ãƒã‚¤ãƒãƒ¼ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹> activate
  neighbor <ãƒã‚¤ãƒãƒ¼ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹> timers 10 30 30
  address-family ipv4 unicast
    neighbor <ãƒã‚¤ãƒãƒ¼ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹> remote-as 64512
    neighbor <ãƒã‚¤ãƒãƒ¼ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹> timers 10 30 30
    neighbor <ãƒã‚¤ãƒãƒ¼ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹> default-originate
    neighbor <ãƒã‚¤ãƒãƒ¼ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹> activate
    neighbor <ãƒã‚¤ãƒãƒ¼ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹> soft-reconfiguration inbound
    network <ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã®ã‚¢ãƒ‰ãƒ¬ã‚¹å¸¯>
  exit
exit
```

ãƒã‚¤ãƒãƒ¼ã‚’ç¢ºèª
```
R1#show ip bgp summ
BGP router identifier 192.168.100.1, local AS number 65000
BGP table version is 2, main routing table version 2
1 network entries using 144 bytes of memory
2 path entries using 160 bytes of memory
2/1 BGP path/bestpath attribute entries using 288 bytes of memory
0 BGP route-map cache entries using 0 bytes of memory
0 BGP filter-list cache entries using 0 bytes of memory
BGP using 592 total bytes of memory
BGP activity 1/0 prefixes, 2/0 paths, scan interval 60 secs

Neighbor        V           AS MsgRcvd MsgSent   TblVer  InQ OutQ Up/Down  State/PfxRcd
<ãƒã‚¤ãƒãƒ¼ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹>  4        64512       3       5        2    0    0 00:00:04        0
```

ãƒˆãƒãƒ­ã‚¸ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç¢ºèª
```
R1#show ip bgp      
BGP table version is 3, local router ID is 192.168.100.1
Status codes: s suppressed, d damped, h history, * valid, > best, i - internal, 
              r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter, 
              x best-external, a additional-path, c RIB-compressed, 
Origin codes: i - IGP, e - EGP, ? - incomplete
RPKI validation codes: V valid, I invalid, N Not found

     Network          Next Hop            Metric LocPrf Weight Path
     0.0.0.0          0.0.0.0                                0 i
 *>                   192.168.11.254           0         32768 i
 *>  10.0.0.0/16      <ãƒã‚¤ãƒãƒ¼ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹>         100             0 64512 i
```

ãƒ«ãƒ¼ãƒˆã‚’ç¢ºèª
```
R1#show ip route bgp
Codes: L - local, C - connected, S - static, R - RIP, M - mobile, B - BGP
       D - EIGRP, EX - EIGRP external, O - OSPF, IA - OSPF inter area 
       N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2
       E1 - OSPF external type 1, E2 - OSPF external type 2
       i - IS-IS, su - IS-IS summary, L1 - IS-IS level-1, L2 - IS-IS level-2
       ia - IS-IS inter area, * - candidate default, U - per-user static route
       o - ODR, P - periodic downloaded static route, H - NHRP, l - LISP
       a - application route
       + - replicated route, % - next hop override

Gateway of last resort is 192.168.11.254 to network 0.0.0.0

      10.0.0.0/16 is subnetted, 1 subnets
B        10.0.0.0 [20/100] via <ãƒã‚¤ãƒãƒ¼ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹>, 00:00:23
```


AWS å´ã§æ¥ç¶šã‚’ç¢ºèª
```
aws ec2 describe-vpn-connections --vpn-connection-ids ${vpnconnectionid}
```

BGPã‚’è¨­å®šã—ãªã„ã¨ IPSEC IS UPã¨ãªã£ã¦ã‚‚ã€Status ã¯ Downã®ã¾ã¾ã¨ãªã‚‹ã€‚
```
            "VgwTelemetry": [                                                                                                                                                                                      
                {                                                                                                                                                                                                  
                    "AcceptedRouteCount": 0,                                                                                                                                                                       
                    "LastStatusChange": "2025-07-17T22:48:35+00:00",                                     
                    "OutsideIpAddress": "3.114.212.141",                                                 
                    "Status": "DOWN",                                                                    
                    "StatusMessage": "IPSEC IS UP"                                                       
                },                                  
                {                                                                                                                                                                                                  
                    "AcceptedRouteCount": 0,                                                                                                                                                                       
                    "LastStatusChange": "2025-07-17T22:40:48+00:00",                                     
                    "OutsideIpAddress": "13.230.233.135",                                                
                    "Status": "DOWN",                                                                                                                                                                              
                    "StatusMessage": "IPSEC IS DOWN"                                                                                                                                                               
                }                                                                                                                                                                                                  
            ],                                 

```

BGP ãŒãƒã‚¤ãƒãƒ¼é–¢ä¿‚ã«ãªã‚‹ã¨UPã«ãªã‚‹ã€‚

```
            "VgwTelemetry": [
                {
                    "AcceptedRouteCount": 1,
                    "LastStatusChange": "2025-07-17T23:08:38+00:00",
                    "OutsideIpAddress": "3.114.212.141",
                    "Status": "UP",
                    "StatusMessage": "1 BGP ROUTES"
                },
                {
                    "AcceptedRouteCount": 0,
                    "LastStatusChange": "2025-07-17T22:40:48+00:00",
                    "OutsideIpAddress": "13.230.233.135",
                    "Status": "DOWN",
                    "StatusMessage": "IPSEC IS DOWN"
                }

```



##  ãƒ«ãƒ¼ãƒˆã®ä¼æ’­

```
aws ec2 enable-vgw-route-propagation --gateway-id ${vpngatewayid} --route-table-id ${routetableid}
```

```
aws ec2 describe-route-tables --route-table-id ${routetableid}
```

## ç‰‡ä»˜ã‘
```
aws ec2 disable-vgw-route-propagation --gateway-id ${vpngatewayid} --route-table-id ${routetableid}
```

```
aws ec2 delete-vpn-connection --vpn-connection-id ${vpnconnectionid}
```

```
aws ec2 delete-customer-gateway --customer-gateway-id ${customergatewayid}
```


```
aws ec2 detach-vpn-gateway --vpc-id ${vpcid} --vpn-gateway-id ${vpngatewayid}
```


```
aws ec2 delete-vpn-gateway --vpn-gateway-id ${vpngatewayid}
```

# (3) é™çš„ãƒ«ãƒ¼ãƒˆã‚’åˆ©ç”¨ / IKEv2ã§æ¥ç¶š

AWSã«å¯¾ã—ã¦ã¯ã€åŸºæœ¬çš„ã« (1) ã¨åŒæ§˜ã®æ“ä½œã€‚

## å¯¾å‘ã®è¨­å®šã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ

```
aws ec2 get-vpn-connection-device-sample-configuration --vpn-connection-id ${vpnconnectionid} \
--vpn-connection-device-type-id 7b754310 --internet-key-exchange-version ikev2 --output text
```

## Cisco ãƒ«ãƒ¼ã‚¿ã®è¨­å®š

<VGWã®ã‚¢ãƒ‰ãƒ¬ã‚¹>
<ãƒ«ãƒ¼ã‚¿ã®ã‚¢ãƒ‰ãƒ¬ã‚¹> NATè¶…ãˆã®å ´åˆã¯ã€ãƒ«ãƒ¼ã‚¿ã®ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã„ã„ã€‚
<PSK>
<ãƒˆãƒ³ãƒãƒ«ãƒ‡ãƒã‚¤ã‚¹ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹> ã¨ <ãƒˆãƒ³ãƒãƒ«ãƒ‡ãƒã‚¤ã‚¹ã®NWãƒã‚¹ã‚¯>
<VPCã®IPã‚¢ãƒ‰ãƒ¬ã‚¹> ã¨ <VPCã®ã®NWãƒã‚¹ã‚¯>

```
crypto ikev2 proposal PROPOSAL1
  encryption aes-cbc-128
  integrity sha1
  group 2

crypto ikev2 policy POLICY1
  match address local <ãƒ«ãƒ¼ã‚¿ã®ã‚¢ãƒ‰ãƒ¬ã‚¹>
  proposal PROPOSAL1

crypto ikev2 keyring KEYRING1
  peer <VGWã®ã‚¢ãƒ‰ãƒ¬ã‚¹>
  address <VGWã®ã‚¢ãƒ‰ãƒ¬ã‚¹>
  pre-shared-key <PSK>

crypto ikev2 profile IKEV2-PROFILE
  match address local <ãƒ«ãƒ¼ã‚¿ã®ã‚¢ãƒ‰ãƒ¬ã‚¹>
  match identity remote address <VGWã®ã‚¢ãƒ‰ãƒ¬ã‚¹>
  authentication remote pre-share
  authentication local pre-share
  keyring local KEYRING1
  lifetime 28800
  dpd 10 10 on-demand

crypto ipsec transform-set ipsec-prop-awsvpn-0 esp-aes 128 esp-sha-hmac
  mode tunnel

crypto ipsec profile ipsec-awsvpn-0
  set pfs group2
  set security-association lifetime seconds 3600
  set transform-set ipsec-prop-awsvpn-0
  set ikev2-profile IKEV2-PROFILE

crypto ipsec df-bit clear
crypto isakmp keepalive 10 10
crypto ipsec security-association replay window-size 128
crypto ipsec fragmentation before-encryption

interface Tunnel1
  ip address <ãƒˆãƒ³ãƒãƒ«ãƒ‡ãƒã‚¤ã‚¹ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹> <ãƒˆãƒ³ãƒãƒ«ãƒ‡ãƒã‚¤ã‚¹ã®NWãƒã‚¹ã‚¯>
  ip virtual-reassembly
  tunnel source <ãƒ«ãƒ¼ã‚¿ã®ã‚¢ãƒ‰ãƒ¬ã‚¹>
  tunnel destination <VGWã®ã‚¢ãƒ‰ãƒ¬ã‚¹>
  tunnel mode ipsec ipv4
  tunnel protection ipsec profile ipsec-awsvpn-0
  ip tcp adjust-mss 1379
  no shutdown

ip route <VPCã®IPã‚¢ãƒ‰ãƒ¬ã‚¹> <VPCã®ã®NWãƒã‚¹ã‚¯> Tunnel1
```


çµæœç¢ºèª
```
IOU2#show crypto ikev2 sa          
 IPv4 Crypto IKEv2  SA 

Tunnel-id Local                 Remote                fvrf/ivrf            Status 
1         192.168.11.212/4500   54.65.54.133/4500     none/none            READY  
      Encr: AES-CBC, keysize: 128, Hash: SHA96, DH Grp:2, Auth sign: PSK, Auth verify: PSK
      Life/Active Time: 28800/1425 sec

 IPv6 Crypto IKEv2  SA 
```

```
IOU2#show crypto ipsec sa

interface: Tunnel1
    Crypto map tag: Tunnel1-head-0, local addr 192.168.11.212

   protected vrf: (none)
   local  ident (addr/mask/prot/port): (0.0.0.0/0.0.0.0/0/0)
   remote ident (addr/mask/prot/port): (0.0.0.0/0.0.0.0/0/0)
   current_peer 54.65.54.133 port 4500
     PERMIT, flags={origin_is_acl,}
    #pkts encaps: 5, #pkts encrypt: 5, #pkts digest: 5
    #pkts decaps: 5, #pkts decrypt: 5, #pkts verify: 5
    #pkts compressed: 0, #pkts decompressed: 0
    #pkts not compressed: 0, #pkts compr. failed: 0
    #pkts not decompressed: 0, #pkts decompress failed: 0
    #send errors 0, #recv errors 0

     local crypto endpt.: 192.168.11.212, remote crypto endpt.: 54.65.54.133
     plaintext mtu 1422, path mtu 1500, ip mtu 1500, ip mtu idb Ethernet0/0
     current outbound spi: 0xCEB1B70E(3467753230)
     PFS (Y/N): N, DH group: none

     inbound esp sas:
      spi: 0x85418A83(2235665027)
        transform: esp-aes esp-sha-hmac ,
        in use settings ={Tunnel UDP-Encaps, }
        conn id: 2, flow_id: SW:2, sibling_flags 80000040, crypto map: Tunnel1-head-0
        sa timing: remaining key lifetime (k/sec): (4177787/2106)
        IV size: 16 bytes
        replay detection support: Y
        ecn bit support: Y status: off  replay window size: 128
        Status: ACTIVE(ACTIVE)

     inbound ah sas:

     inbound pcp sas:

     outbound esp sas:
      spi: 0xCEB1B70E(3467753230)
        transform: esp-aes esp-sha-hmac ,
        in use settings ={Tunnel UDP-Encaps, }
        conn id: 1, flow_id: SW:1, sibling_flags 80000040, crypto map: Tunnel1-head-0
        sa timing: remaining key lifetime (k/sec): (4177787/2106)
        IV size: 16 bytes
        replay detection support: Y
        ecn bit support: Y status: off  replay window size: 128
        Status: ACTIVE(ACTIVE)

     outbound ah sas:

     outbound pcp sas:
```

```
IOU2#show crypto ipsec transform-set
Transform set default: { esp-aes esp-sha-hmac  } 
   will negotiate = { Transport,  }, 
   
Transform set ipsec-prop-awsvpn-0: { esp-aes esp-sha-hmac  } 
   will negotiate = { Tunnel,  }, 
```

```
IOU2#show crypto session int tun1
Crypto session current status

Interface: Tunnel1
Profile: IKEV2-PROFILE
Session status: UP-ACTIVE     
Peer: 54.65.54.133 port 4500 
  Session ID: 1  
  IKEv2 SA: local 192.168.11.212/4500 remote 54.65.54.133/4500 Active 
  IPSEC FLOW: permit ip 0.0.0.0/0.0.0.0 0.0.0.0/0.0.0.0 
        Active SAs: 2, origin: crypto map
```

```
IOU2#show crypto session int tun1 detail
Crypto session current status

Code: C - IKE Configuration mode, D - Dead Peer Detection     
K - Keepalives, N - NAT-traversal, T - cTCP encapsulation     
X - IKE Extended Authentication, F - IKE Fragmentation
R - IKE Auto Reconnect

Interface: Tunnel1
Profile: IKEV2-PROFILE
Uptime: 00:27:21
Session status: UP-ACTIVE     
Peer: 54.65.54.133 port 4500 fvrf: (none) ivrf: (none)
      Phase1_id: 54.65.54.133
      Desc: (none)
  Session ID: 1  
  IKEv2 SA: local 192.168.11.212/4500 remote 54.65.54.133/4500 Active 
          Capabilities:DN connid:1 lifetime:07:32:39
  IPSEC FLOW: permit ip 0.0.0.0/0.0.0.0 0.0.0.0/0.0.0.0 
        Active SAs: 2, origin: crypto map
        Inbound:  #pkts dec'ed 5 drop 0 life (KB/Sec) 4177787/1959
        Outbound: #pkts enc'ed 5 drop 0 life (KB/Sec) 4177787/1959
```
