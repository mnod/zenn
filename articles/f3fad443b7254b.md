---
title: "OpenSSHã®è¨¼æ˜æ›¸èªè¨¼ã‚’è©¦ã™"
emoji: "ğŸªª"
type: "tech"
topics: ["openssh"]
published: true
---

# OpenSSHã®è¨¼æ˜æ›¸èªè¨¼ã«ã¤ã„ã¦

https://docs.redhat.com/ja/documentation/red_hat_enterprise_linux/6/html/deployment_guide/sec-using_openssh_certificate_authentication

## ãƒ¦ãƒ¼ã‚¶èªè¨¼

- CAç§˜å¯†éµã§ç½²åã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶è¨¼æ˜æ›¸(å…¬é–‹éµ)ã®ç½²åæƒ…å ±ã‚’åˆ©ç”¨ã—ã¦èªè¨¼ã™ã‚‹ã€‚
- SSHã‚µãƒ¼ãƒã«ã¯CAå…¬é–‹éµã‚’ç™»éŒ²ã—ã€ãƒ¦ãƒ¼ã‚¶ã‹ã‚‰é€ã‚‰ã‚Œã¦ããƒ¦ãƒ¼ã‚¶è¨¼æ˜æ›¸ã‚’æ¤œè¨¼ã™ã‚‹ã€‚

å…¬é–‹éµã‚’ãƒ¦ãƒ¼ã‚¶ãƒ›ãƒ¼ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ä¸‹ã® ~/.ssh/authorized_keys ã«è¨˜è¼‰ã—ãªãã¦ã‚ˆã„ã€‚(ã‚€ã—ã‚ç½®ã„ã¦ã¯ã„ã‘ãªã„ï¼Ÿ)

## ãƒ›ã‚¹ãƒˆèªè¨¼

- æ¥ç¶šå…ˆã®SSHã‚µãƒ¼ãƒãŒç›®çš„ã®ãƒ›ã‚¹ãƒˆã§ã‚ã‚‹ã“ã¨ã‚’èªè¨¼ã—ã¦è©ç§°ã‚’é˜²ãæŠ€è¡“ã€‚
- SSHã‚µãƒ¼ãƒã«ã¯CAç§˜å¯†éµã§ç½²åã—ãŸãƒ›ã‚¹ãƒˆã‚­ãƒ¼ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€SSHã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ãƒ¦ãƒ¼ã‚¶é ˜åŸŸã«ã¯CAå…¬é–‹éµã®æƒ…å ±ã‚’ä¿ç®¡ã™ã‚‹ã€‚
- SSHã‚µãƒ¼ãƒã‹ã‚‰é€ã‚‰ã‚Œã¦ããŸãƒ›ã‚¹ãƒˆã‚­ãƒ¼ãŒã€ä¿¡é ¼ã—ã¦ã„ã‚‹CAè¨¼æ˜æ›¸ã§ç½²åã•ã‚ŒãŸã‚‚ã®ã‚’ç¢ºèªã™ã‚‹ã€‚

~/.ssh/known_hosts ã«ã¯SSHã‚µãƒ¼ãƒã®ãƒ›ã‚¹ãƒˆã‚­ãƒ¼ã§ã¯ãªã¦ãã€CAå…¬é–‹éµã®æƒ…å ±ã‚’è¨˜è¼‰ã—ã¦ã‚„ã‚‹ã€‚
â†’ åˆå›SSHæ¥ç¶šæ™‚ã«é€šå¸¸ã ã¨ãƒ›ã‚¹ãƒˆã‚­ãƒ¼ã®ãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ—ãƒªãƒ³ãƒˆãŒè¡¨ç¤ºã•ã‚Œã€Œä¿¡é ¼ã—ã¾ã™ã‹ï¼Ÿã€ã¨è¡¨ç¤ºã•ã‚Œã‚‹ã¨ã“ã‚ã®å‡¦ç†ãŒç„¡ããªã‚‹

# ãƒ†ã‚¹ãƒˆç’°å¢ƒ

## ã‚µãƒ¼ãƒå´

Raspberry Pi OS > KVM > Debian12
```
$ cat /etc/os-release
PRETTY_NAME="Debian GNU/Linux 12 (bookworm)"
NAME="Debian GNU/Linux"
VERSION_ID="12"
VERSION="12 (bookworm)"
VERSION_CODENAME=bookworm
ID=debian
HOME_URL="https://www.debian.org/"
SUPPORT_URL="https://www.debian.org/support"
BUG_REPORT_URL="https://bugs.debian.org/"

$ cat /etc/debian_version
12.0

$ uname -a
Linux debian12 6.1.0-9-arm64 #1 SMP Debian 6.1.27-1 (2023-05-08) aarch64 GNU/Linux
```

## ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´

Raspberry Pi OS > Docker > AmazonLinux2023
```
$ cat /etc/os-release
NAME="Amazon Linux"
VERSION="2023"
ID="amzn"
ID_LIKE="fedora"
VERSION_ID="2023"
PLATFORM_ID="platform:al2023"
PRETTY_NAME="Amazon Linux 2023.5.20240708"
ANSI_COLOR="0;33"
CPE_NAME="cpe:2.3:o:amazon:amazon_linux:2023"
HOME_URL="https://aws.amazon.com/linux/amazon-linux-2023/"
DOCUMENTATION_URL="https://docs.aws.amazon.com/linux/"
SUPPORT_URL="https://aws.amazon.com/premiumsupport/"
BUG_REPORT_URL="https://github.com/amazonlinux/amazon-linux-2023"
VENDOR_NAME="AWS"
VENDOR_URL="https://aws.amazon.com/"
SUPPORT_END="2028-03-15"

$ cat /etc/amazon-linux-release
Amazon Linux release 2023.5.20240708 (Amazon Linux)

$ uname -a
Linux e1c64185cb26 6.6.31+rpt-rpi-2712 #1 SMP PREEMPT Debian 1:6.6.31-1+rpt1 (2024-05-29) aarch64 aarch64 aarch64 GNU/Linux
```


# æ™®é€šã®å…¬é–‹éµèªè¨¼

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®éµãƒšã‚¢ã‚’ä½œæˆ
```
$ ssh-keygen -q -t ed25519
Enter file in which to save the key (/home/user/.ssh/id_ed25519):
Enter passphrase (empty for no passphrase):
Enter same passphrase again:

$ ls -l ~/.ssh/id_ed25519*
-rw------- 1 user user 399 Nov  2 06:13 /home/user/.ssh/id_ed25519
-rw-r--r-- 1 user user  95 Nov  2 06:13 /home/user/.ssh/id_ed25519.pub
```

å…¬é–‹éµã‚’ ~/.ssh/authorized_keys ã«è¿½è¨˜
```
$ cat ~/.ssh/id_ed25519.pub | tee -a ~/.ssh/authorized_keys
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIHylCHNgAqZNJrunlbek2+PiNNU/9jo/XjiJToRquOOq user@debian12
```

æ¥ç¶šãƒ†ã‚¹ãƒˆ
```
ssh -i ./id_ed25519 user@192.168.11.120
```

ã“ã®ã¨ãã‚µãƒ¼ãƒå´ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ­ã‚°ãŒå‡ºã‚‹ã€‚
```
# journalctl -u ssh
Nov 02 15:10:41 debian12 sshd[2953]: Accepted publickey for user from 192.168.11.250 port 55696 ssh2: ED25519 SHA256:tPR4rIIfnnh7gHp9sqNnrDGv2nukqx8QwlS2SxTC1Os
```


ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã‚’ç¦æ­¢ã—ãŸã„å ´åˆ(è¨¼æ˜æ›¸èªè¨¼ã«å¤±æ•—ã—ãŸã‚ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ãŸããªã„å ´åˆ)ã¯è¨­å®šã‚’å¤‰æ›´ã™ã‚‹
```
# sed -i -e '/#PasswordAuthentication/ s/.*/PasswordAuthentication no/' /etc/ssh/sshd_config

# systemctl restart ssh
```

# è¨¼æ˜æ›¸èªè¨¼ã®æº–å‚™

## CAè¨¼æ˜æ›¸ä½œæˆ

CAè¨¼æ˜æ›¸(ç½²åã™ã‚‹ãŸã‚ã®éµãƒšã‚¢)ã‚’ä½œæˆã™ã‚‹

```
$ ssh-keygen -q -t ed25519 -f ca.key
Enter passphrase (empty for no passphrase):
Enter same passphrase again:

$ ls -l ca.key*
-rw------- 1 root root 399 Nov  2 06:06 ca.key
-rw-r--r-- 1 root root  95 Nov  2 06:06 ca.key.pub
```

CAè¨¼æ˜æ›¸ã¨è¨€ã‚ã‚Œã‚‹ãŒã€ãŸã ã®SSHéµãƒšã‚¢ã§ã‚ã‚‹ã€‚

## ãƒ¦ãƒ¼ã‚¶è¨¼æ˜æ›¸ä½œæˆ

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®å…¬é–‹éµã«ç½²åã—ã¦ãƒ¦ãƒ¼ã‚¶è¨¼æ˜æ›¸ã‚’ä½œæˆã™ã‚‹ã€‚

ã‚·ãƒªã‚¢ãƒ«ã¨æœ‰åŠ¹æœŸé™ã‚’æŒ‡å®šã™ã‚‹ä¾‹
```
$ ssh-keygen -s ca.key -I certificate-test -n user -z $(date +%Y%m%d%H%M) -V +365d id_ed25519
Signed user key id_ed25519-cert.pub: id "certificate-test" serial 202411020544 for user valid from 2024-11-02T05:43:00 to 2025-11-02T05:44:56
    
$ ssh-keygen -L -f id_ed25519-cert.pub
id_ed25519-cert.pub:
        Type: ssh-ed25519-cert-v01@openssh.com user certificate
        Public key: ED25519-CERT SHA256:tPR4rIIfnnh7gHp9sqNnrDGv2nukqx8QwlS2SxTC1Os
        Signing CA: ED25519 SHA256:p12hRLK8xDAv+ArfcrZS1loLBUXkTC3JRtlRyYZvpwQ (using ssh-ed25519)
        Key ID: "certificate-test"
        Serial: 202411020544
        Valid: from 2024-11-02T05:43:00 to 2025-11-02T05:44:56
        Principals:
                user
        Critical Options: (none)
        Extensions:
                permit-X11-forwarding
                permit-agent-forwarding
                permit-port-forwarding
                permit-pty
                permit-user-rc
```

- è¨¼æ˜æ›¸ãªã®ã§æœ‰åŠ¹æœŸé™ã¯è¨­å®šã—ãŸã„ã€‚
- æ˜ç¤ºçš„ã«ç„¡åŠ¹åŒ–ã™ã‚‹ã«ã¯ã‚·ãƒªã‚¢ãƒ«ã®ç™»éŒ²ãŒå¿…è¦
- ã“ã“ã§ã¯æŒ‡å®šã—ã¦ã„ãªã„ãŒã€æ¥ç¶šå…ƒãƒ›ã‚¹ãƒˆã‚’é™å®šã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚‚ã‚ã‚‹ã‚ˆã†ã ã€‚

ä½œæˆã—ãŸè¨¼æ˜æ›¸ã‚’ãƒ¦ãƒ¼ã‚¶ã«é…å¸ƒã™ã‚‹ã€‚

## CAå…¬é–‹éµã®é…ç½®

SSHã‚µãƒ¼ãƒã«CAå…¬é–‹éµã‚’é…ç½®ã™ã‚‹ã€‚
```
# cp ~user/work/ca.key.pub /etc/ssh/ca.key.pub
# chown root: /etc/ssh/ca.key.pub

# echo "TrustedUserCAKeys /etc/ssh/ca.key.pub" | tee -a /etc/ssh/sshd_config
TrustedUserCAKeys /etc/ssh/ca.key.pub
```

## ãƒ›ã‚¹ãƒˆè¨¼æ˜æ›¸ã®ä½œæˆ

SSHãƒ›ã‚¹ãƒˆå…¬é–‹éµã‚’CAç§˜å¯†éµã§ç½²åã—ã¦ã€ãƒ›ã‚¹ãƒˆè¨¼æ˜æ›¸ã‚’ä½œæˆã™ã‚‹ã€‚

```
# ssh-keygen -s ~user/work/ca.key -h -I certificate-test /etc/ssh/ssh_host_ed25519_key.pub
Signed host key /etc/ssh/ssh_host_ed25519_key-cert.pub: id "certificate-test" serial 0 valid forever

# ssh-keygen -L -f /etc/ssh/ssh_host_ed25519_key-cert.pub
/etc/ssh/ssh_host_ed25519_key-cert.pub:
        Type: ssh-ed25519-cert-v01@openssh.com host certificate
        Public key: ED25519-CERT SHA256:RspUz/oxoReoB+85SbuIWjzAl9bfg8cNRzLjxtwEPfQ
        Signing CA: ED25519 SHA256:p12hRLK8xDAv+ArfcrZS1loLBUXkTC3JRtlRyYZvpwQ (using ssh-ed25519)
        Key ID: "certificate-test"
        Serial: 0
        Valid: forever
        Principals: (none)
        Critical Options: (none)
        Extensions: (none)

# echo "HostCertificate /etc/ssh/ssh_host_ed25519_key-cert.pub" | tee -a /etc/ssh/sshd_config
HostCertificate /etc/ssh/ssh_host_ed25519_key-cert.pub
```

## sshd å†èµ·å‹•

```
# systemctl restart ssh
```


# æ¥ç¶šãƒ†ã‚¹ãƒˆ

## ãƒ¦ãƒ¼ã‚¶å´ã§ä¿¡é ¼ã™ã‚‹CAå…¬é–‹éµã‚’è¨­å®š

```
cat << EOF >> known_hosts
@cert-authority 192.168.11.120 $(cat ca.key.pub)
EOF
```

## ~/.ssh/authorized_keys ã®é€€é¿

~/.ssh/authorized_keys ãŒã‚ã‚‹ã¨ã€å¼·åˆ¶çš„ã«é€šå¸¸ã®å…¬é–‹éµèªè¨¼ã«ãªã‚‹ã‚ˆã†ã ã€‚
å¾Œè¿°ã®KRLã®ä»•çµ„ã¿ã‚‚åŠ¹ã‹ãªããªã‚‹ã®ã§ã€ã‚‚ã—ã‚ã‚Œã°äºˆã‚å‰Šé™¤ã™ã‚‹ã€‚

## æ¥ç¶šãƒ†ã‚¹ãƒˆ

æ¥ç¶šã—ã¦ã¿ã‚‹
```
$ ssh -v -o UserKnownHostsFile=./known_hosts -i ./id_ed25519 -F /dev/null user@192.168.11.120
```

ãƒ›ã‚¹ãƒˆè¨¼æ˜æ›¸ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¤ºã™ãƒ‡ãƒãƒƒã‚°æƒ…å ±
```
debug1: Server host certificate: ssh-ed25519-cert-v01@openssh.com SHA256:RspUz/oxoReoB+85SbuIWjzAl9bfg8cNRzLjxtwEPfQ, serial 0 ID "certificate-test" CA ssh-ed25519 SHA256:p12hRLK8xDAv+ArfcrZS1loLBUXkTC3JRtlRyYZvpwQ valid forever
debug1: Host '192.168.11.120' is known and matches the ED25519-CERT host certificate.
```

ãƒ¦ãƒ¼ã‚¶è¨¼æ˜æ›¸ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¤ºã™ãƒ‡ãƒãƒƒã‚°æƒ…å ±
```
debug1: Will attempt key: ./id_ed25519 ED25519-CERT SHA256:tPR4rIIfnnh7gHp9sqNnrDGv2nukqx8QwlS2SxTC1Os explicit
debug1: Offering public key: ./id_ed25519 ED25519-CERT SHA256:tPR4rIIfnnh7gHp9sqNnrDGv2nukqx8QwlS2SxTC1Os explicit
debug1: Server accepts key: ./id_ed25519 ED25519-CERT SHA256:tPR4rIIfnnh7gHp9sqNnrDGv2nukqx8QwlS2SxTC1Os explicit
```

ã‚µãƒ¼ãƒå´ã§ã‚‚ãƒ¦ãƒ¼ã‚¶æƒ…å ±ã§èªè¨¼ã•ã‚ŒãŸã“ã¨ã‚’ç¤ºã™ãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã‚‹
```
# journalctl -u ssh
Nov 02 08:50:55 debian12 sshd[2734]: Accepted publickey for user from 192.168.11.250 port 57364 ssh2: ED25519-CERT SHA256:tPR4rIIfnnh7gHp9sqNnrDGv2nukqx8QwlS2SxTC1Os ID certificate-test (serial 0) CA ED25519 SHA256:p12hRLK8xDAv+ArfcrZS1>
```

ssh config ã‚’è¨˜è¼‰ã—ã¦åˆ©ç”¨ã™ã‚‹ã¨ç°¡å˜ã€‚
```:config
Host myalias
    HostName 192.168.11.120
    User user
    IdentityFile ./id_ed25519
    UserKnownHostsFile ./known_hosts
```

ssh config ã‚’åˆ©ç”¨ã—ãŸæ¥ç¶šã€‚
```
ssh -v -F ./config myalias
```

scp ã§ã‚‚åˆ©ç”¨ã§ãã‚‹
```
$ scp -v -F config krl myalias:/tmp
```

# è¨¼æ˜æ›¸ã‚’ç„¡åŠ¹åŒ–

ç„¡åŠ¹åŒ–ã™ã¹ããƒ¦ãƒ¼ã‚¶è¨¼æ˜æ›¸ã®ã‚·ãƒªã‚¢ãƒ«ã®ãƒªã‚¹ãƒˆã‚’ä½œæˆã™ã‚‹ã€‚
```: krl.list
serial:202411020544
```

ä½œæˆã—ãŸãƒªã‚¹ãƒˆã«åŸºã¥ã„ã¦ã€KRL(Key Revocation List)ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹(â€» krl æ›´æ–°æ™‚ã¯ -u ã‚’æŒ‡å®šã™ã‚‹)
```
$ ssh-keygen -k -f krl -s ca.key.pub krl.list
Revoking from krl.list
```

ä½œæˆã—ãŸKRLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã™ã‚‹
```
$ ssh-keygen -Q -l -f krl
# KRL version 0
# Generated at 20241102T054916


# CA key ssh-ed25519 SHA256:p12hRLK8xDAv+ArfcrZS1loLBUXkTC3JRtlRyYZvpwQ
serial: 202411020544

$ ssh-keygen -Q -f krl id_ed25519-cert.pub
id_ed25519-cert.pub ((null)): REVOKED
```

ã‚µãƒ¼ãƒã«é…ç½®ã—ã¦ã€sshd ã‚’å†èµ·å‹•ã™ã‚‹ã€‚
```
# mv krl /etc/ssh
# echo "RevokedKeys /etc/ssh/krl" | tee -a /etc/ssh/sshd_config
RevokedKeys /etc/ssh/krl

# systemctl restart ssh
```

ç„¡åŠ¹åŒ–ã—ãŸãƒ¦ãƒ¼ã‚¶è¨¼æ˜æ›¸ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨æ¥ç¶šå¤±æ•—ã¨ãªã‚‹ã€‚
ã‚µãƒ¼ãƒå´ã§ã¯ä»¥ä¸‹ã®ãƒ­ã‚°ãŒå‡ºã‚‹ã€‚
```
# journalctl -u ssh
Nov 03 06:08:20 debian12 sshd[3368]: error: Authentication key ED25519-CERT SHA256:tPR4rIIfnnh7gHp9sqNnrDGv2nukqx8QwlS2SxTC1Os revoked by file /etc/ssh/krl
Nov 03 06:08:20 debian12 sshd[3368]: Connection closed by authenticating user user 192.168.11.250 port 53332 [preauth]
```
