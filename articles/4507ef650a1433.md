---
title: "CloudFormationã‚’è©¦ã™"
emoji: "ğŸ‡¨ğŸ‡«"
type: "tech"
topics: ["aws", "cloudformation"]
published: true
---

# CloudFormationã‚’è©¦ã™

## å‚è€ƒ

https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/Welcome.html

## ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ

ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
```
$ cat template.yml
AWSTemplateFormatVersion: 2010-09-09
Parameters:
  RepositoryName:
    Type: String
    Default: test-nginx
  ENV:
    Type: String
    Default: test
Resources:
  MyRepository:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: !Ref RepositoryName
      ImageScanningConfiguration:
        ScanOnPush: false
      EncryptionConfiguration:
        EncryptionType: "AES256"
      ImageTagMutability: "MUTABLE"
      Tags:
        - Key: Name
          Value: !Ref RepositoryName
        - Key: ENV
          Value: !Ref ENV
```

æœ‰åŠ¹æ€§ã‚’ç¢ºèªã—ã¾ã™ã€‚
```
$ aws cloudformation validate-template --template-body file://template.yml | tee parameter.tmp
{
    "Parameters": [
        {
            "DefaultValue": "test-nginx",
            "NoEcho": false,
            "ParameterKey": "RepositoryName"
        },
        {
            "DefaultValue": "test",
            "NoEcho": false,
            "ParameterKey": "ENV"
        }
    ]
}
```

ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
```
$ jq '.Parameters' parameter.tmp > parameter.json
$ vi parameter.json

$ jq . parameter.json
[
  {
    "ParameterValue": "test-nginx",
    "ParameterKey": "RepositoryName"
  },
  {
    "ParameterValue": "test",
    "ParameterKey": "ENV"
  }
]
```

## ã‚¹ã‚¿ãƒƒã‚¯ã®ä½œæˆ

ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ©ç”¨ã—ã¦ã€ã‚¹ã‚¿ãƒƒã‚¯ã‚’ä½œæˆã—ã¾ã™ã€‚
```
$ aws cloudformation create-stack --template-body file://template.yml --parameters file://parameter.json --stack-name <stack_name>
{
    "StackId": "arn:aws:cloudformation:ap-northeast-1:<aws_account_id>:stack/<stack_name>/f1761580-a1e3-11ee-8502-0aef56d3bc2d"
}
```

ã‚¹ã‚¿ãƒƒã‚¯ä½œæˆã®å®Ÿè¡ŒçŠ¶æ³ã‚’ç¢ºèªã—ã¾ã™ã€‚
```
$ aws cloudformation describe-stack-events --stack-name <stack_name>
{
    "StackEvents": [
        {
            "StackId": "arn:aws:cloudformation:ap-northeast-1:<aws_account_id>:stack/<stack_name>/f1761580-a1e3-11ee-8502-0aef56d3bc2d",
            "EventId": "f4c4a440-a1e3-11ee-b0fa-06efe9a91135",
            "ResourceStatus": "CREATE_COMPLETE",
            "ResourceType": "AWS::CloudFormation::Stack",
            "Timestamp": "2023-12-23T22:38:13.110Z",
            "StackName": "<stack_name>",
            "PhysicalResourceId": "arn:aws:cloudformation:ap-northeast-1:<aws_account_id>:stack/<stack_name>/f1761580-a1e3-11ee-8502-0aef56d3bc2d",
            "LogicalResourceId": "<stack_name>"
        },
        {
:
```

ä½œæˆã•ã‚ŒãŸãƒªã‚½ãƒ¼ã‚¹ã‚’ç¢ºèªã—ã¾ã™ã€‚
```
$ aws cloudformation list-stack-resources --stack-name <stack_name>
{
    "StackResourceSummaries": [
        {
            "ResourceStatus": "CREATE_COMPLETE",
            "DriftInformation": {
                "StackResourceDriftStatus": "NOT_CHECKED"
            },
            "ResourceType": "AWS::ECR::Repository",
            "LastUpdatedTimestamp": "2023-12-23T22:38:12.220Z",
            "PhysicalResourceId": "test-nginx",
            "LogicalResourceId": "MyRepository"
        }
    ]
}
```

ã‚¹ã‚¿ãƒƒã‚¯ã®çŠ¶æ…‹ã‚’ç¢ºèªã—ã¾ã™ã€‚
```
$ aws cloudformation describe-stacks --stack-name <stack_name>
{
    "Stacks": [
        {
            "StackId": "arn:aws:cloudformation:ap-northeast-1:<aws_account_id>:stack/<stack_name>/f1761580-a1e3-11ee-8502-0aef56d3bc2d",
            "DriftInformation": {
                "StackDriftStatus": "NOT_CHECKED"
            },
            "Parameters": [
                {
                    "ParameterValue": "test-nginx",
                    "ParameterKey": "RepositoryName"
                },
                {
                    "ParameterValue": "test",
                    "ParameterKey": "ENV"
                }
            ],
            "Tags": [],
            "EnableTerminationProtection": false,
            "CreationTime": "2023-12-23T22:38:07.639Z",
            "StackName": "<stack_name>",
            "NotificationARNs": [],
            "StackStatus": "CREATE_COMPLETE",
            "DisableRollback": false,
            "RollbackConfiguration": {}
        }
    ]
}
```

åˆ©ç”¨ã•ã‚ŒãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```
$ aws cloudformation get-template --stack-name <stack_name> | jq -r .TemplateBody
AWSTemplateFormatVersion: 2010-09-09
Parameters:
  RepositoryName:
    Type: String
    Default: test-nginx
  ENV:
    Type: String
    Default: test
Resources:
  MyRepository:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: !Ref RepositoryName
      ImageScanningConfiguration:
        ScanOnPush: false
      EncryptionConfiguration:
        EncryptionType: "AES256"
      ImageTagMutability: "MUTABLE"
      Tags:
        - Key: Name
          Value: !Ref RepositoryName
        - Key: ENV
          Value: !Ref ENV
```

## ã‚¹ã‚¿ãƒƒã‚¯ã®å‰Šé™¤

ä½œæˆã—ãŸã‚¹ã‚¿ãƒƒã‚¯ã‚’å‰Šé™¤ã—ã¦ã¿ã¾ã™ã€‚
```
$ aws cloudformation delete-stack --stack-name <stack_name>
```

å‰Šé™¤ã—ãŸã‚¹ã‚¿ãƒƒã‚¯ã®çŠ¶æ…‹ã‚’ç¢ºèªã—ã¾ã™ã€‚
```
$ aws cloudformation list-stacks --query 'StackSummaries[?StackName == `<stack_name>`]'
[
    {
        "StackId": "arn:aws:cloudformation:ap-northeast-1:<aws_account_id>:stack/<stack_name>/f1761580-a1e3-11ee-8502-0aef56d3bc2d",
        "DriftInformation": {
            "StackDriftStatus": "NOT_CHECKED"
        },
        "CreationTime": "2023-12-23T22:38:07.639Z",
        "StackName": "<stack_name>",
        "StackStatus": "DELETE_COMPLETE",
        "DeletionTime": "2023-12-23T22:45:40.383Z"
    }
]
```
