---
title: "Dynamips/Dynagenãƒ©ãƒœæ§‹ç¯‰"
emoji: "ğŸ¦–"
type: "tech"
topics: ["dynamips", "dynagen", "ansible"]
published: true
---


# æœ¬ã‚¨ãƒ³ãƒˆãƒªã«ã¤ã„ã¦

æ™‚ä»£é…ã‚Œæ„ŸãŒã‚ã‚Šã¾ã™ãŒ Dynamips/Dynagen ã‚’åˆ©ç”¨ã—ãŸãƒ©ãƒœç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚
Ciscoæ©Ÿå™¨ã«ã¤ã„ã¦ã®åŸºæœ¬çš„ãªå­¦ç¿’ã®ãŸã‚ã«ã¯Dynagenã‚’åˆ©ç”¨ã™ã‚‹ç’°å¢ƒã§ã‚‚å……åˆ†ã‹ã¨æ€ã„ã¾ã™ã€‚

- ç’°å¢ƒã¯AWSã®EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ä½œã‚Šã¾ã™ã€‚
å‹‰å¼·ã™ã‚‹ã¨ãã«ã¯ä½¿ã‚ãªã„ç’°å¢ƒãªã®ã§ã€è‡ªå®…PCã‚’å¥‡éº—ã«ä¿ã¤ãŸã‚ã€è‡ªå®…PCãƒªã‚½ãƒ¼ã‚¹ã‚„é›»æ°—ä»£ç­‰ã®ç¯€ç´„ã®ãŸã‚ã€EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚
è€ƒãˆæ–¹æ¬¡ç¬¬ã§ã™ãŒã€è‡ªå®…PCã§KVMç­‰ã®ä¸Šã§ä½œã£ã¦ã‚‚ã‚ˆã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
- ã‚³ã‚¹ãƒˆå‰Šæ¸›ã®ãŸã‚ã€ã‚¹ãƒãƒƒãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚
ä¸å¿…è¦ãªæ™‚ã«åœæ­¢ã™ã‚‹ã“ã¨ã§ã€ã•ã‚‰ã«ã‚³ã‚¹ãƒˆã‚’æŠ¼ã•ãˆã¾ã™ã€‚
- ç’°å¢ƒæ§‹ç¯‰ã¯ terraform ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚
CloudFormation ã§ã‚‚ã„ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€è¶£å‘³ã§ã€‚

# æ§‹ç¯‰è³‡æã®æº–å‚™

äº‹å‰ã« Terraformã®åˆ©ç”¨ç’°å¢ƒã¯æ§‹ç¯‰æ¸ˆã¿ã§ã€AWS ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã‚‚åˆ©ç”¨å¯èƒ½ã¨ãªã£ã¦ã„ã‚‹ã“ã¨ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚

## tf ãƒ•ã‚¡ã‚¤ãƒ«

ãŠã‚ˆãä»¥ä¸‹ã®ã‚ˆã†ãª tf ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™ã—ã¾ã™ã€‚

```spot_request.tf
provider "aws" {
  region = "ap-northeast-1"
}

# variables
variable "ami" {}
variable "instance_type" {}

variable "key_name" {
  default = "testkey"
}

variable "userdata" {
  default = "userdata.sh"
}

data "aws_cloudformation_export" "public_subnet" {
  name = "mystack-PublicSubnet1"
}

data "aws_cloudformation_export" "security_group" {
  name = "mystack-SecurityGroupPub"
}

# ec2 spot instance request
resource "aws_spot_instance_request" "spot_instance_dynamips_labo" {
  spot_type                      = "persistent"
  instance_interruption_behavior = "stop"

  ami           = var.ami
  instance_type = var.instance_type
  key_name      = var.key_name
  subnet_id     = data.aws_cloudformation_export.public_subnet.value
  vpc_security_group_ids = [
    data.aws_cloudformation_export.security_group.value
  ]
  user_data = file(var.userdata)

  associate_public_ip_address = "true"
  tags = {
    Name  = "spot_instance_dynamips_labo",
    Built = "terraform"
  }
}

# output
output "spot_instance_requestid" {
  value = aws_spot_instance_request.spot_instance_dynamips_labo.id
}
```

- VPCã€ã‚µãƒ–ãƒãƒƒãƒˆã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã€sshéµã¯ä½œæˆæ¸ˆã¿ã®ã‚‚ã®ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚
ã‚µãƒ–ãƒãƒƒãƒˆã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã¯ã€åˆ¥ã« CloudFormation ã§ä½œæˆã—ã¦ã„ãŸã‚‚ã®ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚
- ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—ã¨AMIã¯ã€æ§‹ç¯‰æ™‚ã«æŒ‡å®šã—ã¾ã™ã€‚AMIã¯ Debian Buster (amd64) ã®æœ€æ–°ç‰ˆã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

## ãƒ¦ãƒ¼ã‚¶ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«

ãƒ¦ãƒ¼ã‚¶ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™ã—ã¾ã™ã€‚

```
#! /bin/sh

version=0.2.22
sed -i.bak 's/ main$/ main contrib non-free/' /etc/apt/sources.list \
&& apt update && apt upgrade -y \
&& DEBIAN_FRONTEND=noninteractive apt install -y \
 vpcs \
 openvswitch-switch \
 snmp snmptrapd \
 freeradius \
 postfix mailutils \
 tcpdump \
 tftpd-hpa tftp-hpa \
 telnet \
 tmux \
 python3-pip sshpass python3-paramiko \
&& curl -fsSL https://toolbelt.treasuredata.com/sh/install-debian-buster-td-agent4.sh | sudo sh \
&& wget https://github.com/GNS3/dynamips/archive/refs/tags/v${version}.tar.gz \
&& tar zxf v${version}.tar.gz \
&& rm v${version}.tar.gz \
&& cd dynamips-${version} \
&& apt install -y gcc cmake libelf-dev libpcap-dev make musl-dev linux-headers-amd64 \
&& mkdir -p build \
&& cd build \
&& cmake .. \
&& make \
&& make install \
&& rm -rf dynamips-${version} \
&& apt remove -y gcc cmake make musl-dev linux-headers \
&& apt autoremove -y \
&& apt install -y dynagen \
&& pip3 install ansible \
&& ovs-vsctl add-br br0 \
&& ip link set br0 up \
&& ip tuntap add dev tap0 mode tap \
&& ovs-vsctl add-port br0 tap0 \
&& ip link set tap0 up \
&& touch /home/admin/startup.sh \
&& chmod +x /home/admin/startup.sh \
&& cat << END > /home/admin/startup.sh
#! /bin/sh
ip address add 10.2.0.1/24 brd + dev br0
ip tuntap add dev tap0 mode tap
ip link set tap0 up
ip link set br0 up
ip route add 10.2.0.0/16 dev br0
ip addr show br0
ovs-vsctl show
dynamips -H 7200 &
ps -ef | grep dynamips | grep -v grep
END
```

- dynamips ã¯ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ã€‚
- å„ç¨®æ¤œè¨¼ã«å¿…è¦ã¨æ€ã‚ã‚Œã‚‹ãƒ„ãƒ¼ãƒ«é¡ã‚‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
- ä»®æƒ³ã‚¹ã‚¤ãƒƒãƒã¯ã€Open vSwitch ã‚’åˆ©ç”¨ã—ã¦ã¿ã¾ã™ã€‚
- ä»®æƒ³ãƒ–ãƒªãƒƒã‚¸ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯OSã‚’èµ·å‹•ã™ã‚‹ãŸã³ã«æ¯å›å‰²ã‚Šå½“ã¦ã‚‹ã“ã¨ã«ã—ã€ãã®ãŸã‚ã®ç°¡æ˜“ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç”¨æ„ã—ã¾ã™ã€‚

## Makefile

ãŠã‚ˆãä»¥ä¸‹ã®ã‚ˆã†ãªMakefile ã‚’ç”¨æ„ã—ã¾ã™ã€‚

:::message
ã“ã“ã® Makefile ã®å†…å®¹ã¯å¿…è¦ãªè€ƒæ…®ãŒä¸è¶³ã—ã¦ã„ã‚‹ã¨æ€ã„ã¾ã™ã€‚
ä»–ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒå‹•ã„ã¦ã„ã‚‹ã¨ãã€ä»–ã®ã‚¹ãƒãƒƒãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒã‚ã‚‹æ™‚ã¯ç‰¹ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚
:::

```Makefile
instance_type=t3.nano
plan=terraform.plan

ami=$(shell aws ssm get-parameters --names /aws/service/debian/release/buster/latest/amd64 --region ap-northeast-1 --query Parameters[].Value --output text)
sir=$(shell terraform output -json | jq -r ".spot_instance_requestid.value")
terraform_opt=-var ami=$(ami) -var instance_type=$(instance_type)
instance_id=$(shell aws ec2 describe-instances --filter "Name=spot-instance-request-id,Values=$(sir)" --query 'Reservations[].Instances[].InstanceId' --output text)

terraform-init:
        terraform init
terraform-plan:
        terraform validate
        terraform plan $(terraform_opt) -out $(plan)
terraform-plan-destroy:
        terraform plan -out $(plan)
terraform-apply:
        terraform apply $(plan)
terraform-clean:
        rm -rf .terraform/providers $(plan)

list-instance:
        aws ec2 describe-spot-instance-requests --query 'SpotInstanceRequests[?Tags[?Key == `Name`].Value | [0] == `spot_instance_dynamips_labo`].{"SpotInstanceRequestId":SpotInstanceRequestId, "InstanceId":InstanceId, "Status":Status , "State":State}'
        aws ec2 describe-instances --filter "Name=spot-instance-request-id,Values=$(sir)" --query 'Reservations[].Instances[].{"State":State, "InstanceId":InstanceId, "PublicDnsName":PublicDnsName}'

stop-instance:
        aws ec2 stop-instances --instance-id $(instance_id)
start-instance:
        aws ec2 start-instances --instance-id $(instance_id)

cancel-request:
        aws ec2 terminate-instances --instance-id $(instance_id)
        aws ec2 cancel-spot-instance-requests --spot-instance-request-ids $(sir)
```

- ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—ã¯ã€ã“ã“ã§ã¯æœ€ä½é™ã® t3.nano ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ãŒã€å®Ÿéš›ã¯é©åˆ‡ãªã‚µã‚¤ã‚ºã‚’æŒ‡å®šã—ã¾ã™ã€‚
- AMIã¯ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰AMIã¯ Debian Buster (amd64) ã®æœ€æ–°ç‰ˆã®AMI IDã‚’å–å¾—ã—ã¾ã™ã€‚

:::message
ã“ã®ã‚ˆã†ãªã¨ãã€è¨˜è¼‰ãŒç°¡å˜ãª make ã«é ¼ã£ã¦ã—ã¾ã„ã¾ã™ã€‚
ç¾ä»£çš„ãªã‚‚ã£ã¨ä¾¿åˆ©ãªãƒ„ãƒ¼ãƒ«ã‚‚ã‚ã‚‹ã¯ãšã ã¨æ€ã†ã®ã§ã™ãŒã€ç´¹ä»‹ã„ãŸã ã‘ã‚‹ã¨ã‚ã‚ŠãŒãŸã„ã§ã™ã€‚
:::

# ç’°å¢ƒæ§‹ç¯‰

```
$ make terraform-init
terraform init

Initializing the backend...

Initializing provider plugins...
- Reusing previous version of hashicorp/aws from the dependency lock file
- Installing hashicorp/aws v4.51.0...
- Installed hashicorp/aws v4.51.0 (signed by HashiCorp)

Terraform has been successfully initialized!

You may now begin working with Terraform. Try running "terraform plan" to see
any changes that are required for your infrastructure. All Terraform commands
should now work.

If you ever set or change modules or backend configuration for Terraform,
rerun this command to reinitialize your working directory. If you forget, other
commands will detect it and remind you to do so if necessary.
```

```
$ make terraform-plan | cat                                                                                                                                                                                                [105/493]
terraform validate
Success! The configuration is valid.

terraform plan -var ami=ami-041e370f47f9b619e -var instance_type=t3.nano -out terraform.plan
data.aws_cloudformation_export.public_subnet: Reading...
data.aws_cloudformation_export.security_group: Reading...
data.aws_cloudformation_export.security_group: Read complete after 0s [id=cloudformation-exports-ap-northeast-1-mystack-SecurityGroupPub]
data.aws_cloudformation_export.public_subnet: Read complete after 0s [id=cloudformation-exports-ap-northeast-1-mystack-PublicSubnet1]

Terraform used the selected providers to generate the following execution
plan. Resource actions are indicated with the following symbols:
  + create

Terraform will perform the following actions:

  # aws_spot_instance_request.spot_instance_dynamips_labo will be created
  + resource "aws_spot_instance_request" "spot_instance_dynamips_labo" {

(çœç•¥)

    }

Plan: 1 to add, 0 to change, 0 to destroy.

Changes to Outputs:
  + spot_instance_requestid = (known after apply)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Saved the plan to: terraform.plan

To perform exactly these actions, run the following command to apply:
    terraform apply "terraform.plan"
```

ã‚¨ãƒ©ãƒ¼ãŒãªã‘ã‚Œã° apply ã—ã¾ã™ã€‚

```
-bash-4.2$ make terraform-apply | cat
terraform apply terraform.plan
aws_spot_instance_request.spot_instance_dynamips_labo: Creating...
aws_spot_instance_request.spot_instance_dynamips_labo: Creation complete after 2s [id=sir-5rapkqtj]

Apply complete! Resources: 1 added, 0 changed, 0 destroyed.

Outputs:

spot_instance_requestid = "sir-5rapkqtj"
```

èµ·å‹•ã—ãŸã‚¹ãƒãƒƒãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®æƒ…å ±ã‚’ç¢ºèªã—ã¾ã™ã€‚

```
$ make list-instance
aws ec2 describe-spot-instance-requests --query 'SpotInstanceRequests[?Tags[?Key == `Name`].Value | [0] == `spot_instance_dynamips_labo`].{"SpotInstanceRequestId":SpotInstanceRequestId, "InstanceId":InstanceId, "Status":Status , "State":State}'
[
    {
        "InstanceId": "i-0bbd73d8079d1cdfd",
        "Status": {
            "Message": "Your spot request is fulfilled.",
            "Code": "fulfilled",
            "UpdateTime": "2023-01-22T07:03:18.000Z"
        },
        "State": "active",
        "SpotInstanceRequestId": "sir-5rapkqtj"
    }
]
aws ec2 describe-instances --filter "Name=spot-instance-request-id,Values=sir-5rapkqtj" --query 'Reservations[].Instances[].{"State":State, "InstanceId":InstanceId, "PublicDnsName":PublicDnsName}'
[
    {
        "InstanceId": "i-0bbd73d8079d1cdfd",
        "State": {
            "Code": 16,
            "Name": "running"
        },
        "PublicDnsName": "ec2-54-250-21-140.ap-northeast-1.compute.amazonaws.com"
    }
]
```

ä½œæˆã—ãŸã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã® PublicDnsName ã«å¯¾ã—ã¦ ssh ã§å…¥ã‚Šã€ä¸‹è¨˜ã‚’ç¢ºèªã—ã¾ã™ã€‚

- ãƒ¦ãƒ¼ã‚¶ãƒ‡ãƒ¼ã‚¿ãŒæ­£å¸¸ã«å®Ÿè¡Œã§ããŸã“ã¨
- ä»®æƒ³ã‚¹ã‚¤ãƒƒãƒãŒæ§‹ç¯‰ã§ãã‚‹ã“ã¨

```
admin@ip-10-0-0-144:~$ tail -f /var/log/cloud-init-output.log
Unpacking python-configobj (5.0.6-3) ...
Selecting previously unselected package dynagen.
Preparing to unpack .../dynagen_0.11.0-7_all.deb ...
Unpacking dynagen (0.11.0-7) ...
Setting up python-configobj (5.0.6-3) ...
Setting up dynamips (0.2.14-1) ...
Setting up dynagen (0.11.0-7) ...
Processing triggers for man-db (2.8.5-2) ...
Cloud-init v. 20.2 running 'modules:final' at Sun, 22 Jan 2023 07:03:31 +0000. Up 8.74 seconds.
Cloud-init v. 20.2 finished at Sun, 22 Jan 2023 07:06:56 +0000. Datasource DataSourceEc2Local.  Up 213.28 seconds

$ sudo ./startup.sh
RTNETLINK answers: File exists
ioctl(TUNSETIFF): Device or resource busy
RTNETLINK answers: File exists
4: br0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UNKNOWN group default qlen 1000
    link/ether 3e:96:7d:04:10:4f brd ff:ff:ff:ff:ff:ff
    inet 10.2.0.1/24 brd 10.2.0.255 scope global br0
       valid_lft forever preferred_lft forever
    inet6 fe80::3c96:7dff:fe04:104f/64 scope link
       valid_lft forever preferred_lft forever
709cf55a-b676-4863-86b4-913bbeca30dc
    Bridge "br0"
        Port "tap0"
            Interface "tap0"
        Port "br0"
            Interface "br0"
                type: internal
    ovs_version: "2.10.7"
Cisco Router Simulation Platform (version 0.2.22-amd64/Linux stable)
Copyright (c) 2005-2011 Christophe Fillot.
Build date: Jan 22 2023 07:06:18

ILT: loaded table "mips64j" from cache.
ILT: loaded table "mips64e" from cache.
ILT: loaded table "ppc32j" from cache.
ILT: loaded table "ppc32e" from cache.
Hypervisor TCP control server started (port 7200).
root     21525 21515  0 07:42 pts/1    00:00:00 dynamips -H 7200
```

# ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®åœæ­¢

persist ã‚’æŒ‡å®šã—ãŸã‚¹ãƒãƒƒãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’åœæ­¢ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ã¾ãŸã€åœæ­¢ã—ãŸã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯ã€å¿…è¦ãªæ™‚ã«å†é–‹ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
EIPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å‰²ã‚Šå½“ã¦ã¦ã„ãªã„ã®ã§ã€åœæ­¢ã—ã¦ã„ã‚‹é–“ã®èª²é‡‘ã¯ã€ãƒ‡ã‚£ã‚¹ã‚¯é ˜åŸŸã«é–¢ã‚ã‚‹æ–™é‡‘ã ã‘ã«ãªã‚Šã¾ã™ã€‚

```
-bash-4.2$ make stop-instance
aws ec2 stop-instances --instance-id i-0bbd73d8079d1cdfd
{
    "StoppingInstances": [
        {
            "InstanceId": "i-0bbd73d8079d1cdfd",
            "CurrentState": {
                "Code": 64,
                "Name": "stopping"
            },
            "PreviousState": {
                "Code": 16,
                "Name": "running"
            }
        }
    ]
}
-bash-4.2$
```

# ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®å†é–‹

åœæ­¢ã—ã¦ã„ãŸã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å†é–‹ã—ã¾ã™ã€‚

```
-bash-4.2$ make start-instance
aws ec2 start-instances --instance-id i-0bbd73d8079d1cdfd
{
    "StartingInstances": [
        {
            "InstanceId": "i-0bbd73d8079d1cdfd",
            "CurrentState": {
                "Code": 0,
                "Name": "pending"
            },
            "PreviousState": {
                "Code": 80,
                "Name": "stopped"
            }
        }
    ]
}
```

PublicDnsName ã‚’ç¢ºèªã—ã¾ã™ã€‚

```
-bash-4.2$ make list-instance
aws ec2 describe-spot-instance-requests --query 'SpotInstanceRequests[?Tags[?Key == `Name`].Value | [0] == `spot_instance_dynamips_labo`].{"SpotInstanceRequestId":SpotInstanceRequestId, "InstanceId":InstanceId, "Status":Status , "State":State}'
[
    {
        "InstanceId": "i-0bbd73d8079d1cdfd",
        "Status": {
            "Message": "Your Spot request is fulfilled.",
            "Code": "fulfilled",
            "UpdateTime": "2023-01-22T07:57:00.000Z"
        },
        "State": "active",
        "SpotInstanceRequestId": "sir-5rapkqtj"
    }
]
aws ec2 describe-instances --filter "Name=spot-instance-request-id,Values=sir-5rapkqtj" --query 'Reservations[].Instances[].{"State":State, "InstanceId":InstanceId, "PublicDnsName":PublicDnsName}'
[
    {
        "InstanceId": "i-0bbd73d8079d1cdfd",
        "State": {
            "Code": 16,
            "Name": "running"
        },
        "PublicDnsName": "ec2-54-95-70-193.ap-northeast-1.compute.amazonaws.com"
    }
]
```

:::message
åœæ­¢ãƒ»å†é–‹ã™ã‚‹ã“ã¨ã§ Public IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å¤‰ã‚ã‚Šã¾ã™ã€‚
Public IP ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒæ¯å›å¤‰ã‚ã‚‹ã“ã¨ãŒæ‰‹é–“ã«æ„Ÿã˜ã‚‹å ´åˆã€ä¸€å®šã®ã‚³ã‚¹ãƒˆã‚’å—ã‘å…¥ã‚Œã‚‰ã‚Œã‚‹ãªã‚‰ã€ä»¥ä¸‹ã®å¯¾ç­–ãŒã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚
- EIPã‚’åˆ©ç”¨ã™ã‚‹
- Route53ç­‰ã‚’åˆ©ç”¨ã™ã‚‹
:::


# ã‚¹ãƒãƒƒãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å¥‘ç´„ã®è§£é™¤

é•·æœŸé–“ä½¿ç”¨ã—ãªã„ã¨ãã¯ã€AMIã‚’ä¿å­˜ã—ã¦ã€ã‚¹ãƒãƒƒãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å¥‘ç´„ã‚’è§£é™¤ã—ã¾ã™ã€‚
ã‚¹ãƒãƒƒãƒˆã‚¤ãƒ³ã‚¿ãƒ³ã‚¹å¥‘ç´„è§£é™¤ã®å‰ã«AMIã‚’ä¿å­˜ã—ã¦ãŠãã€ç’°å¢ƒã‚’å†åˆ©ç”¨ã™ã‚‹æ™‚ã¯ã€AMIã‹ã‚‰èµ·å‹•ã—ã¾ã™ã€‚

## AMI ä¿å­˜

```
-bash-4.2$ make list-instance
aws ec2 describe-spot-instance-requests --query 'SpotInstanceRequests[?Tags[?Key == `Name`].Value | [0] == `spot_instance_dynamips_labo`].{"SpotInstanceRequestId":SpotInstanceRequestId, "InstanceId":InstanceId, "Status":Status , "State":State}'
[
    {
        "InstanceId": "i-0bbd73d8079d1cdfd",
        "Status": {
            "Message": "Your Spot instance is marked for stop due to user-initiated stop.",
            "Code": "marked-for-stop",
            "UpdateTime": "2023-01-22T08:09:17.000Z"
        },
        "State": "active",
        "SpotInstanceRequestId": "sir-5rapkqtj"
    }
]
aws ec2 describe-instances --filter "Name=spot-instance-request-id,Values=sir-5rapkqtj" --query 'Reservations[].Instances[].{"State":State, "InstanceId":InstanceId, "PublicDnsName":PublicDnsName}'
[
    {
        "InstanceId": "i-0bbd73d8079d1cdfd",
        "State": {
            "Code": 80,
            "Name": "stopped"
        },
        "PublicDnsName": ""
    }
]

-bash-4.2$ make create-ami
aws ec2 create-image --description "Backup AMI for Dynamips Labo environment from sir-5rapkqtj" --instance-id i-0bbd73d8079d1cdfd --name "Dynamips Labo environment 20230122081059"
{
    "ImageId": "ami-0314fbc3211babfa8"
}
```

```
-bash-4.2$ aws ec2 describe-images --image-id ami-0314fbc3211babfa8
{
    "Images": [
        {
            "VirtualizationType": "hvm",
            "Description": "Backup AMI for Dynamips Labo environment from sir-5rapkqtj",
            "PlatformDetails": "Linux/UNIX",
            "EnaSupport": true,
            "Hypervisor": "xen",
            "State": "pending",
            "SriovNetSupport": "simple",
            "ImageId": "ami-0314fbc3211babfa8",
            "UsageOperation": "RunInstances",
            "BlockDeviceMappings": [
                {
                    "DeviceName": "/dev/xvda",
                    "Ebs": {
                        "SnapshotId": "snap-0133e49aae5f72d0b",
                        "DeleteOnTermination": true,
                        "VolumeType": "gp2",
                        "VolumeSize": 8,
                        "Encrypted": false
                    }
                }
            ],
            "Architecture": "x86_64",
            "ImageLocation": "xxxxxxxxxxxx/Dynamips Labo environment 20230122081059",
            "RootDeviceType": "ebs",
            "OwnerId": "xxxxxxxxxxxx",
            "RootDeviceName": "/dev/xvda",
            "CreationDate": "2023-01-22T08:11:02.000Z",
            "Public": false,
            "ImageType": "machine",
            "Name": "Dynamips Labo environment 20230122081059"
        }
    ]
}
```

## ã‚¹ãƒãƒƒãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹è§£ç´„

```
-bash-4.2$ make cancel-request
aws ec2 terminate-instances --instance-id i-0bbd73d8079d1cdfd
{
    "TerminatingInstances": [
        {
            "InstanceId": "i-0bbd73d8079d1cdfd",
            "CurrentState": {
                "Code": 48,
                "Name": "terminated"
            },
            "PreviousState": {
                "Code": 80,
                "Name": "stopped"
            }
        }
    ]
}
aws ec2 cancel-spot-instance-requests --spot-instance-request-ids sir-5rapkqtj
{
    "CancelledSpotInstanceRequests": [
        {
            "State": "cancelled",
            "SpotInstanceRequestId": "sir-5rapkqtj"
        }
    ]
}
```


```
-bash-4.2$ make list-instance
aws ec2 describe-spot-instance-requests --query 'SpotInstanceRequests[?Tags[?Key == `Name`].Value | [0] == `spot_instance_dynamips_labo`].{"SpotInstanceRequestId":SpotInstanceRequestId, "InstanceId":InstanceId, "Status":Status , "State":State}'
[
    {
        "InstanceId": "i-0bbd73d8079d1cdfd",
        "Status": {
            "Message": "Your Spot request is canceled.",
            "Code": "request-canceled",
            "UpdateTime": "2023-01-22T08:14:12.000Z"
        },
        "State": "cancelled",
        "SpotInstanceRequestId": "sir-5rapkqtj"
    }
]
aws ec2 describe-instances --filter "Name=spot-instance-request-id,Values=sir-5rapkqtj" --query 'Reservations[].Instances[].{"State":State, "InstanceId":InstanceId, "PublicDnsName":PublicDnsName}'
[
    {
        "InstanceId": "i-0bbd73d8079d1cdfd",
        "State": {
            "Code": 48,
            "Name": "terminated"
        },
        "PublicDnsName": ""
    }
]
-bash-4.2$
```

ã‚¹ãƒãƒƒãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®State ãŒ cancelled ã«ãªã£ãŸã‚‰ã€Terraform ä¸Šã§ã‚‚è¨­å®šã‚’å‰Šé™¤ã—ã¾ã™ã€‚

```
-bash-4.2$ mv spot_request.tf spot_request.tf.destroy
-bash-4.2$
-bash-4.2$ make terraform-plan-destroy
terraform plan -out terraform.plan
aws_spot_instance_request.spot_instance_dynamips_labo: Refreshing state... [id=sir-5rapkqtj]

Changes to Outputs:
  - spot_instance_requestid = "sir-5rapkqtj" -> null

You can apply this plan to save these new output values to the Terraform state, without changing any real infrastructure.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Saved the plan to: terraform.plan

To perform exactly these actions, run the following command to apply:
    terraform apply "terraform.plan"
-bash-4.2$
-bash-4.2$ make terraform-apply
terraform apply terraform.plan

Apply complete! Resources: 0 added, 0 changed, 0 destroyed.


-bash-4.2$
```


