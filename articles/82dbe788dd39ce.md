---
title: "Apaceh mod_auth_openidc ã§ OIDC RP ã‚’è¨­å®šã—ã¦ã¿ã‚‹"
emoji: "ğŸ¥’"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["oidc", "apache", "keycloak"]
published: true
---

# æ¦‚è¦

Apaceh mod_auth_openidc ã§ OIDC RP(Relying Party) ã‚’è¨­å®šã—ã¦ã¿ã¾ã™ã€‚
OP(OpenID Provider) ã¨ã—ã¦ KeyCloakã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

# å‚è€ƒ

https://github.com/OpenIDC/mod_auth_openidc/wiki/Keycloak


# KeyCloak

## ç’°å¢ƒæ§‹ç¯‰

https://zenn.dev/mnod/articles/4faa7d4693765f ã¨åŒæ§˜ã«ã€KeyCloak ã‚‚ Dockerã‚³ãƒ³ãƒ†ãƒŠã§ç”¨æ„ã™ã‚‹ã€‚

## è¨­å®š

1. ä½œæˆã—ãŸ Realm ã¸ç§»å‹•ã™ã‚‹
1. å³ãƒšã‚¤ãƒ³ã§ `Manage` > `Clients` ã¸ç§»å‹•ã™ã‚‹ â†’ å·¦ãƒšã‚¤ãƒ³ã§ `Create Client` ã‚’æŠ¼ä¸‹
1. ä»¥ä¸‹ã‚’å…¥åŠ›ã—ã¦ä½œæˆã™ã‚‹(ãã®ä»–ã®å€¤ã¯åˆæœŸå€¤ã®ã¾ã¾)

| é …ç›® | è¨­å®šå€¤ |
| --- | ---- |
| Client Type | OpenID Connect |
| Client ID | ä»»æ„ã®å€¤ |
| Name | ä»»æ„ã®å€¤ |
| Client authentication | On |
| Valid redirect URIs | https://192.168.11.40/callback |

Credentials ã‚¿ãƒ–ã«ç§»å‹•ã—ã¦ Client Secret ã‚’æ§ãˆã‚‹

# Apaceh mod_auth_openidc ã§ OIDC ã‚’è¨­å®š

## ç’°å¢ƒæ§‹ç¯‰

Docker ã‚³ãƒ³ãƒ†ãƒŠã‚’åˆ©ç”¨ã—ã¦ Apache ç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚ 

```
sudo docker run --rm -it -p 443:443 -v /home/debian/docker/mellontest:/opt --name mellontest debian:bookworm-slim bash
```

## ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

èµ·å‹•ã—ãŸã‚³ãƒ³ãƒ†ãƒŠå†…ã§ã€å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```
# apt update
# apt install --no-install-recommends apache2 libapache2-mod-auth-openidc openssl ca-certificates
```

## TLSæ¥ç¶šã™ã‚‹ãŸã‚ã®è¨¼æ˜æ›¸ã‚’ä½œæˆ

```
# openssl req -newkey rsa:3072 -new -x509 -days 3652 -nodes -out /etc/ssl/certs/mywebserver.pem -keyout /etc/ssl/private/mywebserver.key -subj '/C=JP/ST=Tokyo/L=Shinjuku/CN=192.168.11.40'
```


## Apache ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ

```: /etc/apache2/sites-available/mywebserver.conf
ServerName 192.168.11.40
<IfModule mod_ssl.c>
<VirtualHost _default_:443>
DocumentRoot /var/www/html
ServerSignature Off
ErrorLog /var/log/apache2/error.log
CustomLog /var/log/apache2/access.log combined
LogLevel info ssl:warn

SSLEngine on
SSLCertificateFile /etc/ssl/certs/mywebserver.pem
SSLCertificateKeyFile /etc/ssl/private/mywebserver.key
</VirtualHost>

<Location />
Require valid-user
AuthType "Mellon"
OIDCProviderMetadataURL https://ï¼œKeyCloakã®URLï¼/auth/realms/ï¼œãƒ¬ãƒ«ãƒ åï¼/.well-known/openid-configuration
OIDCClientID ï¼œKeyCloak ã§è¨­å®šã—ãŸ Client IDï¼
OIDCClientSecret ï¼œKeyCloak ã§æ§ãˆãŸ Client Secretï¼
OIDCRedirectURI https://ï¼œApacheã®URLï¼/callback
OIDCCryptoPassphrase my-secret-passphrase
</Location>
</IfModule>
```

ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é…ç½®
```
mkdir -p /var/www/html/protected
date > /var/www/html/protected/index.html
```

## è¨­å®šæœ‰åŠ¹åŒ–

```
apache2ctl configtest
a2enmod ssl
a2ensite mywebserver.conf
```

```
apachectl graceful
```

## ãã®ä»–

KeyCloak ã®HTTPSè¨¼æ˜æ›¸ãŒè‡ªå·±ç½²åã®ã‚‚ã®ãªã®ã§ã€ã“ã‚Œã‚’ä¿¡é ¼ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
(ä¿¡é ¼ã•ã‚Œãªã„è¨¼æ˜æ›¸ã ã£ãŸã‚Šã€CNãŒç•°ãªã£ã¦ãŸã‚Šã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹)

```
# cp /opt/example.crt /usr/local/share/ca-certificates/keycloak.crt
# update-ca-certificates
```

# å‹•ä½œç¢ºèª

Webã‚µãƒ¼ãƒã®URLã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€KeyCloakã®ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«é·ç§»ã™ã‚‹ã‚‹ã“ã¨ã€ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ã“ã¨ã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤ºã§ãã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã€‚
Internal Server Error ã‚„ Bad Requestã®ã‚¨ãƒ©ãƒ¼ãŒã§ãŸã‚‰ã€Apache ã® error.log ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèªã™ã‚‹ã€‚
