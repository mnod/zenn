---
title: "CloudFormation å¤‰æ›´ã‚»ãƒƒãƒˆã‚’ä½¿ç”¨ã—ãŸæ›´æ–°"
emoji: "ğŸ‘€"
type: "tech"
topics: ["aws", "cloudformation"]
published: true
---

## ã‚¹ã‚¿ãƒƒã‚¯ã®ä½œæˆ

ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```: vpc.yml
AWSTemplateFormatVersion: '2010-09-09'
Parameters:
  CidrBlock:
    Type: String
    Default: "10.0.0.0/16"
  SystemName :
    Type: String
    Default: "zenn_test"
Resources:
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref CidrBlock
      Tags:
      - Key: Name
        Value: !Sub "${SystemName}_vpc"
      - Key: SystemName
        Value: !Ref SystemName
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
      - Key: Name
        Value: !Sub "${SystemName}_igw"
      - Key: SystemName
        Value: !Ref SystemName
  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId:
        Ref: VPC
      InternetGatewayId:
        Ref: InternetGateway
Outputs:
  VpcId:
    Value: !Ref VPC
  IgwId:
    Value: !Ref InternetGateway
```

ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®æœ‰åŠ¹æ€§ã‚’ç¢ºèªã—ã¾ã™ã€‚
```
$ aws cloudformation validate-template --template-body file://vpc.yml | tee parameter.tmp
{
    "Parameters": [
        {
            "DefaultValue": "10.0.0.0/16",
            "NoEcho": false,
            "ParameterKey": "CidrBlock"
        },
        {
            "DefaultValue": "zenn_test",
            "NoEcho": false,
            "ParameterKey": "SystemName"
        }
    ]
}
```

ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
```
$ jq '.Parameters' parameter.tmp > parameter.json
$ vi parameter.json

$ jq . parameter.json
[
  {
    "ParameterValue": "10.0.0.0/16",
    "ParameterKey": "CidrBlock"
  },
  {
    "ParameterValue": "zenn_test",
    "ParameterKey": "SystemName"
  }
]
```

ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ©ç”¨ã—ã¦ã€ã‚¹ã‚¿ãƒƒã‚¯ã‚’ä½œæˆã—ã¾ã™ã€‚
```
$ aws cloudformation create-stack --template-body file://vpc.yml --parameters file://parameter.json --stack-name <stack_name>
{
    "StackId": "arn:aws:cloudformation:<region>:<aws_account_id>:stack/<stack_name>/b4e20e60-a5c8-11ee-8c99-0676a70102b5"
}
```

ã‚¹ã‚¿ãƒƒã‚¯ã®çŠ¶æ…‹ã‚’ç¢ºèªã—ã¾ã™ã€‚
```
$ aws cloudformation describe-stacks --stack-name <stack_name>
{
    "Stacks": [
        {
            "StackId": "arn:aws:cloudformation:<region>:<aws_account_id>:stack/<stack_name>/b4e20e60-a5c8-11ee-8c99-0676a70102b5",
            "DriftInformation": {
                "StackDriftStatus": "NOT_CHECKED"
            },
            "Parameters": [
                {
                    "ParameterValue": "10.0.0.0/16",
                    "ParameterKey": "CidrBlock"
                },
                {
                    "ParameterValue": "zenn_test",
                    "ParameterKey": "SystemName"
                }
            ],
            "Tags": [],
            "Outputs": [
                {
                    "OutputKey": "IgwId",
                    "OutputValue": "igw-09a8a7cd70d9c64f3"
                },
                {
                    "OutputKey": "VpcId",
                    "OutputValue": "vpc-088d128811eb40c93"
                }
            ],
            "EnableTerminationProtection": false,
            "CreationTime": "2023-12-28T21:33:14.249Z",
            "StackName": "<stack_name>",
            "NotificationARNs": [],
            "StackStatus": "CREATE_COMPLETE",
            "DisableRollback": false,
            "RollbackConfiguration": {}
        }
    ]
}
```

ä½œæˆã•ã‚ŒãŸãƒªã‚½ãƒ¼ã‚¹ã‚’ç¢ºèªã—ã¾ã™ã€‚
```
$ aws cloudformation list-stack-resources --stack-name <stack_name>
{
    "StackResourceSummaries": [
        {
            "ResourceStatus": "CREATE_COMPLETE",
            "DriftInformation": {
                "StackResourceDriftStatus": "NOT_CHECKED"
            },
            "ResourceType": "AWS::EC2::VPCGatewayAttachment",
            "LastUpdatedTimestamp": "2023-12-28T21:33:37.647Z",
            "PhysicalResourceId": "IGW|vpc-088d128811eb40c93",
            "LogicalResourceId": "AttachGateway"
        },
        {
            "ResourceStatus": "CREATE_COMPLETE",
            "DriftInformation": {
                "StackResourceDriftStatus": "NOT_CHECKED"
            },
            "ResourceType": "AWS::EC2::InternetGateway",
            "LastUpdatedTimestamp": "2023-12-28T21:33:34.226Z",
            "PhysicalResourceId": "igw-09a8a7cd70d9c64f3",
            "LogicalResourceId": "InternetGateway"
        },
        {
            "ResourceStatus": "CREATE_COMPLETE",
            "DriftInformation": {
                "StackResourceDriftStatus": "NOT_CHECKED"
            },
            "ResourceType": "AWS::EC2::VPC",
            "LastUpdatedTimestamp": "2023-12-28T21:33:30.050Z",
            "PhysicalResourceId": "vpc-088d128811eb40c93",
            "LogicalResourceId": "VPC"
        }
    ]
}
```

## change set

å·®åˆ†ã‚’ç™ºç”Ÿã•ã›ã¾ã™ã€‚
ã“ã“ã§ã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¦ã€ã‚¿ã‚°ã®å€¤ã‚’å¤‰æ›´ã—ã¦ã¿ã¾ã™ã€‚
```
$ cp -pi parameter.json{,.000}
$ vi parameter.json

$ diff -u parameter.json{,.000}
--- parameter.json      2023-12-28 21:39:59.201608396 +0000
+++ parameter.json.000  2023-12-28 21:00:35.438369344 +0000
@@ -4,7 +4,7 @@
     "ParameterKey": "CidrBlock"
   },
   {
-    "ParameterValue": "zenn-test",
+    "ParameterValue": "zenn_test",
     "ParameterKey": "SystemName"
   }
 ]
```

å¤‰æ›´ã‚»ãƒƒãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚
```
$ aws cloudformation create-change-set --stack-name <stack_name> --template-body file://vpc.yml --parameters file://parameter.json --change-set-name <change_set_name> --description 'change SystemName'
{
    "StackId": "arn:aws:cloudformation:<region>:<aws_account_id>:stack/<stack_name>/b4e20e60-a5c8-11ee-8c99-0676a70102b5",
    "Id": "arn:aws:cloudformation:<region>:<aws_account_id>:changeSet/<change_set_name>/5503be9c-f6e0-48e4-b097-3f1da2eaa3b3"
}

$ aws cloudformation list-change-sets --stack-name <stack_name>
{
    "Summaries": [
        {
            "StackId": "arn:aws:cloudformation:<region>:<aws_account_id>:stack/<stack_name>/b4e20e60-a5c8-11ee-8c99-0676a70102b5",
            "Status": "CREATE_COMPLETE",
            "ChangeSetName": "<change_set_name>",
            "Description": "change SystemName",
            "CreationTime": "2023-12-28T21:41:01.200Z",
            "StackName": "<stack_name>",
            "ExecutionStatus": "AVAILABLE",
            "ChangeSetId": "arn:aws:cloudformation:<region>:<aws_account_id>:changeSet/<change_set_name>/5503be9c-f6e0-48e4-b097-3f1da2eaa3b3"
        }
    ]
}
```

æƒ³å®šã•ã‚Œã‚‹æ§‹æˆå¤‰æ›´ã‚’ç¢ºèªã—ã¾ã™ã€‚
RequiresRecreation ã®å€¤ãŒ Never ã¨ãªã£ã¦ã„ã‚‹ã‚‚ã®ã¯ã€ãƒªã‚½ãƒ¼ã‚¹ã®å†ä½œæˆã¯è¡Œã‚ã‚Œãšã€å±æ€§å€¤ã®å¤‰æ›´ã ã‘ãŒè¡Œã‚ã‚Œã¾ã™ã€‚
```
$ aws cloudformation describe-change-set --stack-name <stack_name> --change-set-name <change_set_name>
{
    "StackId": "arn:aws:cloudformation:<region>:<aws_account_id>:stack/<stack_name>/b4e20e60-a5c8-11ee-8c99-0676a70102b5",
    "Status": "CREATE_COMPLETE",
    "ChangeSetName": "<change_set_name>",
    "Description": "change SystemName",
    "Parameters": [
        {
            "ParameterValue": "10.0.0.0/16",
            "ParameterKey": "CidrBlock"
        },
        {
            "ParameterValue": "zenn-test",
            "ParameterKey": "SystemName"
        }
    ],
    "Tags": null,
    "ChangeSetId": "arn:aws:cloudformation:<region>:<aws_account_id>:changeSet/<change_set_name>/5503be9c-f6e0-48e4-b097-3f1da2eaa3b3",
    "CreationTime": "2023-12-28T21:41:01.200Z",
    "StatusReason": null,
    "StackName": "<stack_name>",
    "NotificationARNs": [],
    "Capabilities": [],
    "ExecutionStatus": "AVAILABLE",
    "Changes": [
        {
            "ResourceChange": {
                "ResourceType": "AWS::EC2::InternetGateway",
                "PhysicalResourceId": "igw-09a8a7cd70d9c64f3",
                "Details": [
                    {
                        "CausingEntity": "SystemName",
                        "ChangeSource": "ParameterReference",
                        "Evaluation": "Static",
                        "Target": {
                            "Attribute": "Properties",
                            "Name": "Tags",
                            "RequiresRecreation": "Never"
                        }
                    },
                    {
                        "ChangeSource": "DirectModification",
                        "Evaluation": "Dynamic",
                        "Target": {
                            "Attribute": "Properties",
                            "Name": "Tags",
                            "RequiresRecreation": "Never"
                        }
                    }
                ],
                "Action": "Modify",
                "Scope": [
                    "Properties"
                ],
                "LogicalResourceId": "InternetGateway",
                "Replacement": "False"
            },
            "Type": "Resource"
        },
        {
            "ResourceChange": {
                "ResourceType": "AWS::EC2::VPC",
                "PhysicalResourceId": "vpc-088d128811eb40c93",
                "Details": [
                    {
                        "CausingEntity": "SystemName",
                        "ChangeSource": "ParameterReference",
                        "Evaluation": "Static",
                        "Target": {
                            "Attribute": "Properties",
                            "Name": "Tags",
                            "RequiresRecreation": "Never"
                        }
                    },
                    {
                        "ChangeSource": "DirectModification",
                        "Evaluation": "Dynamic",
                        "Target": {
                            "Attribute": "Properties",
                            "Name": "Tags",
                            "RequiresRecreation": "Never"
                        }
                    }
                ],
                "Action": "Modify",
                "Scope": [
                    "Properties"
                ],
                "LogicalResourceId": "VPC",
                "Replacement": "False"
            },
            "Type": "Resource"
        }
    ],
    "RollbackConfiguration": {}
}
```

ã‚ã¨ã‹ã‚‰æ¯”è¼ƒã™ã‚‹ãŸã‚ã€å¤‰æ›´ãŒæƒ³å®šã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹ã®ç¾åœ¨ã®æƒ…å ±ã‚’å–å¾—ã—ã¦ãŠãã¾ã™ã€‚
```
$ aws ec2 describe-vpcs --vpc-ids vpc-088d128811eb40c93 > vpc.before
$ aws ec2 describe-internet-gateways --internet-gateway-ids igw-09a8a7cd70d9c64f3 > igw.before
```

å¤‰æ›´ã‚»ãƒƒãƒˆã‚’é©ç”¨ã—ã¾ã™ã€‚
```
$ aws cloudformation execute-change-set --stack-name <stack_name> --change-set-name <change_set_name>

$ aws cloudformation list-change-sets --stack-name <stack_name>
{
    "Summaries": []
}
```

ã‚¹ã‚¿ãƒƒã‚¯ã®çŠ¶æ…‹ã‚’ç¢ºèªã—ã¾ã™ã€‚
```
$ aws cloudformation describe-stacks --stack-name <stack_name>
{
    "Stacks": [
        {
            "StackId": "arn:aws:cloudformation:<region>:<aws_account_id>:stack/<stack_name>/b4e20e60-a5c8-11ee-8c99-0676a70102b5",
            "DriftInformation": {
                "StackDriftStatus": "NOT_CHECKED"
            },
            "LastUpdatedTime": "2023-12-28T21:50:16.556Z",
            "Parameters": [
                {
                    "ParameterValue": "10.0.0.0/16",
                    "ParameterKey": "CidrBlock"
                },
                {
                    "ParameterValue": "zenn-test",
                    "ParameterKey": "SystemName"
                }
            ],
            "Tags": [],
            "Outputs": [
                {
                    "OutputKey": "IgwId",
                    "OutputValue": "igw-09a8a7cd70d9c64f3"
                },
                {
                    "OutputKey": "VpcId",
                    "OutputValue": "vpc-088d128811eb40c93"
                }
            ],
            "EnableTerminationProtection": false,
            "CreationTime": "2023-12-28T21:33:14.249Z",
            "StackName": "<stack_name>",
            "NotificationARNs": [],
            "StackStatus": "UPDATE_COMPLETE",
            "DisableRollback": false,
            "ChangeSetId": "arn:aws:cloudformation:<region>:<aws_account_id>:changeSet/<change_set_name>/5503be9c-f6e0-48e4-b097-3f1da2eaa3b3",
            "RollbackConfiguration": {}
        }
    ]
}
```

äº‹å‰ã«å–å¾—ã—ã¦ã„ãŸæƒ…å ±ã¨ã®å·®åˆ†ã‚’ç¢ºèªã—ã¾ã™ã€‚
```
$ aws ec2 describe-vpcs --vpc-ids vpc-088d128811eb40c93 | diff -u - vpc.before
--- -   2023-12-28 21:52:24.982994416 +0000
+++ vpc.before  2023-12-28 21:47:50.583599706 +0000
@@ -5,16 +5,16 @@
             "InstanceTenancy": "default",
             "Tags": [
                 {
-                    "Value": "zenn-test",
-                    "Key": "SystemName"
+                    "Value": "zenn_test_vpc",
+                    "Key": "Name"
                 },
                 {
                     "Value": "arn:aws:cloudformation:<region>:<aws_account_id>:stack/<stack_name>/b4e20e60-a5c8-11ee-8c99-0676a70102b5",
                     "Key": "aws:cloudformation:stack-id"
                 },
                 {
-                    "Value": "zenn-test_vpc",
-                    "Key": "Name"
+                    "Value": "zenn_test",
+                    "Key": "SystemName"
                 },
                 {
                     "Value": "VPC",

$ aws ec2 describe-internet-gateways --internet-gateway-ids igw-09a8a7cd70d9c64f3 | diff -u - igw.before
--- -   2023-12-28 21:53:03.331128862 +0000
+++ igw.before  2023-12-28 21:48:52.078822486 +0000
@@ -4,7 +4,7 @@
             "OwnerId": "<aws_account_id>",
             "Tags": [
                 {
-                    "Value": "zenn-test_igw",
+                    "Value": "zenn_test_igw",
                     "Key": "Name"
                 },
                 {
@@ -16,7 +16,7 @@
                     "Key": "aws:cloudformation:stack-name"
                 },
                 {
-                    "Value": "zenn-test",
+                    "Value": "zenn_test",
                     "Key": "SystemName"
                 },
                 {
```

## change set ãƒ‘ã‚¿ãƒ¼ãƒ³2

å·®åˆ†ã‚’ç™ºç”Ÿã•ã›ã¾ã™ã€‚
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¦ã€CidrBlock ã®å€¤ã‚’å¤‰æ›´ã—ã¦ã¿ã¾ã™ã€‚
```
$ cp -pi parameter.json{,.001}
$ vi parameter.json

$ diff -u parameter.json{,.001}
--- parameter.json      2023-12-28 23:14:14.975254718 +0000
+++ parameter.json.001  2023-12-28 21:39:59.201608396 +0000
@@ -1,6 +1,6 @@
 [
   {
-    "ParameterValue": "10.1.0.0/16",
+    "ParameterValue": "10.0.0.0/16",
     "ParameterKey": "CidrBlock"
   },
   {
```

å¤‰æ›´ã‚»ãƒƒãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚
```
$ aws cloudformation create-change-set --stack-name <stack_name> --template-body file://vpc.yml --parameters file://parameter.json --change-set-name <change_set_name> --description 'change CidrBlock'
{
    "StackId": "arn:aws:cloudformation:<region>:<aws_account_id>:stack/<stack_name>/b4e20e60-a5c8-11ee-8c99-0676a70102b5",
    "Id": "arn:aws:cloudformation:<region>:<aws_account_id>:changeSet/<change_set_name>/042ae1e2-db71-485a-9987-a43edb3eb94c"
}

$ aws cloudformation list-change-sets --stack-name <stack_name>
{
    "Summaries": [
        {
            "StackId": "arn:aws:cloudformation:<region>:<aws_account_id>:stack/<stack_name>/b4e20e60-a5c8-11ee-8c99-0676a70102b5",
            "Status": "CREATE_COMPLETE",
            "ChangeSetName": "<change_set_name>",
            "Description": "change CidrBlock",
            "CreationTime": "2023-12-28T23:15:40.050Z",
            "StackName": "<stack_name>",
            "ExecutionStatus": "AVAILABLE",
            "ChangeSetId": "arn:aws:cloudformation:<region>:<aws_account_id>:changeSet/<change_set_name>/042ae1e2-db71-485a-9987-a43edb3eb94c"
        }
    ]
}
```

æƒ³å®šã•ã‚Œã‚‹æ§‹æˆå¤‰æ›´ã‚’ç¢ºèªã—ã¾ã™ã€‚
RequiresRecreation ã®å€¤ãŒ Always ã¨ãªã£ã¦ã„ã‚‹ã‚‚ã®ã¯ã€ãƒªã‚½ãƒ¼ã‚¹ã®å†ä½œæˆãŒè¡Œã‚ã‚Œã¾ã™ã€‚
ãƒªã‚½ãƒ¼ã‚¹ãŒå†ä½œæˆã•ã‚Œã‚‹ã¨å¥½ã¾ã—ããªã„çµæœã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹å ´åˆã¯ã€å†è€ƒãŒæ±‚ã‚ã‚‰ã‚Œã¾ã™ã€‚
```
$ aws cloudformation describe-change-set --stack-name <stack_name> --change-set-name <change_set_name>
{
    "StackId": "arn:aws:cloudformation:<region>:<aws_account_id>:stack/<stack_name>/b4e20e60-a5c8-11ee-8c99-0676a70102b5",
    "Status": "CREATE_COMPLETE",
    "ChangeSetName": "<change_set_name>",
    "Description": "change CidrBlock",
    "Parameters": [
        {
            "ParameterValue": "10.1.0.0/16",
            "ParameterKey": "CidrBlock"
        },
        {
            "ParameterValue": "zenn-test",
            "ParameterKey": "SystemName"
        }
    ],
    "Tags": null,
    "ChangeSetId": "arn:aws:cloudformation:<region>:<aws_account_id>:changeSet/<change_set_name>/042ae1e2-db71-485a-9987-a43edb3eb94c",
    "CreationTime": "2023-12-28T23:15:40.050Z",
    "StatusReason": null,
    "StackName": "<stack_name>",
    "NotificationARNs": [],
    "Capabilities": [],
    "ExecutionStatus": "AVAILABLE",
    "Changes": [
        {
            "ResourceChange": {
                "ResourceType": "AWS::EC2::VPCGatewayAttachment",
                "PhysicalResourceId": "IGW|vpc-088d128811eb40c93",
                "Details": [
                    {
                        "CausingEntity": "VPC",
                        "ChangeSource": "ResourceReference",
                        "Evaluation": "Static",
                        "Target": {
                            "Attribute": "Properties",
                            "Name": "VpcId",
                            "RequiresRecreation": "Always"
                        }
                    }
                ],
                "Action": "Modify",
                "Scope": [
                    "Properties"
                ],
                "LogicalResourceId": "AttachGateway",
                "Replacement": "True"
            },
            "Type": "Resource"
        },
        {
            "ResourceChange": {
                "ResourceType": "AWS::EC2::VPC",
                "PhysicalResourceId": "vpc-088d128811eb40c93",
                "Details": [
                    {
                        "CausingEntity": "CidrBlock",
                        "ChangeSource": "ParameterReference",
                        "Evaluation": "Static",
                        "Target": {
                            "Attribute": "Properties",
                            "Name": "CidrBlock",
                            "RequiresRecreation": "Always"
                        }
                    },
                    {
                        "ChangeSource": "DirectModification",
                        "Evaluation": "Dynamic",
                        "Target": {
                            "Attribute": "Properties",
                            "Name": "CidrBlock",
                            "RequiresRecreation": "Always"
                        }
                    }
                ],
                "Action": "Modify",
                "Scope": [
                    "Properties"
                ],
                "LogicalResourceId": "VPC",
                "Replacement": "True"
            },
            "Type": "Resource"
        }
    ],
    "RollbackConfiguration": {}
}
```

ä»Šå›ã¯å·®åˆ†ã‚’é©ç”¨ã—ãªã„ã§ã€ä½œæˆã—ãŸå¤‰æ›´ã‚»ãƒƒãƒˆã‚’å‰Šé™¤ã—ã¦ãŠãã¾ã™ã€‚ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚åˆ‡ã‚Šæˆ»ã—ã¾ã™ã€‚
```
$ aws cloudformation delete-change-set --stack-name <stack_name> --change-set-name <change_set_name>

$ aws cloudformation list-change-sets --stack-name <stack_name>
{
    "Summaries": []
}

$ mv parameter.json{.001,}
```