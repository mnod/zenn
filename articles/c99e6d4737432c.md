---
title: "CloudFormation Â§âÊõ¥„Çª„ÉÉ„Éà„Çí‰ΩøÁî®„Åó„ÅüÊõ¥Êñ∞"
emoji: "üëÄ"
type: "tech"
topics: ["aws", "cloudformation"]
published: true
---

## „Çπ„Çø„ÉÉ„ÇØ„ÅÆ‰ΩúÊàê

„ÉÜ„É≥„Éó„É¨„Éº„Éà„Éï„Ç°„Ç§„É´„Çí‰ΩúÊàê„Åó„Åæ„Åô„ÄÇ

```: vpc.yml
AWSTemplateFormatVersion: '2010-09-09'
Parameters:
  CidrBlock:
    Type: String
    Default: "10.0.0.0/16"
  SystemName :
    Type: String
    Default: "zenn_test"
Resources:
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref CidrBlock
      Tags:
      - Key: Name
        Value: !Sub "${SystemName}_vpc"
      - Key: SystemName
        Value: !Ref SystemName
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
      - Key: Name
        Value: !Sub "${SystemName}_igw"
      - Key: SystemName
        Value: !Ref SystemName
  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId:
        Ref: VPC
      InternetGatewayId:
        Ref: InternetGateway
Outputs:
  VpcId:
    Value: !Ref VPC
  IgwId:
    Value: !Ref InternetGateway
```

„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅÆÊúâÂäπÊÄß„ÇíÁ¢∫Ë™ç„Åó„Åæ„Åô„ÄÇ
```
$ aws cloudformation validate-template --template-body file://vpc.yml | tee parameter.tmp
{
    "Parameters": [
        {
            "DefaultValue": "10.0.0.0/16",
            "NoEcho": false,
            "ParameterKey": "CidrBlock"
        },
        {
            "DefaultValue": "zenn_test",
            "NoEcho": false,
            "ParameterKey": "SystemName"
        }
    ]
}
```

„Éë„É©„É°„Éº„Çø„Éï„Ç°„Ç§„É´„Çí‰ΩúÊàê„Åó„Åæ„Åô„ÄÇ
```
$ jq '.Parameters' parameter.tmp > parameter.json
$ vi parameter.json

$ jq . parameter.json
[
  {
    "ParameterValue": "10.0.0.0/16",
    "ParameterKey": "CidrBlock"
  },
  {
    "ParameterValue": "zenn_test",
    "ParameterKey": "SystemName"
  }
]
```

„ÉÜ„É≥„Éó„É¨„Éº„Éà„Éï„Ç°„Ç§„É´„ÄÅ„Éë„É©„É°„Éº„Çø„Éï„Ç°„Ç§„É´„ÇíÂà©Áî®„Åó„Å¶„ÄÅ„Çπ„Çø„ÉÉ„ÇØ„Çí‰ΩúÊàê„Åó„Åæ„Åô„ÄÇ
```
$ aws cloudformation create-stack --template-body file://vpc.yml --parameters file://parameter.json --stack-name <stack_name>
{
    "StackId": "arn:aws:cloudformation:<region>:<aws_account_id>:stack/<stack_name>/b4e20e60-a5c8-11ee-8c99-0676a70102b5"
}
```

„Çπ„Çø„ÉÉ„ÇØ„ÅÆÁä∂ÊÖã„ÇíÁ¢∫Ë™ç„Åó„Åæ„Åô„ÄÇ
```
$ aws cloudformation describe-stacks --stack-name <stack_name>
{
    "Stacks": [
        {
            "StackId": "arn:aws:cloudformation:<region>:<aws_account_id>:stack/<stack_name>/b4e20e60-a5c8-11ee-8c99-0676a70102b5",
            "DriftInformation": {
                "StackDriftStatus": "NOT_CHECKED"
            },
            "Parameters": [
                {
                    "ParameterValue": "10.0.0.0/16",
                    "ParameterKey": "CidrBlock"
                },
                {
                    "ParameterValue": "zenn_test",
                    "ParameterKey": "SystemName"
                }
            ],
            "Tags": [],
            "Outputs": [
                {
                    "OutputKey": "IgwId",
                    "OutputValue": "igw-09a8a7cd70d9c64f3"
                },
                {
                    "OutputKey": "VpcId",
                    "OutputValue": "vpc-088d128811eb40c93"
                }
            ],
            "EnableTerminationProtection": false,
            "CreationTime": "2023-12-28T21:33:14.249Z",
            "StackName": "<stack_name>",
            "NotificationARNs": [],
            "StackStatus": "CREATE_COMPLETE",
            "DisableRollback": false,
            "RollbackConfiguration": {}
        }
    ]
}
```

‰ΩúÊàê„Åï„Çå„Åü„É™„ÇΩ„Éº„Çπ„ÇíÁ¢∫Ë™ç„Åó„Åæ„Åô„ÄÇ
```
$ aws cloudformation list-stack-resources --stack-name <stack_name>
{
    "StackResourceSummaries": [
        {
            "ResourceStatus": "CREATE_COMPLETE",
            "DriftInformation": {
                "StackResourceDriftStatus": "NOT_CHECKED"
            },
            "ResourceType": "AWS::EC2::VPCGatewayAttachment",
            "LastUpdatedTimestamp": "2023-12-28T21:33:37.647Z",
            "PhysicalResourceId": "IGW|vpc-088d128811eb40c93",
            "LogicalResourceId": "AttachGateway"
        },
        {
            "ResourceStatus": "CREATE_COMPLETE",
            "DriftInformation": {
                "StackResourceDriftStatus": "NOT_CHECKED"
            },
            "ResourceType": "AWS::EC2::InternetGateway",
            "LastUpdatedTimestamp": "2023-12-28T21:33:34.226Z",
            "PhysicalResourceId": "igw-09a8a7cd70d9c64f3",
            "LogicalResourceId": "InternetGateway"
        },
        {
            "ResourceStatus": "CREATE_COMPLETE",
            "DriftInformation": {
                "StackResourceDriftStatus": "NOT_CHECKED"
            },
            "ResourceType": "AWS::EC2::VPC",
            "LastUpdatedTimestamp": "2023-12-28T21:33:30.050Z",
            "PhysicalResourceId": "vpc-088d128811eb40c93",
            "LogicalResourceId": "VPC"
        }
    ]
}
```

## change set

Â∑ÆÂàÜ„ÇíÁô∫Áîü„Åï„Åõ„Åæ„Åô„ÄÇ
„Åì„Åì„Åß„ÅØ„Éë„É©„É°„Éº„Çø„Éï„Ç°„Ç§„É´„ÇíÁ∑®ÈõÜ„Åó„Å¶„ÄÅ„Çø„Ç∞„ÅÆÂÄ§„ÇíÂ§âÊõ¥„Åó„Å¶„Åø„Åæ„Åô„ÄÇ
```
$ cp -pi parameter.json{,.000}
$ vi parameter.json

$ diff -u parameter.json{,.000}
--- parameter.json      2023-12-28 21:39:59.201608396 +0000
+++ parameter.json.000  2023-12-28 21:00:35.438369344 +0000
@@ -4,7 +4,7 @@
     "ParameterKey": "CidrBlock"
   },
   {
-    "ParameterValue": "zenn-test",
+    "ParameterValue": "zenn_test",
     "ParameterKey": "SystemName"
   }
 ]
```

Â§âÊõ¥„Çª„ÉÉ„Éà„Çí‰ΩúÊàê„Åó„Åæ„Åô„ÄÇ
```
$ aws cloudformation create-change-set --stack-name <stack_name> --template-body file://vpc.yml --parameters file://parameter.json --change-set-name <change_set_name> --description 'change SystemName'
{
    "StackId": "arn:aws:cloudformation:<region>:<aws_account_id>:stack/<stack_name>/b4e20e60-a5c8-11ee-8c99-0676a70102b5",
    "Id": "arn:aws:cloudformation:<region>:<aws_account_id>:changeSet/<change_set_name>/5503be9c-f6e0-48e4-b097-3f1da2eaa3b3"
}

$ aws cloudformation list-change-sets --stack-name <stack_name>
{
    "Summaries": [
        {
            "StackId": "arn:aws:cloudformation:<region>:<aws_account_id>:stack/<stack_name>/b4e20e60-a5c8-11ee-8c99-0676a70102b5",
            "Status": "CREATE_COMPLETE",
            "ChangeSetName": "<change_set_name>",
            "Description": "change SystemName",
            "CreationTime": "2023-12-28T21:41:01.200Z",
            "StackName": "<stack_name>",
            "ExecutionStatus": "AVAILABLE",
            "ChangeSetId": "arn:aws:cloudformation:<region>:<aws_account_id>:changeSet/<change_set_name>/5503be9c-f6e0-48e4-b097-3f1da2eaa3b3"
        }
    ]
}
```

ÊÉ≥ÂÆö„Åï„Çå„ÇãÊßãÊàêÂ§âÊõ¥„ÇíÁ¢∫Ë™ç„Åó„Åæ„Åô„ÄÇ
RequiresRecreation „ÅÆÂÄ§„Åå Never „Å®„Å™„Å£„Å¶„ÅÑ„Çã„ÇÇ„ÅÆ„ÅØ„ÄÅ„É™„ÇΩ„Éº„Çπ„ÅÆÂÜç‰ΩúÊàê„ÅØË°å„Çè„Çå„Åö„ÄÅÂ±ûÊÄßÂÄ§„ÅÆÂ§âÊõ¥„Å†„Åë„ÅåË°å„Çè„Çå„Åæ„Åô„ÄÇ
```
$ aws cloudformation describe-change-set --stack-name <stack_name> --change-set-name <change_set_name>
{
    "StackId": "arn:aws:cloudformation:<region>:<aws_account_id>:stack/<stack_name>/b4e20e60-a5c8-11ee-8c99-0676a70102b5",
    "Status": "CREATE_COMPLETE",
    "ChangeSetName": "<change_set_name>",
    "Description": "change SystemName",
    "Parameters": [
        {
            "ParameterValue": "10.0.0.0/16",
            "ParameterKey": "CidrBlock"
        },
        {
            "ParameterValue": "zenn-test",
            "ParameterKey": "SystemName"
        }
    ],
    "Tags": null,
    "ChangeSetId": "arn:aws:cloudformation:<region>:<aws_account_id>:changeSet/<change_set_name>/5503be9c-f6e0-48e4-b097-3f1da2eaa3b3",
    "CreationTime": "2023-12-28T21:41:01.200Z",
    "StatusReason": null,
    "StackName": "<stack_name>",
    "NotificationARNs": [],
    "Capabilities": [],
    "ExecutionStatus": "AVAILABLE",
    "Changes": [
        {
            "ResourceChange": {
                "ResourceType": "AWS::EC2::InternetGateway",
                "PhysicalResourceId": "igw-09a8a7cd70d9c64f3",
                "Details": [
                    {
                        "CausingEntity": "SystemName",
                        "ChangeSource": "ParameterReference",
                        "Evaluation": "Static",
                        "Target": {
                            "Attribute": "Properties",
                            "Name": "Tags",
                            "RequiresRecreation": "Never"
                        }
                    },
                    {
                        "ChangeSource": "DirectModification",
                        "Evaluation": "Dynamic",
                        "Target": {
                            "Attribute": "Properties",
                            "Name": "Tags",
                            "RequiresRecreation": "Never"
                        }
                    }
                ],
                "Action": "Modify",
                "Scope": [
                    "Properties"
                ],
                "LogicalResourceId": "InternetGateway",
                "Replacement": "False"
            },
            "Type": "Resource"
        },
        {
            "ResourceChange": {
                "ResourceType": "AWS::EC2::VPC",
                "PhysicalResourceId": "vpc-088d128811eb40c93",
                "Details": [
                    {
                        "CausingEntity": "SystemName",
                        "ChangeSource": "ParameterReference",
                        "Evaluation": "Static",
                        "Target": {
                            "Attribute": "Properties",
                            "Name": "Tags",
                            "RequiresRecreation": "Never"
                        }
                    },
                    {
                        "ChangeSource": "DirectModification",
                        "Evaluation": "Dynamic",
                        "Target": {
                            "Attribute": "Properties",
                            "Name": "Tags",
                            "RequiresRecreation": "Never"
                        }
                    }
                ],
                "Action": "Modify",
                "Scope": [
                    "Properties"
                ],
                "LogicalResourceId": "VPC",
                "Replacement": "False"
            },
            "Type": "Resource"
        }
    ],
    "RollbackConfiguration": {}
}
```

„ÅÇ„Å®„Åã„ÇâÊØîËºÉ„Åô„Çã„Åü„ÇÅ„ÄÅÂ§âÊõ¥„ÅåÊÉ≥ÂÆö„Åï„Çå„Çã„É™„ÇΩ„Éº„Çπ„ÅÆÁèæÂú®„ÅÆÊÉÖÂ†±„ÇíÂèñÂæó„Åó„Å¶„Åä„Åç„Åæ„Åô„ÄÇ
```
$ aws ec2 describe-vpcs --vpc-ids vpc-088d128811eb40c93 > vpc.before
$ aws ec2 describe-internet-gateways --internet-gateway-ids igw-09a8a7cd70d9c64f3 > igw.before
```

Â§âÊõ¥„Çª„ÉÉ„Éà„ÇíÈÅ©Áî®„Åó„Åæ„Åô„ÄÇ
```
$ aws cloudformation execute-change-set --stack-name <stack_name> --change-set-name <change_set_name>

$ aws cloudformation list-change-sets --stack-name <stack_name>
{
    "Summaries": []
}
```

„Çπ„Çø„ÉÉ„ÇØ„ÅÆÁä∂ÊÖã„ÇíÁ¢∫Ë™ç„Åó„Åæ„Åô„ÄÇ
```
$ aws cloudformation describe-stacks --stack-name <stack_name>
{
    "Stacks": [
        {
            "StackId": "arn:aws:cloudformation:<region>:<aws_account_id>:stack/<stack_name>/b4e20e60-a5c8-11ee-8c99-0676a70102b5",
            "DriftInformation": {
                "StackDriftStatus": "NOT_CHECKED"
            },
            "LastUpdatedTime": "2023-12-28T21:50:16.556Z",
            "Parameters": [
                {
                    "ParameterValue": "10.0.0.0/16",
                    "ParameterKey": "CidrBlock"
                },
                {
                    "ParameterValue": "zenn-test",
                    "ParameterKey": "SystemName"
                }
            ],
            "Tags": [],
            "Outputs": [
                {
                    "OutputKey": "IgwId",
                    "OutputValue": "igw-09a8a7cd70d9c64f3"
                },
                {
                    "OutputKey": "VpcId",
                    "OutputValue": "vpc-088d128811eb40c93"
                }
            ],
            "EnableTerminationProtection": false,
            "CreationTime": "2023-12-28T21:33:14.249Z",
            "StackName": "<stack_name>",
            "NotificationARNs": [],
            "StackStatus": "UPDATE_COMPLETE",
            "DisableRollback": false,
            "ChangeSetId": "arn:aws:cloudformation:<region>:<aws_account_id>:changeSet/<change_set_name>/5503be9c-f6e0-48e4-b097-3f1da2eaa3b3",
            "RollbackConfiguration": {}
        }
    ]
}
```

‰∫ãÂâç„Å´ÂèñÂæó„Åó„Å¶„ÅÑ„ÅüÊÉÖÂ†±„Å®„ÅÆÂ∑ÆÂàÜ„ÇíÁ¢∫Ë™ç„Åó„Åæ„Åô„ÄÇ
```
$ aws ec2 describe-vpcs --vpc-ids vpc-088d128811eb40c93 | diff -u - vpc.before
--- -   2023-12-28 21:52:24.982994416 +0000
+++ vpc.before  2023-12-28 21:47:50.583599706 +0000
@@ -5,16 +5,16 @@
             "InstanceTenancy": "default",
             "Tags": [
                 {
-                    "Value": "zenn-test",
-                    "Key": "SystemName"
+                    "Value": "zenn_test_vpc",
+                    "Key": "Name"
                 },
                 {
                     "Value": "arn:aws:cloudformation:<region>:<aws_account_id>:stack/<stack_name>/b4e20e60-a5c8-11ee-8c99-0676a70102b5",
                     "Key": "aws:cloudformation:stack-id"
                 },
                 {
-                    "Value": "zenn-test_vpc",
-                    "Key": "Name"
+                    "Value": "zenn_test",
+                    "Key": "SystemName"
                 },
                 {
                     "Value": "VPC",

$ aws ec2 describe-internet-gateways --internet-gateway-ids igw-09a8a7cd70d9c64f3 | diff -u - igw.before
--- -   2023-12-28 21:53:03.331128862 +0000
+++ igw.before  2023-12-28 21:48:52.078822486 +0000
@@ -4,7 +4,7 @@
             "OwnerId": "<aws_account_id>",
             "Tags": [
                 {
-                    "Value": "zenn-test_igw",
+                    "Value": "zenn_test_igw",
                     "Key": "Name"
                 },
                 {
@@ -16,7 +16,7 @@
                     "Key": "aws:cloudformation:stack-name"
                 },
                 {
-                    "Value": "zenn-test",
+                    "Value": "zenn_test",
                     "Key": "SystemName"
                 },
                 {
```

## change set „Éë„Çø„Éº„É≥2

Â∑ÆÂàÜ„ÇíÁô∫Áîü„Åï„Åõ„Åæ„Åô„ÄÇ
„Éë„É©„É°„Éº„Çø„Éï„Ç°„Ç§„É´„ÇíÁ∑®ÈõÜ„Åó„Å¶„ÄÅCidrBlock „ÅÆÂÄ§„ÇíÂ§âÊõ¥„Åó„Å¶„Åø„Åæ„Åô„ÄÇ
```
$ cp -pi parameter.json{,.001}
$ vi parameter.json

$ diff -u parameter.json{,.001}
--- parameter.json      2023-12-28 23:14:14.975254718 +0000
+++ parameter.json.001  2023-12-28 21:39:59.201608396 +0000
@@ -1,6 +1,6 @@
 [
   {
-    "ParameterValue": "10.1.0.0/16",
+    "ParameterValue": "10.0.0.0/16",
     "ParameterKey": "CidrBlock"
   },
   {
```

Â§âÊõ¥„Çª„ÉÉ„Éà„Çí‰ΩúÊàê„Åó„Åæ„Åô„ÄÇ
```
$ aws cloudformation create-change-set --stack-name <stack_name> --template-body file://vpc.yml --parameters file://parameter.json --change-set-name <change_set_name> --description 'change CidrBlock'
{
    "StackId": "arn:aws:cloudformation:<region>:<aws_account_id>:stack/<stack_name>/b4e20e60-a5c8-11ee-8c99-0676a70102b5",
    "Id": "arn:aws:cloudformation:<region>:<aws_account_id>:changeSet/<change_set_name>/042ae1e2-db71-485a-9987-a43edb3eb94c"
}

$ aws cloudformation list-change-sets --stack-name <stack_name>
{
    "Summaries": [
        {
            "StackId": "arn:aws:cloudformation:<region>:<aws_account_id>:stack/<stack_name>/b4e20e60-a5c8-11ee-8c99-0676a70102b5",
            "Status": "CREATE_COMPLETE",
            "ChangeSetName": "<change_set_name>",
            "Description": "change CidrBlock",
            "CreationTime": "2023-12-28T23:15:40.050Z",
            "StackName": "<stack_name>",
            "ExecutionStatus": "AVAILABLE",
            "ChangeSetId": "arn:aws:cloudformation:<region>:<aws_account_id>:changeSet/<change_set_name>/042ae1e2-db71-485a-9987-a43edb3eb94c"
        }
    ]
}
```

ÊÉ≥ÂÆö„Åï„Çå„ÇãÊßãÊàêÂ§âÊõ¥„ÇíÁ¢∫Ë™ç„Åó„Åæ„Åô„ÄÇ
RequiresRecreation „ÅÆÂÄ§„Åå Always „Å®„Å™„Å£„Å¶„ÅÑ„Çã„ÇÇ„ÅÆ„ÅØ„ÄÅ„É™„ÇΩ„Éº„Çπ„ÅÆÂÜç‰ΩúÊàê„ÅåË°å„Çè„Çå„Åæ„Åô„ÄÇ
„É™„ÇΩ„Éº„Çπ„ÅåÂÜç‰ΩúÊàê„Åï„Çå„Çã„Å®Â•Ω„Åæ„Åó„Åè„Å™„ÅÑÁµêÊûú„Å´„Å™„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„ÄÅÂÜçËÄÉ„ÅåÊ±Ç„ÇÅ„Çâ„Çå„Åæ„Åô„ÄÇ
```
$ aws cloudformation describe-change-set --stack-name <stack_name> --change-set-name <change_set_name>
{
    "StackId": "arn:aws:cloudformation:<region>:<aws_account_id>:stack/<stack_name>/b4e20e60-a5c8-11ee-8c99-0676a70102b5",
    "Status": "CREATE_COMPLETE",
    "ChangeSetName": "<change_set_name>",
    "Description": "change CidrBlock",
    "Parameters": [
        {
            "ParameterValue": "10.1.0.0/16",
            "ParameterKey": "CidrBlock"
        },
        {
            "ParameterValue": "zenn-test",
            "ParameterKey": "SystemName"
        }
    ],
    "Tags": null,
    "ChangeSetId": "arn:aws:cloudformation:<region>:<aws_account_id>:changeSet/<change_set_name>/042ae1e2-db71-485a-9987-a43edb3eb94c",
    "CreationTime": "2023-12-28T23:15:40.050Z",
    "StatusReason": null,
    "StackName": "<stack_name>",
    "NotificationARNs": [],
    "Capabilities": [],
    "ExecutionStatus": "AVAILABLE",
    "Changes": [
        {
            "ResourceChange": {
                "ResourceType": "AWS::EC2::VPCGatewayAttachment",
                "PhysicalResourceId": "IGW|vpc-088d128811eb40c93",
                "Details": [
                    {
                        "CausingEntity": "VPC",
                        "ChangeSource": "ResourceReference",
                        "Evaluation": "Static",
                        "Target": {
                            "Attribute": "Properties",
                            "Name": "VpcId",
                            "RequiresRecreation": "Always"
                        }
                    }
                ],
                "Action": "Modify",
                "Scope": [
                    "Properties"
                ],
                "LogicalResourceId": "AttachGateway",
                "Replacement": "True"
            },
            "Type": "Resource"
        },
        {
            "ResourceChange": {
                "ResourceType": "AWS::EC2::VPC",
                "PhysicalResourceId": "vpc-088d128811eb40c93",
                "Details": [
                    {
                        "CausingEntity": "CidrBlock",
                        "ChangeSource": "ParameterReference",
                        "Evaluation": "Static",
                        "Target": {
                            "Attribute": "Properties",
                            "Name": "CidrBlock",
                            "RequiresRecreation": "Always"
                        }
                    },
                    {
                        "ChangeSource": "DirectModification",
                        "Evaluation": "Dynamic",
                        "Target": {
                            "Attribute": "Properties",
                            "Name": "CidrBlock",
                            "RequiresRecreation": "Always"
                        }
                    }
                ],
                "Action": "Modify",
                "Scope": [
                    "Properties"
                ],
                "LogicalResourceId": "VPC",
                "Replacement": "True"
            },
            "Type": "Resource"
        }
    ],
    "RollbackConfiguration": {}
}
```

‰ªäÂõû„ÅØÂ∑ÆÂàÜ„ÇíÈÅ©Áî®„Åó„Å™„ÅÑ„Åß„ÄÅ‰ΩúÊàê„Åó„ÅüÂ§âÊõ¥„Çª„ÉÉ„Éà„ÇíÂâäÈô§„Åó„Å¶„Åä„Åç„Åæ„Åô„ÄÇ„Éë„É©„É°„Éº„Çø„Éï„Ç°„Ç§„É´„ÇÇÂàá„ÇäÊàª„Åó„Åæ„Åô„ÄÇ
```
$ aws cloudformation delete-change-set --stack-name <stack_name> --change-set-name <change_set_name>

$ aws cloudformation list-change-sets --stack-name <stack_name>
{
    "Summaries": []
}

$ mv parameter.json{.001,}
```